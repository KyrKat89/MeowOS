<!doctype html><html lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1"name=viewport><title>MeowOS — a tiny HTML OS</title><style>:root{--bg:#0b0f17;--glass:rgba(255,255,255,0.08);--glass-2:rgba(255,255,255,0.12);--text:#e6ecff;--muted:#a8b3d1;--accent:#8a9bff;--red:#ff6b6b;--yellow:#ffd166;--green:#3ecf8e;--shadow:0 10px 30px rgba(0,0,0,0.4);--blur:saturate(140%) blur(10px);--font-scale:1;--meow-icon-size:92px;--ripple-color:rgba(255,255,255,0.3);--font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Color Emoji","Apple Color Emoji","Segoe UI Emoji",sans-serif;--dark-grad1:color-mix(in srgb, var(--accent) 20%, #14223a);--dark-grad2:color-mix(in srgb, var(--accent) 20%, #1b2b4a)}body.light{--bg:#f0f4ff;--glass:rgba(0,0,0,0.08);--glass-2:rgba(0,0,0,0.12);--text:#0b0f17;--muted:#5a6a8a;--accent:#4a6bff;--red:#ff4a4a;--yellow:#ffb733;--green:#2ab07a;--shadow:0 10px 30px rgba(0,0,0,0.15);--blur:saturate(120%) blur(8px);--ripple-color:rgba(0,0,0,0.1);--light-grad1:color-mix(in srgb, var(--accent) 20%, #e0e8ff);--light-grad2:color-mix(in srgb, var(--accent) 20%, #d0dfff)}*{box-sizing:border-box}body,html{height:100%}body{margin:0;font-family:var(--font-family);color:var(--text);background:var(--bg) center/cover fixed no-repeat;background-image:radial-gradient(80vw 80vh at 10% 15%,var(--dark-grad1),transparent 60%),radial-gradient(80vw 80vh at 90% 85%,var(--dark-grad2),transparent 60%);user-select:none;overflow:hidden;font-size:calc(16px * var(--font-scale))}body.light{background-image:radial-gradient(80vw 80vh at 10% 15%,var(--light-grad1),transparent 60%),radial-gradient(80vw 80vh at 90% 85%,var(--light-grad2),transparent 60%)}.overlay{position:absolute;inset:0;display:grid;place-items:center;background:radial-gradient(1200px 800px at 50% 50%,rgba(0,0,0,.55),rgba(0,0,0,.8));z-index:9999}.overlay#spotlight{background:rgba(0,0,0,.4);backdrop-filter:blur(20px)}body.light .overlay#spotlight{background:rgba(0,0,0,.2)}.card{width:min(560px,92vw);padding:28px;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.12);border-radius:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;min-height:320px}.card h1{margin:0 0 8px;font-weight:800;letter-spacing:.4px}.card p{margin:6px 0 16px;color:var(--muted)}.row{display:flex;gap:12px;align-items:center}.row input[type=password],.row input[type=text]{flex:1}.btn{appearance:none;border:0;cursor:pointer;padding:10px 14px;border-radius:12px;font-weight:700;letter-spacing:.2px;background:linear-gradient(180deg,var(--accent),#6b82ff);color:#0b0f17;box-shadow:0 6px 16px rgba(138,155,255,.35);transition:transform .08s ease,filter .2s ease}body.light .btn{background:linear-gradient(180deg,var(--accent),#3a5aff);color:#fff;box-shadow:0 6px 16px rgba(74,107,255,.25)}.btn:hover{transform:translateY(-1px) scale(1.02)}.btn:active{transform:translateY(1px) scale(.98)}.btn.secondary{background:var(--glass-2);color:var(--text);box-shadow:none;border:1px solid rgba(255,255,255,.12)}body.light .btn.secondary{border:1px solid rgba(0,0,0,.12)}.oobe-card .btn.secondary{background:var(--glass-2);color:var(--text);border:1px solid rgba(255,255,255,.12)}body.light .oobe-card .btn.secondary{border:1px solid rgba(0,0,0,.12)}.input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:var(--text)}body.light .input{border:1px solid rgba(0,0,0,.15);background:rgba(0,0,0,.03)}.hidden{display:none!important}#desktop{position:absolute;inset:0;overflow:hidden}.topbar{position:absolute;inset:12px 12px auto 12px;height:40px;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:12px;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.1);box-shadow:var(--shadow)}.topbar .hello{font-weight:700;cursor:pointer}.topbar .clock{color:var(--muted);font-variant-numeric:tabular-nums;cursor:pointer}#meowMenu{position:absolute;left:50%;bottom:76px;transform:translateX(-50%);width:min(900px,92vw);background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;box-shadow:var(--shadow);z-index:300;display:grid;gap:12px;grid-template-rows:auto 1fr;opacity:0;transition:opacity .3s ease,transform .3s ease;transform:translateX(-50%) scale(.95)}#meowMenu:not(.hidden){opacity:1;transform:translateX(-50%) scale(1)}.meow-head{display:flex;align-items:center;gap:10px}.meow-head .avatar{font-size:24px}.meow-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--meow-icon-size,92px),1fr));gap:10px}.meow-item{display:grid;place-items:center;gap:6px;padding:8px;border-radius:12px;cursor:pointer;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);transition:transform .12s ease,background .2s ease;width:var(--meow-icon-size,92px)}body.light .meow-item{background:rgba(0,0,0,.035);border:1px solid rgba(0,0,0,.08)}.meow-item:hover{transform:translateY(-2px);background:var(--glass-2)}.meow-emoji{font-size:28px;line-height:1}.meow-label{font-size:12px;color:var(--muted);text-align:center}.meow-section-title{font-weight:800;color:var(--muted);margin:6px 2px}.meow-recents{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px}.recent{display:flex;gap:8px;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);cursor:pointer}body.light .recent{background:rgba(0,0,0,.035);border:1px solid rgba(0,0,0,.08)}.recent .icon{font-size:18px}.recent .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.dock{position:absolute;left:50%;bottom:14px;transform:translateX(-50%);display:flex;gap:18px;padding:10px 14px;border-radius:20px;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.12);box-shadow:var(--shadow);overflow-x:auto;overscroll-behavior-x:contain}.dock-item{appearance:none;border:0;background:0 0;color:var(--text);display:grid;place-items:center;gap:6px;padding:6px 8px;border-radius:14px;cursor:pointer;min-width:64px;transition:transform .12s ease,background .2s ease;flex:0 0 auto}.dock-item:hover{transform:translateY(-4px) scale(1.05);background:rgba(255,255,255,.08)}body.light .dock-item:hover{background:rgba(0,0,0,.05)}.dock-emoji{font-size:28px;line-height:1}.dock-label{font-size:12px;color:var(--muted)}.dot{width:6px;height:6px;border-radius:100%;background:var(--green);margin-top:2px;opacity:0;transition:opacity .2s}.dock-item.open .dot{opacity:1}.shortcut{position:absolute;min-width:auto;cursor:pointer}#contextMenu{position:absolute;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px;box-shadow:var(--shadow);z-index:200}.context-item{padding:6px 12px;cursor:pointer}.context-item:hover{background:var(--glass-2)}#fileContextMenu{position:absolute;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px;box-shadow:var(--shadow);z-index:200}.dialog-overlay{position:absolute;inset:0;background:rgba(0,0,0,.6);display:grid;place-items:center;z-index:150}.dialog-card{width:min(400px,80vw);padding:20px;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:var(--shadow)}.dialog-buttons{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}.oobe-card{background:var(--glass);color:var(--text);border:1px solid rgba(255,255,255,.12);box-shadow:var(--shadow);display:flex;flex-direction:column}.oobe-title{font-size:32px;font-weight:600;margin-bottom:12px}.oobe-sub{font-size:16px;color:var(--muted);margin-bottom:24px}.oobe-options{display:flex;flex-direction:column;gap:12px}.oobe-card input,.oobe-card select{color:var(--text);background:var(--glass);border:1px solid rgba(255,255,255,.15)}.oobe-card label{color:var(--text)}.app-window{position:absolute;inset:auto;min-width:360px;min-height:260px;width:680px;height:420px;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.15);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;opacity:0;transform:scale(.9);transition:opacity .3s ease,transform .3s ease}.app-window:not(.hidden):not(.minimized){opacity:1;transform:scale(1)}body.light .app-window{border:1px solid rgba(0,0,0,.15)}.app-window.minimized{display:none!important}.window-header{display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.08);cursor:grab;user-select:none}body.light .window-header{background:rgba(0,0,0,.03);border-bottom:1px solid rgba(0,0,0,.08)}.window-header:active{cursor:grabbing}.win-emoji{font-size:20px}.win-title{font-weight:800;letter-spacing:.3px;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.window-actions{display:flex;gap:10px;align-items:center}.win-btn{width:20px;height:20px;border-radius:100%;border:0;cursor:pointer;box-shadow:0 0 0 1px rgba(0,0,0,.15) inset;transition:transform .08s ease;display:inline-block}.win-close{background:var(--red)}.win-min{background:var(--yellow)}.win-max{background:var(--green)}.win-btn:hover{transform:scale(1.12)}.win-btn:active{transform:scale(.98)}body.dock-left .dock{left:14px;bottom:auto;top:50%;transform:translateY(-50%);flex-direction:column}body.dock-left .dock .dock-item{min-width:56px}.viewer{display:none;height:100%;background:rgba(0,0,0,.4)}body.light .viewer{background:rgba(255,255,255,.4)}.viewer.show{display:block}.media-view{height:100%;display:grid;place-items:center}.media-view audio,.media-view img,.media-view video{max-width:100%;max-height:100%;border-radius:12px}.window-body{height:calc(100% - 46px);display:grid;grid-template-rows:1fr}.settings-body{overflow-y:auto}.pad{padding:12px}.toolbar{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04)}body.light .toolbar{border-bottom:1px solid rgba(0,0,0,.08);background:rgba(0,0,0,.02)}.toolbar input,.toolbar select{background:rgba(255,255,255,.08);color:var(--text);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px 10px}.toolbar select,body.light .toolbar input{background:rgba(0,0,0,.05);border:1px solid rgba(0,0,0,.15)}#notesText{width:100%;height:100%;background:0 0;color:var(--text);border:0;outline:0;font:600 15px/1.6 var(--font-family);white-space:pre-wrap;word-wrap:break-word;padding:12px;overflow:auto}#notesPlaceholder{position:absolute;top:12px;left:12px;color:var(--muted);pointer-events:none;z-index:1}.cal-wrap{display:grid;grid-template-rows:auto 1fr;height:100%}.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:12px}.cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:12px;font-weight:700;color:var(--muted)}.day{padding:10px;border-radius:10px;background:rgba(255,255,255,.04);text-align:right}body.light .day{background:rgba(0,0,0,.03)}.day.today{outline:2px solid var(--accent)}.cal-controls{display:flex;align-items:center;gap:8px;padding:10px 12px;font-size:12px}.urlbar{flex:1;display:flex;gap:8px;align-items:center}.urlbar input{flex:1;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)}body.light .urlbar input{background:rgba(0,0,0,.04);border:1px solid rgba(0,0,0,.08)}.webview{height:100%;border:0;width:100%;background:#0c1220;zoom:100%}body.light .webview{background:#f8faff}.files-shell{display:grid;grid-template-columns:260px 1fr;height:100%}.sidebar{border-right:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);padding:10px;overflow:auto}body.light .sidebar{border-right:1px solid rgba(0,0,0,.08);background:rgba(0,0,0,.02)}.side-title{font-weight:800;margin:8px 0}.filetree,.filetree ul{list-style:none;padding-left:16px}.filetree li{margin:4px 0;color:var(--muted)}.filetree li .fname{color:var(--text);cursor:pointer}.editor{display:grid;grid-template-rows:auto 1fr;height:100%}.editor textarea{width:100%;height:100%;background:0 0;color:var(--text);border:0;outline:0;font:600 14px/1.6 var(--font-family)}.list{display:grid;gap:6px}.pill{padding:8px 10px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);cursor:pointer;display:flex;align-items:center;gap:8px}body.light .pill{background:rgba(0,0,0,.04);border:1px solid rgba(0,0,0,.1)}.pill .action{font-size:12px;color:var(--accent);cursor:pointer}.paint-canvas{border-radius:10px;background:#fff;display:block;width:100%;height:calc(100% - 48px);touch-action:none}#calcDisplay{font-size:24px;text-align:right;margin-bottom:10px}#calcButtons{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}.settings-shell{display:grid;grid-template-columns:240px 1fr;height:100%}.settings-sidebar{border-right:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);padding:12px;overflow:auto}body.light .settings-sidebar{border-right:1px solid rgba(0,0,0,.08);background:rgba(0,0,0,.02)}.settings-sidebar .search{position:sticky;top:0;padding-bottom:10px;background:inherit}.settings-sidebar ul{list-style:none;margin:8px 0 0;padding:0;display:grid;gap:6px}.settings-sidebar li{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;cursor:pointer;color:var(--text);transition:background .15s ease,transform .06s ease}.settings-sidebar li:hover{background:var(--glass-2);transform:translateY(-1px)}body.light .settings-sidebar li:hover{background:rgba(0,0,0,.05)}.settings-sidebar li.active{background:linear-gradient(180deg,var(--accent),#6b82ff);color:#0b0f17;font-weight:800;box-shadow:0 6px 16px rgba(138,155,255,.35)}body.light .settings-sidebar li.active{color:#fff;box-shadow:0 6px 16px rgba(74,107,255,.25)}.settings-content{position:relative;padding:16px 20px;overflow:auto}.settings-pane{max-width:760px;display:grid;gap:16px}.settings-pane[hidden]{display:none!important}.section{border-radius:12px;padding:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}body.light .section{background:rgba(0,0,0,.03);border:1px solid rgba(0,0,0,.08)}.settings-h2{margin:0 0 8px;font-weight:900;letter-spacing:.2px}.settings-row{display:flex;align-items:center;justify-content:space-between;gap:12px}.switch{appearance:none;width:46px;height:26px;border-radius:999px;background:rgba(255,255,255,.28);position:relative;cursor:pointer;box-shadow:inset 0 0 0 1px rgba(0,0,0,.15);transition:background .2s,box-shadow .2s}.switch::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.35);transition:transform .2s}.switch:checked{background:linear-gradient(180deg,var(--accent),#6b82ff)}.switch:checked::after{transform:translateX(20px)}body.no-glass *{backdrop-filter:none!important;-webkit-backdrop-filter:none!important}body.no-glass:not(.light) #meowMenu,body.no-glass:not(.light) .app-window,body.no-glass:not(.light) .card,body.no-glass:not(.light) .dialog-card,body.no-glass:not(.light) .dock,body.no-glass:not(.light) .pill,body.no-glass:not(.light) .section,body.no-glass:not(.light) .sidebar,body.no-glass:not(.light) .toolbar,body.no-glass:not(.light) .topbar{background:#0b0f17;border-color:rgba(255,255,255,.1)}body.no-glass.light #meowMenu,body.no-glass.light .app-window,body.no-glass.light .card,body.no-glass.light .dialog-card,body.no-glass.light .dock,body.no-glass.light .pill,body.no-glass.light .section,body.no-glass.light .sidebar,body.no-glass.light .toolbar,body.no-glass.light .topbar{background:#fff;border-color:rgba(0,0,0,.12)}.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}.setting-group{margin-bottom:16px}.emoji{font-family:"Noto Color Emoji","Apple Color Emoji","Segoe UI Emoji",emoji}body.reduce-motion *{transition:none!important;animation:none!important}body.high-contrast :is(.app-window,.topbar,.dock,#meowMenu,.sidebar,.toolbar,.card,.section,.pill,.dialog-card){background:var(--bg)!important;border-color:rgba(255,255,255,.35)!important}body.light.high-contrast :is(.app-window,.topbar,.dock,#meowMenu,.sidebar,.toolbar,.card,.section,.pill,.dialog-card){background:#fff!important;border-color:rgba(0,0,0,.35)!important}#notifCenter{position:absolute;top:60px;right:12px;width:360px;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;box-shadow:var(--shadow);z-index:400;max-height:60vh;overflow:auto;display:grid;gap:8px}#notifCenter .notif{padding:10px 12px;background:var(--glass-2);border:1px solid rgba(255,255,255,.12);border-radius:10px}#spotlight .card{width:min(600px,80vw)}#spotlightResults{margin-top:10px;display:grid;gap:8px}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.resizer{position:absolute;background:0 0;z-index:10}#welcomeText{transition:opacity .5s ease}#welcomeAnim{background:var(--bg);backdrop-filter:blur(20px)}#welcomeAnim .bloom{position:absolute;top:50%;left:50%;width:0;height:0;background:var(--accent);border-radius:50%;opacity:0;animation:bloom 2s ease-out forwards}@keyframes bloom{0%{width:0;height:0;opacity:.5}100%{width:200vw;height:200vw;opacity:0;transform:translate(-50%,-50%)}}.ripple{position:absolute;border-radius:50%;background:radial-gradient(circle, var(--ripple-color) 0%, transparent 70%);transform:scale(0);opacity:1;animation:ripple-anim 0.6s linear;pointer-events:none}@keyframes ripple-anim{to{transform:scale(2.5);opacity:0}}#screensaver-overlay{position:fixed;inset:0;background:#000;z-index:9998;display:none}#recovery .card{width:min(400px,80vw)}.preview-div{width:100%;height:60px;border-radius:8px;margin-bottom:8px;cursor:pointer}.preview-div:hover{opacity:0.8}.settings-body, .settings-content, .window-body { scrollbar-width: none; -ms-overflow-style: none; } .settings-body::-webkit-scrollbar, .settings-content::-webkit-scrollbar, .window-body::-webkit-scrollbar { display: none; }.start-item{display:flex;align-items:center;gap:12px;padding:8px;cursor:pointer;border-radius:8px;background:rgba(255,255,255,.04);transition:background .2s}.start-item:hover{background:var(--glass-2)}.start-emoji{font-size:24px;line-height:1;flex-shrink:0;text-align:center}.start-label{flex:1;font-size:14px}.credits-kyrkat{cursor:pointer;color:var(--accent);text-decoration:underline}.debug-panel{position:fixed;top:20px;right:20px;width:300px;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:16px;box-shadow:var(--shadow);z-index:500;display:none}.debug-panel button{margin:4px 0}.dancing-cat{position:fixed;z-index:1000;font-size:32px;pointer-events:none;animation:dance 2s ease-in-out infinite}.dancing-cat:nth-child(1){top:20%;left:10%;animation-delay:0s}.dancing-cat:nth-child(2){top:40%;right:10%;animation-delay:0.5s}.dancing-cat:nth-child(3){top:60%;left:20%;animation-delay:1s}@keyframes dance{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-10px) rotate(5deg)}75%{transform:translateY(-10px) rotate(-5deg)}}.pixel-cat{position:absolute;z-index:1000;font-size:20px;pointer-events:none;animation:run 3s linear forwards}.pixel-cat::before{content:"🐱";}@keyframes run{0%{transform:translateX(-100px);opacity:0}10%{opacity:1}90%{opacity:1}100%{transform:translateX(110vw);opacity:0}}.firework{position:fixed;z-index:1000;width:10px;height:10px;background:var(--accent);border-radius:50%;pointer-events:none;animation:firework 1s ease-out forwards}@keyframes firework{0%{opacity:1;transform:translateY(0) scale(0)}100%{opacity:0;transform:translateY(-100vh) scale(2)}}.secret-wallpaper{background:linear-gradient(45deg, #ff00ff, #00ffff, #ffff00, #ff0000, #00ff00);background-size:400% 400%;animation:secret-glow 5s ease infinite}@keyframes secret-glow{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}.widget{position:absolute;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;box-shadow:var(--shadow);z-index:100;display:flex;flex-direction:column}.widget .title{font-weight:800;font-size:12px;color:var(--muted);margin-bottom:8px;flex:0 0 auto}.widget .content{font-size:14px;flex:1;overflow:auto}.weather-widget .temp{font-size:18px;font-weight:700}</style><div class="hidden overlay"id=onboarding><div class="card oobe-card"id=ob-step-1><div style=text-align:center><div style=font-size:56px;line-height:1>🐾</div><h1 style="margin:8px 0 12px;font-size:28px;font-weight:600">Welcome to MeowOS</h1></div><p style=text-align:center class=oobe-sub>Thanks for trying this tiny in-browser OS prototype. It's all in one HTML file and stores your stuff in your browser.<p style="text-align:center; font-size:14px; color:var(--muted); margin-top:16px;margin-bottom:24px">MeowOS is provided as is and we are not responsible for any damage to your device. Using MeowOS for illegal actions is not allowed and illegal.<div class=row style=justify-content:flex-end;gap:10px;margin-top:auto><button class="btn secondary"id=obSkip>Skip</button><button class=btn id=obNext>Next</button></div></div><div class="hidden card oobe-card"id=ob-step-2><div style=text-align:center><div style=font-size:56px;line-height:1>👤</div><h1 style="margin:8px 0 12px;font-size:28px;font-weight:600">Create your local account</h1></div><p style=text-align:center class=oobe-sub>Choose a display name. You can change this later in<strong>⚙️ Settings</strong>.</p><input id=obName class=input placeholder="Enter your name"><div class=row style=justify-content:flex-end;gap:10px;margin-top:auto><button class="btn secondary"id=obBack2>Back</button><button class=btn id=obNext2>Next</button></div></div><div class="hidden card oobe-card"id=ob-step-3><div style=text-align:center><div style=font-size:56px;line-height:1>🌗</div><h1 style="margin:8px 0 12px;font-size:28px;font-weight:600">Choose Theme</h1></div><p style=text-align:center class=oobe-sub>Select your preferred theme. You can change this later in<strong>⚙️ Settings</strong>.<div class=oobe-options><label><input type=radio value=dark name=obTheme checked> Dark Theme</label><label><input type=radio value=light name=obTheme> Light Theme</label></div><div class=row style=justify-content:flex-end;gap:10px;margin-top:auto><button class="btn secondary"id=obBack3>Back</button><button class=btn id=obNext3>Next</button></div></div><div class="hidden card oobe-card"id=ob-step-4><div style=text-align:center><div style=font-size:56px;line-height:1>🕒</div><h1 style="margin:8px 0 12px;font-size:28px;font-weight:600">Choose Time Zone</h1></div><p style=text-align:center class=oobe-sub>Select your time zone. You can change this later in<strong>⚙️ Settings</strong>.</p><select id=obTimeZone class=input style=width:100%><option value=UTC>UTC<option value=America/New_York>America/New York<option value=Europe/London>Europe/London<option value=Asia/Tokyo>Asia/Tokyo<option value=Australia/Sydney>Australia/Sydney<option value=Asia/Shanghai>Asia/Shanghai</select><div class=row style=justify-content:flex-end;gap:10px;margin-top:auto><button class="btn secondary"id=obBack4>Back</button><button class=btn id=obFinish>Finish Setup</button></div></div></div><div class="hidden overlay"id=loading><div class="card oobe-card"><div style=text-align:center><div style="font-size:56px;line-height:1;animation:spin 1s linear infinite">🔄</div><h1 style="margin:8px 0 12px;font-size:28px;font-weight:600">Loading and Setting Up</h1></div><p style=text-align:center;color:var(--muted)>Please wait...</div></div><div class=hidden id=desktop><div class=topbar><div class="emoji hello"id=hello>😺 Hi!</div><div class=clock id=clock>--:--</div></div><div class=hidden id=meowMenu><div><div class=meow-head><div class=avatar>😺</div><div style=font-weight:800 id=meowUser>Meow</div><div style=margin-left:auto;color:var(--muted);font-size:12px>Meow</div></div><div class=meow-section-title style=margin-top:10px id=pinnedTitle>Pinned</div><div class=meow-grid id=meowPinned></div><div class=meow-section-title style=margin-top:10px id=allTitle>All apps</div><div class=meow-grid id=meowAll></div><div class=meow-section-title style=margin-top:10px id=recentsTitle>Recent files</div><div class=meow-recents id=meowRecents></div></div></div><div class="hidden app-window"id=win-notes style=left:6vw;top:9vh data-app=notes><div class=window-header><div class=win-emoji draggable=true>🗒️</div><div class=win-title>Notes</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class=window-body style=display:flex;flex-direction:column><div class=toolbar><button class="btn secondary" id=notesBold title=Bold><strong>B</strong></button><button class="btn secondary" id=notesItalic title=Italic><em>I</em></button><button class="btn secondary" id=notesUnderline title=Underline><u>U</u></button></div><div style=flex:1;position:relative><div id=notesPlaceholder style=position:absolute;top:12px;left:12px;color:var(--muted);pointer-events:none;z-index:1>Write your notes here… (auto-saves)</div><div id=notesText contenteditable=true style=height:100%;padding:12px;overflow:auto;outline:none></div></div></div></div><div class="hidden app-window"id=win-calendar style=left:22vw;top:12vh;width:620px data-app=calendar><div class=window-header><div class=win-emoji draggable=true>📅</div><div class=win-title id=calTitle>Calendar</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body cal-wrap"><div class=cal-controls><button class="btn secondary"id=calPrev>◀</button><div style=font-weight:800 id=calMonth></div><button class="btn secondary"id=calNext>▶</button></div><div class=cal-head><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div></div><div class=cal-grid id=calGrid></div></div></div><div class="hidden app-window"id=win-browser style=left:12vw;top:18vh;width:820px;height:520px data-app=browser><div class=window-header><div class=win-emoji draggable=true>🌐</div><div class=win-title>Web Browser</div><div class=window-actions style=flex:1;justify-content:flex-end><div class=toolbar style=margin-right:auto><button class="btn secondary"id=back title=Back>⟵</button><button class="btn secondary"id=forward title=Forward>⟶</button><button class="btn secondary"id=reload title=Reload>⟳</button><div class=urlbar><input id=url placeholder="Enter a URL or search (e.g. cats)"><button class=btn id=go>Go</button></div><button class="btn secondary"id=openExt title="Open original in new tab">↗</button><button class="btn secondary"id=zoomOut>-</button><span id=zoomLevel>100%</span><button class="btn secondary"id=zoomIn>+</button></div><div style=width:8px></div><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class=window-body><div style=width:100%;height:100%;display:none;overflow:auto id=embedContainer></div><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"class=webview id=webview referrerpolicy=no-referrer title=webview></iframe></div></div><div class="hidden app-window"id=win-files style=left:38vw;top:10vh;width:860px;height:520px data-app=files><div class=window-header><div class=win-emoji draggable=true>📁</div><div class=win-title>Files</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body files-shell"><div class=sidebar><hr style="border-color:rgba(255,255,255,.1);margin:10px 0"><div class="emoji side-title">📄 Created Files</div><div class=row style=margin-bottom:8px><input id=newFileName class=input placeholder=new-file.txt><button class=btn id=createFile>Create</button></div><div class=list id=createdList></div></div><div class=editor><div class=toolbar><div class=emoji id=currentFileIcon>📄</div><div style=font-weight:800;flex:1 id=currentFileName>No file open</div><button class="btn secondary"id=downloadFile>Download</button><button class=btn id=saveFile>Save</button></div><div class=viewer id=viewerWrap><div class=media-view id=mediaViewer></div></div><textarea id=editorArea placeholder="Open or create a text file to edit…"></textarea></div></div></div><div class="hidden app-window"id=win-recorder style=left:20vw;top:18vh;width:500px;height:280px data-app=recorder><div class=window-header><div class=win-emoji draggable=true>🎙️</div><div class=win-title>Recorder</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body pad"style=display:flex;flex-direction:column;gap:10px><div style=display:flex;gap:8px;align-items:center><button class=btn id=recStart>Record</button><button class="btn secondary"id=recStop disabled>Stop</button><div style=color:var(--muted) id=recState>Idle</div></div><div style=display:grid;gap:8px id=recList></div></div></div><div class="hidden app-window"id=win-paint style=left:30vw;top:16vh;width:700px;height:520px data-app=paint><div class=window-header><div class=win-emoji draggable=true>🎨</div><div class=win-title>Paint</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body pad"style=display:flex;flex-direction:column;gap:8px><div style=display:flex;gap:8px><input id=brushSize type=range value=6 max=40 min=1> <input id=brushColor type=color value=#000000><button class=btn id=clearPaint>Clear</button><button class=btn id=savePaint>Save</button></div><canvas class=paint-canvas id=paintCanvas></canvas></div></div><div class="hidden app-window"id=win-calculator style=left:15vw;top:15vh;width:400px;height:500px data-app=calculator><div class=window-header><div class=win-emoji draggable=true>🧮</div><div class=win-title>Calculator</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body pad"style=display:flex;flex-direction:column><input id=calcDisplay class=input readonly style=font-size:24px;text-align:right;margin-bottom:10px><div style=display:grid;grid-template-columns:repeat(4,1fr);gap:8px id=calcButtons></div></div></div><div class="hidden app-window"id=win-clock style=left:40vw;top:10vh;width:400px;height:500px data-app=clock><div class=window-header><div class=win-emoji draggable=true>🕐</div><div class=win-title>Clock</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body pad" style=display:flex;flex-direction:column;gap:10px><div style=display:flex;gap:8px;border-bottom:1px solid rgba(255,255,255,.08)><button class="btn secondary active" data-tab=alarm>Alarms</button><button class="btn secondary" data-tab=stopwatch>Stopwatch</button><button class="btn secondary" data-tab=timer>Timer</button></div><div id=clockTabs style=flex:1;overflow:auto><div data-tab-content=alarm><div id=alarmList style=display:grid;gap:8px></div><div style=display:flex;gap:8px><input id=alarmInput type=number placeholder="Minutes"><button class=btn id=addAlarm>Add Alarm</button></div></div><div data-tab-content=stopwatch style=display:none><div id=stopwatchDisplay style=font-size:32px;text-align:center;font-weight:bold;margin:20px 0>00:00:00</div><div style=display:flex;justify-content:center;gap:10px><button class=btn id=swStart>Start</button><button class=btn id=swStop>Stop</button><button class=btn id=swReset>Reset</button></div></div><div data-tab-content=timer style=display:none><div id=timerDisplay style=font-size:32px;text-align:center;font-weight:bold;margin:20px 0>00:00</div><div style=display:flex;justify-content:center;gap:10px><input id=timerInput type=number placeholder="Minutes" style=width:100px><button class=btn id=timerStart>Start</button><button class=btn id=timerStop>Stop</button></div></div></div></div></div><div class="hidden app-window"id=win-settings style=left:26vw;top:14vh;width:700px data-app=settings><div class=window-header><div class=win-emoji draggable=true>⚙️</div><div class=win-title>Settings</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body settings-body"><div class=settings-shell><aside class=settings-sidebar><div class=search><input id=settingsSearch class=input placeholder="Search Settings"></div><ul id=settingsCats><li data-cat=profile class=active>👤 Profile<li data-cat=appearance>🎨 Appearance<li data-cat=accessibility>♿ Accessibility<li data-cat=meowmenu>🐾 Meow Menu<li data-cat=wallpapers>🖼️ Wallpapers<li data-cat=desktop>🖥 Desktop & Dock<li data-cat=browser>🌐 Browser<li data-cat=apps>📦 Apps<li data-cat=system>⚙️ System<li data-cat=credits>📝 Credits</ul></aside><section class=settings-content><div class=settings-pane data-pane=profile><h2 class=settings-h2>Profile</h2><div class=section><label for=setName>Display name</label><input id=setName class=input placeholder="Your name"><div style=height:8px></div><button class=btn id=applyName>Update Name</button></div></div><div class=settings-pane data-pane=appearance hidden><h2 class=settings-h2>Appearance</h2><div class="section settings-row"><h3 class=emoji style=margin:0>🌗 Theme</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=lightTheme type=checkbox class=switch><span>Light Theme</span></label></div><div class="section settings-row"><h3 class=emoji style=margin:0>🎨 Accent Color</h3><input id=accentColor type=color value=#8a9bff></div><div class="section settings-row"><h3 class=emoji style=margin:0>🌓 High Contrast</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=highContrast type=checkbox class=switch><span>Stronger borders & surfaces</span></label></div><div class="section settings-row"><h3 class=emoji style=margin:0>💤 Screensaver</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=screensaverEnable type=checkbox class=switch><span>Enable</span></label></div><div class=section><h3 class=emoji style="margin:0 0 8px">⏱️ Screensaver Timeout (minutes)</h3><input id=screensaverTimeout type=number class=input max=60 min=1 value=5></div></div><div class=settings-pane data-pane=accessibility hidden><h2 class=settings-h2>Accessibility</h2><div class=section><h3 class=emoji style="margin:0 0 8px">🔤 Text Size</h3><input id=textScale type=range value=1 max=1.5 min=0.8 step=0.1><div style=text-align:center;color:var(--muted) id=scaleValue>1.0x</div></div><div class="section settings-row"><h3 class=emoji style=margin:0>🧊 Reduce transparency</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=reduceTransparency type=checkbox class=switch><span>Disable blur & glass</span></label></div><div class=section><h3 class=emoji style="margin:0 0 8px">🔍 Blur Intensity</h3><input id=blurIntensity type=range value=10 max=20 min=0 step=2><div style=text-align:center;color:var(--muted) id=blurValue>10px</div></div><div class="section settings-row"><h3 class=emoji style=margin:0>🌀 Reduce Motion</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=reduceMotion type=checkbox class=switch><span>Disable animations</span></label></div></div><div class=settings-pane data-pane=meowmenu hidden><h2 class=settings-h2>Meow Menu</h2><div class="section settings-row"><h3 class=emoji style=margin:0>📌 Show Pinned</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=showPinned type=checkbox class=switch checked><span>Enable pinned apps section</span></label></div><div class="section settings-row"><h3 class=emoji style=margin:0>📱 Show All Apps</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=showAll type=checkbox class=switch checked><span>Enable all apps section</span></label></div><div class="section settings-row"><h3 class=emoji style=margin:0>📄 Show Recent Files</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=showRecents type=checkbox class=switch checked><span>Enable recent files section</span></label></div><div class=section><h3 class=emoji style="margin:0 0 8px">📐 Icon Size</h3><input id=meowIconSize type=range value=92 max=120 min=64 step=4><div style=text-align:center;color:var(--muted) id=iconSizeValue>92px</div></div></div><div class=settings-pane data-pane=wallpapers hidden><h2 class=settings-h2>Wallpapers</h2><div class=section><h3 class=emoji style="margin:0 0 8px">🖼️ Default Wallpapers</h3><div id=defaultPreviews class=grid></div></div><div class=section><h3 class=emoji style="margin:0 0 8px">📤 Upload from Device</h3><input id=wallUpload type=file accept=image/*></div><div class=section><h3 class=emoji style="margin:0 0 8px">📁 From Files</h3><div id=fileWallList class=list></div></div></div><div class=settings-pane data-pane=desktop hidden><h2 class=settings-h2>Desktop & Dock</h2><div class="section settings-row"><h3 class=emoji style=margin:0>🕒 24-hour Clock</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=clock24h type=checkbox class=switch><span>Use 24-hour format</span></label></div><div class="section settings-row"><h3 class=emoji style=margin:0>🌍 Time Zone</h3><select id=timeZone><option value=UTC>UTC<option value=America/New_York>America/New York<option value=Europe/London>Europe/London<option value=Asia/Tokyo>Asia/Tokyo<option value=Australia/Sydney>Australia/Sydney<option value=Asia/Shanghai>Asia/Shanghai</select></div><div class="section settings-row"><h3 class=emoji style=margin:0>🛞 Dock Position</h3><select id=dockPos><option value=bottom>Bottom<option value=left>Left</select></div><div class=section><h3 class=emoji style="margin:0 0 8px">🗓️ Widgets</h3><div class=settings-row><h4>Clock Widget</h4><label style=display:flex;align-items:center;gap:10px><input id=clockWidget type=checkbox class=switch><span>Enable</span></label></div><div class=settings-row><h4>Calendar Widget</h4><label style=display:flex;align-items:center;gap:10px><input id=calendarWidget type=checkbox class=switch><span>Enable</span></label></div><div class=settings-row><h4>Weather Widget</h4><label style=display:flex;align-items:center;gap:10px><input id=weatherWidget type=checkbox class=switch><span>Enable</span></label></div><div class=settings-row><h4>Random Wikipedia</h4><label style=display:flex;align-items:center;gap:10px><input id=randomWidget type=checkbox class=switch><span>Enable</span></label></div></div></div><div class=settings-pane data-pane=browser hidden><h2 class=settings-h2>Browser</h2><div class="section settings-row"><h3 class=emoji style=margin:0>🔎 Search Engine</h3><select id=searchEngine><option value=ddg>DuckDuckGo<option value=google>Google<option value=bing>Bing<option value=brave>Brave<option value=wikipedia selected>Wikipedia</select></div><div class=section><h3 class=emoji style="margin:0 0 8px">🏠 Home Page</h3><div class=row><input id=homePage class=input placeholder=https://en.wikipedia.org value="https://en.wikipedia.org"><button class=btn id=applyHome>Set Home</button></div></div><div class="section settings-row"><h3 class=emoji style=margin:0>🧰 Proxy Mode</h3><select id=proxyMode title="Use reader proxy for sites that block iframes"><option value=auto>Auto (only when blocked)<option value=always>Always use reader proxy<option value=off>Off (try embedding directly)</select></div><div class="section settings-row"><h3 class=emoji style=margin:0>🚫 Block Popups</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=blockPopups type=checkbox class=switch><span>Prevent new tabs from sites</span></label></div><div class=section><button class="btn secondary"id=clearHistory>Clear Browsing History</button><div style=color:var(--muted);font-size:13px;margin-top:6px>Sites that block iframes are auto-viewed via a safe readable proxy in Auto/Always modes. Use ↗ to open the original.</div></div></div><div class=settings-pane data-pane=apps hidden><h2 class=settings-h2>Installed Apps</h2><div class="section settings-row"><h3 class=emoji style=margin:0>🔓 Sandbox</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=appNoSandbox type=checkbox class=switch><span>Disable for apps & .maf files</span></label></div><div class=section id=installedAppsList></div></div><div class=settings-pane data-pane=system hidden><h2 class=settings-h2>System</h2><div class=section><h3 class=emoji style="margin:0 0 8px">🐱 About MeowOS</h3><div style=display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center><div style=text-align:center><div style=font-size:56px;line-height:1>🐈</div><div style=font-size:36px;font-weight:900;margin-top:8px>MeowOS</div><div style=font-size:14px;color:var(--muted);margin-top:6px>Siamese</div></div><div style=color:var(--muted);text-align:center;max-width:420px>MeowOS is a tiny in-browser operating system prototype. It stores files locally and demonstrates apps — Notes, Calendar, Files, Browser, Paint, Recorder, Calculator, Clock, Settings.</div></div></div><div class=section><h3 class=emoji style="margin:0 0 8px">🧹 Maintenance</h3><button class="btn secondary"id=factoryReset>Factory Reset (clear MeowOS local data)</button><button class="btn secondary"id=recoveryBtn>Recovery Mode</button></div><div class=section><h3 class=emoji style="margin:0 0 8px">🗂️ Backup & Restore</h3><div class=row><button class=btn id=exportConfig>Export Settings</button><label style=display:inline-block;cursor:pointer class="btn secondary">Import Settings <input id=importConfig type=file accept=application/json style=display:none></label></div></div></div><div class=settings-pane data-pane=credits hidden><h2 class=settings-h2>Credits</h2><div class=section><h3 class=emoji style="margin:0 0 8px">📝 Credits</h3><div style="color: var(--text); text-align: left; white-space: pre-wrap; background: rgba(255,255,255,.04); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,.08);">Credits:
Creation idea:<span class="credits-kyrkat">KyrKat</span>
inspiration:macOS and AnuraOS
Basic development:ChatGPT
UI and UX:ChatGPT nad Grok and KyrKat
Enhanced Development:Grok and ChatGPT
Features Ideas:ChatGPT and KyrKat and VladKing014 (Nickname)
Beta Tests:KyrKat and VladKing014
</div></div></section></div></div></div><div class="hidden app-window"id=win-appinstaller style=left:15vw;top:20vh;width:500px;height:400px data-app=appinstaller><div class=window-header><div class=win-emoji draggable=true>📦</div><div class=win-title>App Installer</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body pad"style=display:flex;flex-direction:column;gap:10px><input id=appName class=input placeholder="App Name"> <input id=appEmoji class=input placeholder="Emoji Icon (e.g. 🚀)"maxlength=2><textarea id=appHtml placeholder="Paste HTML code here"class=input style=height:100px></textarea><button class="btn secondary" id=chooseFile>Choose File</button><button class=btn id=addApp>Add App</button></div></div><div class="hidden app-window"id=win-cat style="left:50vw;top:30vh;width:300px;height:200px;" data-app=cat><div class=window-header><div class=win-emoji>🐾</div><div class=win-title>Cat Growth</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body pad"id=catBody style=display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center></div></div><div class=dock id=dock></div><div class=hidden id=contextMenu><div class=context-item id=removeShortcut>Remove</div></div><div class=hidden id=fileContextMenu><div class=context-item data-action=rename>Rename</div><div class=context-item data-action=delete>Delete</div></div><div class="hidden dialog-overlay"id=dialogTemplate><div class=dialog-card><h3 id=dialogTitle></h3><div id=dialogMessage></div><div class=dialog-buttons><button class="btn secondary" id="dialogCancel">Cancel</button><button class=btn id="dialogConfirm">Confirm</button></div></div></div><div class=hidden id=notifCenter><div id=notifsList></div></div><div class="hidden overlay"id=spotlight><div class=card><input id=spotlightInput class=input placeholder="Search apps or /meowai query"><div id=spotlightResults></div></div></div><div id=screensaver-overlay></div><div class="hidden overlay"id=recovery><div class=card><h1>Recovery Mode</h1><button class=btn id=recReset>Factory Reset</button><button class="btn secondary"id=recNoAnim>Disable Animations</button><button class="btn secondary"id=recNoGlass>Disable Glass Effects</button><button class="btn secondary"id=recBack>Back</button></div></div><div class="debug-panel"id=debugPanel><h3>KyrKat Menu 🐱</h3><div style=display:flex;gap:4px><input id=debugChaosDuration type=number class=input placeholder="Duration (s)" style=width:80px value=4><button class=btn id=debugSpawnMeowTest>Activate MeowTest Chaos</button></div><button class=btn id=debugFullscreen>Toggle Fullscreen</button><button class=btn id=debugNoSandbox>Toggle No Sandbox</button><div style=display:flex;gap:4px><input id=debugNotifText class=input placeholder="Enter notification text" style=width:180px><button class=btn id=debugShowNotif>Show Notification</button></div><div style=display:flex;gap:4px><input id=debugCatDays type=number class=input placeholder="Days" style=width:80px><button class=btn id=debugSetCatAge>Set Cat Age</button></div><button class=btn id=debugFireworks>Spawn Fireworks</button><button class=btn id=debugClose>Close</button></div></div><script>const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const store = {
      get(k, def=null){ try { const v = localStorage.getItem(k); return v==null? def : JSON.parse(v); } catch { return def; } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
      del(k){ localStorage.removeItem(k); }
    };

    const K = {
      setup: 'meowos_setup',
      name: 'meowos_name',
      notes: 'meowos_notes',
      files: 'meowos_files',
      wallpaper: 'meowos_wallpaper',
      clock24: 'meowos_clock24',
      accent: 'meowos_accent',
      scale: 'meowos_scale',
      dock: 'meowos_dockpos',
      theme: 'meowos_theme',
      pinned: 'meowos_pinned',
      shortcuts: 'meowos_shortcuts',
      blur: 'meowos_blur',
      reduce: 'meowos_reduce',
      search: 'meowos_search',
      home: 'meowos_home',
      proxy: 'meowos_proxy',
      blockPopups: 'meowos_blockpopups',
      reduceMotion: 'meowos_reduce_motion',
      highContrast: 'meowos_high_contrast',
      customApps: 'meowos_customapps',
      clockWidget: 'meowos_clockwidget',
      calendarWidget: 'meowos_calendarwidget',
      weatherWidget: 'meowos_weatherwidget',
      randomWidget: 'meowos_randomwidget',
      weatherCity: 'meowos_weathercity',
      tz: 'meowos_tz',
      screensaverEnable: 'meowos_screensaver_enable',
      screensaverTimeout: 'meowos_screensaver_timeout',
      fontFamily: 'meowos_fontfamily',
      defaultWall: 'meowos_defaultwall',
      alarms: 'meowos_alarms',
      cat: 'meowos_cat',
      showPinned: 'meowos_show_pinned',
      showAll: 'meowos_show_all',
      showRecents: 'meowos_show_recents',
      meowIconSize: 'meowos_meow_icon_size',
      debugUnlocked: 'meowos_debug_unlocked',
      secretWallpaper: 'meowos_secret_wallpaper',
      noSandbox: 'meowos_no_sandbox',
      appNoSandbox: 'meowos_app_no_sandbox'
    };

    const apps = ['notes', 'calendar', 'browser', 'files', 'recorder', 'paint', 'calculator', 'clock', 'settings', 'appinstaller'];

    function getEmoji(app) {
      const map = {notes: '🗒️', calendar: '📅', browser: '🌐', files: '📁', recorder: '🎙️', paint: '🎨', calculator: '🧮', clock: '🕐', settings: '⚙️', appinstaller: '📦', cat: '🐱'};
      if (app.startsWith('custom_')) {
        const customs = store.get(K.customApps, []);
        const c = customs.find(c => c.id === app.slice(7));
        return c ? c.emoji : '❓';
      }
      return map[app] || '❓';
    }
    function getLabel(app) {
      if (app.startsWith('custom_')) {
        const customs = store.get(K.customApps, []);
        const c = customs.find(c => c.id === app.slice(7));
        return c ? c.name : 'Unknown';
      }
      return app.charAt(0).toUpperCase() + app.slice(1);
    }

    let zTop = 10;
    let dragElement = null, dragOffsetX = 0, dragOffsetY = 0;

    let clockWidget = null;
    let calendarWidget = null;
    let weatherWidget = null;
    let randomWidget = null;

    let lastMidnight = null;

    let idleTimer;
    let catInterval;

    let startClickCount = 0;
    let startClickTimer = 0;

    // Easter Egg: Konami Code
    const konamiCode = [38,38,40,40,37,39,37,39,66,65]; // ↑↑↓↓←→←→BA
    let konamiIndex = 0;
    function initKonami() {
      document.addEventListener('keydown', (e) => {
        if ($('#onboarding').classList.contains('hidden') && !$('#spotlight').classList.contains('hidden') === false) {
          if (e.keyCode === konamiCode[konamiIndex]) {
            konamiIndex++;
            if (konamiIndex === konamiCode.length) {
              konamiIndex = 0;
              // Spawn pixel cats running across the screen
              for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                  const cat = document.createElement('div');
                  cat.className = 'pixel-cat';
                  cat.style.top = (20 + Math.random() * 60) + '%';
                  cat.style.animationDelay = Math.random() * 0.5 + 's';
                  document.body.appendChild(cat);
                  setTimeout(() => cat.remove(), 3000);
                }, i * 200);
              }
              flash('Konami Code activated! 🐱 Running cats!');
            }
          } else {
            konamiIndex = 0;
          }
        }
      });
    }

    function checkAlarms() {
      const nowStr = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', hour12: false});
      let alarms = store.get(K.alarms, []);
      const ringing = alarms.filter(a => a.time === nowStr);
      if (ringing.length) {
        showCustomAlert('Alarm', 'Alarm ringing!');
        alarms = alarms.filter(a => a.time !== nowStr);
        store.set(K.alarms, alarms);
      }
    }

    function resetIdleTimer() {
      clearTimeout(idleTimer);
      $('#screensaver-overlay').style.display = 'none';
      if (store.get(K.screensaverEnable, false)) {
        const timeout = store.get(K.screensaverTimeout, 5) * 60000;
        idleTimer = setTimeout(() => {
          $('#screensaver-overlay').style.display = 'block';
        }, timeout);
      }
    }

    function applyBackground() {
      const wp = store.get(K.wallpaper);
      if (wp) {
        document.body.style.backgroundImage = `url(${wp})`;
        document.body.style.backgroundSize = 'cover';
      } else {
        const def = store.get(K.defaultWall, 'cat-orange');
        let grad1 = '--dark-grad1', grad2 = '--dark-grad2';
        if (document.body.classList.contains('light')) {
          grad1 = '--light-grad1';
          grad2 = '--light-grad2';
        }
        let bg = '';
        if (def === 'default') {
          bg = `radial-gradient(80vw 80vh at 10% 15%,var(${grad1}),transparent 60%),radial-gradient(80vw 80vh at 90% 85%,var(${grad2}),transparent 60%)`;
        } else if (def === 'blue') {
          bg = 'linear-gradient(to bottom, #00008b, #87ceeb)';
        } else if (def === 'green') {
          bg = 'linear-gradient(to bottom, #006400, #90ee90)';
        } else if (def === 'red') {
          bg = 'linear-gradient(to bottom, #8b0000, #ff7f7f)';
        } else if (def === 'purple') {
          bg = 'linear-gradient(to bottom, #4b0082, #dda0dd)';
        } else if (def === 'orange') {
          bg = 'linear-gradient(to bottom, #ff4500, #ffd700)';
        } else if (def === 'pink') {
          bg = 'linear-gradient(to bottom, #ff1493, #ffc0cb)';
        } else if (def === 'teal') {
          bg = 'linear-gradient(to bottom, #008080, #00bfff)';
        } else if (def === 'lavender') {
          bg = 'linear-gradient(to bottom, #e6e6fa, #9370db)';
        } else if (def === 'gray') {
          bg = 'linear-gradient(to bottom, #a9a9a9, #696969)';
        } else if (def === 'yellow') {
          bg = 'linear-gradient(to bottom, #ffff00, #ffd700)';
        } else if (def === 'cyan') {
          bg = 'linear-gradient(to bottom, #00ffff, #008b8b)';
        } else if (def === 'magenta') {
          bg = 'linear-gradient(to bottom, #ff00ff, #da70d6)';
        } else if (def === 'black') {
          bg = 'linear-gradient(to bottom, #000000, #333333)';
        } else if (def === 'cat-orange') {
          bg = 'radial-gradient(circle at 20% 80%, #cc7a00, #cc5500, #cc6600)';
        } else if (def === 'secret') {
          document.body.classList.add('secret-wallpaper');
          return;
        }
        document.body.style.backgroundImage = bg;
      }
    }

    function showDesktop(){
      $('#onboarding').classList.add('hidden');
      $('#loading').classList.add('hidden');
      $('#desktop').classList.remove('hidden');
      const name = store.get(K.name, 'Friend');
      $('#hello').textContent = `😺 Welcome, ${name}!`;
      $('#meowUser').textContent = name;

      const clock = $('#clock');
      const tz = store.get(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
      const update = ()=>{
        const d = new Date();
        const opts = {hour:'2-digit', minute:'2-digit', timeZone: tz};
        if(store.get(K.clock24, false)) opts.hourCycle = 'h23';
        clock.textContent = d.toLocaleTimeString([], opts);

        const timeStr = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hourCycle: 'h23', timeZone: tz});
        const currentDate = d.toLocaleString([], {timeZone: tz, year:'numeric', month:'numeric', day:'numeric'});
        if (timeStr === '00:00' && lastMidnight !== currentDate) {
          flash('🐱💤');
          lastMidnight = currentDate;
        }
      };
      update(); setInterval(update, 1000*30);

      setInterval(checkAlarms, 60000);
      checkAlarms();

      if(store.get(K.theme, 'dark') === 'light') document.body.classList.add('light');

      const scale = store.get(K.scale, 1);
      document.documentElement.style.setProperty('--font-scale', scale);

      const font = store.get(K.fontFamily, null);
      if(font) document.documentElement.style.setProperty('--font-family', font);

      const dockPos = store.get(K.dock, 'bottom');
      if(dockPos === 'left') document.body.classList.add('dock-left');

      const accent = store.get(K.accent, '#8a9bff');
      document.documentElement.style.setProperty('--accent', accent);

      const blur = store.get(K.blur, 10);
      document.documentElement.style.setProperty('--blur', `saturate(140%) blur(${blur}px)`);

      document.body.classList.toggle('no-glass', !!store.get(K.reduce, false));

      document.body.classList.toggle('reduce-motion', !!store.get(K.reduceMotion, false));
      document.body.classList.toggle('high-contrast', !!store.get(K.highContrast, false));

      const iconSize = store.get(K.meowIconSize, 92);
      document.documentElement.style.setProperty('--meow-icon-size', iconSize + 'px');

      applyBackground();

      buildMeowMenu();
      renderDock();
      renderShortcuts();

      toggleClockWidget(store.get(K.clockWidget, false));
      toggleCalendarWidget(store.get(K.calendarWidget, false));
      toggleWeatherWidget(store.get(K.weatherWidget, false));
      toggleRandomWidget(store.get(K.randomWidget, false));

      // Edge minimizers
      const leftEdge = document.createElement('div');
      leftEdge.id = 'leftMinEdge';
      leftEdge.style.cssText = 'position:fixed;left:0;top:0;width:20px;height:100vh;z-index:999;cursor:pointer;background:transparent;';
      leftEdge.addEventListener('click', restoreFromEdge.bind(null, 'left'));
      document.body.appendChild(leftEdge);

      const rightEdge = document.createElement('div');
      rightEdge.id = 'rightMinEdge';
      rightEdge.style.cssText = 'position:fixed;right:0;top:0;width:20px;height:100vh;z-index:999;cursor:pointer;background:transparent;';
      rightEdge.addEventListener('click', restoreFromEdge.bind(null, 'right'));
      document.body.appendChild(rightEdge);

      document.addEventListener('mousemove', resetIdleTimer);
      document.addEventListener('keydown', resetIdleTimer);
      document.addEventListener('touchstart', resetIdleTimer);
      resetIdleTimer();

      // Easter Eggs init
      initKonami();
      initDebug();
    }

    function restoreFromEdge(side) {
      const edge = side === 'left' ? $('#leftMinEdge') : $('#rightMinEdge');
      const winId = edge.dataset.minWindow;
      if (!winId) return;
      const win = document.getElementById(winId);
      if (!win) return;
      win.style.display = '';
      const origLeft = win.dataset.origLeft;
      const origTop = win.dataset.origTop;
      const origWidth = win.dataset.origWidth;
      const origHeight = win.dataset.origHeight;
      win.style.left = side === 'left' ? `-${parseFloat(origWidth)}px` : `${window.innerWidth}px`;
      win.style.top = origTop;
      win.style.width = origWidth;
      win.style.height = origHeight;
      win.style.transition = 'left 0.3s ease';
      setTimeout(() => {
        win.style.left = origLeft;
      }, 10);
      setTimeout(() => {
        win.style.transition = '';
        edge.dataset.minWindow = '';
        bringToFront(win);
        dockMarkOpen(win.dataset.app, true);
      }, 300);
    }

    function toggleClockWidget(enable) {
      if (clockWidget) clockWidget.remove();
      if (!enable) return;
      clockWidget = document.createElement('div');
      clockWidget.className = 'widget';
      clockWidget.style.top = '60px';
      clockWidget.style.right = '20px';
      clockWidget.style.width = '120px';
      clockWidget.style.minWidth = '100px';
      clockWidget.style.minHeight = '80px';
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = 'Clock';
      clockWidget.appendChild(title);
      const time = document.createElement('div');
      time.className = 'content';
      time.style.fontSize = '24px';
      time.style.fontWeight = 'bold';
      clockWidget.appendChild(time);
      const updateTime = () => {
        const d = new Date();
        const tz = store.get(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
        const opts = {hour:'2-digit', minute:'2-digit', timeZone: tz};
        if(store.get(K.clock24, false)) opts.hourCycle = 'h23';
        time.textContent = d.toLocaleTimeString([], opts);
      };
      updateTime();
      setInterval(updateTime, 60000);
      $('#desktop').appendChild(clockWidget);
      makeWidgetDraggable(clockWidget);
      addWidgetResizers(clockWidget, 100, 80);
    }

    function toggleCalendarWidget(enable) {
      if (calendarWidget) calendarWidget.remove();
      if (!enable) return;
      calendarWidget = document.createElement('div');
      calendarWidget.className = 'widget';
      calendarWidget.style.top = '200px';
      calendarWidget.style.right = '20px';
      calendarWidget.style.width = '210px';
      calendarWidget.style.minWidth = '180px';
      calendarWidget.style.minHeight = '150px';
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = 'Calendar';
      calendarWidget.appendChild(title);
      const month = document.createElement('div');
      month.style.textAlign = 'center';
      month.style.fontWeight = 'bold';
      calendarWidget.appendChild(month);
      const grid = document.createElement('div');
      grid.style.display = 'grid';
      grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
      grid.style.gap = '2px';
      calendarWidget.appendChild(grid);
      const updateCal = () => {
        const d = new Date();
        const tz = store.get(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
        month.textContent = d.toLocaleString(undefined, {month:'long', year:'numeric', timeZone: tz});
        grid.innerHTML = '';
        ['M','T','W','T','F','S','S'].forEach(day => {
          const dh = document.createElement('div');
          dh.textContent = day;
          dh.style.textAlign = 'center';
          dh.style.color = 'var(--muted)';
          grid.appendChild(dh);
        });
        const first = new Date(d.toLocaleString('en-us', {timeZone: tz, year:'numeric', month:'numeric', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'}));
        first.setDate(1);
        const offset = (first.getDay() + 6) % 7;
        for(let i=0; i<offset; i++) {
          const empty = document.createElement('div');
          grid.appendChild(empty);
        }
        const daysInMonth = new Date(first.getFullYear(), first.getMonth() + 1, 0).getDate();
        const today = new Date();
        for(let day=1; day<=daysInMonth; day++) {
          const dd = document.createElement('div');
          dd.textContent = day;
          dd.style.textAlign = 'center';
          if (day === today.getDate() && first.getMonth() === today.getMonth() && first.getFullYear() === today.getFullYear()) {
            dd.style.background = 'var(--accent)';
            dd.style.color = '#fff';
          }
          dd.style.borderRadius = '50%';
          dd.style.width = '24px';
          dd.style.height = '24px';
          dd.style.lineHeight = '24px';
          dd.style.margin = 'auto';
          grid.appendChild(dd);
        }
        const dateCellsSoFar = offset + daysInMonth;
        const endOffset = 42 - dateCellsSoFar;
        for(let i=0; i<endOffset; i++) {
          const empty = document.createElement('div');
          grid.appendChild(empty);
        }
      };
      updateCal();
      $('#desktop').appendChild(calendarWidget);
      makeWidgetDraggable(calendarWidget);
      addWidgetResizers(calendarWidget, 180, 150);
    }

    function toggleWeatherWidget(enable) {
      if (weatherWidget) weatherWidget.remove();
      if (!enable) return;
      weatherWidget = document.createElement('div');
      weatherWidget.className = 'widget weather-widget';
      weatherWidget.style.top = '340px';
      weatherWidget.style.right = '20px';
      weatherWidget.style.width = '120px';
      weatherWidget.style.minWidth = '100px';
      weatherWidget.style.minHeight = '80px';
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = 'Weather';
      weatherWidget.appendChild(title);
      const content = document.createElement('div');
      content.className = 'content';
      weatherWidget.appendChild(content);
      const city = store.get(K.weatherCity, 'London');
      const updateWeather = async () => {
        const weather = await fetchWeatherFor(city);
        content.innerHTML = `<div class="temp">${weather.split('°C')[0]}°C</div><div style="font-size:12px;color:var(--muted)">${city}</div>`;
      };
      updateWeather();
      setInterval(updateWeather, 600000); // Update every 10 min
      $('#desktop').appendChild(weatherWidget);
      makeWidgetDraggable(weatherWidget);
      addWidgetResizers(weatherWidget, 100, 80);
    }

    function openInBrowser(url) {
      openWindow('browser');
      const input = $('#url');
      input.value = url;
      const event = new KeyboardEvent('keydown', { key: 'Enter', bubbles: true });
      input.dispatchEvent(event);
    }

    function toggleRandomWidget(enable) {
      if (randomWidget) randomWidget.remove();
      if (!enable) return;
      randomWidget = document.createElement('div');
      randomWidget.className = 'widget random-widget';
      randomWidget.style.top = '60px';
      randomWidget.style.left = '20px';
      randomWidget.style.width = '200px';
      randomWidget.style.minWidth = '150px';
      randomWidget.style.minHeight = '100px';
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = 'Random Wiki';
      randomWidget.appendChild(title);
      const content = document.createElement('div');
      content.className = 'content';
      content.style.cursor = 'pointer';
      randomWidget.appendChild(content);
      const updateRandom = async () => {
        try {
          const randRes = await fetch('https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&list=random&rnnamespace=0&rnlimit=1');
          const randData = await randRes.json();
          const randTitle = randData.query.random[0].title;
          const extractRes = await fetch(`https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=extracts&exintro&explaintext&redirects=1&titles=${encodeURIComponent(randTitle)}`);
          const extractData = await extractRes.json();
          const pages = extractData.query.pages;
          const page = Object.values(pages)[0];
          if (page.missing) {
            content.innerHTML = 'No article found.';
            return;
          }
          const summary = page.extract ? page.extract.split('.')[0] + '.' : 'No summary available.';
          content.innerHTML = `<div style="font-weight:bold; margin-bottom:4px;">${randTitle}</div><div style="font-size:12px;">${summary}</div><div style="font-size:10px; color:var(--muted); margin-top:4px; cursor:pointer;" onclick="openInBrowser('https://en.wikipedia.org/wiki/${encodeURIComponent(randTitle.replace(/ /g, '_'))}')">Read more</div>`;
        } catch (e) {
          content.textContent = 'Failed to load random article.';
        }
      };
      updateRandom();
      setInterval(updateRandom, 3600000); // Update every hour
      content.addEventListener('click', () => updateRandom());
      $('#desktop').appendChild(randomWidget);
      makeWidgetDraggable(randomWidget);
      addWidgetResizers(randomWidget, 150, 100);
    }

    function makeWidgetDraggable(widget) {
      let dragging = false, sx=0, sy=0, startX=0, startY=0;
      widget.addEventListener('mousedown', e => {
        if (e.target.closest('.resizer')) return;
        if (e.button !== 0) return;
        dragging = true;
        widget.style.cursor = 'grabbing';
        const rect = widget.getBoundingClientRect();
        sx = rect.left; sy = rect.top;
        startX = e.clientX; startY = e.clientY;
        e.preventDefault();
        e.stopPropagation();
      });
      window.addEventListener('mousemove', e => {
        if(!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        widget.style.left = (sx + dx) + 'px';
        widget.style.top = (sy + dy) + 'px';
        widget.style.right = 'auto';
      });
      window.addEventListener('mouseup', () => {
        dragging = false;
        widget.style.cursor = 'default';
      });
    }

    function addWidgetResizers(widget, minW, minH) {
      const directions = [
        {pos: 'top-left', cursor: 'nwse-resize', dx: -1, dy: -1, width:'10px', height:'10px', top:'-5px', left:'-5px'},
        {pos: 'top-right', cursor: 'nesw-resize', dx: 1, dy: -1, width:'10px', height:'10px', top:'-5px', right:'-5px'},
        {pos: 'bottom-left', cursor: 'nesw-resize', dx: -1, dy: 1, width:'10px', height:'10px', bottom:'-5px', left:'-5px'},
        {pos: 'bottom-right', cursor: 'nwse-resize', dx: 1, dy: 1, width:'10px', height:'10px', bottom:'-5px', right:'-5px'},
        {pos: 'top', cursor: 'ns-resize', dx: 0, dy: -1, width:'calc(100% + 10px)', height:'10px', top:'-5px', left:'-5px'},
        {pos: 'bottom', cursor: 'ns-resize', dx: 0, dy: 1, width:'calc(100% + 10px)', height:'10px', bottom:'-5px', left:'-5px'},
        {pos: 'left', cursor: 'ew-resize', dx: -1, dy: 0, width:'10px', height:'calc(100% + 10px)', left:'-5px', top:'-5px'},
        {pos: 'right', cursor: 'ew-resize', dx: 1, dy: 0, width:'10px', height:'calc(100% + 10px)', right:'-5px', top:'-5px'},
      ];
      directions.forEach(dir => {
        const resizer = document.createElement('div');
        resizer.className = `resizer ${dir.pos}`;
        resizer.style.cursor = dir.cursor;
        resizer.style.width = dir.width;
        resizer.style.height = dir.height;
        resizer.style.position = 'absolute';
        resizer.style.userSelect = 'none';
        if (dir.top) resizer.style.top = dir.top;
        if (dir.bottom) resizer.style.bottom = dir.bottom;
        if (dir.left) resizer.style.left = dir.left;
        if (dir.right) resizer.style.right = dir.right;
        widget.appendChild(resizer);
        let resizing = false, startX, startY, startWidth, startHeight, startLeft, startTop;
        resizer.addEventListener('mousedown', e => {
          resizing = true;
          startX = e.clientX;
          startY = e.clientY;
          startWidth = parseInt(getComputedStyle(widget).width, 10);
          startHeight = parseInt(getComputedStyle(widget).height, 10);
          startLeft = widget.getBoundingClientRect().left;
          startTop = widget.getBoundingClientRect().top;
          e.preventDefault();
        });
        window.addEventListener('mousemove', e => {
          if (!resizing) return;
          if (dir.dx !== 0) {
            if (dir.dx === -1) {
              const newWidth = startWidth - (e.clientX - startX);
              if (newWidth > minW) {
                widget.style.width = newWidth + 'px';
                widget.style.left = startLeft + (e.clientX - startX) + 'px';
              }
            } else {
              const newWidth = startWidth + (e.clientX - startX);
              if (newWidth > minW) widget.style.width = newWidth + 'px';
            }
          }
          if (dir.dy !== 0) {
            if (dir.dy === -1) {
              const newHeight = startHeight - (e.clientY - startY);
              if (newHeight > minH) {
                widget.style.height = newHeight + 'px';
                widget.style.top = startTop + (e.clientY - startY) + 'px';
              }
            } else {
              const newHeight = startHeight + (e.clientY - startY);
              if (newHeight > minH) widget.style.height = newHeight + 'px';
            }
          }
        });
        window.addEventListener('mouseup', () => { resizing = false; });
      });
    }

    function startOnboarding(){
      $('#onboarding').classList.remove('hidden');
      $('#ob-step-1').classList.remove('hidden');
      $('#ob-step-2').classList.add('hidden');
      $('#ob-step-3').classList.add('hidden');
      $('#ob-step-4').classList.add('hidden');
      const currentTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      $('#obTimeZone').value = currentTz;
      if(!$('#obTimeZone').querySelector(`option[value="${currentTz}"]`)) {
        const opt = document.createElement('option');
        opt.value = currentTz;
        opt.textContent = currentTz;
        $('#obTimeZone').appendChild(opt);
        $('#obTimeZone').value = currentTz;
      }
    }

    function makeDraggable(win){
      const header = $('.window-header', win);
      let startX=0,startY=0, sx=0, sy=0, dragging=false;

      header.addEventListener('mousedown', (e)=>{
        const tag = e.target.tagName;
        if (['INPUT','TEXTAREA','SELECT','BUTTON','LABEL','A'].includes(tag) || e.target.closest('.toolbar')) return;
        if(e.target.classList.contains('win-btn') || e.target.closest('.win-emoji')) return;
        dragging = true; header.style.cursor='grabbing';
        const rect = win.getBoundingClientRect();
        sx = rect.left; sy = rect.top; startX = e.clientX; startY = e.clientY;
        bringToFront(win);
        e.preventDefault();
      });

      window.addEventListener('mousemove', (e)=>{
        if(!dragging) return;
        const dx = e.clientX - startX; const dy = e.clientY - startY;
        win.style.left = Math.max(6, sx + dx) + 'px';
        win.style.top  = Math.max(6, sy + dy) + 'px';
      });
      window.addEventListener('mouseup', ()=>{ dragging=false; header.style.cursor='grab'; });

      header.addEventListener('dblclick', ()=> toggleMaximize(win));

      win.addEventListener('mousedown', ()=> bringToFront(win));

      const [minBtn, maxBtn, closeBtn] = $$('.win-btn', win);
      if(minBtn) minBtn.addEventListener('click', ()=> minimizeWindow(win));
      if(maxBtn) maxBtn.addEventListener('click', ()=> toggleMaximize(win));
      if(closeBtn) closeBtn.addEventListener('click', ()=> closeWindow(win));

      const emoji = $('.win-emoji', win);
      if (emoji) {
        emoji.addEventListener('dragstart', (e)=>{
          e.dataTransfer.setData('text', JSON.stringify({from:'window', app: win.dataset.app}));
        });
      }
      addResizers(win);
    }

    function addResizers(win) {
      const directions = [
        {pos: 'top-left', cursor: 'nwse-resize', dx: -1, dy: -1, width:'10px', height:'10px', top:'-5px', left:'-5px'},
        {pos: 'top-right', cursor: 'nesw-resize', dx: 1, dy: -1, width:'10px', height:'10px', top:'-5px', right:'-5px'},
        {pos: 'bottom-left', cursor: 'nesw-resize', dx: -1, dy: 1, width:'10px', height:'10px', bottom:'-5px', left:'-5px'},
        {pos: 'bottom-right', cursor: 'nwse-resize', dx: 1, dy: 1, width:'10px', height:'10px', bottom:'-5px', right:'-5px'},
        {pos: 'top', cursor: 'ns-resize', dx: 0, dy: -1, width:'calc(100% + 10px)', height:'10px', top:'-5px', left:'-5px'},
        {pos: 'bottom', cursor: 'ns-resize', dx: 0, dy: 1, width:'calc(100% + 10px)', height:'10px', bottom:'-5px', left:'-5px'},
        {pos: 'left', cursor: 'ew-resize', dx: -1, dy: 0, width:'10px', height:'calc(100% + 10px)', left:'-5px', top:'-5px'},
        {pos: 'right', cursor: 'ew-resize', dx: 1, dy: 0, width:'10px', height:'calc(100% + 10px)', right:'-5px', top:'-5px'},
      ];
      directions.forEach(dir => {
        const resizer = document.createElement('div');
        resizer.className = `resizer ${dir.pos}`;
        resizer.style.cursor = dir.cursor;
        resizer.style.width = dir.width;
        resizer.style.height = dir.height;
        resizer.style.position = 'absolute';
        resizer.style.userSelect = 'none';
        if (dir.top) resizer.style.top = dir.top;
        if (dir.bottom) resizer.style.bottom = dir.bottom;
        if (dir.left) resizer.style.left = dir.left;
        if (dir.right) resizer.style.right = dir.right;
        win.appendChild(resizer);
        let resizing = false, startX, startY, startWidth, startHeight, startLeft, startTop;
        resizer.addEventListener('mousedown', e => {
          resizing = true;
          startX = e.clientX;
          startY = e.clientY;
          startWidth = parseInt(getComputedStyle(win).width, 10);
          startHeight = parseInt(getComputedStyle(win).height, 10);
          startLeft = win.getBoundingClientRect().left;
          startTop = win.getBoundingClientRect().top;
          e.preventDefault();
        });
        window.addEventListener('mousemove', e => {
          if (!resizing) return;
          if (dir.dx !== 0) {
            if (dir.dx === -1) {
              const newWidth = startWidth - (e.clientX - startX);
              if (newWidth > 200) {
                win.style.width = newWidth + 'px';
                win.style.left = startLeft + (e.clientX - startX) + 'px';
              }
            } else {
              const newWidth = startWidth + (e.clientX - startX);
              if (newWidth > 200) win.style.width = newWidth + 'px';
            }
          }
          if (dir.dy !== 0) {
            if (dir.dy === -1) {
              const newHeight = startHeight - (e.clientY - startY);
              if (newHeight > 150) {
                win.style.height = newHeight + 'px';
                win.style.top = startTop + (e.clientY - startY) + 'px';
              }
            } else {
              const newHeight = startHeight + (e.clientY - startY);
              if (newHeight > 150) win.style.height = newHeight + 'px';
            }
          }
        });
        window.addEventListener('mouseup', () => { resizing = false; });
      });
    }
    function bringToFront(win){ win.style.zIndex = ++zTop; dockMarkOpen(win.dataset.app, true); }
    function openWindow(app){ 
      if (app.startsWith('custom_')) {
        openCustom(app.slice(7));
        return;
      }
      if(app === 'cat'){
        showCatWindow();
        return;
      }
      if(app === 'kyrkat'){
        $('#debugPanel').style.display = 'block';
        return;
      }
      const win = $(`#win-${app}`); if(!win) return; win.classList.remove('hidden','minimized'); bringToFront(win); 
    }
    function minimizeWindow(win){
      if(win.dataset.max === '1'){ toggleMaximize(win); }
      win.dataset.origLeft = win.style.left || win.getBoundingClientRect().left + 'px';
      win.dataset.origTop = win.style.top || win.getBoundingClientRect().top + 'px';
      win.dataset.origWidth = win.style.width || win.getBoundingClientRect().width + 'px';
      win.dataset.origHeight = win.style.height || win.getBoundingClientRect().height + 'px';
      const rect = win.getBoundingClientRect();
      const isLeft = rect.left + rect.width / 2 < window.innerWidth / 2;
      const targetLeft = isLeft ? -rect.width : window.innerWidth;
      win.dataset.minSide = isLeft ? 'left' : 'right';
      win.style.transition = 'left 0.3s ease';
      win.style.left = targetLeft + 'px';
      setTimeout(() => {
        win.style.display = 'none';
        win.style.transition = '';
        const edge = isLeft ? $('#leftMinEdge') : $('#rightMinEdge');
        edge.dataset.minWindow = win.id;
        edge.style.background = 'rgba(255,255,255,0.1)';
        setTimeout(() => edge.style.background = 'transparent', 500);
      }, 300);
      dockMarkOpen(win.dataset.app, false);
    }
    function closeWindow(win){ 
      if(win.dataset.app === 'cat'){
        if(catInterval) clearInterval(catInterval);
      }
      const side = win.dataset.minSide;
      if (side) {
        const edge = side === 'left' ? $('#leftMinEdge') : $('#rightMinEdge');
        if (edge.dataset.minWindow === win.id) {
          edge.dataset.minWindow = '';
        }
      }
      win.classList.add('hidden'); dockMarkOpen(win.dataset.app, false); 
    }
    function toggleMaximize(win){
      if(win.dataset.max === '1'){
        win.style.left = win.dataset.x; win.style.top = win.dataset.y; win.style.width = win.dataset.w; win.style.height = win.dataset.h; win.dataset.max = '0';
      } else {
        const rect = win.getBoundingClientRect();
        win.dataset.x = rect.left + 'px'; win.dataset.y = rect.top + 'px'; win.dataset.w = rect.width + 'px'; win.dataset.h = rect.height + 'px';
        win.style.left = '6px'; win.style.top = '6px';
        win.style.width = (window.innerWidth - 12) + 'px';
        win.style.height = (window.innerHeight - 78) + 'px';
        win.dataset.max = '1';
      }
      bringToFront(win);
    }
    function dockMarkOpen(app, isOpen){ const btn = $(`.dock-item[data-open="${app}"]`); if(btn){ btn.classList.toggle('open', isOpen); } }

    function buildMeowMenu() {
      const pinnedPref = store.get(K.pinned, null) ?? null;
      const defaultPins = ['notes','files','browser','settings'];
      if (pinnedPref === null) store.set(K.pinned, defaultPins);

      const pins = store.get(K.pinned, defaultPins);
      const showPinned = store.get(K.showPinned, true);
      const pinWrap = $('#meowPinned'); pinWrap.innerHTML = '';
      $('#pinnedTitle').style.display = showPinned ? 'block' : 'none';
      if (showPinned) {
        pins.forEach(app=>{
          const b = document.createElement('div');
          b.className = 'meow-item'; b.draggable = true;
          b.innerHTML = `<div class="meow-emoji">${getEmoji(app)}</div><div class="meow-label">${getLabel(app)}</div>`;
          b.addEventListener('click', ()=> openWindow(app));
          b.addEventListener('dragstart', e => e.dataTransfer.setData('text', JSON.stringify({from:'meow', app})));
          pinWrap.appendChild(b);
        });
      }

      const showAll = store.get(K.showAll, true);
      const allWrap = $('#meowAll'); allWrap.innerHTML = '';
      $('#allTitle').style.display = showAll ? 'block' : 'none';
      if (showAll) {
        apps.forEach(app=>{
          const b = document.createElement('div');
          b.className = 'meow-item'; b.draggable = true;
          b.innerHTML = `<div class="meow-emoji">${getEmoji(app)}</div><div class="meow-label">${getLabel(app)}</div>`;
          b.addEventListener('click', ()=> openWindow(app));
          b.addEventListener('dragstart', e => e.dataTransfer.setData('text', JSON.stringify({from:'meow', app})));
          allWrap.appendChild(b);
        });

        const customs = store.get(K.customApps, []);
        customs.forEach(c => {
          const b = document.createElement('div');
          b.className = 'meow-item'; b.draggable = true;
          b.innerHTML = `<div class="meow-emoji">${c.emoji}</div><div class="meow-label">${c.name}</div>`;
          b.addEventListener('click', () => openWindow('custom_' + c.id));
          b.addEventListener('dragstart', e => e.dataTransfer.setData('text', JSON.stringify({from: 'meow', app: 'custom_' + c.id})));
          allWrap.appendChild(b);
        });

        // KyrKat Menu if unlocked
        if (store.get(K.debugUnlocked, false)) {
          const kyrkatItem = document.createElement('div');
          kyrkatItem.className = 'meow-item';
          kyrkatItem.innerHTML = `<div class="meow-emoji">🐱</div><div class="meow-label">KyrKat Menu</div>`;
          kyrkatItem.addEventListener('click', () => openWindow('kyrkat'));
          allWrap.appendChild(kyrkatItem);
        }
      }

      const showRecents = store.get(K.showRecents, true);
      const recWrap = $('#meowRecents'); recWrap.innerHTML = '';
      $('#recentsTitle').style.display = showRecents ? 'block' : 'none';
      if (showRecents) {
        const files = loadFilesStore();
        Object.keys(files).slice(-8).reverse().forEach(name=>{
          const entry = files[name];
          const icon = entry.type==='text'?'📄': entry.type==='image'?'🖼️': entry.type==='audio'?'🎵':'🎞️';
          const item = document.createElement('div');
          item.className='recent';
          item.innerHTML = `<div class="icon">${icon}</div><div class="name">${name}</div>`;
          item.addEventListener('click', ()=>{ openWindow('files'); openCreatedFile(name); });
          recWrap.appendChild(item);
        });
      }
    }

    $('#hello').addEventListener('click', () => {
      $('#meowMenu').classList.toggle('hidden');
      const now = Date.now();
      if (startClickCount === 0 || now - startClickTimer > 5000) {
        startClickCount = 1;
        startClickTimer = now;
      } else {
        startClickCount++;
      }
      if (startClickCount >= 5) {
        showCatWindow();
        startClickCount = 0;
      }
    });
    document.addEventListener('click', e => {
      const sm = $('#meowMenu'), hello = $('#hello');
      if(!sm.contains(e.target) && !hello.contains(e.target)) sm.classList.add('hidden');
      const nc = $('#notifCenter'), clock = $('#clock');
      if(!nc.contains(e.target) && !clock.contains(e.target)) nc.classList.add('hidden');
    });

    function renderDock() {
      let pinned = store.get(K.pinned, null);
      if (pinned === null) { pinned = ['notes','files','browser','settings']; store.set(K.pinned, pinned); }
      const dock = $('#dock'); dock.innerHTML = '';
      pinned.forEach(app => {
        const item = document.createElement('button');
        item.className = 'dock-item';
        item.dataset.open = app;
        item.innerHTML = `<div class="dock-emoji">${getEmoji(app)}</div><div class="dock-label">${getLabel(app)}</div><div class="dot"></div>`;
        item.addEventListener('click', () => openWindow(app));
        item.draggable = true;
        item.addEventListener('dragstart', e => e.dataTransfer.setData('text', JSON.stringify({from: 'dock', app})));
        dock.appendChild(item);
      });
    }

    function renderShortcuts() {
      $$('.shortcut').forEach(e => e.remove());
      const shortcuts = store.get(K.shortcuts, []);
      shortcuts.forEach((s, i) => {
        const icon = document.createElement('button');
        icon.className = 'dock-item shortcut';
        icon.style.position = 'absolute';
        icon.style.left = s.x + 'px';
        icon.style.top = s.y + 'px';
        icon.style.minWidth = 'auto';
        icon.dataset.index = i;
        icon.innerHTML = `<div class="dock-emoji">${s.type === 'app' ? getEmoji(s.id) : '📄'}</div><div class="dock-label">${s.type === 'app' ? getLabel(s.id) : s.id}</div>`;
        icon.addEventListener('click', () => { 
          if (s.type === 'app') openWindow(s.id);
          else { openWindow('files'); openCreatedFile(s.id); }
        });
        icon.addEventListener('mousedown', e => {
          dragElement = icon;
          const rect = icon.getBoundingClientRect();
          dragOffsetX = e.clientX - rect.left;
          dragOffsetY = e.clientY - rect.top;
          e.preventDefault();
        });
        icon.addEventListener('contextmenu', e => {
          e.preventDefault(); showContextMenu(e.clientX, e.clientY, icon);
        });
        $('#desktop').appendChild(icon);
      });
    }

    function addShortcut(type, id, x, y) { let shortcuts = store.get(K.shortcuts, []); shortcuts.push({type, id, x, y}); store.set(K.shortcuts, shortcuts); renderShortcuts(); }
    function updateShortcutPosition(i, x, y) { let shortcuts = store.get(K.shortcuts, []); shortcuts[i].x = parseInt(x); shortcuts[i].y = parseInt(y); store.set(K.shortcuts, shortcuts); }
    function removeShortcut(i) { let shortcuts = store.get(K.shortcuts, []); shortcuts.splice(i, 1); store.set(K.shortcuts, shortcuts); renderShortcuts(); }
    function unpinApp(app) { let pinned = store.get(K.pinned, ['notes','files','browser','settings']); pinned = pinned.filter(a => a !== app); store.set(K.pinned, pinned); renderDock(); buildMeowMenu(); }

    function showContextMenu(x, y, target) {
      const menu = $('#contextMenu');
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.classList.remove('hidden');
      $('#removeShortcut').addEventListener('click', () => {
        showCustomConfirm('Remove Shortcut', 'Remove this shortcut?', () => { removeShortcut(target.dataset.index); });
        menu.classList.add('hidden');
      }, {once: true});
    }

    function showFileContext(x, y, name) {
      const menu = $('#fileContextMenu');
      menu.dataset.name = name;
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.classList.remove('hidden');
      $$('.context-item', menu).forEach(item => item.replaceWith(item.cloneNode(true)));
      $$('.context-item', menu).forEach(item => {
        item.addEventListener('click', () => {
          const action = item.dataset.action;
          if (action === 'rename') {
            showCustomPrompt('Rename File', 'New name:', name, newName => {
              if (newName && newName !== name) {
                const files = loadFilesStore();
                if (files[newName]) { showCustomAlert('Error', 'Name exists'); return; }
                files[newName] = files[name];
                delete files[name];
                saveFilesStore(files);
                renderCreatedList();
              }
            });
          } else if (action === 'delete') {
            showCustomConfirm('Delete File', 'Delete ' + name + '?', () => {
              const files = loadFilesStore();
              delete files[name];
              saveFilesStore(files);
              renderCreatedList();
            });
          }
          menu.classList.add('hidden');
        }, {once: true});
      });
    }

    document.addEventListener('click', () => {
      $('#contextMenu').classList.add('hidden');
      $('#fileContextMenu').classList.add('hidden');
    });

    function showCustomConfirm(title, message, onConfirm) {
      const overlay = document.createElement('div');
      overlay.className = 'dialog-overlay';
      const card = document.createElement('div');
      card.className = 'dialog-card';
      card.innerHTML = `<h3>${title}</h3><div id="dialogMessage"></div><div class="dialog-buttons"><button class="btn secondary" id="dialogCancel">Cancel</button><button class="btn" id="dialogConfirm">Confirm</button></div>`;
      overlay.appendChild(card);
      document.body.appendChild(overlay);
      $('#dialogMessage', overlay).innerHTML = message;
      $('#dialogCancel', overlay).addEventListener('click', () => overlay.remove());
      $('#dialogConfirm', overlay).addEventListener('click', () => { onConfirm(); overlay.remove(); });
    }

    function showCustomAlert(title, message) {
      const overlay = document.createElement('div');
      overlay.className = 'dialog-overlay';
      const card = document.createElement('div');
      card.className = 'dialog-card';
      card.innerHTML = `<h3>${title}</h3><div id="dialogMessage"></div><div class="dialog-buttons"><button class="btn" id="dialogOK">OK</button></div>`;
      overlay.appendChild(card);
      document.body.appendChild(overlay);
      $('#dialogMessage', overlay).innerHTML = message;
      $('#dialogOK', overlay).addEventListener('click', () => overlay.remove());
    }

    function showCustomPrompt(title, message, def = '', onConfirm) {
      const overlay = document.createElement('div');
      overlay.className = 'dialog-overlay';
      const card = document.createElement('div');
      card.className = 'dialog-card';
      card.innerHTML = `<h3>${title}</h3><div id="dialogMessage"></div><input class="input" id="promptInput" value="${def}"><div class="dialog-buttons"><button class="btn secondary" id="dialogCancel">Cancel</button><button class="btn" id="dialogConfirm">OK</button></div>`;
      overlay.appendChild(card);
      document.body.appendChild(overlay);
      $('#dialogMessage', overlay).innerHTML = message;
      const input = $('#promptInput', overlay);
      input.focus();
      $('#dialogCancel', overlay).addEventListener('click', () => overlay.remove());
      $('#dialogConfirm', overlay).addEventListener('click', () => { onConfirm(input.value.trim()); overlay.remove(); });
    }

    function showFileSelectDialog(title, items, onSelect) {
      const overlay = document.createElement('div');
      overlay.className = 'dialog-overlay';
      const card = document.createElement('div');
      card.className = 'dialog-card';
      card.innerHTML = `<h3>${title}</h3><div id="fileSelectList" style="max-height:200px; overflow:auto;"></div><div class="dialog-buttons"><button class="btn secondary">Cancel</button></div>`;
      overlay.appendChild(card);
      document.body.appendChild(overlay);
      const list = $('#fileSelectList', overlay);
      items.forEach(item => {
        const div = document.createElement('div');
        div.textContent = item;
        div.style.padding = '8px';
        div.style.cursor = 'pointer';
        div.style.borderRadius = '4px';
        div.addEventListener('click', () => {
          onSelect(item);
          overlay.remove();
        });
        list.appendChild(div);
      });
      $('.btn.secondary', overlay).addEventListener('click', () => overlay.remove());
    }

    function buildTree(paths) {
      function createNode(name) {
        return { name, children: {}, files: [] };
      }
      const root = createNode('root');
      paths.forEach(path => {
        const parts = path.split('/');
        let current = root;
        for (let i = 0; i < parts.length - 1; i++) {
          const part = parts[i];
          if (!current.children[part]) {
            current.children[part] = createNode(part);
          }
          current = current.children[part];
        }
        const fileName = parts[parts.length - 1];
        current.files.push(fileName);
      });
      function renderNode(node, ul) {
        const childNames = Object.keys(node.children).sort();
        const sortedFiles = node.files.sort();
        childNames.forEach(childName => {
          const child = node.children[childName];
          const li = document.createElement('li');
          const dirSpan = document.createElement('span');
          dirSpan.className = 'fname';
          dirSpan.textContent = childName + '/';
          li.appendChild(dirSpan);
          const childUl = document.createElement('ul');
          renderNode(child, childUl);
          li.appendChild(childUl);
          ul.appendChild(li);
        });
        sortedFiles.forEach(file => {
          const li = document.createElement('li');
          const fileSpan = document.createElement('span');
          fileSpan.className = 'fname';
          fileSpan.textContent = file;
          li.appendChild(fileSpan);
          ul.appendChild(li);
        });
      }
      const ul = document.createElement('ul');
      renderNode(root, ul);
      return ul;
    }

    function initNotes(){ 
      const notesDiv = $('#notesText');
      const placeholder = $('#notesPlaceholder');
      notesDiv.innerHTML = store.get(K.notes, '');
      function updatePlaceholder(){
        placeholder.style.display = notesDiv.innerHTML.trim() === '' ? 'block' : 'none';
      }
      updatePlaceholder();
      let t;
      notesDiv.addEventListener('input', ()=>{
        updatePlaceholder();
        clearTimeout(t);
        t=setTimeout(()=> store.set(K.notes, notesDiv.innerHTML), 250);
      });
      notesDiv.addEventListener('focus', ()=> notesDiv.style.outline = 'none');
      function applyFormat(cmd){
        notesDiv.focus();
        document.execCommand(cmd, false, null);
        notesDiv.focus();
      }
      $('#notesBold').addEventListener('click', ()=> applyFormat('bold'));
      $('#notesItalic').addEventListener('click', ()=> applyFormat('italic'));
      $('#notesUnderline').addEventListener('click', ()=> applyFormat('underline'));
    }

    let calDate = new Date();
function renderCalendar(){
  const grid = $('#calGrid'); grid.innerHTML = '';
  const m = calDate.getMonth(), y = calDate.getFullYear();
  $('#calMonth').textContent = calDate.toLocaleString(undefined, {month:'long', year:'numeric'});
  const first = new Date(y, m, 1);
  const startOffset = (first.getDay()+6)%7;
  const daysInMonth = new Date(y, m+1, 0).getDate();
  for(let i=0;i<startOffset;i++) {
    const empty = document.createElement('div');
    empty.className = 'day';
    grid.appendChild(empty);
  }
  const today = new Date();
  for(let d=1; d<=daysInMonth; d++){
    const cell = document.createElement('div'); cell.className='day'; cell.textContent = d;
    if(d===today.getDate() && m===today.getMonth() && y===today.getFullYear()) cell.classList.add('today');
    grid.appendChild(cell);
  }
  const totalSoFar = startOffset + daysInMonth;
  const endOffset = 42 - totalSoFar;
  for(let i=0; i<endOffset; i++) {
    const empty = document.createElement('div');
    empty.className = 'day';
    grid.appendChild(empty);
  }
}

    const BLOCKED_HOSTS = new Set([
      'google.com','www.google.com','accounts.google.com',
      'youtube.com','www.youtube.com','youtu.be',
      'facebook.com','www.facebook.com','instagram.com','www.instagram.com',
      'twitter.com','www.twitter.com','x.com','t.co',
      'linkedin.com','www.linkedin.com','tiktok.com','www.tiktok.com',
      'openai.com','www.openai.com','paypal.com','www.paypal.com',
      'bing.com','www.bing.com','duckduckgo.com','www.duckduckgo.com'
    ]);

    function readerProxy(u){ return 'https://r.jina.ai/http/' + u.replace(/^https?:\/\//i, ' '); }

    function selectEmbedUrl(raw){
      const mode = store.get(K.proxy, 'auto');
      try{
        const url = new URL(raw);
        if(mode === 'always') return readerProxy(url.href);
        if(mode === 'off') return url.href;
        if(BLOCKED_HOSTS.has(url.hostname)) return readerProxy(url.href);
        return url.href;
      }catch{ return raw; }
    }

    const SEARCH_ENGINES = {
      ddg: q => `https://duckduckgo.com/?q=${encodeURIComponent(q)}`,
      google: q => `https://www.google.com/search?q=${encodeURIComponent(q)}`,
      bing: q => `https://www.bing.com/search?q=${encodeURIComponent(q)}`,
      brave: q => `https://search.brave.com/search?q=${encodeURIComponent(q)}`,
      wikipedia: q => `https://en.wikipedia.org/w/index.php?search=${encodeURIComponent(q)}`
    };

    function isLikelyUrl(v){ return /^https?:\/\//i.test(v) || (v.includes('.') && !v.includes(' ')); }

    function normalizeUrl(input){
      const v = (input || '').trim();
      if(!v) return store.get(K.home, 'https://en.wikipedia.org');
      if(isLikelyUrl(v)) return /^https?:\/\//i.test(v) ? v : 'https://' + v;
      const engine = store.get(K.search, 'wikipedia');
      const builder = SEARCH_ENGINES[engine] || SEARCH_ENGINES.wikipedia;
      return builder(v);
    }

    let browserHistory = []; let browserIndex = -1; let browserZoom = 100;

    function applyBrowserSandbox(){
      const frame = $('#webview');
      const noSand = store.get(K.noSandbox, false);
      if (noSand) {
        frame.sandbox = '';
        return;
      }
      const block = store.get(K.blockPopups, true);
      let sandbox = 'allow-same-origin allow-scripts allow-forms';
      if(!block) sandbox += ' allow-popups allow-popups-to-escape-sandbox';
      frame.setAttribute('sandbox', sandbox);
    }

    function initBrowser(){
      const input = $('#url'); const go = $('#go'); const frame = $('#webview');
      const zoomOut = $('#zoomOut'); const zoomIn = $('#zoomIn'); const zoomLevel = $('#zoomLevel');

      applyBrowserSandbox();

      const updateZoom = ()=>{ frame.style.zoom = browserZoom + '%'; zoomLevel.textContent = browserZoom + '%'; };
      zoomOut.addEventListener('click', ()=>{ browserZoom = Math.max(50, browserZoom - 25); updateZoom(); });
      zoomIn.addEventListener('click', ()=>{ browserZoom = Math.min(250, browserZoom + 25); updateZoom(); });

      function isYouTubeUrl(u) {
        try {
          const url = new URL(u);
          if (url.hostname.endsWith('youtube.com') || url.hostname.endsWith('youtu.be')) {
            const v = url.searchParams.get('v') || url.pathname.slice(1);
            if (v) return v;
          }
        } catch {}
        return null;
      }
      function isXUrl(u) {
        try {
          const url = new URL(u);
          if (url.hostname.endsWith('x.com') || url.hostname.endsWith('twitter.com')) {
            const parts = url.pathname.split('/');
            if (parts.length >= 4 && parts[2] === 'status') {
              return parts[3];
            }
          }
        } catch {}
        return null;
      }
      function navigate(raw, push=true){
        const urlRaw = normalizeUrl(raw || input.value);
        let target = selectEmbedUrl(urlRaw);
        const ytId = isYouTubeUrl(urlRaw);
        const xId = isXUrl(urlRaw);
        const embedContainer = $('#embedContainer');
        frame.style.display = 'block';
        embedContainer.style.display = 'none';
        if (ytId) {
          target = `https://www.youtube.com/embed/${ytId}`;
        } else if (xId) {
          frame.style.display = 'none';
          embedContainer.style.display = 'block';
          embedContainer.innerHTML = `
            <blockquote class="twitter-tweet">
              <a href="${urlRaw}"></a>
            </blockquote>
          `;
          if (!document.querySelector('script[src="https://platform.twitter.com/widgets.js"]')) {
            const script = document.createElement('script');
            script.src = 'https://platform.twitter.com/widgets.js';
            script.async = true;
            document.body.appendChild(script);
          } else if (typeof twttr !== 'undefined' && twttr.widgets) {
            twttr.widgets.load(embedContainer);
          }
          if (push){ browserHistory = browserHistory.slice(0, browserIndex+1); browserHistory.push(urlRaw); browserIndex = browserHistory.length - 1; }
          input.value = urlRaw;
          return;
        }
        frame.src = target;
        if(push){ browserHistory = browserHistory.slice(0, browserIndex+1); browserHistory.push(urlRaw); browserIndex = browserHistory.length - 1; }
        input.value = urlRaw;

        let settled = false;
        const t = setTimeout(()=>{
          if(!settled){
            try{
              const doc = frame.contentDocument;
              if(doc && (!doc.body || !doc.body.childElementCount)){
                frame.src = readerProxy(urlRaw);
                flash('Site restricted — showing reader view');
              }
            }catch{}
          }
        }, 1200);

        frame.addEventListener('load', ()=>{ settled = true; clearTimeout(t); const current = browserHistory[browserIndex]; if(current) input.value = current; }, {once:true});
      }

      go.addEventListener('click', ()=> navigate($('#url').value));
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') navigate(input.value); });
      $('#back').addEventListener('click', ()=> { if(browserIndex>0){ browserIndex--; const u = browserHistory[browserIndex]; frame.src = selectEmbedUrl(u); $('#url').value = u; } });
      $('#forward').addEventListener('click', ()=>{ if(browserIndex < browserHistory.length -1){ browserIndex++; const u = browserHistory[browserIndex]; frame.src = selectEmbedUrl(u); $('#url').value = u; } });
      $('#reload').addEventListener('click', ()=> { const u = $('#url').value || browserHistory[browserIndex] || store.get(K.home, 'https://en.wikipedia.org'); frame.src = selectEmbedUrl(u); });
      $('#openExt').addEventListener('click', ()=> { const url = $('#url').value || browserHistory[browserIndex] || store.get(K.home, 'https://en.wikipedia.org'); window.open(url, '_blank'); });

      input.value = store.get(K.home, 'https://en.wikipedia.org'); navigate(input.value, true); updateZoom();
    }

    function loadFilesStore(){ return store.get(K.files, {}); }
    function saveFilesStore(obj){ store.set(K.files, obj); }
    const fileState = { currentName: null, isCreated: false, currentType: 'text' };
    function readAsText(file){ return new Promise((res, rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsText(file); }); }
    function readAsDataURL(file){ return new Promise((res, rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

    function installFromContent(name, content) {
      const lines = content.split('\n');
      let app_name, app_icon, app_developer, app_code = '';
      let inCode = false;
      let codeLines = [];
      for (let line of lines) {
        line = line.trim();
        if (!inCode) {
          if (line === 'app_code:') {
            inCode = true;
            continue;
          } else if (line) {
            const parts = line.split(':');
            if (parts.length >= 2) {
              const key = parts[0].trim();
              const val = parts.slice(1).join(':').trim();
              if (key === 'app_name') app_name = val;
              if (key === 'app_icon') app_icon = val;
              if (key === 'app_developer') app_developer = val;
            }
          }
        } else {
          if (line === '---') continue;
          codeLines.push(line);
        }
      }
      app_code = codeLines.join('\n');
      app_name = app_name || name.replace(/\.maf$/, '');
      app_icon = app_icon || '📦';
      app_developer = app_developer || 'Unknown';
      const message = `
        <div style="text-align:center; padding:20px">
          <div style="font-size:64px; line-height:1">${app_icon}</div>
          <h2 style="margin:10px 0; font-size:24px;">${app_name}</h2>
          <p style="color:var(--muted); margin:5px 0; font-size:14px;">by ${app_developer}</p>
        </div>
      `;
      showCustomConfirm('Install App?', message, () => {
        const id = app_name.toLowerCase().replace(/\W+/g, '-');
        let customs = store.get(K.customApps, []);
        if (customs.find(c => c.id === id)) { showCustomAlert('Error', 'App with that name exists'); return; }
        customs.push({ id, name: app_name, emoji: app_icon, html: app_code });
        store.set(K.customApps, customs);
        buildMeowMenu();
        flash('App installed! Find it in Meow menu.');
      });
    }

    function installMaf(name) {
      const files = loadFilesStore();
      const content = files[name].text;
      installFromContent(name, content);
    }

    function renderCreatedList(){
      const files = loadFilesStore(); const list = $('#createdList'); list.innerHTML='';
      Object.keys(files).sort().forEach(name=>{
        const entry = files[name];
        let icon = name.endsWith('.maf') ? '📦' : entry.type==='text'?'📄': entry.type==='image'?'🖼️': entry.type==='audio'?'🎵':'🎞️';
        const btn = document.createElement('div'); btn.className='pill'; btn.innerHTML = `${icon} ${name} <span class="action download" data-name="${name}">⬇️</span> <span class="action rename" data-name="${name}">✏️</span> <span class="action delete" data-name="${name}">🗑️</span>`;
        let clickTimer;
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (clickTimer) {
            clearTimeout(clickTimer);
            if (name.endsWith('.maf')) {
              installMaf(name);
            }
            clickTimer = null;
          } else {
            clickTimer = setTimeout(() => {
              openCreatedFile(name);
              clickTimer = null;
            }, 250);
          }
        });
        btn.querySelector('.download').addEventListener('click', (e)=>{
          e.stopPropagation();
          const files = loadFilesStore();
          const entry = files[name];
          if(entry.type === 'text'){ 
            const blob = new Blob([entry.text||entry.data||''], {type:'text/plain'}); 
            triggerDownload(blob, name); 
          } else { 
            const blob = dataURLtoBlob(entry.data); 
            triggerDownload(blob, name); 
          }
        });
        btn.querySelector('.rename').addEventListener('click', (e)=>{
          e.stopPropagation();
          showCustomPrompt('Rename File', 'New name:', name, newName => {
            if (newName && newName !== name) {
              if (files[newName]) { showCustomAlert('Error', 'Name exists'); return; }
              files[newName] = files[name]; delete files[name]; saveFilesStore(files); renderCreatedList();
            }
          });
        });
        btn.querySelector('.delete').addEventListener('click', (e)=>{
          e.stopPropagation();
          showCustomConfirm('Delete File', 'Delete ' + name + '?', () => { delete files[name]; saveFilesStore(files); renderCreatedList(); });
        });
        btn.addEventListener('contextmenu', e => {
          e.preventDefault();
          e.stopPropagation();
          showFileContext(e.clientX, e.clientY, name);
        });
        btn.draggable = true; btn.addEventListener('dragstart', e => e.dataTransfer.setData('text', JSON.stringify({type:'file', id:name})));
        list.appendChild(btn);
      });
    }
    async function openCreatedFile(name){
      const files = loadFilesStore(); const entry = files[name]; if(!entry) return;
      $('#currentFileName').textContent = name; fileState.currentName = name; fileState.isCreated = true; fileState.currentType = entry.type;
      if(entry.type === 'text'){
        $('#editorArea').style.display = 'block'; $('#viewerWrap').classList.remove('show');
        $('#editorArea').value = entry.text ?? entry.data ?? ''; $('#currentFileIcon').textContent = '📄';
      } else {
        $('#editorArea').style.display = 'none'; $('#viewerWrap').classList.add('show');
        const v = $('#mediaViewer'); v.innerHTML = '';
        if(entry.type === 'image'){ const img = document.createElement('img'); img.src = entry.data; v.appendChild(img); $('#currentFileIcon').textContent = '🖼️'; }
        else if(entry.type === 'audio'){ const a = document.createElement('audio'); a.controls=true; a.src = entry.data; v.appendChild(a); $('#currentFileIcon').textContent = '🎵'; }
        else if(entry.type === 'video'){ const vid = document.createElement('video'); vid.controls=true; vid.src = entry.data; v.appendChild(vid); $('#currentFileIcon').textContent = '🎞️'; }
        else { v.textContent = 'Preview not available.'; $('#currentFileIcon').textContent = '📄'; }
      }
    }
    function saveCurrentFile(){
      if(!fileState.currentName){ showCustomAlert('Error', 'No file open.'); return; }
      const files = loadFilesStore();
      if(fileState.isCreated){
        const entry = files[fileState.currentName] || { type: 'text', text: '' };
        if(entry.type === 'text'){
          entry.text = $('#editorArea').value; entry.type = 'text'; files[fileState.currentName] = entry; saveFilesStore(files); renderCreatedList(); flash('Saved!');
        } else { flash('Saved (no overwrite for binary files via editor).'); }
      } else { flash('Uploaded files cannot be overwritten in place. Create a new file to save edits.'); }
    }
    function downloadCurrent(){
      if(!fileState.currentName){ showCustomAlert('Error', 'No file open.'); return; }
      const files = loadFilesStore(); const entry = files[fileState.currentName]; if(!entry) return;
      if(entry.type === 'text'){ const blob = new Blob([entry.text||entry.data||''], {type:'text/plain'}); triggerDownload(blob, fileState.currentName); }
      else { const blob = dataURLtoBlob(entry.data); triggerDownload(blob, fileState.currentName); }
    }
    function triggerDownload(blob, name){ const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); setTimeout(()=> URL.revokeObjectURL(a.href), 1500); }
    function dataURLtoBlob(dataurl) { const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n); for (let i=0;i<n;i++) u8arr[i]=bstr.charCodeAt(i); return new Blob([u8arr], {type:mime}); }
    function flash(msg){
      const list = $('#notifsList');
      const t = document.createElement('div');
      t.className = 'notif';
      t.textContent = msg;
      list.prepend(t);
    }
    let currentUploadedFiles = []; let currentUploadedMap = {};
    let uploadClickPath = null;
    let uploadClickTimer;
    function initFiles(){
      renderCreatedList();
      $('#createFile').addEventListener('click', ()=>{
        const name = ($('#newFileName').value || '').trim();
        if(!name){ showCustomAlert('Error', 'Enter a file name, e.g. notes.txt'); return; }
        const files = loadFilesStore();
        if(files[name]){ showCustomAlert('Error', 'That name already exists.'); return; }
        files[name] = { type: 'text', text: '' }; saveFilesStore(files); $('#newFileName').value=''; renderCreatedList(); openCreatedFile(name);
      });
      $('#saveFile').addEventListener('click', saveCurrentFile);
      $('#downloadFile').addEventListener('click', downloadCurrent);

    }

    function initCalculator() {
      let currentInput = ''; const display = $('#calcDisplay');
      function updateDisplay() { display.value = currentInput || '0'; }
      const buttons = ['7','8','9','/','4','5','6','*','1','2','3','-','0','.','=','+','C'];
      const container = $('#calcButtons');
      buttons.forEach(btnText => {
        const btn = document.createElement('button'); btn.className = 'btn secondary'; btn.textContent = btnText;
        btn.addEventListener('click', () => {
          if (btnText === 'C') currentInput = '';
          else if (btnText === '=') { try { currentInput = eval(currentInput).toString(); } catch { currentInput = 'Error'; } }
          else currentInput += btnText;
          updateDisplay();
        });
        container.appendChild(btn);
      });
      updateDisplay();
    }

    function initClock() {
      $$('[data-tab]').forEach(btn => btn.addEventListener('click', e => {
        $$('[data-tab]').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        $$('[data-tab-content]').forEach(c => c.style.display = c.dataset.tabContent === e.target.dataset.tab ? 'block' : 'none');
      }));

      // Alarms
      let alarms = store.get(K.alarms, []);
      function renderAlarms() {
        const list = $('#alarmList'); list.innerHTML = '';
        alarms.forEach((a, i) => {
          const div = document.createElement('div');
          div.style.display = 'flex';
          div.style.alignItems = 'center';
          div.style.gap = '8px';
          div.style.padding = '8px';
          div.style.border = '1px solid rgba(255,255,255,.1)';
          div.style.borderRadius = '8px';
          div.innerHTML = `<span>${a.time}</span> <span class="action" data-action="delete" data-index="${i}">🗑️</span>`;
          div.querySelector('[data-action="delete"]').addEventListener('click', () => {
            alarms.splice(i, 1);
            store.set(K.alarms, alarms);
            renderAlarms();
          });
          list.appendChild(div);
        });
      }
      renderAlarms();
      $('#addAlarm').addEventListener('click', () => {
        const min = parseInt($('#alarmInput').value);
        if (isNaN(min) || min <= 0) return;
        const now = new Date();
        const alarmTime = new Date(now.getTime() + min * 60000);
        const timeStr = alarmTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        alarms.push({ time: timeStr });
        store.set(K.alarms, alarms);
        renderAlarms();
        $('#alarmInput').value = '';
      });

      // Stopwatch
      let swInterval, swTime = 0, swRunning = false;
      function updateSW() {
        const sec = Math.floor(swTime / 1000);
        const min = Math.floor(sec / 60);
        const h = Math.floor(min / 60);
        const s = sec % 60;
        const m = min % 60;
        $('#stopwatchDisplay').textContent = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
      }
      $('#swStart').addEventListener('click', () => {
        if (swRunning) return;
        swRunning = true;
        swInterval = setInterval(() => {
          swTime += 1000;
          updateSW();
        }, 1000);
      });
      $('#swStop').addEventListener('click', () => {
        if (!swRunning) return;
        clearInterval(swInterval);
        swRunning = false;
      });
      $('#swReset').addEventListener('click', () => {
        clearInterval(swInterval);
        swRunning = false;
        swTime = 0;
        updateSW();
      });

      // Timer
      let timerInterval, timerTime = 0, timerRunning = false;
      function updateTimer() {
        const sec = Math.floor(timerTime / 1000);
        const min = Math.floor(sec / 60);
        $('#timerDisplay').textContent = `${min.toString().padStart(2, '0')}:${(sec % 60).toString().padStart(2, '0')}`;
        if (timerTime <= 0) {
          clearInterval(timerInterval);
          timerRunning = false;
          showCustomAlert('Timer', 'Timer done!');
        }
      }
      $('#timerStart').addEventListener('click', () => {
        if (timerRunning || !$('#timerInput').value) return;
        const min = parseInt($('#timerInput').value);
        timerTime = min * 60 * 1000;
        timerRunning = true;
        updateTimer();
        timerInterval = setInterval(() => {
          timerTime -= 1000;
          updateTimer();
        }, 1000);
      });
      $('#timerStop').addEventListener('click', () => {
        clearInterval(timerInterval);
        timerRunning = false;
      });
    }

    const gameDayMs = 24 * 1000; // 24 seconds = 1 game day

    function showCatWindow(){
      const win = $('#win-cat');
      if(!win) return;
      win.classList.remove('hidden','minimized');
      bringToFront(win);
      const catData = store.get(K.cat, null);
      const catBody = $('#catBody');
      if(!catData){
        catBody.innerHTML = `
          <p>Choose a name for your cat:</p>
          <input id=catName class=input placeholder="e.g. Whiskers" style=width:200px;>
          <button class=btn id=catStart>Start Growing</button>
          <p style=font-size:12px;color:var(--muted)>Tap 🐱 top right to check growth</p>
        `;
        $('#catStart').addEventListener('click', ()=>{
          const name = $('#catName').value.trim();
          if(!name){ showCustomAlert('Name required'); return; }
          store.set(K.cat, {name, startTime: Date.now()});
          updateCatDisplay();
        });
      } else {
        catBody.innerHTML = `
          <div style=font-size:48px;line-height:1 id=catEmoji>🐱</div>
          <div style=font-weight:800 id=catNameDisplay>${catData.name}</div>
          <div id=catAge style=font-size:18px></div>
          <div style=width:100%;height:4px;background:var(--glass-2);border-radius:2px>
            <div id=catProgress style=height:100%;background:var(--accent);border-radius:2px;width:0%;transition:width 0.5s></div>
          </div>
        `;
        catInterval = setInterval(updateCatDisplay, 1000);
      }
    }

    function updateCatDisplay(){
      const catData = store.get(K.cat, null);
      if(!catData) return;
      const now = Date.now();
      const elapsed = now - catData.startTime;
      const days = Math.floor(elapsed / gameDayMs);
      const progress = (elapsed % gameDayMs) / gameDayMs * 100;
      $('#catAge').textContent = `${days} days old`;
      $('#catProgress').style.width = progress + '%';
      let emoji = '🐱';
      if(days >= 7 && days < 30) emoji = '😺';
      else if(days >= 30 && days < 60) emoji = '🐈';
      else if(days >= 60) emoji = '🐈‍⬛';
      $('#catEmoji').textContent = emoji;
    }

    function initSettings(){
      function renderInstalledApps() {
        const list = $('#installedAppsList');
        list.innerHTML = '';
        const customs = store.get(K.customApps, []);
        if (!customs.length) {
          list.innerHTML = '<p>No installed apps.</p>';
          return;
        }
        customs.forEach((app, index) => {
          const row = document.createElement('div');
          row.className = 'settings-row';
          row.innerHTML = `<span>${app.emoji} ${app.name}</span>`;
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn secondary';
          deleteBtn.textContent = 'Delete';
          deleteBtn.addEventListener('click', () => {
            showCustomConfirm('Delete App', `Are you sure you want to delete ${app.name}?`, () => {
              customs.splice(index, 1);
              store.set(K.customApps, customs);
              let pinned = store.get(K.pinned, []);
              pinned = pinned.filter(p => p !== 'custom_' + app.id);
              store.set(K.pinned, pinned);
              let shortcuts = store.get(K.shortcuts, []);
              shortcuts = shortcuts.filter(s => !(s.type === 'app' && s.id === 'custom_' + app.id));
              store.set(K.shortcuts, shortcuts);
              renderInstalledApps();
              buildMeowMenu();
              renderDock();
              renderShortcuts();
              const win = $('#win-custom-' + app.id);
              if (win) win.remove();
              flash('App deleted');
            });
          });
          row.appendChild(deleteBtn);
          list.appendChild(row);
        });
      }
      renderInstalledApps();
      $('#setName').value = store.get(K.name, '') || '';
      $('#applyName').addEventListener('click', ()=>{ const v = $('#setName').value.trim(); if(!v){ showCustomAlert('Error', 'Enter a name'); return; } store.set(K.name, v); $('#hello').textContent = `😺 Welcome, ${v}!`; $('#meowUser').textContent = v; flash('Name updated'); });

      $('#lightTheme').checked = store.get(K.theme, 'dark') === 'light';
      $('#lightTheme').addEventListener('change', (e)=>{
        const theme = e.target.checked ? 'light' : 'dark';
        store.set(K.theme, theme); document.body.classList.toggle('light', theme === 'light'); applyBackground(); flash('Theme updated');
      });

      const scaleSlider = $('#textScale'); const scaleValue = $('#scaleValue');
      scaleSlider.value = store.get(K.scale, 1); scaleValue.textContent = `${scaleSlider.value}x`;
      scaleSlider.addEventListener('input', (e)=>{ const val = e.target.value; document.documentElement.style.setProperty('--font-scale', val); scaleValue.textContent = `${val}x`; });
      scaleSlider.addEventListener('change', (e)=>{ store.set(K.scale, e.target.value); flash('Text scale updated'); });

      $('#clock24h').checked = store.get(K.clock24, false);
      $('#clock24h').addEventListener('change', (e)=>{
        store.set(K.clock24, e.target.checked);
        const d = new Date(); 
        const tz = store.get(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
        const opts = {hour:'2-digit', minute:'2-digit', timeZone: tz};
        if(e.target.checked) opts.hourCycle = 'h23';
        $('#clock').textContent = d.toLocaleTimeString([], opts); flash('Clock format updated');
      });

      const currentTz = store.get(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
      $('#timeZone').value = currentTz;
      if(!$('#timeZone').querySelector(`option[value="${currentTz}"]`)) {
        const opt = document.createElement('option');
        opt.value = currentTz;
        opt.textContent = currentTz;
        $('#timeZone').appendChild(opt);
        $('#timeZone').value = currentTz;
      }
      $('#timeZone').addEventListener('change', (e)=>{
        store.set(K.tz, e.target.value);
        const d = new Date(); 
        const opts = {hour:'2-digit', minute:'2-digit', timeZone: e.target.value};
        if(store.get(K.clock24, false)) opts.hourCycle = 'h23';
        $('#clock').textContent = d.toLocaleTimeString([], opts); flash('Time zone updated');
        if(clockWidget) toggleClockWidget(true);
        if(calendarWidget) toggleCalendarWidget(true);
      });

      $('#accentColor').addEventListener('input', (e)=> document.documentElement.style.setProperty('--accent', e.target.value));
      $('#accentColor').addEventListener('change', (e)=>{ store.set(K.accent, e.target.value); flash('Accent color updated'); });

      $('#dockPos').value = store.get(K.dock, 'bottom');
      $('#dockPos').addEventListener('change', (e)=>{ const pos = e.target.value; store.set(K.dock, pos); document.body.classList.toggle('dock-left', pos === 'left'); flash('Dock position updated'); });

      $('#reduceTransparency').checked = !!store.get(K.reduce, false);
      $('#reduceTransparency').addEventListener('change', (e)=>{
        const on = e.target.checked; store.set(K.reduce, on); document.body.classList.toggle('no-glass', on);
        if(on) document.documentElement.style.setProperty('--blur', 'none');
        else document.documentElement.style.setProperty('--blur', `saturate(140%) blur(${store.get(K.blur,10)}px)`);
        flash(on ? 'Transparency disabled' : 'Transparency enabled');
      });

      const blurSlider = $('#blurIntensity'); const blurValue = $('#blurValue');
      blurSlider.value = store.get(K.blur, 10); blurValue.textContent = `${blurSlider.value}px`;
      blurSlider.addEventListener('input', (e)=>{
        const val = e.target.value; if(!store.get(K.reduce,false)) document.documentElement.style.setProperty('--blur', `saturate(140%) blur(${val}px)`); blurValue.textContent = `${val}px`;
      });
      blurSlider.addEventListener('change', (e)=>{ store.set(K.blur, e.target.value); if(!store.get(K.reduce,false)) flash('Blur intensity updated'); });

      $('#searchEngine').value = store.get(K.search, 'wikipedia');
      $('#searchEngine').addEventListener('change', e => { store.set(K.search, e.target.value); flash('Search engine updated'); });

      $('#homePage').value = store.get(K.home, 'https://en.wikipedia.org');
      $('#applyHome').addEventListener('click', ()=>{
        const v = $('#homePage').value.trim();
        if(!v){ showCustomAlert('Error', 'Enter a URL'); return; }
        store.set(K.home, /^https?:\/\//i.test(v) ? v : 'https://' + v);
        flash('Homepage updated');
      });

      $('#proxyMode').value = store.get(K.proxy, 'auto');
      $('#proxyMode').addEventListener('change', e => { store.set(K.proxy, e.target.value); flash('Proxy mode updated'); });

      $('#blockPopups').checked = !!store.get(K.blockPopups, true);
      $('#blockPopups').addEventListener('change', e => {
        store.set(K.blockPopups, e.target.checked);
        applyBrowserSandbox();
        flash(e.target.checked ? 'Popups blocked' : 'Popups allowed');
      });

      $('#clearHistory').addEventListener('click', ()=>{ browserHistory = []; browserIndex = -1; flash('Browsing history cleared'); });

      $('#reduceMotion').checked = !!store.get(K.reduceMotion, false);
      $('#reduceMotion').addEventListener('change', e=>{
        store.set(K.reduceMotion, e.target.checked);
        document.body.classList.toggle('reduce-motion', e.target.checked);
        flash(e.target.checked ? 'Motion reduced' : 'Motion enabled');
      });

      $('#highContrast').checked = !!store.get(K.highContrast, false);
      $('#highContrast').addEventListener('change', e=>{
        store.set(K.highContrast, e.target.checked);
        document.body.classList.toggle('high-contrast', e.target.checked);
        flash(e.target.checked ? 'High contrast on' : 'High contrast off');
      });

      $('#screensaverEnable').checked = !!store.get(K.screensaverEnable, false);
      $('#screensaverEnable').addEventListener('change', e=>{
        store.set(K.screensaverEnable, e.target.checked);
        resetIdleTimer();
        flash(e.target.checked ? 'Screensaver enabled' : 'Screensaver disabled');
      });

      $('#screensaverTimeout').value = store.get(K.screensaverTimeout, 5);
      $('#screensaverTimeout').addEventListener('change', e=>{
        store.set(K.screensaverTimeout, parseInt(e.target.value));
        resetIdleTimer();
        flash('Screensaver timeout updated');
      });

      $('#clockWidget').checked = !!store.get(K.clockWidget, false);
      $('#clockWidget').addEventListener('change', e => {
        store.set(K.clockWidget, e.target.checked);
        toggleClockWidget(e.target.checked);
        flash(e.target.checked ? 'Clock widget enabled' : 'Clock widget disabled');
      });

      $('#calendarWidget').checked = !!store.get(K.calendarWidget, false);
      $('#calendarWidget').addEventListener('change', e => {
        store.set(K.calendarWidget, e.target.checked);
        toggleCalendarWidget(e.target.checked);
        flash(e.target.checked ? 'Calendar widget enabled' : 'Calendar widget disabled');
      });

      $('#weatherWidget').checked = !!store.get(K.weatherWidget, false);
      $('#weatherWidget').addEventListener('change', e => {
        store.set(K.weatherWidget, e.target.checked);
        toggleWeatherWidget(e.target.checked);
        if (e.target.checked) {
          showCustomPrompt('Weather City', 'Enter city name:', store.get(K.weatherCity, 'London'), city => {
            store.set(K.weatherCity, city);
          });
        }
        flash(e.target.checked ? 'Weather widget enabled' : 'Weather widget disabled');
      });

      $('#randomWidget').checked = !!store.get(K.randomWidget, false);
      $('#randomWidget').addEventListener('change', e => {
        store.set(K.randomWidget, e.target.checked);
        toggleRandomWidget(e.target.checked);
        flash(e.target.checked ? 'Random Wikipedia widget enabled' : 'Random Wikipedia widget disabled');
      });

      // Meow Menu settings
      $('#showPinned').checked = store.get(K.showPinned, true);
      $('#showPinned').addEventListener('change', e => {
        store.set(K.showPinned, e.target.checked);
        buildMeowMenu();
        flash(e.target.checked ? 'Pinned section enabled' : 'Pinned section disabled');
      });

      $('#showAll').checked = store.get(K.showAll, true);
      $('#showAll').addEventListener('change', e => {
        store.set(K.showAll, e.target.checked);
        buildMeowMenu();
        flash(e.target.checked ? 'All apps section enabled' : 'All apps section disabled');
      });

      $('#showRecents').checked = store.get(K.showRecents, true);
      $('#showRecents').addEventListener('change', e => {
        store.set(K.showRecents, e.target.checked);
        buildMeowMenu();
        flash(e.target.checked ? 'Recent files section enabled' : 'Recent files section disabled');
      });

      const iconSizeSlider = $('#meowIconSize'); const iconSizeValue = $('#iconSizeValue');
      iconSizeSlider.value = store.get(K.meowIconSize, 92);
      iconSizeValue.textContent = `${iconSizeSlider.value}px`;
      iconSizeSlider.addEventListener('input', (e) => {
        const val = e.target.value;
        document.documentElement.style.setProperty('--meow-icon-size', val + 'px');
        iconSizeValue.textContent = `${val}px`;
        $$('.meow-item').forEach(item => { item.style.width = val + 'px'; });
      });
      iconSizeSlider.addEventListener('change', (e) => {
        store.set(K.meowIconSize, parseInt(e.target.value));
        flash('Icon size updated');
      });

      // App Sandbox setting
      $('#appNoSandbox').checked = !!store.get(K.appNoSandbox, false);
      $('#appNoSandbox').addEventListener('change', e => {
        store.set(K.appNoSandbox, e.target.checked);
        flash(e.target.checked ? 'App sandbox disabled' : 'App sandbox enabled');
      });

      // Ripple effect for settings content
      const content = $('.settings-content');
      content.addEventListener('click', (e) => {
        const interactiveTags = ['BUTTON', 'INPUT', 'SELECT', 'LABEL', 'A'];
        if (interactiveTags.includes(e.target.tagName) || e.target.closest('.switch') || e.target.closest('.btn')) {
          return;
        }
        const ripple = document.createElement('span');
        const rect = content.getBoundingClientRect();
        const size = Math.max(content.clientWidth, content.clientHeight);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        ripple.classList.add('ripple');
        content.appendChild(ripple);
        setTimeout(() => ripple.remove(), 600);
      });

      // Easter Egg: Credits KyrKat click
      $$('.credits-kyrkat').forEach(el => {
        el.addEventListener('click', () => {
          flash('🐱 Thanks, KyrKat! Secret unlocked! 🐱');
          store.set(K.debugUnlocked, true);
          store.set(K.secretWallpaper, 'secret');
          applyBackground();
        });
      });

      // Wallpaper settings
      const defaults = [
        {id: 'default', name: 'Meow Gradient', css: 'radial-gradient(80vw 80vh at 10% 15%,var(--dark-grad1),transparent 60%),radial-gradient(80vw 80vh at 90% 85%,var(--dark-grad2),transparent 60%)', lightCss: 'radial-gradient(80vw 80vh at 10% 15%,var(--light-grad1),transparent 60%),radial-gradient(80vw 80vh at 90% 85%,var(--light-grad2),transparent 60%)'},
        {id: 'blue', name: 'Blue Sky', css: 'linear-gradient(to bottom, #00008b, #87ceeb)', lightCss: 'linear-gradient(to bottom, #87ceeb, #ffffff)'},
        {id: 'green', name: 'Green Forest', css: 'linear-gradient(to bottom, #006400, #90ee90)', lightCss: 'linear-gradient(to bottom, #90ee90, #ffffff)'},
        {id: 'red', name: 'Red Sunset', css: 'linear-gradient(to bottom, #8b0000, #ff7f7f)', lightCss: 'linear-gradient(to bottom, #ff7f7f, #ffffff)'},
        {id: 'purple', name: 'Purple Night', css: 'linear-gradient(to bottom, #4b0082, #dda0dd)', lightCss: 'linear-gradient(to bottom, #dda0dd, #ffffff)'},
        {id: 'orange', name: 'Orange Sunset', css: 'linear-gradient(to bottom, #ff4500, #ffd700)', lightCss: 'linear-gradient(to bottom, #ffd700, #ffffff)'},
        {id: 'pink', name: 'Pink Dawn', css: 'linear-gradient(to bottom, #ff1493, #ffc0cb)', lightCss: 'linear-gradient(to bottom, #ffc0cb, #ffffff)'},
        {id: 'teal', name: 'Teal Ocean', css: 'linear-gradient(to bottom, #008080, #00bfff)', lightCss: 'linear-gradient(to bottom, #00bfff, #ffffff)'},
        {id: 'lavender', name: 'Lavender Fields', css: 'linear-gradient(to bottom, #e6e6fa, #9370db)', lightCss: 'linear-gradient(to bottom, #9370db, #ffffff)'},
        {id: 'gray', name: 'Gray Mist', css: 'linear-gradient(to bottom, #a9a9a9, #696969)', lightCss: 'linear-gradient(to bottom, #d3d3d3, #a9a9a9)'},
        {id: 'yellow', name: 'Sunny Yellow', css: 'linear-gradient(to bottom, #ffff00, #ffd700)', lightCss: 'linear-gradient(to bottom, #ffd700, #ffffff)'},
        {id: 'cyan', name: 'Cyan Waves', css: 'linear-gradient(to bottom, #00ffff, #008b8b)', lightCss: 'linear-gradient(to bottom, #00ffff, #e0ffff)'},
        {id: 'magenta', name: 'Magenta Bloom', css: 'linear-gradient(to bottom, #ff00ff, #da70d6)', lightCss: 'linear-gradient(to bottom, #ff00ff, #ffffff)'},
        {id: 'black', name: 'Night Black', css: 'linear-gradient(to bottom, #000000, #333333)', lightCss: 'linear-gradient(to bottom, #333333, #666666)'},
        {id: 'cat-orange', name: 'Dark Cat Orange', css: 'radial-gradient(circle at 20% 80%, #cc7a00, #cc5500, #cc6600)', lightCss: 'radial-gradient(circle at 20% 80%, #ff9500, #ff6b35, #f7931e)'}
      ];
      const prevWrap = $('#defaultPreviews');
      defaults.forEach(d => {
        const pill = document.createElement('div');
        pill.className = 'pill';
        pill.dataset.id = d.id;
        const prev = document.createElement('div');
        prev.className = 'preview-div';
        prev.style.backgroundImage = document.body.classList.contains('light') ? d.lightCss : d.css;
        const label = document.createElement('div');
        label.textContent = d.name;
        pill.appendChild(prev);
        pill.appendChild(label);
        pill.addEventListener('click', () => {
          store.set(K.defaultWall, d.id);
          store.del(K.wallpaper);
          applyBackground();
          flash('Wallpaper set');
        });
        prevWrap.appendChild(pill);
      });
      if (store.get(K.defaultWall) && !store.get(K.wallpaper)) {
        const active = prevWrap.querySelector(`[data-id="${store.get(K.defaultWall)}"]`);
        if (active) active.style.border = '2px solid var(--accent)';
      }

      $('#wallUpload').addEventListener('change', async (e)=>{
        const file = e.target.files[0]; if(!file) return;
        const data = await new Promise(r=>{ const reader = new FileReader(); reader.onload = ()=>r(reader.result); reader.readAsDataURL(file); });
        store.set(K.wallpaper, data);
        store.del(K.defaultWall);
        applyBackground();
        flash('Wallpaper updated');
      });

      function renderFileWalls() {
        const files = loadFilesStore();
        const list = $('#fileWallList');
        list.innerHTML = '';
        Object.keys(files).filter(n => files[n].type === 'image').forEach(name => {
          const pill = document.createElement('div');
          pill.className = 'pill';
          const prev = document.createElement('img');
          prev.src = files[name].data;
          prev.style.width = '100px';
          prev.style.height = '60px';
          prev.style.objectFit = 'cover';
          prev.style.borderRadius = '8px';
          const label = document.createElement('div');
          label.textContent = name;
          pill.appendChild(prev);
          pill.appendChild(label);
          pill.addEventListener('click', () => {
            store.set(K.wallpaper, files[name].data);
            store.del(K.defaultWall);
            applyBackground();
            flash('Wallpaper set from file');
          });
          list.appendChild(pill);
        });
      }
      renderFileWalls();

      $('#factoryReset').addEventListener('click', () => {
        showCustomConfirm('Factory Reset', 'Clear all MeowOS data?', () => {
          Object.keys(localStorage).filter(k => k.startsWith('meowos_')).forEach(k => localStorage.removeItem(k));
          location.reload();
        });
      });

      $('#recoveryBtn').addEventListener('click', () => {
        $('#recovery').classList.remove('hidden');
      });

      $('#recReset').addEventListener('click', () => {
        showCustomConfirm('Factory Reset', 'Clear all MeowOS data?', () => {
          Object.keys(localStorage).filter(k => k.startsWith('meowos_')).forEach(k => localStorage.removeItem(k));
          location.reload();
        });
      });

      $('#recNoAnim').addEventListener('click', () => {
        store.set(K.reduceMotion, true);
        document.body.classList.add('reduce-motion');
        flash('Animations disabled');
        $('#recovery').classList.add('hidden');
      });

      $('#recNoGlass').addEventListener('click', () => {
        store.set(K.reduce, true);
        document.body.classList.add('no-glass');
        document.documentElement.style.setProperty('--blur', 'none');
        flash('Glass effects disabled');
        $('#recovery').classList.add('hidden');
      });

      $('#recBack').addEventListener('click', () => {
        $('#recovery').classList.add('hidden');
      });

      $('#exportConfig').addEventListener('click', ()=>{
        const keys = Object.values(K);
        const obj = {};
        keys.forEach(k => { const v = localStorage.getItem(k); if(v!=null) obj[k] = JSON.parse(v); });
        const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
        triggerDownload(blob, 'meowos-settings.json');
      });

      $('#importConfig').addEventListener('change', async e=>{
        const file = e.target.files?.[0]; if(!file) return;
        const text = await file.text();
        try{
          const data = JSON.parse(text);
          Object.entries(data).forEach(([k,v])=>{
            if(Object.values(K).includes(k)) localStorage.setItem(k, JSON.stringify(v));
          });
          flash('Settings imported — reloading…');
          setTimeout(()=> location.reload(), 600);
        }catch{ showCustomAlert('Error', 'Invalid settings file'); }
      });

      const cats = $('#settingsCats'); const panes = $$('.settings-pane');
      cats.addEventListener('click', (e)=>{
        const li = e.target.closest('li'); if(!li) return;
        cats.querySelectorAll('li').forEach(n=> n.classList.remove('active'));
        li.classList.add('active'); const target = li.dataset.cat;
        panes.forEach(p=> p.hidden = (p.dataset.pane !== target));
      });

      const index = [];
      panes.forEach(pane=>{
        pane.querySelectorAll('h2,h3,label,button,select,input').forEach(el=>{
          const txt = (el.textContent || el.placeholder || '').trim();
          if(txt) index.push({pane, el, text: txt.toLowerCase()});
        });
      });
      function jumpToPane(pane){
        const id = pane.dataset.pane;
        cats.querySelectorAll('li').forEach(n=> n.classList.remove('active'));
        const li = cats.querySelector(`li[data-cat="${id}"]`);
        if(li){ li.classList.add('active'); }
        panes.forEach(p=> p.hidden = (p!==pane));
      }
      function highlight(el){
        el.scrollIntoView({behavior:'smooth', block:'center'});
        el.style.outline = `2px solid var(--accent)`; el.style.borderRadius = '6px';
        setTimeout(()=>{ el.style.outline=''; }, 1200);
      }
      $('#settingsSearch').addEventListener('input', (e)=>{
        const q = e.target.value.trim().toLowerCase();
        if(!q) return;
        const hit = index.find(it => it.text.includes(q));
        if(hit){ jumpToPane(hit.pane); highlight(hit.el); }
      });
    }

    function initPaint(){
      const canvas = $('#paintCanvas'); const ctx = canvas.getContext('2d');
      function resizeCanvas(){ const rect = canvas.getBoundingClientRect(); canvas.width = rect.width * devicePixelRatio; canvas.height = rect.height * devicePixelRatio; ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0); ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height); }
      let painting=false, lastX=0, lastY=0;
      const brush = ()=> parseInt($('#brushSize').value, 10) || 6; const color = ()=> $('#brushColor').value || '#000';
      function start(e){ painting=true; const r = canvas.getBoundingClientRect(); const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top; lastX = x; lastY=y; }
      function draw(e){ if(!painting) return; const r = canvas.getBoundingClientRect(); const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top; ctx.strokeStyle = color(); ctx.lineWidth = brush(); ctx.lineCap = 'round'; ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(x, y); ctx.stroke(); lastX = x; lastY = y; e.preventDefault(); }
      function stop(){ painting=false; }
      canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stop); canvas.addEventListener('mouseleave', stop);
      canvas.addEventListener('touchstart', start, {passive:false}); canvas.addEventListener('touchmove', draw, {passive:false}); canvas.addEventListener('touchend', stop);
      $('#clearPaint').addEventListener('click', ()=>{ ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height); });
      $('#savePaint').addEventListener('click', ()=>{ const dataURL = canvas.toDataURL('image/png'); const files = loadFilesStore(); let base='painting', i=1, name = `${base}.png`; while(files[name]){ i++; name = `${base}-${i}.png`; } files[name] = { type: 'image', data: dataURL }; saveFilesStore(files); renderCreatedList(); openCreatedFile(name); flash('Painting saved'); });
      const ro = new ResizeObserver(()=> resizeCanvas()); ro.observe(canvas); setTimeout(()=> resizeCanvas(), 200);
    }

    function initRecorder(){
      const startBtn = $('#recStart'), stopBtn = $('#recStop'), recState = $('#recState'), recList = $('#recList');
      let mediaRecorder = null, chunks = [];
      startBtn.addEventListener('click', async ()=>{
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream); chunks = [];
          mediaRecorder.ondataavailable = e=> { if(e.data && e.data.size) chunks.push(e.data); };
          mediaRecorder.onstop = async ()=>{
            const blob = new Blob(chunks, { type: 'audio/webm' });
            const dataURL = await new Promise((res,rej)=>{ const r = new FileReader(); r.onload = ()=> res(r.result); r.onerror=rej; r.readAsDataURL(blob); });
            const files = loadFilesStore(); let base='recording', i=1, name = `${base}.webm`; while(files[name]){ i++; name = `${base}-${i}.webm`; }
            files[name] = { type: 'audio', data: dataURL }; saveFilesStore(files); renderCreatedList();
            const el = document.createElement('div'); el.style.display='flex'; el.style.alignItems='center'; el.style.gap='8px';
            const a = document.createElement('audio'); a.controls=true; a.src=dataURL; a.style.flex='1';
            const dl = document.createElement('button'); dl.className='btn secondary'; dl.textContent='Download'; dl.addEventListener('click', ()=>{ const b = dataURLtoBlob(dataURL); triggerDownload(b, name); });
            el.appendChild(a); el.appendChild(dl); recList.prepend(el);
            flash('Recording saved to Files'); recState.textContent = 'Idle'; startBtn.disabled = false; stopBtn.disabled = true;
          };
          mediaRecorder.start(); recState.textContent = 'Recording…'; startBtn.disabled = true; stopBtn.disabled = false;
        } catch(e){ showCustomAlert('Error', 'Microphone access denied or not available.'); }
      });
      stopBtn.addEventListener('click', ()=>{ if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop(); });
      const files = loadFilesStore(); Object.keys(files).filter(n=> files[n].type === 'audio').reverse().forEach(n=> {
        const el = document.createElement('div'); el.style.display='flex'; el.style.alignItems='center'; el.style.gap='8px';
        const a = document.createElement('audio'); a.controls=true; a.src=files[n].data; a.style.flex='1';
        const dl = document.createElement('button'); dl.className='btn secondary'; dl.textContent='Download'; dl.addEventListener('click', ()=>{ const b = dataURLtoBlob(files[n].data); triggerDownload(b, n); });
        el.appendChild(a); el.appendChild(dl); recList.prepend(el);
      });
    }

    function initAppInstaller() {
      const htmlTa = $('#appHtml');
      const chooseFileBtn = $('#chooseFile');
      chooseFileBtn.addEventListener('click', () => {
        const sources = [
          {name: 'Choose from Device', action: 'device'},
          {name: 'MeowOS Files', action: 'meowos'}
        ];
        showFileSelectDialog('Choose File Source', sources.map(s => s.name), selected => {
          const action = sources.find(s => s.name === selected).action;
          if (action === 'device') {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.html,.htm';
            input.onchange = async e => {
              const file = e.target.files[0];
              if (file) {
                const text = await readAsText(file);
                htmlTa.value = text;
              }
            };
            input.click();
          } else {
            const filesObj = loadFilesStore();
            const textFiles = Object.keys(filesObj).filter(n => filesObj[n].type === 'text');
            if (textFiles.length) {
              showFileSelectDialog('Select File', textFiles, name => {
                htmlTa.value = filesObj[name].text;
              });
            } else {
              showCustomAlert('No Files', 'No text files to choose from.');
            }
          }
        });
      });
      $('#addApp').addEventListener('click', () => {
        const name = $('#appName').value.trim();
        if (!name) { showCustomAlert('Error', 'Enter app name'); return; }
        const emoji = $('#appEmoji').value.trim() || '❓';
        const html = htmlTa.value.trim();
        if (!html) { showCustomAlert('Error', 'Provide HTML code or file'); return; }
        const id = name.toLowerCase().replace(/\W+/g, '-');
        let customs = store.get(K.customApps, []);
        if (customs.find(c => c.id === id)) { showCustomAlert('Error', 'App with that name exists'); return; }
        customs.push({ id, name, emoji, html });
        store.set(K.customApps, customs);
        buildMeowMenu();
        flash('App added! Find it in Meow menu.');
        $('#appName').value = '';
        $('#appEmoji').value = '';
        htmlTa.value = '';
      });
    }

    function openCustom(id) {
      const customs = store.get(K.customApps, []);
      const c = customs.find(c => c.id === id);
      if (!c) return;
      let win = $('#win-custom-' + id);
      if (!win) {
        win = document.createElement('div');
        win.className = 'app-window hidden';
        win.id = 'win-custom-' + id;
        win.dataset.app = 'custom_' + id;
        win.style.left = '20vw'; win.style.top = '15vh'; win.style.width = '700px'; win.style.height = '500px';
        const header = document.createElement('div');
        header.className = 'window-header';
        header.innerHTML = `
          <div class="win-emoji" draggable="true">${c.emoji}</div>
          <div class="win-title">${c.name}</div>
          <div class="window-actions">
            <button class="win-btn win-min" title="Minimize"></button>
            <button class="win-btn win-max" title="Maximize"></button>
            <button class="win-btn win-close" title="Close"></button>
          </div>
        `;
        win.appendChild(header);
        const body = document.createElement('div');
        body.className = 'window-body';
        body.style.height = 'calc(100% - 46px)';
        const iframe = document.createElement('iframe');
        iframe.style.width = '100%'; iframe.style.height = '100%'; iframe.style.border = '0';
        iframe.srcdoc = c.html;
        const appNoSand = store.get(K.appNoSandbox, false);
        if (appNoSand) {
          iframe.sandbox = '';
        }
        body.appendChild(iframe);
        win.appendChild(body);
        $('#desktop').appendChild(win);
        makeDraggable(win);
        addResizers(win);
      }
      win.classList.remove('hidden', 'minimized');
      bringToFront(win);
    }

    // Easter Egg: Debug Menu
    function initDebug() {
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'k' && e.key === 'd') { // Simplified: ctrl+k then d
          if (store.get(K.debugUnlocked, false)) {
            $('#debugPanel').style.display = $('#debugPanel').style.display === 'block' ? 'none' : 'block';
          }
        }
      });

      $('#debugSpawnMeowTest').addEventListener('click', () => {
        const duration = parseInt($('#debugChaosDuration').value) || 4;
        let count = 0;
        const interval = setInterval(() => {
          if (count++ > duration * 5) { // Approximate taps per second
            clearInterval(interval);
            return;
          }
          const x = Math.random() * window.innerWidth;
          const y = Math.random() * window.innerHeight;
          const event = new MouseEvent('click', { clientX: x, clientY: y, bubbles: true });
          document.elementFromPoint(x, y)?.dispatchEvent(event);
        }, 200);
        flash(`MeowTest Chaos activated! Random taps for ${duration} seconds.`);
      });

      $('#debugFullscreen').addEventListener('click', () => {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(err => flash('Fullscreen failed: ' + err.message));
        } else {
          document.exitFullscreen();
        }
        flash('Fullscreen toggled');
      });

      $('#debugNoSandbox').addEventListener('click', () => {
        const current = store.get(K.noSandbox, false);
        store.set(K.noSandbox, !current);
        flash(`App sandbox ${!current ? 'disabled' : 'enabled'}`);
        const browserWin = $('#win-browser');
        if (!browserWin.classList.contains('hidden')) {
          applyBrowserSandbox();
        }
      });

      $('#debugShowNotif').addEventListener('click', () => {
        const text = $('#debugNotifText').value.trim();
        if (text) {
          flash(text);
          $('#debugNotifText').value = '';
        }
      });

      $('#debugSetCatAge').addEventListener('click', () => {
        const days = parseInt($('#debugCatDays').value);
        if (days && days >= 0) {
          const catData = store.get(K.cat, null);
          if (catData) {
            catData.startTime = Date.now() - days * gameDayMs;
            store.set(K.cat, catData);
            if (!$('#win-cat').classList.contains('hidden')) {
              updateCatDisplay();
            }
            flash(`Cat age set to ${days} days!`);
          } else {
            flash('No cat data found. Create a cat first.');
          }
          $('#debugCatDays').value = '';
        }
      });

      $('#debugFireworks').addEventListener('click', () => {
        flash('Fireworks!');
        for (let i = 0; i < 20; i++) {
          setTimeout(() => {
            const fw = document.createElement('div');
            fw.className = 'firework';
            fw.style.left = Math.random() * 100 + '%';
            fw.style.top = '100vh';
            document.body.appendChild(fw);
            setTimeout(() => fw.remove(), 1000);
          }, i * 100);
        }
      });

      $('#debugClose').addEventListener('click', () => {
        $('#debugPanel').style.display = 'none';
      });
    }

    document.addEventListener('mousemove', e => {
      if (dragElement && dragElement.classList.contains('shortcut')) {
        dragElement.style.left = (e.clientX - dragOffsetX) + 'px';
        dragElement.style.top = (e.clientY - dragOffsetY) + 'px';
      }
    });
    document.addEventListener('mouseup', () => {
      if (dragElement && dragElement.classList.contains('shortcut')) {
        updateShortcutPosition(dragElement.dataset.index, dragElement.style.left, dragElement.style.top);
      }
      dragElement = null;
    });

    $('#desktop').addEventListener('dragover', e => e.preventDefault());
    $('#desktop').addEventListener('drop', e => {
      e.preventDefault();
      const dockRect = $('#dock').getBoundingClientRect();
      if (e.clientX >= dockRect.left && e.clientX <= dockRect.right &&
          e.clientY >= dockRect.top  && e.clientY <= dockRect.bottom) return;

      const rawData = e.dataTransfer.getData('text'); if (!rawData) return;
      const data = JSON.parse(rawData);
      if (data.from === 'dock') {
        unpinApp(data.app);
      } else if (data.from === 'meow' || data.from === 'window') {
        addShortcut('app', data.app, e.clientX, e.clientY);
      } else if (data.type === 'file') {
        addShortcut('file', data.id, e.clientX, e.clientY);
      }
    });

    $('#dock').addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); });
    $('#dock').addEventListener('drop', e => {
      e.preventDefault(); e.stopPropagation();
      const rawData = e.dataTransfer.getData('text'); if (!rawData) return;
      const data = JSON.parse(rawData);
      if (data.from === 'meow' || data.from === 'window') {
        let pinned = store.get(K.pinned, ['notes','files','browser','settings']);
        if (!pinned.includes(data.app)) { pinned.push(data.app); store.set(K.pinned, pinned); renderDock(); buildMeowMenu(); }
      }
    });

    const CITY_TZ = {
      tokyo: 'Asia/Tokyo',
      london: 'Europe/London',
      paris: 'Europe/Paris',
      berlin: 'Europe/Berlin',
      copenhagen: 'Europe/Copenhagen',
      newyork: 'America/New_York', 'new york': 'America/New_York', nyc: 'America/New_York',
      losangeles: 'America/Los_Angeles', 'los angeles': 'America/Los_Angeles', la: 'America/Los_Angeles',
      sydney: 'Australia/Sydney',
      moscow: 'Europe/Moscow',
      beijing: 'Asia/Shanghai',
      delhi: 'Asia/Kolkata',
      dubai: 'Asia/Dubai',
      singapore: 'Asia/Singapore'
    };

    function formatTimeInTZ(tz){
      const d = new Date();
      const opts = {hour:'2-digit', minute:'2-digit', hour12: !store.get(K.clock24,false), timeZone: tz};
      return d.toLocaleTimeString([], opts);
    }

    function formatLocalDate(){
      const d = new Date();
      return d.toLocaleDateString(undefined, {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    }

    async function fetchWeatherFor(query){
      const q = (query||'').toLowerCase();
      try{
        if(/\b(here|my location|near me)\b/.test(q) && navigator.geolocation){
          const coords = await new Promise((res, rej)=> navigator.geolocation.getCurrentPosition(p=>res(p.coords), rej, {enableHighAccuracy:true, timeout:6000}));
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.latitude}&longitude=${coords.longitude}&current_weather=true`;
          const r = await fetch(url); const j = await r.json();
          if(j && j.current_weather){ const cw=j.current_weather; return `Weather here: ${cw.temperature}°C, wind ${cw.windspeed} km/h`; }
        }
      }catch{}
      const m = query.match(/weather\s+(.+)/i);
      const name = m ? m[1].trim() : query.replace(/weather/gi,'').trim();
      if(!name) return "Tell me a city, e.g. weather Paris";
      try{
        const g = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1`);
        const gj = await g.json();
        if(gj && gj.results && gj.results.length){
          const {latitude, longitude, name: city, country} = gj.results[0];
          const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`);
          const jw = await w.json();
          if(jw && jw.current_weather){
            const cw = jw.current_weather;
            return `Weather in ${city}, ${country}: ${cw.temperature}°C, wind ${cw.windspeed} km/h`;
          }
        }
        return "Couldn't find that city for weather, sorry.";
      }catch{ return "Weather lookup failed, meow."; }
    }

    async function localBot(text){
      const t = text.trim();
      const lower = t.toLowerCase();

      if (lower.startsWith('what is ')) {
        const query = t.slice(8).trim();
        try {
          const res = await fetch(`https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=extracts&exintro&explaintext&redirects=1&titles=${encodeURIComponent(query)}`);
          const data = await res.json();
          const pages = data.query.pages;
          const page = Object.values(pages)[0];
          if (page.missing) return `No Wikipedia entry for "${query}"`;
          return page.extract || `Found "${page.title}" but no summary available.`;
        } catch (e) {
          return 'Failed to fetch from Wikipedia.';
        }
      }

      if(lower.includes('meow')) return "Meow, I love cats too! 🐾";

      if(/\bdate\b/.test(lower)) return `Today is ${formatLocalDate()}.`;

      if(/\btime\b/.test(lower)){
        const cityMatch = lower.match(/\btime(?:\s+in)?\s+([a-z\s]+)$/i);
        if(cityMatch){
          const cityRaw = cityMatch[1].trim();
          const key = cityRaw.replace(/\s+/g,'');
          const tz = CITY_TZ[cityRaw] || CITY_TZ[key];
          if(tz) return `Time in ${cityRaw.replace(/\b\w/g, c=>c.toUpperCase())}: ${formatTimeInTZ(tz)}.`;
        }
        return `Local time: ${formatTimeInTZ(Intl.DateTimeFormat().resolvedOptions().timeZone)}.`;
      }

      if(lower.includes('weather')){
        return await fetchWeatherFor(lower);
      }

      return "Sorry, I don't understand that query.";
    }

    // Easter Egg: Spotlight /meowdance
    function initSpotlightEasterEgg() {
      $('#spotlightInput').addEventListener('input', async () => {
        const val = $('#spotlightInput').value.trim().toLowerCase();
        const res = $('#spotlightResults');
        res.innerHTML = '';
        if (val === '/meowdance') {
          // Dance across the screen
          for (let i = 0; i < 3; i++) {
            const dancer = document.createElement('div');
            dancer.className = 'dancing-cat';
            dancer.innerHTML = '😺';
            document.body.appendChild(dancer);
            setTimeout(() => dancer.remove(), 2000);
          }
          flash('Meowdance activated! 💃🐱');
          $('#spotlight').classList.add('hidden');
          $('#spotlightInput').value = '';
          return;
        }
        if (val.startsWith('/meowai ')) {
          const query = val.slice(8).trim();
          if (query) {
            const response = await localBot(query);
            const div = document.createElement('div');
            div.textContent = response;
            res.appendChild(div);
          }
        } else {
          const allApps = [...apps, ...store.get(K.customApps, []).map(c => 'custom_' + c.id)];
          allApps.filter(a => getLabel(a).toLowerCase().includes(val)).forEach(a => {
            const btn = document.createElement('div');
            btn.className = 'start-item';
            btn.innerHTML = `<div class="start-emoji">${getEmoji(a)}</div><div class="start-label">${getLabel(a)}</div>`;
            btn.addEventListener('click', () => { openWindow(a); $('#spotlight').classList.add('hidden'); $('#spotlightInput').value = ''; });
            res.appendChild(btn);
          });
        }
      });
    }

    document.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
        e.preventDefault();
        const spot = $('#spotlight');
        spot.classList.toggle('hidden');
        if (!spot.classList.contains('hidden')) $('#spotlightInput').focus();
      }
      if (e.key === 'Escape' && !$('#spotlight').classList.contains('hidden')) {
        $('#spotlight').classList.add('hidden');
        $('#spotlightInput').value = '';
        $('#spotlightResults').innerHTML = '';
      }
      if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'r' && !$('#onboarding').classList.contains('hidden')) {
        $('#recovery').classList.remove('hidden');
      }
    });

    $('#spotlightInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        const res = $$('#spotlightResults .start-item');
        if (res.length) res[0].click();
      }
    });

    $('#clock').addEventListener('click', () => $('#notifCenter').classList.toggle('hidden'));

    window.addEventListener('DOMContentLoaded', ()=>{
      const isSetup = !!store.get(K.setup, false);
      if(isSetup) showDesktop(); else startOnboarding();

      $('#obNext').addEventListener('click', ()=>{ $('#ob-step-1').classList.add('hidden'); $('#ob-step-2').classList.remove('hidden'); $('#obName').focus(); });
      $('#obBack2').addEventListener('click', ()=>{ $('#ob-step-2').classList.add('hidden'); $('#ob-step-1').classList.remove('hidden'); });
      $('#obNext2').addEventListener('click', ()=>{
        const name = $('#obName').value.trim() || 'Friend'; store.set(K.name, name);
        $('#ob-step-2').classList.add('hidden'); $('#ob-step-3').classList.remove('hidden');
      });
      $('#obBack3').addEventListener('click', ()=>{ $('#ob-step-3').classList.add('hidden'); $('#ob-step-2').classList.remove('hidden'); });
      $('#obNext3').addEventListener('click', ()=>{
        const theme = document.querySelector('input[name="obTheme"]:checked').value; store.set(K.theme, theme);
        $('#ob-step-3').classList.add('hidden'); $('#ob-step-4').classList.remove('hidden');
      });
      $('#obBack4').addEventListener('click', ()=>{ $('#ob-step-4').classList.add('hidden'); $('#ob-step-3').classList.remove('hidden'); });
      $('#obFinish').addEventListener('click', ()=>{
        const tz = $('#obTimeZone').value; store.set(K.tz, tz); store.set(K.scale, 1); store.set(K.setup, true); 
        $('#onboarding').classList.add('hidden');
        $('#loading').classList.add('hidden');
        showDesktop();
      });
      $('#obSkip').addEventListener('click', ()=>{ store.set(K.name, 'Friend'); store.set(K.theme, 'dark'); store.set(K.scale, 1); store.set(K.setup, true); store.set(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
        $('#onboarding').classList.add('hidden');
        $('#loading').classList.add('hidden');
        showDesktop();
      });

      $$('input[name="obTheme"]').forEach(r => r.addEventListener('change', (e)=>{ document.body.classList.toggle('light', e.target.value === 'light'); }));

      ['notes','calendar','browser','files','recorder','paint','calculator','clock','settings','appinstaller','cat'].forEach(id=>{
        const el = document.getElementById('win-' + id); if(el) makeDraggable(el);
      });

      initNotes(); initFiles(); initSettings(); initBrowser(); initRecorder(); initPaint(); initCalculator(); initClock(); initAppInstaller();

      $('#calPrev').addEventListener('click', ()=>{ calDate.setMonth(calDate.getMonth()-1); renderCalendar(); });
      $('#calNext').addEventListener('click', ()=>{ calDate.setMonth(calDate.getMonth()+1); renderCalendar(); });
      renderCalendar();

      // Init Easter Eggs
      initSpotlightEasterEgg();

      if(isSetup) openWindow('notes');
    });

    (function ensureDefaults(){
      const files = loadFilesStore();
      if(!Object.keys(files).length){ files['welcome.txt'] = { type: 'text', text: 'Welcome to MeowOS! Your files are stored locally in your browser.' }; saveFilesStore(files); }
    })();</script>