<!doctypehtml><html lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1"name=viewport><title>MeowOS — a tiny HTML OS</title><style>:root{--bg:#0b0f17;--glass:rgba(255,255,255,0.08);--glass-2:rgba(255,255,255,0.12);--text:#e6ecff;--muted:#a8b3d1;--accent:#8a9bff;--red:#ff6b6b;--yellow:#ffd166;--green:#3ecf8e;--shadow:0 10px 30px rgba(0,0,0,0.4);--blur:saturate(140%) blur(10px);--font-scale:1;--font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Color Emoji","Apple Color Emoji","Segoe UI Emoji",sans-serif;--dark-grad1:color-mix(in srgb, var(--accent) 20%, #14223a);--dark-grad2:color-mix(in srgb, var(--accent) 20%, #1b2b4a)}body.light{--bg:#f0f4ff;--glass:rgba(0,0,0,0.08);--glass-2:rgba(0,0,0,0.12);--text:#0b0f17;--muted:#5a6a8a;--accent:#4a6bff;--red:#ff4a4a;--yellow:#ffb733;--green:#2ab07a;--shadow:0 10px 30px rgba(0,0,0,0.15);--blur:saturate(120%) blur(8px);--light-grad1:color-mix(in srgb, var(--accent) 20%, #e0e8ff);--light-grad2:color-mix(in srgb, var(--accent) 20%, #d0dfff)}*{box-sizing:border-box}body,html{height:100%}body{margin:0;font-family:var(--font-family);color:var(--text);background:var(--bg) center/cover fixed no-repeat;background-image:radial-gradient(80vw 80vh at 10% 15%,var(--dark-grad1),transparent 60%),radial-gradient(80vw 80vh at 90% 85%,var(--dark-grad2),transparent 60%);user-select:none;overflow:hidden;font-size:calc(16px * var(--font-scale))}body.light{background-image:radial-gradient(80vw 80vh at 10% 15%,var(--light-grad1),transparent 60%),radial-gradient(80vw 80vh at 90% 85%,var(--light-grad2),transparent 60%)}.overlay{position:absolute;inset:0;display:grid;place-items:center;background:radial-gradient(1200px 800px at 50% 50%,rgba(0,0,0,.55),rgba(0,0,0,.8));z-index:9999}.overlay#spotlight{background:rgba(0,0,0,.4);backdrop-filter:blur(20px)}body.light .overlay#spotlight{background:rgba(0,0,0,.2)}.card{width:min(560px,92vw);padding:28px;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.12);border-radius:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;min-height:320px}.card h1{margin:0 0 8px;font-weight:800;letter-spacing:.4px}.card p{margin:6px 0 16px;color:var(--muted)}.row{display:flex;gap:12px;align-items:center}.row input[type=password],.row input[type=text]{flex:1}.btn{appearance:none;border:0;cursor:pointer;padding:10px 14px;border-radius:12px;font-weight:700;letter-spacing:.2px;background:linear-gradient(180deg,var(--accent),#6b82ff);color:#0b0f17;box-shadow:0 6px 16px rgba(138,155,255,.35);transition:transform .08s ease,filter .2s ease}body.light .btn{background:linear-gradient(180deg,var(--accent),#3a5aff);color:#fff;box-shadow:0 6px 16px rgba(74,107,255,.25)}.btn:hover{transform:translateY(-1px) scale(1.02)}.btn:active{transform:translateY(1px) scale(.98)}.btn.secondary{background:var(--glass-2);color:var(--text);box-shadow:none;border:1px solid rgba(255,255,255,.12)}body.light .btn.secondary{border:1px solid rgba(0,0,0,.12)}.oobe-card .btn.secondary{background:rgba(0,0,0,.06);color:#000;border:1px solid rgba(0,0,0,.15)}.input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:var(--text)}body.light .input{border:1px solid rgba(0,0,0,.15);background:rgba(0,0,0,.03)}.hidden{display:none!important}#desktop{position:absolute;inset:0;overflow:hidden}.topbar{position:absolute;inset:12px 12px auto 12px;height:40px;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:12px;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.1);box-shadow:var(--shadow)}.topbar .hello{font-weight:700;cursor:pointer}.topbar .clock{color:var(--muted);font-variant-numeric:tabular-nums;cursor:pointer}#startMenu{position:absolute;left:50%;bottom:76px;transform:translateX(-50%);width:min(900px,92vw);background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;box-shadow:var(--shadow);z-index:300;display:grid;gap:12px;grid-template-rows:auto 1fr;opacity:0;transition:opacity .3s ease,transform .3s ease;transform:translateX(-50%) scale(.95)}#startMenu:not(.hidden){opacity:1;transform:translateX(-50%) scale(1)}.start-head{display:flex;align-items:center;gap:10px}.start-head .avatar{font-size:24px}.start-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(92px,1fr));gap:10px}.start-item{display:grid;place-items:center;gap:6px;padding:8px;border-radius:12px;cursor:pointer;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);transition:transform .12s ease,background .2s ease}body.light .start-item{background:rgba(0,0,0,.035);border:1px solid rgba(0,0,0,.08)}.start-item:hover{transform:translateY(-2px);background:var(--glass-2)}.start-emoji{font-size:28px;line-height:1}.start-label{font-size:12px;color:var(--muted);text-align:center}.start-section-title{font-weight:800;color:var(--muted);margin:6px 2px}.start-recents{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px}.recent{display:flex;gap:8px;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);cursor:pointer}body.light .recent{background:rgba(0,0,0,.035);border:1px solid rgba(0,0,0,.08)}.recent .icon{font-size:18px}.recent .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.dock{position:absolute;left:50%;bottom:14px;transform:translateX(-50%);display:flex;gap:18px;padding:10px 14px;border-radius:20px;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.12);box-shadow:var(--shadow);overflow-x:auto;overscroll-behavior-x:contain}.dock-item{appearance:none;border:0;background:0 0;color:var(--text);display:grid;place-items:center;gap:6px;padding:6px 8px;border-radius:14px;cursor:pointer;min-width:64px;transition:transform .12s ease,background .2s ease;flex:0 0 auto}.dock-item:hover{transform:translateY(-4px) scale(1.05);background:rgba(255,255,255,.08)}body.light .dock-item:hover{background:rgba(0,0,0,.05)}.dock-emoji{font-size:28px;line-height:1}.dock-label{font-size:12px;color:var(--muted)}.dot{width:6px;height:6px;border-radius:100%;background:var(--green);margin-top:2px;opacity:0;transition:opacity .2s}.dock-item.open .dot{opacity:1}.shortcut{position:absolute;min-width:auto;cursor:pointer}#contextMenu{position:absolute;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px;box-shadow:var(--shadow);z-index:200}.context-item{padding:6px 12px;cursor:pointer}.context-item:hover{background:var(--glass-2)}.dialog-overlay{position:absolute;inset:0;background:rgba(0,0,0,.6);display:grid;place-items:center;z-index:150}.dialog-card{width:min(400px,80vw);padding:20px;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:var(--shadow)}.dialog-buttons{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}.oobe-card{background:rgba(255,255,255,.95);color:#000;border:none;box-shadow:0 20px 60px rgba(0,0,0,.2);display:flex;flex-direction:column}body.light .oobe-card{background:rgba(255,255,255,.95)}.oobe-title{font-size:32px;font-weight:600;margin-bottom:12px}.oobe-sub{font-size:16px;color:#666;margin-bottom:24px}.oobe-options{display:flex;flex-direction:column;gap:12px}.oobe-card input,.oobe-card select{color:#000;background:rgba(0,0,0,.05);border:1px solid rgba(0,0,0,.15)}.oobe-card label{color:#000}.app-window{position:absolute;inset:auto;min-width:360px;min-height:260px;width:680px;height:420px;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.15);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;opacity:0;transform:scale(.9);transition:opacity .3s ease,transform .3s ease}.app-window:not(.hidden):not(.minimized){opacity:1;transform:scale(1)}body.light .app-window{border:1px solid rgba(0,0,0,.15)}.app-window.minimized{display:none!important}.window-header{display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.08);cursor:grab;user-select:none}body.light .window-header{background:rgba(0,0,0,.03);border-bottom:1px solid rgba(0,0,0,.08)}.window-header:active{cursor:grabbing}.win-emoji{font-size:20px}.win-title{font-weight:800;letter-spacing:.3px;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.window-actions{display:flex;gap:10px;align-items:center}.win-btn{width:20px;height:20px;border-radius:100%;border:0;cursor:pointer;box-shadow:0 0 0 1px rgba(0,0,0,.15) inset;transition:transform .08s ease;display:inline-block}.win-close{background:var(--red)}.win-min{background:var(--yellow)}.win-max{background:var(--green)}.win-btn:hover{transform:scale(1.12)}.win-btn:active{transform:scale(.98)}body.dock-left .dock{left:14px;bottom:auto;top:50%;transform:translateY(-50%);flex-direction:column}body.dock-left .dock .dock-item{min-width:56px}.viewer{display:none;height:100%;background:rgba(0,0,0,.4)}body.light .viewer{background:rgba(255,255,255,.4)}.viewer.show{display:block}.media-view{height:100%;display:grid;place-items:center}.media-view audio,.media-view img,.media-view video{max-width:100%;max-height:100%;border-radius:12px}.window-body{height:calc(100% - 46px);display:grid;grid-template-rows:1fr}.settings-body{overflow-y:auto}.pad{padding:12px}.toolbar{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04)}body.light .toolbar{border-bottom:1px solid rgba(0,0,0,.08);background:rgba(0,0,0,.02)}.toolbar input,.toolbar select{background:rgba(255,255,255,.08);color:var(--text);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px 10px}.toolbar select,body.light .toolbar input{background:rgba(0,0,0,.05);border:1px solid rgba(0,0,0,.15)}#notesText{width:100%;height:100%;background:0 0;color:var(--text);border:0;outline:0;font:600 15px/1.6 var(--font-family)}.cal-wrap{display:grid;grid-template-rows:auto 1fr;height:100%}.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:12px}.cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:12px;font-weight:700;color:var(--muted)}.day{padding:10px;border-radius:10px;background:rgba(255,255,255,.04);text-align:right}body.light .day{background:rgba(0,0,0,.03)}.day.today{outline:2px solid var(--accent)}.cal-controls{display:flex;align-items:center;gap:8px;padding:10px 12px}.urlbar{flex:1;display:flex;gap:8px;align-items:center}.urlbar input{flex:1;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)}body.light .urlbar input{background:rgba(0,0,0,.04);border:1px solid rgba(0,0,0,.08)}.webview{height:100%;border:0;width:100%;background:#0c1220;zoom:100%}body.light .webview{background:#f8faff}.files-shell{display:grid;grid-template-columns:260px 1fr;height:100%}.sidebar{border-right:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);padding:10px;overflow:auto}body.light .sidebar{border-right:1px solid rgba(0,0,0,.08);background:rgba(0,0,0,.02)}.side-title{font-weight:800;margin:8px 0}.filetree,.filetree ul{list-style:none;padding-left:16px}.filetree li{margin:4px 0;color:var(--muted)}.filetree li .fname{color:var(--text);cursor:pointer}.editor{display:grid;grid-template-rows:auto 1fr;height:100%}.editor textarea{width:100%;height:100%;background:0 0;color:var(--text);border:0;outline:0;font:600 14px/1.6 var(--font-family)}.list{display:grid;gap:6px}.pill{padding:8px 10px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);cursor:pointer}body.light .pill{background:rgba(0,0,0,.04);border:1px solid rgba(0,0,0,.1)}.paint-canvas{border-radius:10px;background:#fff;display:block;width:100%;height:calc(100% - 48px);touch-action:none}#calcDisplay{font-size:24px;text-align:right;margin-bottom:10px}#calcButtons{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}.settings-shell{display:grid;grid-template-columns:240px 1fr;height:100%}.settings-sidebar{border-right:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);padding:12px;overflow:auto}body.light .settings-sidebar{border-right:1px solid rgba(0,0,0,.08);background:rgba(0,0,0,.02)}.settings-sidebar .search{position:sticky;top:0;padding-bottom:10px;background:inherit}.settings-sidebar ul{list-style:none;margin:8px 0 0;padding:0;display:grid;gap:6px}.settings-sidebar li{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;cursor:pointer;color:var(--text);transition:background .15s ease,transform .06s ease}.settings-sidebar li:hover{background:var(--glass-2);transform:translateY(-1px)}body.light .settings-sidebar li:hover{background:rgba(0,0,0,.05)}.settings-sidebar li.active{background:linear-gradient(180deg,var(--accent),#6b82ff);color:#0b0f17;font-weight:800;box-shadow:0 6px 16px rgba(138,155,255,.35)}body.light .settings-sidebar li.active{color:#fff;box-shadow:0 6px 16px rgba(74,107,255,.25)}.settings-content{padding:16px 20px;overflow:auto}.settings-pane{max-width:760px;display:grid;gap:16px}.settings-pane[hidden]{display:none!important}.section{border-radius:12px;padding:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}body.light .section{background:rgba(0,0,0,.03);border:1px solid rgba(0,0,0,.08)}.settings-h2{margin:0 0 8px;font-weight:900;letter-spacing:.2px}.settings-row{display:flex;align-items:center;justify-content:space-between;gap:12px}.switch{appearance:none;width:46px;height:26px;border-radius:999px;background:rgba(255,255,255,.28);position:relative;cursor:pointer;box-shadow:inset 0 0 0 1px rgba(0,0,0,.15);transition:background .2s,box-shadow .2s}.switch::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.35);transition:transform .2s}.switch:checked{background:linear-gradient(180deg,var(--accent),#6b82ff)}.switch:checked::after{transform:translateX(20px)}body.no-glass *{backdrop-filter:none!important;-webkit-backdrop-filter:none!important}body.no-glass:not(.light) #startMenu,body.no-glass:not(.light) .app-window,body.no-glass:not(.light) .card,body.no-glass:not(.light) .dialog-card,body.no-glass:not(.light) .dock,body.no-glass:not(.light) .pill,body.no-glass:not(.light) .section,body.no-glass:not(.light) .sidebar,body.no-glass:not(.light) .toolbar,body.no-glass:not(.light) .topbar{background:#0b0f17;border-color:rgba(255,255,255,.1)}body.no-glass.light #startMenu,body.no-glass.light .app-window,body.no-glass.light .card,body.no-glass.light .dialog-card,body.no-glass.light .dock,body.no-glass.light .pill,body.no-glass.light .section,body.no-glass.light .sidebar,body.no-glass.light .toolbar,body.no-glass.light .topbar{background:#fff;border-color:rgba(0,0,0,.12)}.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}.setting-group{margin-bottom:16px}.emoji{font-family:"Noto Color Emoji","Apple Color Emoji","Segoe UI Emoji",emoji}body.reduce-motion *{transition:none!important;animation:none!important}body.high-contrast :is(.app-window,.topbar,.dock,#startMenu,.sidebar,.toolbar,.card,.section,.pill,.dialog-card){background:var(--bg)!important;border-color:rgba(255,255,255,.35)!important}body.light.high-contrast :is(.app-window,.topbar,.dock,#startMenu,.sidebar,.toolbar,.card,.section,.pill,.dialog-card){background:#fff!important;border-color:rgba(0,0,0,.35)!important}#notifCenter{position:absolute;top:60px;right:12px;width:360px;background:var(--glass);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;box-shadow:var(--shadow);z-index:400;max-height:60vh;overflow:auto;display:grid;gap:8px}#notifCenter .notif{padding:10px 12px;background:var(--glass-2);border:1px solid rgba(255,255,255,.12);border-radius:10px}#spotlight .card{width:min(600px,80vw)}#spotlightResults{margin-top:10px;display:grid;gap:8px}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.resizer{position:absolute;background:0 0;z-index:10}#welcomeText{transition:opacity .5s ease}#welcomeAnim{background:var(--bg);backdrop-filter:blur(20px)}#welcomeAnim .bloom{position:absolute;top:50%;left:50%;width:0;height:0;background:var(--accent);border-radius:50%;opacity:0;animation:bloom 2s ease-out forwards}@keyframes bloom{0%{width:0;height:0;opacity:.5}100%{width:200vw;height:200vw;opacity:0;transform:translate(-50%,-50%)}}#screensaver-overlay{position:fixed;inset:0;background:#000;z-index:9998;display:none}#recovery .card{width:min(400px,80vw)}</style><div class="hidden overlay"id=onboarding><div class="card oobe-card"id=ob-step-1><div style=text-align:center><div style=font-size:56px;line-height:1>🐾</div><h1 style="margin:8px 0 12px;font-size:28px;font-weight:600">Welcome to MeowOS</h1></div><p style=text-align:center class=oobe-sub>Thanks for trying this tiny in-browser OS prototype. It's all in one HTML file and stores your stuff in your browser.<div class=row style=justify-content:flex-end;gap:10px;margin-top:auto><button class="btn secondary"id=obSkip>Skip</button><button class=btn id=obNext>Next</button></div></div><div class="hidden card oobe-card"id=ob-step-2><div style=text-align:center><div style=font-size:56px;line-height:1>👤</div><h1 style="margin:8px 0 12px;font-size:28px;font-weight:600">Create your local account</h1></div><p style=text-align:center class=oobe-sub>Choose a display name. You can change this later in<strong>⚙️ Settings</strong>.</p><input id=obName class=input placeholder="Enter your name"><div class=row style=justify-content:flex-end;gap:10px;margin-top:auto><button class="btn secondary"id=obBack2>Back</button><button class=btn id=obNext2>Next</button></div></div><div class="hidden card oobe-card"id=ob-step-3><div style=text-align:center><div style=font-size:56px;line-height:1>🌗</div><h1 style="margin:8px 0 12px;font-size:28px;font-weight:600">Choose Theme</h1></div><p style=text-align:center class=oobe-sub>Select your preferred theme. You can change this later in<strong>⚙️ Settings</strong>.<div class=oobe-options><label><input type=radio value=dark name=obTheme checked> Dark Theme</label><label><input type=radio value=light name=obTheme> Light Theme</label></div><div class=row style=justify-content:flex-end;gap:10px;margin-top:auto><button class="btn secondary"id=obBack3>Back</button><button class=btn id=obNext3>Next</button></div></div><div class="hidden card oobe-card"id=ob-step-4><div style=text-align:center><div style=font-size:56px;line-height:1>🕒</div><h1 style="margin:8px 0 12px;font-size:28px;font-weight:600">Choose Time Zone</h1></div><p style=text-align:center class=oobe-sub>Select your time zone. You can change this later in<strong>⚙️ Settings</strong>.</p><select id=obTimeZone class=input style=width:100%><option value=UTC>UTC<option value=America/New_York>America/New York<option value=Europe/London>Europe/London<option value=Asia/Tokyo>Asia/Tokyo<option value=Australia/Sydney>Australia/Sydney<option value=Asia/Shanghai>Asia/Shanghai</select><div class=row style=justify-content:flex-end;gap:10px;margin-top:auto><button class="btn secondary"id=obBack4>Back</button><button class=btn id=obFinish>Finish Setup</button></div></div></div><div class="hidden overlay"id=loading><div class="card oobe-card"><div style=text-align:center><div style="font-size:56px;line-height:1;animation:spin 1s linear infinite">🔄</div><h1 style="margin:8px 0 12px;font-size:28px;font-weight:600">Loading and Setting Up</h1></div><p style=text-align:center;color:#666>Please wait...</div></div><div class="hidden overlay"id=welcomeAnim style=backdrop-filter:blur(20px)><div class=bloom></div><div class=card style="background:0 0;border:none;box-shadow:none;text-align:center"><div style=font-size:48px;font-weight:800;color:var(--accent);opacity:0 id=welcomeText>Welcome</div></div></div><div class=hidden id=desktop><div class=topbar><div class="emoji hello"id=hello>😺 Hi!</div><div class=clock id=clock>--:--</div></div><div class=hidden id=startMenu><div><div class=start-head><div class=avatar>😺</div><div style=font-weight:800 id=startUser>Meow</div><div style=margin-left:auto;color:var(--muted);font-size:12px>Start</div></div><div class=start-section-title style=margin-top:10px>Pinned</div><div class=start-grid id=startPinned></div><div class=start-section-title style=margin-top:10px>All apps</div><div class=start-grid id=startAll></div><div class=start-section-title style=margin-top:10px>Recent files</div><div class=start-recents id=startRecents></div></div></div><div class="hidden app-window"id=win-notes style=left:6vw;top:9vh data-app=notes><div class=window-header><div class=win-emoji draggable=true>🗒️</div><div class=win-title>Notes</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body pad"><textarea id=notesText placeholder="Write your notes here… (auto-saves)"></textarea></div></div><div class="hidden app-window"id=win-calendar style=left:22vw;top:12vh;width:620px data-app=calendar><div class=window-header><div class=win-emoji draggable=true>📅</div><div class=win-title id=calTitle>Calendar</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body cal-wrap"><div class=cal-controls><button class="btn secondary"id=calPrev>◀</button><div style=font-weight:800 id=calMonth></div><button class="btn secondary"id=calNext>▶</button></div><div class=cal-head><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div></div><div class=cal-grid id=calGrid></div></div></div><div class="hidden app-window"id=win-browser style=left:12vw;top:18vh;width:820px;height:520px data-app=browser><div class=window-header><div class=win-emoji draggable=true>🌐</div><div class=win-title>Web Browser</div><div class=window-actions style=flex:1;justify-content:flex-end><div class=toolbar style=margin-right:auto><button class="btn secondary"id=back title=Back>⟵</button><button class="btn secondary"id=forward title=Forward>⟶</button><button class="btn secondary"id=reload title=Reload>⟳</button><div class=urlbar><input id=url placeholder="Enter a URL or search (e.g. cats)"><button class=btn id=go>Go</button></div><button class="btn secondary"id=openExt title="Open original in new tab">↗</button><button class="btn secondary"id=zoomOut>-</button><span id=zoomLevel>100%</span><button class="btn secondary"id=zoomIn>+</button></div><div style=width:8px></div><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class=window-body><div style=width:100%;height:100%;display:none;overflow:auto id=embedContainer></div><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"class=webview id=webview referrerpolicy=no-referrer title=webview></iframe></div></div><div class="hidden app-window"id=win-files style=left:38vw;top:10vh;width:860px;height:520px data-app=files><div class=window-header><div class=win-emoji draggable=true>📁</div><div class=win-title>Files</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body files-shell"><div class=sidebar><div class="emoji side-title">🗂️ Uploaded Folder</div><input id=folderInput type=file directory multiple webkitdirectory><button class="btn secondary"id=importFolder style=margin-top:8px>Import to Created Files</button><ul id=fileTree class=filetree></ul><hr style="border-color:rgba(255,255,255,.1);margin:10px 0"><div class="emoji side-title">📄 Created Files</div><div class=row style=margin-bottom:8px><input id=newFileName class=input placeholder=new-file.txt><button class=btn id=createFile>Create</button></div><div class=list id=createdList></div></div><div class=editor><div class=toolbar><div class=emoji id=currentFileIcon>📄</div><div style=font-weight:800;flex:1 id=currentFileName>No file open</div><button class="btn secondary"id=downloadFile>Download</button><button class=btn id=saveFile>Save</button></div><div class=viewer id=viewerWrap><div class=media-view id=mediaViewer></div></div><textarea id=editorArea placeholder="Open or create a text file to edit…"></textarea></div></div></div><div class="hidden app-window"id=win-recorder style=left:20vw;top:18vh;width:500px;height:280px data-app=recorder><div class=window-header><div class=win-emoji draggable=true>🎙️</div><div class=win-title>Recorder</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body pad"style=display:flex;flex-direction:column;gap:10px><div style=display:flex;gap:8px;align-items:center><button class=btn id=recStart>Record</button><button class="btn secondary"id=recStop disabled>Stop</button><div style=color:var(--muted) id=recState>Idle</div></div><div style=display:grid;gap:8px id=recList></div></div></div><div class="hidden app-window"id=win-paint style=left:30vw;top:16vh;width:700px;height:520px data-app=paint><div class=window-header><div class=win-emoji draggable=true>🎨</div><div class=win-title>Paint</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body pad"style=display:flex;flex-direction:column;gap:8px><div style=display:flex;gap:8px><input id=brushSize type=range value=6 max=40 min=1> <input id=brushColor type=color value=#000000><button class=btn id=clearPaint>Clear</button><button class=btn id=savePaint>Save</button></div><canvas class=paint-canvas id=paintCanvas></canvas></div></div><div class="hidden app-window"id=win-calculator style=left:15vw;top:15vh;width:400px;height:500px data-app=calculator><div class=window-header><div class=win-emoji draggable=true>🧮</div><div class=win-title>Calculator</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body pad"style=display:flex;flex-direction:column><input id=calcDisplay class=input readonly style=font-size:24px;text-align:right;margin-bottom:10px><div style=display:grid;grid-template-columns:repeat(4,1fr);gap:8px id=calcButtons></div></div></div><div class="hidden app-window"id=win-settings style=left:26vw;top:14vh;width:700px data-app=settings><div class=window-header><div class=win-emoji draggable=true>⚙️</div><div class=win-title>Settings</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body settings-body"><div class=settings-shell><aside class=settings-sidebar><div class=search><input id=settingsSearch class=input placeholder="Search Settings"></div><ul id=settingsCats><li data-cat=profile class=active>👤 Profile<li data-cat=appearance>🎨 Appearance<li data-cat=desktop>🖥 Desktop & Dock<li data-cat=browser>🌐 Browser<li data-cat=apps>📦 Apps<li data-cat=system>⚙️ System</ul></aside><section class=settings-content><div class=settings-pane data-pane=profile><h2 class=settings-h2>Profile</h2><div class=section><label for=setName>Display name</label><input id=setName class=input placeholder="Your name"><div style=height:8px></div><button class=btn id=applyName>Update Name</button></div></div><div class=settings-pane data-pane=appearance hidden><h2 class=settings-h2>Appearance</h2><div class="section settings-row"><h3 class=emoji style=margin:0>🌗 Theme</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=lightTheme type=checkbox class=switch><span>Light Theme</span></label></div><div class=section><h3 class=emoji style="margin:0 0 8px">🔤 Text Size</h3><input id=textScale type=range value=1 max=1.5 min=0.8 step=0.1><div style=text-align:center;color:var(--muted) id=scaleValue>1.0x</div></div><div class="section settings-row"><h3 class=emoji style=margin:0>🎨 Accent Color</h3><input id=accentColor type=color value=#8a9bff></div><div class=section><h3 class=emoji style="margin:0 0 8px">🖼️ Wallpaper</h3><input id=wallInput type=file accept=image/*><div style=height:8px></div><button class="btn secondary"id=resetWallpaper>Reset Wallpaper</button></div><div class="section settings-row"><h3 class=emoji style=margin:0>🧊 Reduce transparency</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=reduceTransparency type=checkbox class=switch><span>Disable blur & glass</span></label></div><div class=section><h3 class=emoji style="margin:0 0 8px">🔍 Blur Intensity</h3><input id=blurIntensity type=range value=10 max=20 min=0 step=2><div style=text-align:center;color:var(--muted) id=blurValue>10px</div></div><div class="section settings-row"><h3 class=emoji style=margin:0>🌀 Reduce Motion</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=reduceMotion type=checkbox class=switch><span>Disable animations</span></label></div><div class="section settings-row"><h3 class=emoji style=margin:0>🌓 High Contrast</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=highContrast type=checkbox class=switch><span>Stronger borders & surfaces</span></label></div><div class="section settings-row"><h3 class=emoji style=margin:0>💤 Screensaver</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=screensaverEnable type=checkbox class=switch><span>Enable</span></label></div><div class=section><h3 class=emoji style="margin:0 0 8px">⏱️ Screensaver Timeout (minutes)</h3><input id=screensaverTimeout type=number class=input max=60 min=1 value=5></div></div><div class=settings-pane data-pane=desktop hidden><h2 class=settings-h2>Desktop & Dock</h2><div class="section settings-row"><h3 class=emoji style=margin:0>🕒 24-hour Clock</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=clock24h type=checkbox class=switch><span>Use 24-hour format</span></label></div><div class="section settings-row"><h3 class=emoji style=margin:0>🌍 Time Zone</h3><select id=timeZone><option value=UTC>UTC<option value=America/New_York>America/New York<option value=Europe/London>Europe/London<option value=Asia/Tokyo>Asia/Tokyo<option value=Australia/Sydney>Australia/Sydney<option value=Asia/Shanghai>Asia/Shanghai</select></div><div class="section settings-row"><h3 class=emoji style=margin:0>🛞 Dock Position</h3><select id=dockPos><option value=bottom>Bottom<option value=left>Left</select></div><div class=section><h3 class=emoji style="margin:0 0 8px">🗓️ Widgets</h3><div class=settings-row><h4>Clock Widget</h4><label style=display:flex;align-items:center;gap:10px><input id=clockWidget type=checkbox class=switch><span>Enable</span></label></div><div class=settings-row><h4>Calendar Widget</h4><label style=display:flex;align-items:center;gap:10px><input id=calendarWidget type=checkbox class=switch><span>Enable</span></label></div></div></div><div class=settings-pane data-pane=browser hidden><h2 class=settings-h2>Browser</h2><div class="section settings-row"><h3 class=emoji style=margin:0>🔎 Search Engine</h3><select id=searchEngine><option value=ddg>DuckDuckGo<option value=google>Google<option value=bing>Bing<option value=brave>Brave<option value=wikipedia>Wikipedia</select></div><div class=section><h3 class=emoji style="margin:0 0 8px">🏠 Home Page</h3><div class=row><input id=homePage class=input placeholder=https://example.com><button class=btn id=applyHome>Set Home</button></div></div><div class="section settings-row"><h3 class=emoji style=margin:0>🧰 Proxy Mode</h3><select id=proxyMode title="Use reader proxy for sites that block iframes"><option value=auto>Auto (only when blocked)<option value=always>Always use reader proxy<option value=off>Off (try embedding directly)</select></div><div class="section settings-row"><h3 class=emoji style=margin:0>🚫 Block Popups</h3><label style=display:flex;align-items:center;gap:10px;margin-left:auto><input id=blockPopups type=checkbox class=switch><span>Prevent new tabs from sites</span></label></div><div class=section><button class="btn secondary"id=clearHistory>Clear Browsing History</button><div style=color:var(--muted);font-size:13px;margin-top:6px>Sites that block iframes are auto-viewed via a safe readable proxy in Auto/Always modes. Use ↗ to open the original.</div></div></div><div class=settings-pane data-pane=apps hidden><h2 class=settings-h2>Installed Apps</h2><div class=section id=installedAppsList></div></div><div class=settings-pane data-pane=system hidden><h2 class=settings-h2>System</h2><div class=section><h3 class=emoji style="margin:0 0 8px">🐱 About MeowOS</h3><div style=display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center><div style=text-align:center><div style=font-size:56px;line-height:1>🐈</div><div style=font-size:36px;font-weight:900;margin-top:8px>MeowOS</div><div style=font-size:14px;color:var(--muted);margin-top:6px>Beta</div></div><div style=color:var(--muted);text-align:center;max-width:420px>MeowOS is a tiny in-browser operating system prototype. It stores files locally and demonstrates apps — Notes, Calendar, Files, Browser, Paint, Recorder, Calculator, Settings.</div></div></div><div class=section><h3 class=emoji style="margin:0 0 8px">🧹 Maintenance</h3><button class="btn secondary"id=factoryReset>Factory Reset (clear MeowOS local data)</button><button class="btn secondary"id=recoveryBtn>Recovery Mode</button></div><div class=section><h3 class=emoji style="margin:0 0 8px">🗂️ Backup & Restore</h3><div class=row><button class=btn id=exportConfig>Export Settings</button><label style=display:inline-block;cursor:pointer class="btn secondary">Import Settings <input id=importConfig type=file accept=application/json style=display:none></label></div></div></div></section></div></div></div><div class="hidden app-window"id=win-appinstaller style=left:15vw;top:20vh;width:500px;height:400px data-app=appinstaller><div class=window-header><div class=win-emoji draggable=true>📦</div><div class=win-title>App Installer</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body pad"style=display:flex;flex-direction:column;gap:10px><input id=appName class=input placeholder="App Name"> <input id=appEmoji class=input placeholder="Emoji Icon (e.g. 🚀)"maxlength=2><textarea id=appHtml placeholder="Paste HTML code here"class=input style=height:100px></textarea><input id=appFile type=file accept=.html,.htm><button class=btn id=addApp>Add App</button></div></div><div class="hidden app-window"id=win-tips style=left:10vw;top:10vh;width:800px;height:600px data-app=tips><div class=window-header><div class=win-emoji draggable=true>📖</div><div class=win-title>Tips</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body pad"style=overflow:auto><h1>MeowOS User Manual</h1><h2>1. Getting Started</h2><p>After completing the Out-of-Box Experience (OOBE), where you set your name, theme, and time zone, you'll see a welcome animation before arriving at the desktop.<h2>2. Desktop Interface</h2><ul><li><strong>Top Bar:</strong> Click "Hello" to open the Start menu. Click the clock to view notifications.<li><strong>Dock:</strong> Bottom or left (configurable). Pinned apps here. Drag from Start to Dock to pin, from Dock to desktop to unpin. Dock scrolls if too many items.<li><strong>Shortcuts:</strong> On desktop. Drag apps from Start or files from Files app to create. Right-click to remove.<li><strong>Widgets:</strong> Clock and Calendar. Enable in Settings > Desktop & Dock. Draggable on desktop.</ul><h2>3. Start Menu</h2><ul><li><strong>Pinned:</strong> Quick access apps.<li><strong>All Apps:</strong> Full list, including custom.<li><strong>Recent Files:</strong> Last opened/created files.</ul><h2>4. Windows and Navigation</h2><ul><li>Drag header to move windows.<li>Resize from any corner or edge.<li>Minimize, maximize, close buttons.<li>Double-click header to maximize/restore.</ul><h2>5. Built-in Apps</h2><ul><li><strong>Notes:</strong> Simple text editor, auto-saves.<li><strong>Calendar:</strong> Monthly view, navigate months.<li><strong>Browser:</strong> Enter URL/search, back/forward/reload, zoom, open external, proxy for blocked sites.<li><strong>Files:</strong> Upload folders, create text files, edit/view text/images/audio/videos, save/download.<li><strong>Recorder:</strong> Record audio, save to Files.<li><strong>Paint:</strong> Draw with brush size/color, clear, save to Files.<li><strong>Calculator:</strong> Basic arithmetic operations.<li><strong>Settings:</strong> Customize profile, appearance, desktop, browser, view installed apps, system info/reset/backup/recovery.<li><strong>App Installer:</strong> Add custom HTML-based apps.<li><strong>Tips:</strong> This manual.<li><strong>Themes:</strong> Create, apply, export/import themes: font, size, colors, wallpaper, time-based wallpaper.</ul><h2>6. Spotlight Search</h2><p>Press Ctrl+S (or Cmd+S on Mac) to open. Search for apps to launch, or use /meowai for queries like time, date, weather in cities.<h2>7. Customization in Settings</h2><ul><li><strong>Profile:</strong> Change display name.<li><strong>Appearance:</strong> Theme, text size, accent color, wallpaper, reduce transparency/blur/motion, high contrast, screensaver.<li><strong>Desktop & Dock:</strong> 24-hour clock, time zone, dock position, enable widgets.<li><strong>Browser:</strong> Search engine, home page, proxy mode, block popups, clear history.<li><strong>Apps:</strong> List and delete custom apps.<li><strong>System:</strong> About, factory reset, recovery mode, export/import settings.</ul><h2>8. Other Features</h2><ul><li><strong>Notifications:</strong> View via clock, shows messages like "Saved!".<li><strong>Drag and Drop:</strong> Apps/files to desktop/dock.<li><strong>Local Storage:</strong> All data (notes, files, settings) stored in browser localStorage.<li><strong>Screensaver:</strong> Enable in Settings, activates after idle timeout with black overlay.<li><strong>Recovery Mode:</strong> Access via Ctrl+Alt+R during OOBE or from Settings. Options for factory reset, disable animations, disable glass effects.<li><strong>Themes App:</strong> Customize and share themes including time-based wallpapers.</ul><p>For more help, explore or reset in Settings.</div></div><div class="hidden app-window"id=win-themes style=left:25vw;top:20vh;width:600px;height:500px data-app=themes><div class=window-header><div class=win-emoji draggable=true>🖌️</div><div class=win-title>Themes</div><div class=window-actions><button class="win-btn win-min"title=Minimize></button><button class="win-btn win-max"title=Maximize></button><button class="win-btn win-close"title=Close></button></div></div><div class="window-body pad"style=overflow:auto><h2>Create Theme</h2><div class=section><label>Font Family</label><input id=themeFont class=input placeholder=ui-sans-serif,system-ui,...></div><div class=section><label>Font Size Scale</label><input id=themeFontSize type=range value=1 max=1.5 min=0.8 step=0.1><div style=text-align:center;color:var(--muted) id=fontSizeValue>1.0x</div></div><div class="section settings-row"><h3>Background Color</h3><input id=themeBg type=color value=#0b0f17></div><div class="section settings-row"><h3>Text Color</h3><input id=themeText type=color value=#e6ecff></div><div class="section settings-row"><h3>Accent Color</h3><input id=themeAccent type=color value=#8a9bff></div><div class=section><label>Wallpaper</label><input id=themeWall type=file accept=image/*></div><div class=section><h3>Time-based Wallpaper</h3><label><input id=themeTimeBased type=checkbox> Enable</label><div style=display:none id=timeWalls><div>Night (22-6): <input id=wallNight type=file accept=image/*></div><div>Morning (6-12): <input id=wallMorning type=file accept=image/*></div><div>Day (12-18): <input id=wallDay type=file accept=image/*></div><div>Evening (18-22): <input id=wallEvening type=file accept=image/*></div></div></div><div class=row><button class=btn id=applyTheme>Apply</button><button class="btn secondary"id=exportTheme>Export JSON</button><label style=display:inline-block;cursor:pointer class="btn secondary">Import JSON <input id=importTheme type=file accept=application/json style=display:none></label></div></div></div><div class=dock id=dock></div><div class=hidden id=contextMenu><div class=context-item id=removeShortcut>Remove</div></div><div class="hidden dialog-overlay"id=dialogTemplate><div class=dialog-card><h3 id=dialogTitle></h3><p id=dialogMessage><div class=dialog-buttons><button class="btn secondary"id=dialogCancel>Cancel</button><button class=btn id=dialogConfirm>Confirm</button></div></div></div><div class=hidden id=notifCenter><div id=notifsList></div></div><div class="hidden overlay"id=spotlight><div class=card><input id=spotlightInput class=input placeholder="Search apps or /meowai query"><div id=spotlightResults></div></div></div><div id=screensaver-overlay></div><div class="hidden overlay"id=recovery><div class=card><h1>Recovery Mode</h1><button class=btn id=recReset>Factory Reset</button><button class="btn secondary"id=recNoAnim>Disable Animations</button><button class="btn secondary"id=recNoGlass>Disable Glass Effects</button><button class="btn secondary"id=recBack>Back</button></div></div></div><script>const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const store = {
      get(k, def=null){ try { const v = localStorage.getItem(k); return v==null? def : JSON.parse(v); } catch { return def; } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
      del(k){ localStorage.removeItem(k); }
    };

    const K = {
      setup: 'meowos_setup',
      name: 'meowos_name',
      notes: 'meowos_notes',
      files: 'meowos_files',
      wallpaper: 'meowos_wallpaper',
      clock24: 'meowos_clock24',
      accent: 'meowos_accent',
      scale: 'meowos_scale',
      dock: 'meowos_dockpos',
      theme: 'meowos_theme',
      pinned: 'meowos_pinned',
      shortcuts: 'meowos_shortcuts',
      blur: 'meowos_blur',
      reduce: 'meowos_reduce',
      search: 'meowos_search',
      home: 'meowos_home',
      proxy: 'meowos_proxy',
      blockPopups: 'meowos_blockpopups',
      reduceMotion: 'meowos_reduce_motion',
      highContrast: 'meowos_high_contrast',
      customApps: 'meowos_customapps',
      clockWidget: 'meowos_clockwidget',
      calendarWidget: 'meowos_calendarwidget',
      tz: 'meowos_tz',
      screensaverEnable: 'meowos_screensaver_enable',
      screensaverTimeout: 'meowos_screensaver_timeout',
      fontFamily: 'meowos_fontfamily',
      timeBasedWall: 'meowos_timebasedwall'
    };

    const apps = ['notes', 'calendar', 'browser', 'files', 'recorder', 'paint', 'calculator', 'settings', 'appinstaller', 'tips', 'themes'];

    function getEmoji(app) {
      const map = {notes: '🗒️', calendar: '📅', browser: '🌐', files: '📁', recorder: '🎙️', paint: '🎨', calculator: '🧮', settings: '⚙️', appinstaller: '📦', tips: '📖', themes: '🖌️'};
      if (app.startsWith('custom_')) {
        const customs = store.get(K.customApps, []);
        const c = customs.find(c => c.id === app.slice(7));
        return c ? c.emoji : '❓';
      }
      return map[app] || '❓';
    }
    function getLabel(app) {
      if (app.startsWith('custom_')) {
        const customs = store.get(K.customApps, []);
        const c = customs.find(c => c.id === app.slice(7));
        return c ? c.name : 'Unknown';
      }
      return app.charAt(0).toUpperCase() + app.slice(1);
    }

    let zTop = 10;
    let dragElement = null, dragOffsetX = 0, dragOffsetY = 0;

    let clockWidget = null;
    let calendarWidget = null;

    let lastMidnight = null;

    let idleTimer;

    function resetIdleTimer() {
      clearTimeout(idleTimer);
      $('#screensaver-overlay').style.display = 'none';
      if (store.get(K.screensaverEnable, false)) {
        const timeout = store.get(K.screensaverTimeout, 5) * 60000;
        idleTimer = setTimeout(() => {
          $('#screensaver-overlay').style.display = 'block';
        }, timeout);
      }
    }

    function showDesktop(){
      $('#onboarding').classList.add('hidden');
      $('#loading').classList.add('hidden');
      $('#desktop').classList.remove('hidden');
      const name = store.get(K.name, 'Friend');
      $('#hello').textContent = `😺 Welcome, ${name}!`;
      $('#startUser').textContent = name;

      const clock = $('#clock');
      const tz = store.get(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
      const update = ()=>{
        const d = new Date();
        const opts = {hour:'2-digit', minute:'2-digit', timeZone: tz};
        if(store.get(K.clock24, false)) opts.hourCycle = 'h23';
        clock.textContent = d.toLocaleTimeString([], opts);

        const timeStr = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hourCycle: 'h23', timeZone: tz});
        const currentDate = d.toLocaleString([], {timeZone: tz, year:'numeric', month:'numeric', day:'numeric'});
        if (timeStr === '00:00' && lastMidnight !== currentDate) {
          flash('🐱💤');
          lastMidnight = currentDate;
        }
      };
      update(); setInterval(update, 1000*30);

      const wp = store.get(K.wallpaper, null);
      if(wp){
        document.body.style.backgroundImage = `url(${wp})`;
        document.body.style.backgroundSize = 'cover';
      } else {
        const timeBased = store.get(K.timeBasedWall, {enabled: false});
        if(timeBased.enabled){
          const d = new Date();
          const hour = parseInt(d.toLocaleString([], {hour: 'numeric', hourCycle: 'h23', timeZone: tz}));
          let key;
          if (hour >= 22 || hour < 6) key = 'night';
          else if (hour < 12) key = 'morning';
          else if (hour < 18) key = 'day';
          else key = 'evening';
          const url = timeBased[key];
          if(url){
            const img = new Image();
            img.src = url;
            img.onload = () => {
              document.body.style.backgroundImage = `url(${url})`;
              document.body.style.backgroundSize = 'cover';
            };
          }
        }
      }

      if(store.get(K.theme, 'dark') === 'light') document.body.classList.add('light');

      const scale = store.get(K.scale, 1);
      document.documentElement.style.setProperty('--font-scale', scale);

      const font = store.get(K.fontFamily, null);
      if(font) document.documentElement.style.setProperty('--font-family', font);

      const dockPos = store.get(K.dock, 'bottom');
      if(dockPos === 'left') document.body.classList.add('dock-left');

      const accent = store.get(K.accent, '#8a9bff');
      document.documentElement.style.setProperty('--accent', accent);

      const blur = store.get(K.blur, 10);
      document.documentElement.style.setProperty('--blur', `saturate(140%) blur(${blur}px)`);

      document.body.classList.toggle('no-glass', !!store.get(K.reduce, false));

      document.body.classList.toggle('reduce-motion', !!store.get(K.reduceMotion, false));
      document.body.classList.toggle('high-contrast', !!store.get(K.highContrast, false));

      buildStartMenu();
      renderDock();
      renderShortcuts();

      toggleClockWidget(store.get(K.clockWidget, false));
      toggleCalendarWidget(store.get(K.calendarWidget, false));

      document.addEventListener('mousemove', resetIdleTimer);
      document.addEventListener('keydown', resetIdleTimer);
      document.addEventListener('touchstart', resetIdleTimer);
      resetIdleTimer();
    }

    function toggleClockWidget(enable) {
      if (clockWidget) clockWidget.remove();
      if (!enable) return;
      clockWidget = document.createElement('div');
      clockWidget.style.position = 'absolute';
      clockWidget.style.top = '60px';
      clockWidget.style.right = '20px';
      clockWidget.style.background = 'var(--glass)';
      clockWidget.style.backdropFilter = 'var(--blur)';
      clockWidget.style.border = '1px solid rgba(255,255,255,.12)';
      clockWidget.style.borderRadius = '12px';
      clockWidget.style.padding = '10px';
      clockWidget.style.boxShadow = 'var(--shadow)';
      clockWidget.style.zIndex = '100';
      clockWidget.style.width = '120px';
      clockWidget.style.textAlign = 'center';
      const time = document.createElement('div');
      time.style.fontSize = '24px';
      time.style.fontWeight = 'bold';
      clockWidget.appendChild(time);
      const updateTime = () => {
        const d = new Date();
        const tz = store.get(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
        const opts = {hour:'2-digit', minute:'2-digit', timeZone: tz};
        if(store.get(K.clock24, false)) opts.hourCycle = 'h23';
        time.textContent = d.toLocaleTimeString([], opts);
      };
      updateTime();
      setInterval(updateTime, 60000);
      $('#desktop').appendChild(clockWidget);
      makeWidgetDraggable(clockWidget);
    }

    function toggleCalendarWidget(enable) {
      if (calendarWidget) calendarWidget.remove();
      if (!enable) return;
      calendarWidget = document.createElement('div');
      calendarWidget.style.position = 'absolute';
      calendarWidget.style.top = '120px';
      calendarWidget.style.right = '20px';
      calendarWidget.style.background = 'var(--glass)';
      calendarWidget.style.backdropFilter = 'var(--blur)';
      calendarWidget.style.border = '1px solid rgba(255,255,255,.12)';
      calendarWidget.style.borderRadius = '12px';
      calendarWidget.style.padding = '10px';
      calendarWidget.style.boxShadow = 'var(--shadow)';
      calendarWidget.style.zIndex = '100';
      calendarWidget.style.width = '210px';
      calendarWidget.style.textAlign = 'center';
      const month = document.createElement('div');
      month.style.textAlign = 'center';
      month.style.fontWeight = 'bold';
      calendarWidget.appendChild(month);
      const grid = document.createElement('div');
      grid.style.display = 'grid';
      grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
      grid.style.gap = '2px';
      calendarWidget.appendChild(grid);
      const updateCal = () => {
        const d = new Date();
        const tz = store.get(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
        month.textContent = d.toLocaleString(undefined, {month:'long', year:'numeric', timeZone: tz});
        grid.innerHTML = '';
        ['M','T','W','T','F','S','S'].forEach(day => {
          const dh = document.createElement('div');
          dh.textContent = day;
          dh.style.textAlign = 'center';
          dh.style.color = 'var(--muted)';
          grid.appendChild(dh);
        });
        const first = new Date(d.toLocaleString('en-us', {timeZone: tz, year:'numeric', month:'numeric', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'}));
        first.setDate(1);
        const offset = (first.getDay() + 6) % 7;
        for(let i=0; i<offset; i++) {
          const empty = document.createElement('div');
          grid.appendChild(empty);
        }
        const daysInMonth = new Date(first.getFullYear(), first.getMonth()+1, 0).getDate();
        for(let day=1; day<=daysInMonth; day++) {
          const dd = document.createElement('div');
          dd.textContent = day;
          dd.style.textAlign = 'center';
          if(day === d.getDate()) {
            dd.style.background = 'var(--accent)';
            dd.style.color = '#fff';
          }
          dd.style.borderRadius = '50%';
          dd.style.width = '24px';
          dd.style.height = '24px';
          dd.style.lineHeight = '24px';
          dd.style.margin = 'auto';
          grid.appendChild(dd);
        }
      };
      updateCal();
      $('#desktop').appendChild(calendarWidget);
      makeWidgetDraggable(calendarWidget);
    }

    function makeWidgetDraggable(widget) {
      let dragging = false, sx=0, sy=0, startX=0, startY=0;
      widget.addEventListener('mousedown', e => {
        if (e.button !== 0) return;
        dragging = true;
        widget.style.cursor = 'grabbing';
        const rect = widget.getBoundingClientRect();
        sx = rect.left; sy = rect.top;
        startX = e.clientX; startY = e.clientY;
        e.preventDefault();
        e.stopPropagation();
      });
      window.addEventListener('mousemove', e => {
        if(!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        widget.style.left = (sx + dx) + 'px';
        widget.style.top = (sy + dy) + 'px';
        widget.style.right = 'auto';
      });
      window.addEventListener('mouseup', () => {
        dragging = false;
        widget.style.cursor = 'default';
      });
    }

    function startOnboarding(){
      $('#onboarding').classList.remove('hidden');
      $('#ob-step-1').classList.remove('hidden');
      $('#ob-step-2').classList.add('hidden');
      $('#ob-step-3').classList.add('hidden');
      $('#ob-step-4').classList.add('hidden');
      const currentTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      $('#obTimeZone').value = currentTz;
      if(!$('#obTimeZone').querySelector(`option[value="${currentTz}"]`)) {
        const opt = document.createElement('option');
        opt.value = currentTz;
        opt.textContent = currentTz;
        $('#obTimeZone').appendChild(opt);
        $('#obTimeZone').value = currentTz;
      }
    }

    function makeDraggable(win){
      const header = $('.window-header', win);
      let startX=0,startY=0, sx=0, sy=0, dragging=false;

      header.addEventListener('mousedown', (e)=>{
        const tag = e.target.tagName;
        if (['INPUT','TEXTAREA','SELECT','BUTTON','LABEL','A'].includes(tag) || e.target.closest('.toolbar')) return;
        if(e.target.classList.contains('win-btn') || e.target.closest('.win-emoji')) return;
        dragging = true; header.style.cursor='grabbing';
        const rect = win.getBoundingClientRect();
        sx = rect.left; sy = rect.top; startX = e.clientX; startY = e.clientY;
        bringToFront(win);
        e.preventDefault();
      });

      window.addEventListener('mousemove', (e)=>{
        if(!dragging) return;
        const dx = e.clientX - startX; const dy = e.clientY - startY;
        win.style.left = Math.max(6, sx + dx) + 'px';
        win.style.top  = Math.max(6, sy + dy) + 'px';
      });
      window.addEventListener('mouseup', ()=>{ dragging=false; header.style.cursor='grab'; });

      header.addEventListener('dblclick', ()=> toggleMaximize(win));

      win.addEventListener('mousedown', ()=> bringToFront(win));

      const [minBtn, maxBtn, closeBtn] = $$('.win-btn', win);
      if(minBtn) minBtn.addEventListener('click', ()=> minimizeWindow(win));
      if(maxBtn) maxBtn.addEventListener('click', ()=> toggleMaximize(win));
      if(closeBtn) closeBtn.addEventListener('click', ()=> closeWindow(win));

      const emoji = $('.win-emoji', win);
      if (emoji) {
        emoji.addEventListener('dragstart', (e)=>{
          e.dataTransfer.setData('text', JSON.stringify({from:'window', app: win.dataset.app}));
        });
      }
      addResizers(win);
    }

    function addResizers(win) {
      const directions = [
        {pos: 'top-left', cursor: 'nwse-resize', dx: -1, dy: -1, width:'10px', height:'10px', top:'-5px', left:'-5px'},
        {pos: 'top-right', cursor: 'nesw-resize', dx: 1, dy: -1, width:'10px', height:'10px', top:'-5px', right:'-5px'},
        {pos: 'bottom-left', cursor: 'nesw-resize', dx: -1, dy: 1, width:'10px', height:'10px', bottom:'-5px', left:'-5px'},
        {pos: 'bottom-right', cursor: 'nwse-resize', dx: 1, dy: 1, width:'10px', height:'10px', bottom:'-5px', right:'-5px'},
        {pos: 'top', cursor: 'ns-resize', dx: 0, dy: -1, width:'calc(100% + 10px)', height:'10px', top:'-5px', left:'-5px'},
        {pos: 'bottom', cursor: 'ns-resize', dx: 0, dy: 1, width:'calc(100% + 10px)', height:'10px', bottom:'-5px', left:'-5px'},
        {pos: 'left', cursor: 'ew-resize', dx: -1, dy: 0, width:'10px', height:'calc(100% + 10px)', left:'-5px', top:'-5px'},
        {pos: 'right', cursor: 'ew-resize', dx: 1, dy: 0, width:'10px', height:'calc(100% + 10px)', right:'-5px', top:'-5px'},
      ];
      directions.forEach(dir => {
        const resizer = document.createElement('div');
        resizer.className = `resizer ${dir.pos}`;
        resizer.style.cursor = dir.cursor;
        resizer.style.width = dir.width;
        resizer.style.height = dir.height;
        resizer.style.position = 'absolute';
        resizer.style.userSelect = 'none';
        if (dir.top) resizer.style.top = dir.top;
        if (dir.bottom) resizer.style.bottom = dir.bottom;
        if (dir.left) resizer.style.left = dir.left;
        if (dir.right) resizer.style.right = dir.right;
        win.appendChild(resizer);
        let resizing = false, startX, startY, startWidth, startHeight, startLeft, startTop;
        resizer.addEventListener('mousedown', e => {
          resizing = true;
          startX = e.clientX;
          startY = e.clientY;
          startWidth = parseInt(getComputedStyle(win).width, 10);
          startHeight = parseInt(getComputedStyle(win).height, 10);
          startLeft = win.getBoundingClientRect().left;
          startTop = win.getBoundingClientRect().top;
          e.preventDefault();
        });
        window.addEventListener('mousemove', e => {
          if (!resizing) return;
          if (dir.dx !== 0) {
            if (dir.dx === -1) {
              const newWidth = startWidth - (e.clientX - startX);
              if (newWidth > 200) {
                win.style.width = newWidth + 'px';
                win.style.left = startLeft + (e.clientX - startX) + 'px';
              }
            } else {
              const newWidth = startWidth + (e.clientX - startX);
              if (newWidth > 200) win.style.width = newWidth + 'px';
            }
          }
          if (dir.dy !== 0) {
            if (dir.dy === -1) {
              const newHeight = startHeight - (e.clientY - startY);
              if (newHeight > 150) {
                win.style.height = newHeight + 'px';
                win.style.top = startTop + (e.clientY - startY) + 'px';
              }
            } else {
              const newHeight = startHeight + (e.clientY - startY);
              if (newHeight > 150) win.style.height = newHeight + 'px';
            }
          }
        });
        window.addEventListener('mouseup', () => { resizing = false; });
      });
    }
    function bringToFront(win){ win.style.zIndex = ++zTop; dockMarkOpen(win.dataset.app, true); }
    function openWindow(app){ 
      if (app.startsWith('custom_')) {
        openCustom(app.slice(7));
        return;
      }
      const win = $(`#win-${app}`); if(!win) return; win.classList.remove('hidden','minimized'); bringToFront(win); 
    }
    function minimizeWindow(win){ win.classList.add('minimized'); dockMarkOpen(win.dataset.app, false); }
    function closeWindow(win){ win.classList.add('hidden'); dockMarkOpen(win.dataset.app, false); }
    function toggleMaximize(win){
      if(win.dataset.max === '1'){
        win.style.left = win.dataset.x; win.style.top = win.dataset.y; win.style.width = win.dataset.w; win.style.height = win.dataset.h; win.dataset.max = '0';
      } else {
        const rect = win.getBoundingClientRect();
        win.dataset.x = rect.left + 'px'; win.dataset.y = rect.top + 'px'; win.dataset.w = rect.width + 'px'; win.dataset.h = rect.height + 'px';
        win.style.left = '6px'; win.style.top = '6px';
        win.style.width = (window.innerWidth - 12) + 'px';
        win.style.height = (window.innerHeight - 78) + 'px';
        win.dataset.max = '1';
      }
      bringToFront(win);
    }
    function dockMarkOpen(app, isOpen){ const btn = $(`.dock-item[data-open="${app}"]`); if(btn){ btn.classList.toggle('open', isOpen); } }

    function buildStartMenu() {
      const pinnedPref = store.get(K.pinned, null) ?? null;
      const defaultPins = ['notes','files','browser','settings'];
      if (pinnedPref === null) store.set(K.pinned, defaultPins);

      const pins = store.get(K.pinned, defaultPins);
      const pinWrap = $('#startPinned'); pinWrap.innerHTML = '';
      pins.forEach(app=>{
        const b = document.createElement('div');
        b.className = 'start-item'; b.draggable = true;
        b.innerHTML = `<div class="start-emoji">${getEmoji(app)}</div><div class="start-label">${getLabel(app)}</div>`;
        b.addEventListener('click', ()=> openWindow(app));
        b.addEventListener('dragstart', e => e.dataTransfer.setData('text', JSON.stringify({from:'start', app})));
        pinWrap.appendChild(b);
      });

      const allWrap = $('#startAll'); allWrap.innerHTML = '';
      apps.forEach(app=>{
        const b = document.createElement('div');
        b.className = 'start-item'; b.draggable = true;
        b.innerHTML = `<div class="start-emoji">${getEmoji(app)}</div><div class="start-label">${getLabel(app)}</div>`;
        b.addEventListener('click', ()=> openWindow(app));
        b.addEventListener('dragstart', e => e.dataTransfer.setData('text', JSON.stringify({from:'start', app})));
        allWrap.appendChild(b);
      });

      const customs = store.get(K.customApps, []);
      customs.forEach(c => {
        const b = document.createElement('div');
        b.className = 'start-item'; b.draggable = true;
        b.innerHTML = `<div class="start-emoji">${c.emoji}</div><div class="start-label">${c.name}</div>`;
        b.addEventListener('click', () => openWindow('custom_' + c.id));
        b.addEventListener('dragstart', e => e.dataTransfer.setData('text', JSON.stringify({from: 'start', app: 'custom_' + c.id})));
        allWrap.appendChild(b);
      });

      const recWrap = $('#startRecents'); recWrap.innerHTML = '';
      const files = loadFilesStore();
      Object.keys(files).slice(-8).reverse().forEach(name=>{
        const entry = files[name];
        const icon = entry.type==='text'?'📄': entry.type==='image'?'🖼️': entry.type==='audio'?'🎵':'🎞️';
        const item = document.createElement('div');
        item.className='recent';
        item.innerHTML = `<div class="icon">${icon}</div><div class="name">${name}</div>`;
        item.addEventListener('click', ()=>{ openWindow('files'); openCreatedFile(name); });
        recWrap.appendChild(item);
      });
    }

    $('#hello').addEventListener('click', () => {
      $('#startMenu').classList.toggle('hidden');
    });
    document.addEventListener('click', e => {
      const sm = $('#startMenu'), hello = $('#hello');
      if(!sm.contains(e.target) && !hello.contains(e.target)) sm.classList.add('hidden');
      const nc = $('#notifCenter'), clock = $('#clock');
      if(!nc.contains(e.target) && !clock.contains(e.target)) nc.classList.add('hidden');
    });

    function renderDock() {
      let pinned = store.get(K.pinned, null);
      if (pinned === null) { pinned = ['notes','files','browser','settings']; store.set(K.pinned, pinned); }
      const dock = $('#dock'); dock.innerHTML = '';
      pinned.forEach(app => {
        const item = document.createElement('button');
        item.className = 'dock-item';
        item.dataset.open = app;
        item.innerHTML = `<div class="dock-emoji">${getEmoji(app)}</div><div class="dock-label">${getLabel(app)}</div><div class="dot"></div>`;
        item.addEventListener('click', () => openWindow(app));
        item.draggable = true;
        item.addEventListener('dragstart', e => e.dataTransfer.setData('text', JSON.stringify({from: 'dock', app})));
        dock.appendChild(item);
      });
    }

    function renderShortcuts() {
      $$('.shortcut').forEach(e => e.remove());
      const shortcuts = store.get(K.shortcuts, []);
      shortcuts.forEach((s, i) => {
        const icon = document.createElement('button');
        icon.className = 'dock-item shortcut';
        icon.style.position = 'absolute';
        icon.style.left = s.x + 'px';
        icon.style.top = s.y + 'px';
        icon.style.minWidth = 'auto';
        icon.dataset.index = i;
        icon.innerHTML = `<div class="dock-emoji">${s.type === 'app' ? getEmoji(s.id) : '📄'}</div><div class="dock-label">${s.type === 'app' ? getLabel(s.id) : s.id}</div>`;
        icon.addEventListener('click', () => { 
          if (s.type === 'app') openWindow(s.id);
          else { openWindow('files'); openCreatedFile(s.id); }
        });
        icon.addEventListener('mousedown', e => {
          dragElement = icon;
          const rect = icon.getBoundingClientRect();
          dragOffsetX = e.clientX - rect.left;
          dragOffsetY = e.clientY - rect.top;
          e.preventDefault();
        });
        icon.addEventListener('contextmenu', e => {
          e.preventDefault(); showContextMenu(e.clientX, e.clientY, icon);
        });
        $('#desktop').appendChild(icon);
      });
    }

    function addShortcut(type, id, x, y) { let shortcuts = store.get(K.shortcuts, []); shortcuts.push({type, id, x, y}); store.set(K.shortcuts, shortcuts); renderShortcuts(); }
    function updateShortcutPosition(i, x, y) { let shortcuts = store.get(K.shortcuts, []); shortcuts[i].x = parseInt(x); shortcuts[i].y = parseInt(y); store.set(K.shortcuts, shortcuts); }
    function removeShortcut(i) { let shortcuts = store.get(K.shortcuts, []); shortcuts.splice(i, 1); store.set(K.shortcuts, shortcuts); renderShortcuts(); }
    function unpinApp(app) { let pinned = store.get(K.pinned, ['notes','files','browser','settings']); pinned = pinned.filter(a => a !== app); store.set(K.pinned, pinned); renderDock(); buildStartMenu(); }

    function showContextMenu(x, y, target) {
      const menu = $('#contextMenu');
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.classList.remove('hidden');
      $('#removeShortcut').addEventListener('click', () => {
        showCustomConfirm('Remove Shortcut', 'Remove this shortcut?', () => { removeShortcut(target.dataset.index); });
        menu.classList.add('hidden');
      }, {once: true});
    }
    document.addEventListener('click', () => $('#contextMenu').classList.add('hidden'));

    function showCustomConfirm(title, message, onConfirm) {
      const dialog = $('#dialogTemplate');
      $('#dialogTitle').textContent = title;
      $('#dialogMessage').textContent = message;
      dialog.classList.remove('hidden');
      $('#dialogCancel').addEventListener('click', () => dialog.classList.add('hidden'), {once: true});
      $('#dialogConfirm').addEventListener('click', () => { onConfirm(); dialog.classList.add('hidden'); }, {once: true});
    }

    function initNotes(){ const ta = $('#notesText'); ta.value = store.get(K.notes, ''); let t; ta.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(()=> store.set(K.notes, ta.value), 250); }); }

    let calDate = new Date();
    function renderCalendar(){
      const grid = $('#calGrid'); grid.innerHTML = '';
      const m = calDate.getMonth(), y = calDate.getFullYear();
      $('#calMonth').textContent = calDate.toLocaleString(undefined, {month:'long', year:'numeric'});
      const first = new Date(y, m, 1);
      const startOffset = (first.getDay()+6)%7;
      const daysInMonth = new Date(y, m+1, 0).getDate();
      for(let i=0;i<startOffset;i++) grid.appendChild(document.createElement('div'));
      const today = new Date();
      for(let d=1; d<=daysInMonth; d++){
        const cell = document.createElement('div'); cell.className='day'; cell.textContent = d;
        if(d===today.getDate() && m===today.getMonth() && y===today.getFullYear()) cell.classList.add('today');
        grid.appendChild(cell);
      }
    }

    const BLOCKED_HOSTS = new Set([
      'google.com','www.google.com','accounts.google.com',
      'youtube.com','www.youtube.com','youtu.be',
      'facebook.com','www.facebook.com','instagram.com','www.instagram.com',
      'twitter.com','www.twitter.com','x.com','t.co',
      'linkedin.com','www.linkedin.com','tiktok.com','www.tiktok.com',
      'openai.com','www.openai.com','paypal.com','www.paypal.com',
      'bing.com','www.bing.com','duckduckgo.com','www.duckduckgo.com'
    ]);

    function readerProxy(u){ return 'https://r.jina.ai/http/' + u.replace(/^https?:\/\//i, ' '); }

    function selectEmbedUrl(raw){
      const mode = store.get(K.proxy, 'auto');
      try{
        const url = new URL(raw);
        if(mode === 'always') return readerProxy(url.href);
        if(mode === 'off') return url.href;
        if(BLOCKED_HOSTS.has(url.hostname)) return readerProxy(url.href);
        return url.href;
      }catch{ return raw; }
    }

    const SEARCH_ENGINES = {
      ddg: q => `https://duckduckgo.com/?q=${encodeURIComponent(q)}`,
      google: q => `https://www.google.com/search?q=${encodeURIComponent(q)}`,
      bing: q => `https://www.bing.com/search?q=${encodeURIComponent(q)}`,
      brave: q => `https://search.brave.com/search?q=${encodeURIComponent(q)}`,
      wikipedia: q => `https://en.wikipedia.org/w/index.php?search=${encodeURIComponent(q)}`
    };

    function isLikelyUrl(v){ return /^https?:\/\//i.test(v) || (v.includes('.') && !v.includes(' ')); }

    function normalizeUrl(input){
      const v = (input || '').trim();
      if(!v) return store.get(K.home, 'https://duckduckgo.com');
      if(isLikelyUrl(v)) return /^https?:\/\//i.test(v) ? v : 'https://' + v;
      const engine = store.get(K.search, 'ddg');
      const builder = SEARCH_ENGINES[engine] || SEARCH_ENGINES.ddg;
      return builder(v);
    }

    let browserHistory = []; let browserIndex = -1; let browserZoom = 100;

    function applyBrowserSandbox(){
      const frame = $('#webview');
      const block = store.get(K.blockPopups, true);
      let sandbox = 'allow-same-origin allow-scripts allow-forms';
      if(!block) sandbox += ' allow-popups allow-popups-to-escape-sandbox';
      frame.setAttribute('sandbox', sandbox);
    }

    function initBrowser(){
      const input = $('#url'); const go = $('#go'); const frame = $('#webview');
      const zoomOut = $('#zoomOut'); const zoomIn = $('#zoomIn'); const zoomLevel = $('#zoomLevel');

      applyBrowserSandbox();

      const updateZoom = ()=>{ frame.style.zoom = browserZoom + '%'; zoomLevel.textContent = browserZoom + '%'; };
      zoomOut.addEventListener('click', ()=>{ browserZoom = Math.max(50, browserZoom - 25); updateZoom(); });
      zoomIn.addEventListener('click', ()=>{ browserZoom = Math.min(250, browserZoom + 25); updateZoom(); });

      function isYouTubeUrl(u) {
        try {
          const url = new URL(u);
          if (url.hostname.endsWith('youtube.com') || url.hostname.endsWith('youtu.be')) {
            const v = url.searchParams.get('v') || url.pathname.slice(1);
            if (v) return v;
          }
        } catch {}
        return null;
      }
      function isXUrl(u) {
        try {
          const url = new URL(u);
          if (url.hostname.endsWith('x.com') || url.hostname.endsWith('twitter.com')) {
            const parts = url.pathname.split('/');
            if (parts.length >= 4 && parts[2] === 'status') {
              return parts[3];
            }
          }
        } catch {}
        return null;
      }
      function navigate(raw, push=true){
        const urlRaw = normalizeUrl(raw || input.value);
        let target = selectEmbedUrl(urlRaw);
        const ytId = isYouTubeUrl(urlRaw);
        const xId = isXUrl(urlRaw);
        const embedContainer = $('#embedContainer');
        frame.style.display = 'block';
        embedContainer.style.display = 'none';
        if (ytId) {
          target = `https://www.youtube.com/embed/${ytId}`;
        } else if (xId) {
          frame.style.display = 'none';
          embedContainer.style.display = 'block';
          embedContainer.innerHTML = `
            <blockquote class="twitter-tweet">
              <a href="${urlRaw}"></a>
            </blockquote>
          `;
          if (!document.querySelector('script[src="https://platform.twitter.com/widgets.js"]')) {
            const script = document.createElement('script');
            script.src = 'https://platform.twitter.com/widgets.js';
            script.async = true;
            document.body.appendChild(script);
          } else if (typeof twttr !== 'undefined' && twttr.widgets) {
            twttr.widgets.load(embedContainer);
          }
          if (push){ browserHistory = browserHistory.slice(0, browserIndex+1); browserHistory.push(urlRaw); browserIndex = browserHistory.length - 1; }
          input.value = urlRaw;
          return;
        }
        frame.src = target;
        if(push){ browserHistory = browserHistory.slice(0, browserIndex+1); browserHistory.push(urlRaw); browserIndex = browserHistory.length - 1; }
        input.value = urlRaw;

        let settled = false;
        const t = setTimeout(()=>{
          if(!settled){
            try{
              const doc = frame.contentDocument;
              if(doc && (!doc.body || !doc.body.childElementCount)){
                frame.src = readerProxy(urlRaw);
                flash('Site restricted — showing reader view');
              }
            }catch{}
          }
        }, 1200);

        frame.addEventListener('load', ()=>{ settled = true; clearTimeout(t); const current = browserHistory[browserIndex]; if(current) input.value = current; }, {once:true});
      }

      go.addEventListener('click', ()=> navigate($('#url').value));
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') navigate(input.value); });
      $('#back').addEventListener('click', ()=> { if(browserIndex>0){ browserIndex--; const u = browserHistory[browserIndex]; frame.src = selectEmbedUrl(u); $('#url').value = u; } });
      $('#forward').addEventListener('click', ()=>{ if(browserIndex < browserHistory.length -1){ browserIndex++; const u = browserHistory[browserIndex]; frame.src = selectEmbedUrl(u); $('#url').value = u; } });
      $('#reload').addEventListener('click', ()=> { const u = $('#url').value || browserHistory[browserIndex] || store.get(K.home, 'https://duckduckgo.com'); frame.src = selectEmbedUrl(u); });
      $('#openExt').addEventListener('click', ()=> { const url = $('#url').value || browserHistory[browserIndex] || store.get(K.home, 'https://duckduckgo.com'); window.open(url, '_blank'); });

      input.value = store.get(K.home, 'https://duckduckgo.com'); navigate(input.value, true); updateZoom();
    }

    function loadFilesStore(){ return store.get(K.files, {}); }
    function saveFilesStore(obj){ store.set(K.files, obj); }
    const fileState = { currentName: null, isCreated: false, currentType: 'text' };
    function readAsText(file){ return new Promise((res, rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsText(file); }); }
    function readAsDataURL(file){ return new Promise((res, rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
    function renderCreatedList(){
      const files = loadFilesStore(); const list = $('#createdList'); list.innerHTML='';
      Object.keys(files).sort().forEach(name=>{
        const entry = files[name];
        const icon = entry.type==='text'?'📄': entry.type==='image'?'🖼️': entry.type==='audio'?'🎵':'🎞️';
        const btn = document.createElement('div'); btn.className='pill'; btn.textContent = `${icon} ${name}`; btn.title = 'Open';
        btn.addEventListener('click', ()=> openCreatedFile(name));
        btn.draggable = true; btn.addEventListener('dragstart', e => e.dataTransfer.setData('text', JSON.stringify({type:'file', id:name})));
        list.appendChild(btn);
      });
    }
    async function openCreatedFile(name){
      const files = loadFilesStore(); const entry = files[name]; if(!entry) return;
      $('#currentFileName').textContent = name; fileState.currentName = name; fileState.isCreated = true; fileState.currentType = entry.type;
      if(entry.type === 'text'){
        $('#editorArea').style.display = 'block'; $('#viewerWrap').classList.remove('show');
        $('#editorArea').value = entry.text ?? entry.data ?? ''; $('#currentFileIcon').textContent = '📄';
      } else {
        $('#editorArea').style.display = 'none'; $('#viewerWrap').classList.add('show');
        const v = $('#mediaViewer'); v.innerHTML = '';
        if(entry.type === 'image'){ const img = document.createElement('img'); img.src = entry.data; v.appendChild(img); $('#currentFileIcon').textContent = '🖼️'; }
        else if(entry.type === 'audio'){ const a = document.createElement('audio'); a.controls=true; a.src = entry.data; v.appendChild(a); $('#currentFileIcon').textContent = '🎵'; }
        else if(entry.type === 'video'){ const vid = document.createElement('video'); vid.controls=true; vid.src = entry.data; v.appendChild(vid); $('#currentFileIcon').textContent = '🎞️'; }
        else { v.textContent = 'Preview not available.'; $('#currentFileIcon').textContent = '📄'; }
      }
    }
    function saveCurrentFile(){
      if(!fileState.currentName){ alert('No file open.'); return; }
      const files = loadFilesStore();
      if(fileState.isCreated){
        const entry = files[fileState.currentName] || { type: 'text', text: '' };
        if(entry.type === 'text'){
          entry.text = $('#editorArea').value; entry.type = 'text'; files[fileState.currentName] = entry; saveFilesStore(files); renderCreatedList(); flash('Saved!');
        } else { flash('Saved (no overwrite for binary files via editor).'); }
      } else { flash('Uploaded files cannot be overwritten in place. Create a new file to save edits.'); }
    }
    function downloadCurrent(){
      if(!fileState.currentName){ alert('No file open.'); return; }
      const files = loadFilesStore(); const entry = files[fileState.currentName]; if(!entry) return;
      if(entry.type === 'text'){ const blob = new Blob([entry.text||entry.data||''], {type:'text/plain'}); triggerDownload(blob, fileState.currentName); }
      else { const blob = dataURLtoBlob(entry.data); triggerDownload(blob, fileState.currentName); }
    }
    function triggerDownload(blob, name){ const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); setTimeout(()=> URL.revokeObjectURL(a.href), 1500); }
    function dataURLtoBlob(dataurl) { const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n); for (let i=0;i<n;i++) u8arr[i]=bstr.charCodeAt(i); return new Blob([u8arr], {type:mime}); }
    function flash(msg){
      const list = $('#notifsList');
      const t = document.createElement('div');
      t.className = 'notif';
      t.textContent = msg;
      list.prepend(t);
    }
    let currentUploadedFiles = []; let currentUploadedMap = {};
    function initFiles(){
      renderCreatedList();
      $('#createFile').addEventListener('click', ()=>{
        const name = ($('#newFileName').value || '').trim();
        if(!name){ alert('Enter a file name, e.g. notes.txt'); return; }
        const files = loadFilesStore();
        if(files[name]){ alert('That name already exists.'); return; }
        files[name] = { type: 'text', text: '' }; saveFilesStore(files); $('#newFileName').value=''; renderCreatedList(); openCreatedFile(name);
      });
      $('#saveFile').addEventListener('click', saveCurrentFile);
      $('#downloadFile').addEventListener('click', downloadCurrent);

      $('#folderInput').addEventListener('change', async (e)=>{
        currentUploadedFiles = Array.from(e.target.files); if(!currentUploadedFiles.length) return;
        const paths = currentUploadedFiles.map(f=> f.webkitRelativePath || f.name);
        const tree = buildTree(paths); const container = $('#fileTree'); container.innerHTML=''; container.appendChild(tree);
        currentUploadedMap = currentUploadedFiles.reduce((acc, f)=>{ acc[(f.webkitRelativePath||f.name)] = f; return acc; }, {});
        container.addEventListener('click', async (ev)=>{
          const span = ev.target.closest('span.fname'); if(!span) return;
          let path = span.textContent; let parent = span.parentElement.parentElement;
          while(parent && parent !== container){ const li = parent.parentElement; if(!li) break; const label = li.querySelector('span.fname'); if(label) path = label.textContent + '/' + path; parent = li.parentElement; }
          const file = currentUploadedMap[path];
          if(file){
            if(file.type.startsWith('text') || file.name.match(/\.(txt|md|csv|json|html|css|js)$/i)){
              const content = await readAsText(file);
              $('#editorArea').style.display='block'; $('#viewerWrap').classList.remove('show');
              $('#editorArea').value = content; $('#currentFileName').textContent = file.name; $('#currentFileIcon').textContent = '📄';
              fileState.currentName = file.name; fileState.isCreated = false; fileState.currentType='text';
            } else if(file.type.startsWith('image')){
              const data = await readAsDataURL(file);
              $('#editorArea').style.display='none'; $('#viewerWrap').classList.add('show'); $('#mediaViewer').innerHTML = '';
              const img = document.createElement('img'); img.src = data; $('#mediaViewer').appendChild(img);
              $('#currentFileName').textContent = file.name; $('#currentFileIcon').textContent = '🖼️';
              fileState.currentName = file.name; fileState.isCreated = false; fileState.currentType='image';
            } else if(file.type.startsWith('audio')){
              const data = await readAsDataURL(file);
              $('#editorArea').style.display='none'; $('#viewerWrap').classList.add('show'); $('#mediaViewer').innerHTML = '';
              const a = document.createElement('audio'); a.controls=true; a.src=data; $('#mediaViewer').appendChild(a);
              $('#currentFileName').textContent = file.name; $('#currentFileIcon').textContent = '🎵';
              fileState.currentName = file.name; fileState.isCreated = false; fileState.currentType='audio';
            } else if(file.type.startsWith('video')){
              const data = await readAsDataURL(file);
              $('#editorArea').style.display='none'; $('#viewerWrap').classList.add('show'); $('#mediaViewer').innerHTML = '';
              const v = document.createElement('video'); v.controls=true; v.src=data; $('#mediaViewer').appendChild(v);
              $('#currentFileName').textContent = file.name; $('#currentFileIcon').textContent = '🎞️';
              fileState.currentName = file.name; fileState.isCreated = false; fileState.currentType='video';
            } else { alert('Preview not available for this file type.'); }
          }
        });
      });

      $('#importFolder').addEventListener('click', async ()=>{
        if(!currentUploadedFiles.length){ alert('Upload a folder first.'); return; }
        const files = loadFilesStore();
        for(const file of currentUploadedFiles){
          const path = file.webkitRelativePath || file.name;
          if(files[path]){ continue; }
          let entry;
          if(file.type.startsWith('text') || file.name.match(/\.(txt|md|csv|json|html|css|js)$/i)){
            const text = await readAsText(file); const data = await readAsDataURL(file);
            entry = { type: 'text', text, data };
          } else {
            const data = await readAsDataURL(file);
            let type = 'binary';
            if(file.type.startsWith('image')) type = 'image';
            else if(file.type.startsWith('audio')) type = 'audio';
            else if(file.type.startsWith('video')) type = 'video';
            entry = { type, data };
          }
          files[path] = entry;
        }
        saveFilesStore(files); renderCreatedList(); flash('Folder imported to Created Files');
      });
    }

    function initCalculator() {
      let currentInput = ''; const display = $('#calcDisplay');
      function updateDisplay() { display.value = currentInput || '0'; }
      const buttons = ['7','8','9','/','4','5','6','*','1','2','3','-','0','.','=','+','C'];
      const container = $('#calcButtons');
      buttons.forEach(btnText => {
        const btn = document.createElement('button'); btn.className = 'btn secondary'; btn.textContent = btnText;
        btn.addEventListener('click', () => {
          if (btnText === 'C') currentInput = '';
          else if (btnText === '=') { try { currentInput = eval(currentInput).toString(); } catch { currentInput = 'Error'; } }
          else currentInput += btnText;
          updateDisplay();
        });
        container.appendChild(btn);
      });
      updateDisplay();
    }

    function initSettings(){
      function renderInstalledApps() {
        const list = $('#installedAppsList');
        list.innerHTML = '';
        const customs = store.get(K.customApps, []);
        if (!customs.length) {
          list.innerHTML = '<p>No installed apps.</p>';
          return;
        }
        customs.forEach((app, index) => {
          const row = document.createElement('div');
          row.className = 'settings-row';
          row.innerHTML = `<span>${app.emoji} ${app.name}</span>`;
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn secondary';
          deleteBtn.textContent = 'Delete';
          deleteBtn.addEventListener('click', () => {
            showCustomConfirm('Delete App', `Are you sure you want to delete ${app.name}?`, () => {
              customs.splice(index, 1);
              store.set(K.customApps, customs);
              let pinned = store.get(K.pinned, []);
              pinned = pinned.filter(p => p !== 'custom_' + app.id);
              store.set(K.pinned, pinned);
              let shortcuts = store.get(K.shortcuts, []);
              shortcuts = shortcuts.filter(s => !(s.type === 'app' && s.id === 'custom_' + app.id));
              store.set(K.shortcuts, shortcuts);
              renderInstalledApps();
              buildStartMenu();
              renderDock();
              renderShortcuts();
              const win = $('#win-custom-' + app.id);
              if (win) win.remove();
              flash('App deleted');
            });
          });
          row.appendChild(deleteBtn);
          list.appendChild(row);
        });
      }
      renderInstalledApps();
      $('#setName').value = store.get(K.name, '') || '';
      $('#applyName').addEventListener('click', ()=>{ const v = $('#setName').value.trim(); if(!v){ alert('Enter a name'); return; } store.set(K.name, v); $('#hello').textContent = `😺 Welcome, ${v}!`; $('#startUser').textContent = v; flash('Name updated'); });
      $('#wallInput').addEventListener('change', async (e)=>{
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader(); reader.onload = ()=>{ const data = reader.result; store.set(K.wallpaper, data); document.body.style.backgroundImage = `url(${data})`; document.body.style.backgroundSize = 'cover'; flash('Wallpaper updated'); }; reader.readAsDataURL(file);
      });
      $('#resetWallpaper').addEventListener('click', ()=>{ store.del(K.wallpaper); document.body.style.backgroundImage=''; flash('Wallpaper reset'); });

      $('#lightTheme').checked = store.get(K.theme, 'dark') === 'light';
      $('#lightTheme').addEventListener('change', (e)=>{
        const theme = e.target.checked ? 'light' : 'dark';
        store.set(K.theme, theme); document.body.classList.toggle('light', theme === 'light'); flash('Theme updated');
      });

      const scaleSlider = $('#textScale'); const scaleValue = $('#scaleValue');
      scaleSlider.value = store.get(K.scale, 1); scaleValue.textContent = `${scaleSlider.value}x`;
      scaleSlider.addEventListener('input', (e)=>{ const val = e.target.value; document.documentElement.style.setProperty('--font-scale', val); scaleValue.textContent = `${val}x`; });
      scaleSlider.addEventListener('change', (e)=>{ store.set(K.scale, e.target.value); flash('Text scale updated'); });

      $('#clock24h').checked = store.get(K.clock24, false);
      $('#clock24h').addEventListener('change', (e)=>{
        store.set(K.clock24, e.target.checked);
        // Update clock immediately
        const d = new Date(); 
        const tz = store.get(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
        const opts = {hour:'2-digit', minute:'2-digit', timeZone: tz};
        if(e.target.checked) opts.hourCycle = 'h23';
        $('#clock').textContent = d.toLocaleTimeString([], opts); flash('Clock format updated');
      });

      const currentTz = store.get(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
      $('#timeZone').value = currentTz;
      if(!$('#timeZone').querySelector(`option[value="${currentTz}"]`)) {
        const opt = document.createElement('option');
        opt.value = currentTz;
        opt.textContent = currentTz;
        $('#timeZone').appendChild(opt);
        $('#timeZone').value = currentTz;
      }
      $('#timeZone').addEventListener('change', (e)=>{
        store.set(K.tz, e.target.value);
        // Update clock immediately
        const d = new Date(); 
        const opts = {hour:'2-digit', minute:'2-digit', timeZone: e.target.value};
        if(store.get(K.clock24, false)) opts.hourCycle = 'h23';
        $('#clock').textContent = d.toLocaleTimeString([], opts); flash('Time zone updated');
        if(clockWidget) toggleClockWidget(true);
        if(calendarWidget) toggleCalendarWidget(true);
      });

      $('#accentColor').addEventListener('input', (e)=> document.documentElement.style.setProperty('--accent', e.target.value));
      $('#accentColor').addEventListener('change', (e)=>{ store.set(K.accent, e.target.value); flash('Accent color updated'); });

      $('#dockPos').value = store.get(K.dock, 'bottom');
      $('#dockPos').addEventListener('change', (e)=>{ const pos = e.target.value; store.set(K.dock, pos); document.body.classList.toggle('dock-left', pos === 'left'); flash('Dock position updated'); });

      $('#reduceTransparency').checked = !!store.get(K.reduce, false);
      $('#reduceTransparency').addEventListener('change', (e)=>{
        const on = e.target.checked; store.set(K.reduce, on); document.body.classList.toggle('no-glass', on);
        if(on) document.documentElement.style.setProperty('--blur', 'none');
        else document.documentElement.style.setProperty('--blur', `saturate(140%) blur(${store.get(K.blur,10)}px)`);
        flash(on ? 'Transparency disabled' : 'Transparency enabled');
      });

      const blurSlider = $('#blurIntensity'); const blurValue = $('#blurValue');
      blurSlider.value = store.get(K.blur, 10); blurValue.textContent = `${blurSlider.value}px`;
      blurSlider.addEventListener('input', (e)=>{
        const val = e.target.value; if(!store.get(K.reduce,false)) document.documentElement.style.setProperty('--blur', `saturate(140%) blur(${val}px)`); blurValue.textContent = `${val}px`;
      });
      blurSlider.addEventListener('change', (e)=>{ store.set(K.blur, e.target.value); if(!store.get(K.reduce,false)) flash('Blur intensity updated'); });

      $('#searchEngine').value = store.get(K.search, 'ddg');
      $('#searchEngine').addEventListener('change', e => { store.set(K.search, e.target.value); flash('Search engine updated'); });

      $('#homePage').value = store.get(K.home, 'https://duckduckgo.com');
      $('#applyHome').addEventListener('click', ()=>{
        const v = $('#homePage').value.trim();
        if(!v){ alert('Enter a URL'); return; }
        store.set(K.home, /^https?:\/\//i.test(v) ? v : 'https://' + v);
        flash('Homepage updated');
      });

      $('#proxyMode').value = store.get(K.proxy, 'auto');
      $('#proxyMode').addEventListener('change', e => { store.set(K.proxy, e.target.value); flash('Proxy mode updated'); });

      $('#blockPopups').checked = !!store.get(K.blockPopups, true);
      $('#blockPopups').addEventListener('change', e => {
        store.set(K.blockPopups, e.target.checked);
        applyBrowserSandbox();
        flash(e.target.checked ? 'Popups blocked' : 'Popups allowed');
      });

      $('#clearHistory').addEventListener('click', ()=>{ browserHistory = []; browserIndex = -1; flash('Browsing history cleared'); });

      $('#reduceMotion').checked = !!store.get(K.reduceMotion, false);
      $('#reduceMotion').addEventListener('change', e=>{
        store.set(K.reduceMotion, e.target.checked);
        document.body.classList.toggle('reduce-motion', e.target.checked);
        flash(e.target.checked ? 'Motion reduced' : 'Motion enabled');
      });

      $('#highContrast').checked = !!store.get(K.highContrast, false);
      $('#highContrast').addEventListener('change', e=>{
        store.set(K.highContrast, e.target.checked);
        document.body.classList.toggle('high-contrast', e.target.checked);
        flash(e.target.checked ? 'High contrast on' : 'High contrast off');
      });

      $('#screensaverEnable').checked = !!store.get(K.screensaverEnable, false);
      $('#screensaverEnable').addEventListener('change', e=>{
        store.set(K.screensaverEnable, e.target.checked);
        resetIdleTimer();
        flash(e.target.checked ? 'Screensaver enabled' : 'Screensaver disabled');
      });

      $('#screensaverTimeout').value = store.get(K.screensaverTimeout, 5);
      $('#screensaverTimeout').addEventListener('change', e=>{
        store.set(K.screensaverTimeout, parseInt(e.target.value));
        resetIdleTimer();
        flash('Screensaver timeout updated');
      });

      $('#clockWidget').checked = !!store.get(K.clockWidget, false);
      $('#clockWidget').addEventListener('change', e => {
        store.set(K.clockWidget, e.target.checked);
        toggleClockWidget(e.target.checked);
        flash(e.target.checked ? 'Clock widget enabled' : 'Clock widget disabled');
      });

      $('#calendarWidget').checked = !!store.get(K.calendarWidget, false);
      $('#calendarWidget').addEventListener('change', e => {
        store.set(K.calendarWidget, e.target.checked);
        toggleCalendarWidget(e.target.checked);
        flash(e.target.checked ? 'Calendar widget enabled' : 'Calendar widget disabled');
      });

      $('#factoryReset').addEventListener('click', () => {
        showCustomConfirm('Factory Reset', 'Clear all MeowOS data?', () => {
          Object.keys(localStorage).filter(k => k.startsWith('meowos_')).forEach(k => localStorage.removeItem(k));
          location.reload();
        });
      });

      $('#recoveryBtn').addEventListener('click', () => {
        $('#recovery').classList.remove('hidden');
      });

      $('#recReset').addEventListener('click', () => {
        showCustomConfirm('Factory Reset', 'Clear all MeowOS data?', () => {
          Object.keys(localStorage).filter(k => k.startsWith('meowos_')).forEach(k => localStorage.removeItem(k));
          location.reload();
        });
      });

      $('#recNoAnim').addEventListener('click', () => {
        store.set(K.reduceMotion, true);
        document.body.classList.add('reduce-motion');
        flash('Animations disabled');
        $('#recovery').classList.add('hidden');
      });

      $('#recNoGlass').addEventListener('click', () => {
        store.set(K.reduce, true);
        document.body.classList.add('no-glass');
        document.documentElement.style.setProperty('--blur', 'none');
        flash('Glass effects disabled');
        $('#recovery').classList.add('hidden');
      });

      $('#recBack').addEventListener('click', () => {
        $('#recovery').classList.add('hidden');
      });

      $('#exportConfig').addEventListener('click', ()=>{
        const keys = Object.values(K);
        const obj = {};
        keys.forEach(k => { const v = localStorage.getItem(k); if(v!=null) obj[k] = JSON.parse(v); });
        const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
        triggerDownload(blob, 'meowos-settings.json');
      });

      $('#importConfig').addEventListener('change', async e=>{
        const file = e.target.files?.[0]; if(!file) return;
        const text = await file.text();
        try{
          const data = JSON.parse(text);
          Object.entries(data).forEach(([k,v])=>{
            if(Object.values(K).includes(k)) localStorage.setItem(k, JSON.stringify(v));
          });
          flash('Settings imported — reloading…');
          setTimeout(()=> location.reload(), 600);
        }catch{ alert('Invalid settings file'); }
      });

      const cats = $('#settingsCats'); const panes = $$('.settings-pane');
      cats.addEventListener('click', (e)=>{
        const li = e.target.closest('li'); if(!li) return;
        cats.querySelectorAll('li').forEach(n=> n.classList.remove('active'));
        li.classList.add('active'); const target = li.dataset.cat;
        panes.forEach(p=> p.hidden = (p.dataset.pane !== target));
      });

      const index = [];
      panes.forEach(pane=>{
        pane.querySelectorAll('h2,h3,label,button,select,input').forEach(el=>{
          const txt = (el.textContent || el.placeholder || '').trim();
          if(txt) index.push({pane, el, text: txt.toLowerCase()});
        });
      });
      function jumpToPane(pane){
        const id = pane.dataset.pane;
        cats.querySelectorAll('li').forEach(n=> n.classList.remove('active'));
        const li = cats.querySelector(`li[data-cat="${id}"]`);
        if(li){ li.classList.add('active'); }
        panes.forEach(p=> p.hidden = (p!==pane));
      }
      function highlight(el){
        el.scrollIntoView({behavior:'smooth', block:'center'});
        el.style.outline = `2px solid var(--accent)`; el.style.borderRadius = '6px';
        setTimeout(()=>{ el.style.outline=''; }, 1200);
      }
      $('#settingsSearch').addEventListener('input', (e)=>{
        const q = e.target.value.trim().toLowerCase();
        if(!q) return;
        const hit = index.find(it => it.text.includes(q));
        if(hit){ jumpToPane(hit.pane); highlight(hit.el); }
      });
    }

    function initPaint(){
      const canvas = $('#paintCanvas'); const ctx = canvas.getContext('2d');
      function resizeCanvas(){ const rect = canvas.getBoundingClientRect(); canvas.width = rect.width * devicePixelRatio; canvas.height = rect.height * devicePixelRatio; ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0); ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height); }
      let painting=false, lastX=0, lastY=0;
      const brush = ()=> parseInt($('#brushSize').value, 10) || 6; const color = ()=> $('#brushColor').value || '#000';
      function start(e){ painting=true; const r = canvas.getBoundingClientRect(); const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top; lastX = x; lastY=y; }
      function draw(e){ if(!painting) return; const r = canvas.getBoundingClientRect(); const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top; ctx.strokeStyle = color(); ctx.lineWidth = brush(); ctx.lineCap = 'round'; ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(x, y); ctx.stroke(); lastX = x; lastY = y; e.preventDefault(); }
      function stop(){ painting=false; }
      canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stop); canvas.addEventListener('mouseleave', stop);
      canvas.addEventListener('touchstart', start, {passive:false}); canvas.addEventListener('touchmove', draw, {passive:false}); canvas.addEventListener('touchend', stop);
      $('#clearPaint').addEventListener('click', ()=>{ ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height); });
      $('#savePaint').addEventListener('click', ()=>{ const dataURL = canvas.toDataURL('image/png'); const files = loadFilesStore(); let base='painting', i=1, name = `${base}.png`; while(files[name]){ i++; name = `${base}-${i}.png`; } files[name] = { type: 'image', data: dataURL }; saveFilesStore(files); renderCreatedList(); openCreatedFile(name); flash('Painting saved'); });
      const ro = new ResizeObserver(()=> resizeCanvas()); ro.observe(canvas); setTimeout(()=> resizeCanvas(), 200);
    }

    function initRecorder(){
      const startBtn = $('#recStart'), stopBtn = $('#recStop'), recState = $('#recState'), recList = $('#recList');
      let mediaRecorder = null, chunks = [];
      startBtn.addEventListener('click', async ()=>{
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream); chunks = [];
          mediaRecorder.ondataavailable = e=> { if(e.data && e.data.size) chunks.push(e.data); };
          mediaRecorder.onstop = async ()=>{
            const blob = new Blob(chunks, { type: 'audio/webm' });
            const dataURL = await new Promise((res,rej)=>{ const r = new FileReader(); r.onload = ()=> res(r.result); r.onerror=rej; r.readAsDataURL(blob); });
            const files = loadFilesStore(); let base='recording', i=1, name = `${base}.webm`; while(files[name]){ i++; name = `${base}-${i}.webm`; }
            files[name] = { type: 'audio', data: dataURL }; saveFilesStore(files); renderCreatedList();
            const el = document.createElement('div'); el.style.display='flex'; el.style.alignItems='center'; el.style.gap='8px';
            const a = document.createElement('audio'); a.controls=true; a.src=dataURL; a.style.flex='1';
            const dl = document.createElement('button'); dl.className='btn secondary'; dl.textContent='Download'; dl.addEventListener('click', ()=>{ const b = dataURLtoBlob(dataURL); triggerDownload(b, name); });
            el.appendChild(a); el.appendChild(dl); recList.prepend(el);
            flash('Recording saved to Files'); recState.textContent = 'Idle'; startBtn.disabled = false; stopBtn.disabled = true;
          };
          mediaRecorder.start(); recState.textContent = 'Recording…'; startBtn.disabled = true; stopBtn.disabled = false;
        } catch(e){ alert('Microphone access denied or not available.'); }
      });
      stopBtn.addEventListener('click', ()=>{ if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop(); });
      const files = loadFilesStore(); Object.keys(files).filter(n=> files[n].type === 'audio').reverse().forEach(n=> {
        const el = document.createElement('div'); el.style.display='flex'; el.style.alignItems='center'; el.style.gap='8px';
        const a = document.createElement('audio'); a.controls=true; a.src=files[n].data; a.style.flex='1';
        const dl = document.createElement('button'); dl.className='btn secondary'; dl.textContent='Download'; dl.addEventListener('click', ()=>{ const b = dataURLtoBlob(files[n].data); triggerDownload(b, n); });
        el.appendChild(a); el.appendChild(dl); recList.prepend(el);
      });
    }

    function initAppInstaller() {
      const fileInput = $('#appFile');
      const htmlTa = $('#appHtml');
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0]; if (!file) return;
        const text = await readAsText(file);
        htmlTa.value = text;
      });
      $('#addApp').addEventListener('click', () => {
        const name = $('#appName').value.trim();
        if (!name) { alert('Enter app name'); return; }
        const emoji = $('#appEmoji').value.trim() || '❓';
        const html = htmlTa.value.trim();
        if (!html) { alert('Provide HTML code or file'); return; }
        const id = name.toLowerCase().replace(/\W+/g, '-');
        let customs = store.get(K.customApps, []);
        if (customs.find(c => c.id === id)) { alert('App with that name exists'); return; }
        customs.push({ id, name, emoji, html });
        store.set(K.customApps, customs);
        buildStartMenu();
        flash('App added! Find it in Start menu.');
        $('#appName').value = '';
        $('#appEmoji').value = '';
        htmlTa.value = '';
        fileInput.value = '';
      });
    }

    function openCustom(id) {
      const customs = store.get(K.customApps, []);
      const c = customs.find(c => c.id === id);
      if (!c) return;
      let win = $('#win-custom-' + id);
      if (!win) {
        win = document.createElement('div');
        win.className = 'app-window hidden';
        win.id = 'win-custom-' + id;
        win.dataset.app = 'custom_' + id;
        win.style.left = '20vw'; win.style.top = '15vh'; win.style.width = '700px'; win.style.height = '500px';
        const header = document.createElement('div');
        header.className = 'window-header';
        header.innerHTML = `
          <div class="win-emoji" draggable="true">${c.emoji}</div>
          <div class="win-title">${c.name}</div>
          <div class="window-actions">
            <button class="win-btn win-min" title="Minimize"></button>
            <button class="win-btn win-max" title="Maximize"></button>
            <button class="win-btn win-close" title="Close"></button>
          </div>
        `;
        win.appendChild(header);
        const body = document.createElement('div');
        body.className = 'window-body';
        body.style.height = 'calc(100% - 46px)';
        const iframe = document.createElement('iframe');
        iframe.style.width = '100%'; iframe.style.height = '100%'; iframe.style.border = '0';
        iframe.srcdoc = c.html;
        body.appendChild(iframe);
        win.appendChild(body);
        $('#desktop').appendChild(win);
        makeDraggable(win);
        addResizers(win);
      }
      win.classList.remove('hidden', 'minimized');
      bringToFront(win);
    }

    document.addEventListener('mousemove', e => {
      if (dragElement && dragElement.classList.contains('shortcut')) {
        dragElement.style.left = (e.clientX - dragOffsetX) + 'px';
        dragElement.style.top = (e.clientY - dragOffsetY) + 'px';
      }
    });
    document.addEventListener('mouseup', () => {
      if (dragElement && dragElement.classList.contains('shortcut')) {
        updateShortcutPosition(dragElement.dataset.index, dragElement.style.left, dragElement.style.top);
      }
      dragElement = null;
    });

    $('#desktop').addEventListener('dragover', e => e.preventDefault());
    $('#desktop').addEventListener('drop', e => {
      e.preventDefault();
      const dockRect = $('#dock').getBoundingClientRect();
      if (e.clientX >= dockRect.left && e.clientX <= dockRect.right &&
          e.clientY >= dockRect.top  && e.clientY <= dockRect.bottom) return;

      const rawData = e.dataTransfer.getData('text'); if (!rawData) return;
      const data = JSON.parse(rawData);
      if (data.from === 'dock') {
        unpinApp(data.app);
      } else if (data.from === 'start' || data.from === 'window') {
        addShortcut('app', data.app, e.clientX, e.clientY);
      } else if (data.type === 'file') {
        addShortcut('file', data.id, e.clientX, e.clientY);
      }
    });

    $('#dock').addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); });
    $('#dock').addEventListener('drop', e => {
      e.preventDefault(); e.stopPropagation();
      const rawData = e.dataTransfer.getData('text'); if (!rawData) return;
      const data = JSON.parse(rawData);
      if (data.from === 'start' || data.from === 'window') {
        let pinned = store.get(K.pinned, ['notes','files','browser','settings']);
        if (!pinned.includes(data.app)) { pinned.push(data.app); store.set(K.pinned, pinned); renderDock(); buildStartMenu(); }
      }
    });

    const CITY_TZ = {
      tokyo: 'Asia/Tokyo',
      london: 'Europe/London',
      paris: 'Europe/Paris',
      berlin: 'Europe/Berlin',
      copenhagen: 'Europe/Copenhagen',
      newyork: 'America/New_York', 'new york': 'America/New_York', nyc: 'America/New_York',
      losangeles: 'America/Los_Angeles', 'los angeles': 'America/Los_Angeles', la: 'America/Los_Angeles',
      sydney: 'Australia/Sydney',
      moscow: 'Europe/Moscow',
      beijing: 'Asia/Shanghai',
      delhi: 'Asia/Kolkata',
      dubai: 'Asia/Dubai',
      singapore: 'Asia/Singapore'
    };

    function formatTimeInTZ(tz){
      const d = new Date();
      const opts = {hour:'2-digit', minute:'2-digit', hour12: !store.get(K.clock24,false), timeZone: tz};
      return d.toLocaleTimeString([], opts);
    }

    function formatLocalDate(){
      const d = new Date();
      return d.toLocaleDateString(undefined, {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    }

    async function fetchWeatherFor(query){
      const q = (query||'').toLowerCase();
      try{
        if(/\b(here|my location|near me)\b/.test(q) && navigator.geolocation){
          const coords = await new Promise((res, rej)=> navigator.geolocation.getCurrentPosition(p=>res(p.coords), rej, {enableHighAccuracy:true, timeout:6000}));
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.latitude}&longitude=${coords.longitude}&current_weather=true`;
          const r = await fetch(url); const j = await r.json();
          if(j && j.current_weather){ const cw=j.current_weather; return `Weather here: ${cw.temperature}°C, wind ${cw.windspeed} km/h`; }
        }
      }catch{}
      const m = query.match(/weather\s+(.+)/i);
      const name = m ? m[1].trim() : query.replace(/weather/gi,'').trim();
      if(!name) return "Tell me a city, e.g. weather Paris";
      try{
        const g = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1`);
        const gj = await g.json();
        if(gj && gj.results && gj.results.length){
          const {latitude, longitude, name: city, country} = gj.results[0];
          const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`);
          const jw = await w.json();
          if(jw && jw.current_weather){
            const cw = jw.current_weather;
            return `Weather in ${city}, ${country}: ${cw.temperature}°C, wind ${cw.windspeed} km/h`;
          }
        }
        return "Couldn't find that city for weather, sorry.";
      }catch{ return "Weather lookup failed, meow."; }
    }

    async function localBot(text){
      const t = text.trim();
      const lower = t.toLowerCase();

      if(lower.includes('meow')) return "Meow, I love cats too! 🐾";

      if(/\bdate\b/.test(lower)) return `Today is ${formatLocalDate()}.`;

      if(/\btime\b/.test(lower)){
        const cityMatch = lower.match(/\btime(?:\s+in)?\s+([a-z\s]+)$/i);
        if(cityMatch){
          const cityRaw = cityMatch[1].trim();
          const key = cityRaw.replace(/\s+/g,'');
          const tz = CITY_TZ[cityRaw] || CITY_TZ[key];
          if(tz) return `Time in ${cityRaw.replace(/\b\w/g, c=>c.toUpperCase())}: ${formatTimeInTZ(tz)}.`;
        }
        return `Local time: ${formatTimeInTZ(Intl.DateTimeFormat().resolvedOptions().timeZone)}.`;
      }

      if (/\b(calculate|math|eval)\b/i.test(lower)) {
        const expr = t.replace(/\b(calculate|math|eval)\b/i, '').trim();
        try {
          return `Result: ${eval(expr)}`;
        } catch (e) {
          return 'Invalid math expression.';
        }
      }

      if (/\bjoke\b/i.test(lower)) {
        const jokes = [
          'Why did the cat go to school? To improve his purr-sonal skills!',
          'What is a cat\'s favorite color? Purr-ple!',
          'Why was the cat afraid of the tree? Because of its bark!'
        ];
        return jokes[Math.floor(Math.random() * jokes.length)];
      }

      if (/\bfact\b/i.test(lower)) {
        const facts = [
          'Cats sleep for about 70% of their lives.',
          'A group of cats is called a clowder.',
          'Cats have over 20 muscles that control their ears.'
        ];
        return facts[Math.floor(Math.random() * facts.length)];
      }

      if (/\bflip coin\b/i.test(lower)) {
        return Math.random() < 0.5 ? 'Heads!' : 'Tails!';
      }

      if (/\broll dice\b/i.test(lower)) {
        return `You rolled a ${Math.floor(Math.random() * 6) + 1}.`;
      }

      return "Sorry, I don't understand that query.";
    }

    document.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
        e.preventDefault();
        const spot = $('#spotlight');
        spot.classList.toggle('hidden');
        if (!spot.classList.contains('hidden')) $('#spotlightInput').focus();
      }
      if (e.key === 'Escape' && !$('#spotlight').classList.contains('hidden')) {
        $('#spotlight').classList.add('hidden');
        $('#spotlightInput').value = '';
        $('#spotlightResults').innerHTML = '';
      }
      if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'r' && !$('#onboarding').classList.contains('hidden')) {
        $('#recovery').classList.remove('hidden');
      }
    });

    $('#spotlightInput').addEventListener('input', async () => {
      const val = $('#spotlightInput').value.trim().toLowerCase();
      const res = $('#spotlightResults');
      res.innerHTML = '';
      if (val.startsWith('/meowai ')) {
        const query = val.slice(8).trim();
        if (query) {
          const response = await localBot(query);
          const div = document.createElement('div');
          div.textContent = response;
          res.appendChild(div);
        }
      } else {
        const allApps = [...apps, ...store.get(K.customApps, []).map(c => 'custom_' + c.id)];
        allApps.filter(a => getLabel(a).toLowerCase().includes(val)).forEach(a => {
          const btn = document.createElement('div');
          btn.className = 'start-item';
          btn.innerHTML = `<div class="start-emoji">${getEmoji(a)}</div><div class="start-label">${getLabel(a)}</div>`;
          btn.addEventListener('click', () => { openWindow(a); $('#spotlight').classList.add('hidden'); $('#spotlightInput').value = ''; });
          res.appendChild(btn);
        });
      }
    });

    $('#spotlightInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        const res = $$('#spotlightResults .start-item');
        if (res.length) res[0].click();
      }
    });

    $('#clock').addEventListener('click', () => $('#notifCenter').classList.toggle('hidden'));

    function showWelcomeAnim(){
      $('#onboarding').classList.add('hidden');
      $('#loading').classList.add('hidden');
      $('#welcomeAnim').classList.remove('hidden');
      const texts = ['Welcome', "Let's Start", 'View Tips For Help'];
      let i = 0;
      const textEl = $('#welcomeText');
      const bloom = document.querySelector('#welcomeAnim .bloom');
      bloom.style.animation = 'bloom 2s ease-out forwards';
      function nextText(){
        textEl.style.opacity = 0;
        setTimeout(() => {
          textEl.textContent = texts[i];
          textEl.style.opacity = 1;
          i++;
          if (i < texts.length) {
            setTimeout(nextText, 1500);
          } else {
            setTimeout(() => {
              $('#welcomeAnim').classList.add('hidden');
              showDesktop();
            }, 1500);
          }
        }, 500);
      }
      nextText();
    }

    function initThemes(){
      $('#themeFont').value = store.get(K.fontFamily, '') || '';
      const fsSlider = $('#themeFontSize'); const fsValue = $('#fontSizeValue');
      fsSlider.value = store.get(K.scale, 1); fsValue.textContent = `${fsSlider.value}x`;
      fsSlider.addEventListener('input', (e)=>{ fsValue.textContent = `${e.target.value}x`; });

      $('#themeBg').value = store.get(K.bgColor, '#0b0f17');
      $('#themeText').value = store.get(K.textColor, '#e6ecff');
      $('#themeAccent').value = store.get(K.accent, '#8a9bff');

      const timeBased = store.get(K.timeBasedWall, {enabled: false, night: null, morning: null, day: null, evening: null});
      $('#themeTimeBased').checked = timeBased.enabled;
      const tw = $('#timeWalls');
      tw.style.display = timeBased.enabled ? 'block' : 'none';
      $('#themeTimeBased').addEventListener('change', (e)=>{ tw.style.display = e.target.checked ? 'block' : 'none'; });

      $('#applyTheme').addEventListener('click', async ()=>{
        const font = $('#themeFont').value.trim() || null;
        if(font) document.documentElement.style.setProperty('--font-family', font);
        store.set(K.fontFamily, font);

        const scale = parseFloat(fsSlider.value);
        document.documentElement.style.setProperty('--font-scale', scale);
        store.set(K.scale, scale);

        const bg = $('#themeBg').value;
        document.documentElement.style.setProperty('--bg', bg);
        store.set(K.bgColor, bg);

        const text = $('#themeText').value;
        document.documentElement.style.setProperty('--text', text);
        store.set(K.textColor, text);

        const accent = $('#themeAccent').value;
        document.documentElement.style.setProperty('--accent', accent);
        store.set(K.accent, accent);

        const wallFile = $('#themeWall').files[0];
        if(wallFile){
          const data = await new Promise(r=>{ const reader = new FileReader(); reader.onload = ()=>r(reader.result); reader.readAsDataURL(wallFile); });
          store.set(K.wallpaper, data);
          document.body.style.backgroundImage = `url(${data})`;
          document.body.style.backgroundSize = 'cover';
        }

        const tbEnabled = $('#themeTimeBased').checked;
        const tb = {enabled: tbEnabled};
        if(tbEnabled){
          const keys = ['night', 'morning', 'day', 'evening'];
          for(const k of keys){
            const f = $(`#wall${k.charAt(0).toUpperCase() + k.slice(1)}`).files[0];
            if(f){
              tb[k] = await new Promise(r=>{ const reader = new FileReader(); reader.onload = ()=>r(reader.result); reader.readAsDataURL(f); });
            } else {
              tb[k] = timeBased[k];
            }
          }
          store.set(K.timeBasedWall, tb);
        } else {
          store.set(K.timeBasedWall, tb);
        }

        flash('Theme applied');
        location.reload(); // to fully apply
      });

      $('#exportTheme').addEventListener('click', ()=>{
        const obj = {
          fontFamily: store.get(K.fontFamily),
          scale: store.get(K.scale),
          bgColor: store.get(K.bgColor),
          textColor: store.get(K.textColor),
          accent: store.get(K.accent),
          wallpaper: store.get(K.wallpaper),
          timeBasedWall: store.get(K.timeBasedWall)
        };
        const blob = new Blob([JSON.stringify(obj, null, 2)], {type: 'application/json'});
        triggerDownload(blob, 'meowos-theme.json');
      });

      $('#importTheme').addEventListener('change', async e=>{
        const file = e.target.files[0]; if(!file) return;
        const text = await readAsText(file);
        try{
          const data = JSON.parse(text);
          if(data.fontFamily) {
            store.set(K.fontFamily, data.fontFamily);
            document.documentElement.style.setProperty('--font-family', data.fontFamily);
          }
          if(data.scale) {
            store.set(K.scale, data.scale);
            document.documentElement.style.setProperty('--font-scale', data.scale);
          }
          if(data.bgColor) {
            store.set(K.bgColor, data.bgColor);
            document.documentElement.style.setProperty('--bg', data.bgColor);
          }
          if(data.textColor) {
            store.set(K.textColor, data.textColor);
            document.documentElement.style.setProperty('--text', data.textColor);
          }
          if(data.accent) {
            store.set(K.accent, data.accent);
            document.documentElement.style.setProperty('--accent', data.accent);
          }
          if(data.wallpaper) {
            store.set(K.wallpaper, data.wallpaper);
            document.body.style.backgroundImage = `url(${data.wallpaper})`;
            document.body.style.backgroundSize = 'cover';
          }
          if(data.timeBasedWall) store.set(K.timeBasedWall, data.timeBasedWall);
          flash('Theme imported - reload to apply fully');
          location.reload();
        }catch{ alert('Invalid theme file'); }
      });
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      const isSetup = !!store.get(K.setup, false);
      if(isSetup) showDesktop(); else startOnboarding();

      $('#obNext').addEventListener('click', ()=>{ $('#ob-step-1').classList.add('hidden'); $('#ob-step-2').classList.remove('hidden'); $('#obName').focus(); });
      $('#obBack2').addEventListener('click', ()=>{ $('#ob-step-2').classList.add('hidden'); $('#ob-step-1').classList.remove('hidden'); });
      $('#obNext2').addEventListener('click', ()=>{
        const name = $('#obName').value.trim() || 'Friend'; store.set(K.name, name);
        $('#ob-step-2').classList.add('hidden'); $('#ob-step-3').classList.remove('hidden');
      });
      $('#obBack3').addEventListener('click', ()=>{ $('#ob-step-3').classList.add('hidden'); $('#ob-step-2').classList.remove('hidden'); });
      $('#obNext3').addEventListener('click', ()=>{
        const theme = document.querySelector('input[name="obTheme"]:checked').value; store.set(K.theme, theme);
        $('#ob-step-3').classList.add('hidden'); $('#ob-step-4').classList.remove('hidden');
      });
      $('#obBack4').addEventListener('click', ()=>{ $('#ob-step-4').classList.add('hidden'); $('#ob-step-3').classList.remove('hidden'); });
      $('#obFinish').addEventListener('click', ()=>{
        const tz = $('#obTimeZone').value; store.set(K.tz, tz); store.set(K.scale, 1); store.set(K.setup, true); 
        showWelcomeAnim();
      });
      $('#obSkip').addEventListener('click', ()=>{ store.set(K.name, 'Friend'); store.set(K.theme, 'dark'); store.set(K.scale, 1); store.set(K.setup, true); store.set(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
        showWelcomeAnim();
      });

      $$('input[name="obTheme"]').forEach(r => r.addEventListener('change', (e)=>{ document.body.classList.toggle('light', e.target.value === 'light'); }));

      ['notes','calendar','browser','files','settings','recorder','paint','calculator','appinstaller','tips','themes'].forEach(id=>{
        const el = document.getElementById('win-' + id); if(el) makeDraggable(el);
      });

      initNotes(); initFiles(); initSettings(); initBrowser(); initRecorder(); initPaint(); initCalculator(); initAppInstaller(); initThemes();

      $('#calPrev').addEventListener('click', ()=>{ calDate.setMonth(calDate.getMonth()-1); renderCalendar(); });
      $('#calNext').addEventListener('click', ()=>{ calDate.setMonth(calDate.getMonth()+1); renderCalendar(); });
      renderCalendar();

      if(isSetup) openWindow('notes');
    });

    (function ensureDefaults(){
      const files = loadFilesStore();
      if(!Object.keys(files).length){ files['welcome.txt'] = { type: 'text', text: 'Welcome to MeowOS! Your files are stored locally in your browser.' }; saveFilesStore(files); }
    })();</script>