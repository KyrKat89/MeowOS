<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width,initial-scale=1" name="viewport" />
    <title>MeowOS ‚Äî a tiny HTML OS</title>
    <style>
        :root {
            --bg: #0b0f17;
            --glass: rgba(255, 255, 255, 0.2);
            --glass-2: rgba(255, 255, 255, 0.25);
            --text: #e6ecff;
            --muted: #a8b3d1;
            --accent: #8a9bff;
            --red: #ff6b6b;
            --yellow: #ffd166;
            --green: #3ecf8e;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            --blur: saturate(140%) blur(50px);
            --font-scale: 1;
            --meow-icon-size: 92px;
            --dock-icon-radius: 8px;
            --ripple-color: rgba(255, 255, 255, 0.3);
            --font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Color Emoji", "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
            --dark-grad1: color-mix(in srgb, var(--accent) 20%, #14223a);
            --dark-grad2: color-mix(in srgb, var(--accent) 20%, #1b2b4a);
            --noise-url: url("data:image/svg+xml;base64,CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2aWV3Qm94PSIwIDAgNjAwIDYwMCI+CiAgPGZpbHRlciBpZD0ibiI+CiAgICA8ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iMC42NSIgbnVtT2N0YXZlcz0iMyIgc3RpdGNoVGlsZXM9InN0aXRjaCI+CiAgICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9ImJhc2VGcmVxdWVuY3kiIHZhbHVlcz0iMC42NTswLjY4OzAuNjUiIGR1cj0iMjBzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIvPgogICAgPC9mZVR1cmJ1bGVuY2U+CiAgPC9maWx0ZXI+CiAgPHJlY3Qgd2lkdGg9IjYwMCIgaGVpZ2h0PSI2MDAiIGZpbHRlcj0idXJsKCNuKSIgb3BhY2l0eT0iMC4xIj48L3JlY3Q+Cjwvc3ZnPgo=");
        }

        * {
            box-sizing: border-box;
        }

        body,
        html {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: var(--font-family);
            color: var(--text);
            background: var(--bg) center/cover fixed no-repeat;
            background-image: radial-gradient(circle at 10% 30%, #2c5282 0, #2a4365 30%, transparent 50%), radial-gradient(circle at 70% 60%, #319795 0, #285e61 30%, transparent 50%), radial-gradient(circle at 40% 90%, #68d391 0, #38a169 30%, transparent 50%), linear-gradient(to bottom, #0b0f17, #1a1f2e);
            user-select: none;
            overflow: hidden;
            font-size: calc(16px * var(--font-scale));
        }

        .overlay {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            background: radial-gradient(1200px 800px at 50% 50%, rgba(0, 0, 0, 0.55), rgba(0, 0, 0, 0.8)), radial-gradient(circle at 10% 30%, #2c5282 0, #2a4365 30%, transparent 50%), radial-gradient(circle at 70% 60%, #319795 0, #285e61 30%, transparent 50%), radial-gradient(circle at 40% 90%, #68d391 0, #38a169 30%, transparent 50%), linear-gradient(to bottom, #0b0f17, #1a1f2e);
            z-index: 9999;
            background-blend-mode: multiply;
        }

        .overlay#spotlight {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
        }

        .overlay#onboarding {
            background: rgba(0, 0, 0, 0.3), radial-gradient(circle at 10% 30%, #2c5282 0, #2a4365 30%, transparent 50%), radial-gradient(circle at 70% 60%, #319795 0, #285e61 30%, transparent 50%), radial-gradient(circle at 40% 90%, #68d391 0, #38a169 30%, transparent 50%), linear-gradient(to bottom, #0b0f17, #1a1f2e);
            background-blend-mode: multiply;
            backdrop-filter: blur(20px);
        }

        .oobe-ball {
            position: absolute;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, var(--accent), transparent);
            border-radius: 50%;
            filter: blur(4px);
            opacity: 0.6;
            animation: float 15s infinite ease-in-out;
        }

        .oobe-ball:nth-child(1) {
            top: 10%;
            left: 10%;
            animation-delay: 0s;
            animation-duration: 12s;
        }

        .oobe-ball:nth-child(2) {
            top: 20%;
            right: 15%;
            animation-delay: 3s;
            animation-duration: 18s;
        }

        .oobe-ball:nth-child(3) {
            bottom: 30%;
            left: 20%;
            animation-delay: 6s;
            animation-duration: 14s;
        }

        .oobe-ball:nth-child(4) {
            top: 60%;
            right: 30%;
            animation-delay: 9s;
            animation-duration: 16s;
        }

        .oobe-ball:nth-child(5) {
            bottom: 10%;
            left: 50%;
            animation-delay: 1s;
            animation-duration: 20s;
        }

        @keyframes float {
            0%,
            100% {
                transform: translateY(0) rotate(0) scale(1);
                opacity: 0.6;
            }
            25% {
                transform: translateY(-20px) rotate(90deg) scale(1.1);
                opacity: 0.8;
            }
            50% {
                transform: translateY(-10px) rotate(180deg) scale(0.9);
                opacity: 0.4;
            }
            75% {
                transform: translateY(-30px) rotate(270deg) scale(1.2);
                opacity: 0.7;
            }
        }

        .card {
            width: min(560px, 92vw);
            padding: 28px;
            background: var(--glass) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            backdrop-filter: var(--blur);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 18px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            min-height: 320px;
        }

        .card h1 {
            margin: 0 0 8px;
            font-weight: 800;
            letter-spacing: 0.4px;
        }

        .card p {
            margin: 6px 0 16px;
            color: var(--muted);
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .row input[type="password"],
        .row input[type="text"] {
            flex: 1;
        }

        .btn {
            appearance: none;
            border: 0;
            cursor: pointer;
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: 700;
            letter-spacing: 0.2px;
            background: linear-gradient(180deg, var(--accent), #6b82ff);
            color: #0b0f17;
            box-shadow: 0 6px 16px rgba(138, 155, 255, 0.35);
            transition: transform 0.08s ease, filter 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-1px) scale(1.02);
        }

        .btn:active {
            transform: translateY(1px) scale(0.98);
        }

        .btn.secondary {
            background: var(--glass-2) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            color: var(--text);
            box-shadow: none;
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .oobe-card .btn.secondary {
            background: var(--glass-2) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
        }

        .hidden {
            display: none !important;
        }

        #desktop {
            position: absolute;
            inset: 0;
            overflow: hidden;
        }

        .topbar {
            position: absolute;
            inset: 12px 12px auto 12px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: 12px;
            background: var(--glass) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            backdrop-filter: var(--blur);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow);
        }

        .topbar .hello {
            font-weight: 700;
            cursor: pointer;
        }

        .topbar .clock {
            color: var(--muted);
            font-variant-numeric: tabular-nums;
            cursor: pointer;
        }

        .control-center {
            background: 0 0;
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 20px;
            padding: 0 8px;
            border-radius: 6px;
            transition: background 0.2s ease;
            margin-left: auto;
        }

        .control-center:hover {
            background: var(--glass-2) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
        }

        #controlCenterMenu {
            position: absolute;
            top: 60px;
            right: 12px;
            width: 250px;
            background: var(--glass) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            backdrop-filter: var(--blur);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            padding: 14px;
            box-shadow: var(--shadow);
            z-index: 400;
            display: flex;
            flex-direction: column;
            gap: 12px;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translateY(-10px);
        }

        #controlCenterMenu:not(.hidden) {
            opacity: 1;
            transform: translateY(0);
        }

        .cc-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .cc-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .cc-item label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        #meowMenu {
            position: absolute;
            left: 50%;
            bottom: 76px;
            transform: translateX(-50%);
            width: min(900px, 92vw);
            background: var(--glass) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            backdrop-filter: var(--blur);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            padding: 14px;
            box-shadow: var(--shadow);
            z-index: 300;
            display: grid;
            gap: 12px;
            grid-template-rows: auto 1fr;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translateX(-50%) scale(0.95);
        }

        #meowMenu:not(.hidden) {
            opacity: 1;
            transform: translateX(-50%) scale(1);
        }

        .meow-head {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .meow-head .avatar {
            font-size: 24px;
        }

        .meow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(var(--meow-icon-size, 92px), 1fr));
            gap: 10px;
        }

        .meow-item {
            display: grid;
            place-items: center;
            gap: 6px;
            padding: 8px;
            border-radius: 12px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: transform 0.12s ease, background 0.2s ease;
            width: var(--meow-icon-size, 92px);
        }

        .meow-item:hover {
            transform: translateY(-2px);
            background: var(--glass-2) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
        }

        .meow-emoji {
            font-size: 28px;
            line-height: 1;
        }

        .meow-label {
            font-size: 12px;
            color: var(--muted);
            text-align: center;
        }

        .meow-section-title {
            font-weight: 800;
            color: var(--muted);
            margin: 6px 2px;
        }

        .meow-recents {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }

        .recent {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 8px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
        }

        .recent .icon {
            font-size: 18px;
        }

        .recent .name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dock {
            position: absolute;
            left: 50%;
            bottom: 14px;
            transform: translateX(-50%);
            display: flex;
            gap: 18px;
            padding: 10px 14px;
            border-radius: 20px;
            background: var(--glass) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            backdrop-filter: var(--blur);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: var(--shadow);
            overflow-x: auto;
            overscroll-behavior-x: contain;
        }

        .dock-item {
            appearance: none;
            border: 0;
            background: 0 0;
            color: var(--text);
            display: grid;
            place-items: center;
            gap: 6px;
            padding: 6px 8px;
            border-radius: 14px;
            cursor: pointer;
            min-width: 64px;
            transition: transform 0.12s ease, background 0.2s ease;
            flex: 0 0 auto;
        }

        .dock-item:hover {
            transform: translateY(-4px) scale(1.05);
            background: rgba(255, 255, 255, 0.08);
        }

        .dock-emoji {
            font-size: 28px;
            line-height: 1;
        }

        .dock-label {
            font-size: 12px;
            color: var(--muted);
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 100%;
            background: var(--green);
            margin-top: 2px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .dock-item.open .dot {
            opacity: 1;
        }

        .shortcut {
            position: absolute;
            min-width: auto;
            cursor: pointer;
        }

        #contextMenu {
            position: absolute;
            background: var(--glass) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            backdrop-filter: var(--blur);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 12px;
            padding: 8px;
            box-shadow: var(--shadow);
            z-index: 200;
        }

        .context-item {
            padding: 6px 12px;
            cursor: pointer;
        }

        .context-item:hover {
            background: var(--glass-2) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
        }

        #fileContextMenu {
            position: absolute;
            background: var(--glass) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            backdrop-filter: var(--blur);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 12px;
            padding: 8px;
            box-shadow: var(--shadow);
            z-index: 200;
        }

        .dialog-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: grid;
            place-items: center;
            z-index: 10000 !important;
        }

        .dialog-card {
            width: min(400px, 80vw);
            padding: 20px;
            background: var(--glass) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            backdrop-filter: var(--blur);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 16px;
        }

        .oobe-card {
            background: var(--glass) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .oobe-title {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .oobe-sub {
            font-size: 16px;
            color: var(--muted);
            margin-bottom: 24px;
        }

        .oobe-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .oobe-card input,
        .oobe-card select {
            color: var(--text);
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .oobe-card label {
            color: var(--text);
        }

        .app-window {
            position: absolute;
            inset: auto;
            min-width: 360px;
            min-height: 260px;
            width: 680px;
            height: 420px;
            background: var(--glass) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            backdrop-filter: var(--blur);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .app-window:not(.hidden):not(.minimized) {
            opacity: 1;
            transform: scale(1);
        }

        .app-window.minimized {
            display: none !important;
        }

        .window-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.06);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            cursor: grab;
            user-select: none;
        }

        .window-header:active {
            cursor: grabbing;
        }

        .win-emoji {
            font-size: 20px;
        }

        .win-title {
            font-weight: 800;
            letter-spacing: 0.3px;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .window-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .win-btn {
            width: 20px;
            height: 20px;
            border-radius: 100%;
            border: 0;
            cursor: pointer;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.15) inset;
            transition: transform 0.08s ease;
            display: inline-block;
        }

        .win-close {
            background: var(--red);
        }

        .win-min {
            background: var(--yellow);
        }

        .win-max {
            background: var(--green);
        }

        .win-btn:hover {
            transform: scale(1.12);
        }

        .win-btn:active {
            transform: scale(0.98);
        }

        body.dock-left .dock {
            left: 14px;
            bottom: auto;
            top: 50%;
            transform: translateY(-50%);
            flex-direction: column;
        }

        body.dock-left .dock .dock-item {
            min-width: 56px;
        }

        .viewer {
            display: none;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
        }

        .viewer.show {
            display: block;
        }

        .media-view {
            height: 100%;
            display: grid;
            place-items: center;
        }

        .media-view audio,
        .media-view img,
        .media-view video {
            max-width: 100%;
            max-height: 100%;
            border-radius: 12px;
        }

        .window-body {
            height: calc(100% - 46px);
            display: grid;
            grid-template-rows: 1fr;
        }

        .settings-body {
            overflow-y: auto;
        }

        .pad {
            padding: 12px;
        }

        .toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.04);
        }

        .toolbar input,
        .toolbar select {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 8px 10px;
        }

        #notesText {
            width: 100%;
            height: 100%;
            background: 0 0;
            color: var(--text);
            border: 0;
            outline: 0;
            font: 600 15px/1.6 var(--font-family);
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 12px;
            overflow: auto;
        }

        #notesPlaceholder {
            position: absolute;
            top: 12px;
            left: 12px;
            color: var(--muted);
            pointer-events: none;
            z-index: 1;
        }

        .cal-wrap {
            display: grid;
            grid-template-rows: auto 1fr;
            height: 100%;
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            padding: 12px;
        }

        .cal-head {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            padding: 12px;
            font-weight: 700;
            color: var(--muted);
        }

        .day {
            padding: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.04);
            text-align: right;
        }

        .day.today {
            outline: 2px solid var(--accent);
        }

        .cal-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            font-size: 12px;
        }

        .urlbar {
            flex: 1;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .urlbar input {
            flex: 1;
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .webview {
            height: 100%;
            border: 0;
            width: 100%;
            background: #0c1220;
            zoom: 100%;
        }

        .files-shell {
            display: grid;
            grid-template-columns: 260px 1fr;
            height: 100%;
        }

        .sidebar {
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.03);
            padding: 10px;
            overflow: auto;
        }

        .side-title {
            font-weight: 800;
            margin: 8px 0;
        }

        .filetree,
        .filetree ul {
            list-style: none;
            padding-left: 16px;
        }

        .filetree li {
            margin: 4px 0;
            color: var(--muted);
        }

        .filetree li .fname {
            color: var(--text);
            cursor: pointer;
        }

        .editor {
            display: grid;
            grid-template-rows: auto 1fr;
            height: 100%;
        }

        .editor textarea {
            width: 100%;
            height: 100%;
            background: 0 0;
            color: var(--text);
            border: 0;
            outline: 0;
            font: 600 14px/1.6 var(--font-family);
        }

        .list {
            display: grid;
            gap: 6px;
        }

        .pill {
            padding: 8px 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.06) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pill .action {
            font-size: 12px;
            color: var(--accent);
            cursor: pointer;
        }

        .paint-canvas {
            border-radius: 10px;
            background: #fff;
            display: block;
            width: 100%;
            height: calc(100% - 48px);
            touch-action: none;
        }

        #calcDisplay {
            font-size: 24px;
            text-align: right;
            margin-bottom: 10px;
        }

        #calcButtons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .settings-shell {
            display: grid;
            grid-template-columns: 240px 1fr;
            height: 100%;
        }

        .settings-sidebar {
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            overflow: auto;
        }

        .settings-sidebar .search {
            position: sticky;
            top: 0;
            padding-bottom: 10px;
            background: inherit;
        }

        .settings-sidebar ul {
            list-style: none;
            margin: 8px 0 0;
            padding: 0;
            display: grid;
            gap: 6px;
        }

        .settings-sidebar li {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 10px;
            cursor: pointer;
            color: var(--text);
            transition: background 0.15s ease, transform 0.06s ease;
        }

        .settings-sidebar li:hover {
            background: var(--glass-2) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            transform: translateY(-1px);
        }

        .settings-sidebar li.active {
            background: linear-gradient(180deg, var(--accent), #6b82ff);
            color: #0b0f17;
            font-weight: 800;
            box-shadow: 0 6px 16px rgba(138, 155, 255, 0.35);
        }

        .settings-content {
            position: relative;
            padding: 16px 20px;
            overflow: auto;
        }

        .settings-pane {
            max-width: 760px;
            display: grid;
            gap: 16px;
        }

        .settings-pane[hidden] {
            display: none !important;
        }

        .section {
            border-radius: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.04) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .settings-h2 {
            margin: 0 0 8px;
            font-weight: 900;
            letter-spacing: 0.2px;
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .switch {
            appearance: none;
            width: 46px;
            height: 26px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.28);
            position: relative;
            cursor: pointer;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.15);
            transition: background 0.2s, box-shadow 0.2s;
        }

        .switch::after {
            content: "";
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.35);
            transition: transform 0.2s;
        }

        .switch:checked {
            background: linear-gradient(180deg, var(--accent), #6b82ff);
        }

        .switch:checked::after {
            transform: translateX(20px);
        }

        body.no-glass * {
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            --noise-url: none;
        }

        body.no-glass:not(.light) #meowMenu,
        body.no-glass:not(.light) .app-window,
        body.no-glass:not(.light) .card,
        body.no-glass:not(.light) .dialog-card,
        body.no-glass:not(.light) .dock,
        body.no-glass:not(.light) .pill,
        body.no-glass:not(.light) .section,
        body.no-glass:not(.light) .sidebar,
        body.no-glass:not(.light) .toolbar,
        body.no-glass:not(.light) .topbar {
            background: #0b0f17;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .setting-group {
            margin-bottom: 16px;
        }

        .emoji {
            font-family: "Noto Color Emoji", "Apple Color Emoji", "Segoe UI Emoji", emoji;
        }

        body.reduce-motion * {
            transition: none !important;
            animation: none !important;
        }

        body.high-contrast :is(.app-window,
        .topbar,
        .dock,
        #meowMenu,
        .sidebar,
        .toolbar,
        .card,
        .section,
        .pill,
        .dialog-card) {
            background: var(--bg) !important;
            border-color: rgba(255, 255, 255, 0.35) !important;
        }

        #notifCenter {
            position: absolute;
            top: 60px;
            right: 12px;
            width: 360px;
            background: var(--glass) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            backdrop-filter: var(--blur);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            padding: 14px;
            box-shadow: var(--shadow);
            z-index: 400;
            max-height: 60vh;
            overflow: auto;
            display: grid;
            gap: 8px;
        }

        #notifCenter .notif {
            padding: 10px 12px;
            background: var(--glass-2) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #spotlight .card {
            width: min(600px, 80vw);
        }

        #spotlightResults {
            margin-top: 10px;
            display: grid;
            gap: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .resizer {
            position: absolute;
            background: 0 0;
            z-index: 10;
        }

        #welcomeText {
            transition: opacity 0.5s ease;
        }

        #welcomeAnim {
            background: var(--bg);
            backdrop-filter: blur(20px);
        }

        #welcomeAnim .bloom {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--accent);
            border-radius: 50%;
            opacity: 0;
            animation: bloom 2s ease-out forwards;
        }

        @keyframes bloom {
            0% {
                width: 0;
                height: 0;
                opacity: 0.5;
            }
            100% {
                width: 200vw;
                height: 200vw;
                opacity: 0;
                transform: translate(-50%, -50%);
            }
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, var(--ripple-color) 0, transparent 70%);
            transform: scale(0);
            opacity: 1;
            animation: ripple-anim 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple-anim {
            to {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        #screensaver-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9998;
            display: none;
        }

        #recovery .card {
            width: min(400px, 80vw);
        }

        .preview-div {
            width: 100%;
            height: 60px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .preview-div:hover {
            opacity: 0.8;
        }

        .settings-body,
        .settings-content,
        .window-body {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .settings-body::-webkit-scrollbar,
        .settings-content::-webkit-scrollbar,
        .window-body::-webkit-scrollbar {
            display: none;
        }

        .start-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            cursor: pointer;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.04);
            transition: background 0.2s;
        }

        .start-item:hover {
            background: var(--glass-2) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
        }

        .start-emoji {
            font-size: 24px;
            line-height: 1;
            flex-shrink: 0;
            text-align: center;
        }

        .start-label {
            flex: 1;
            font-size: 14px;
        }

        .credits-kyrkat {
            cursor: pointer;
            color: var(--accent);
            text-decoration: underline;
        }

        .debug-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            background: var(--glass) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            backdrop-filter: var(--blur);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow);
            z-index: 500;
            display: none;
        }

        .debug-panel button {
            margin: 4px 0;
        }

        .dancing-cat {
            position: fixed;
            z-index: 1000;
            font-size: 32px;
            pointer-events: none;
            animation: dance 2s ease-in-out infinite;
        }

        .dancing-cat:nth-child(1) {
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }

        .dancing-cat:nth-child(2) {
            top: 40%;
            right: 10%;
            animation-delay: 0.5s;
        }

        .dancing-cat:nth-child(3) {
            top: 60%;
            left: 20%;
            animation-delay: 1s;
        }

        @keyframes dance {
            0%,
            100% {
                transform: translateY(0) rotate(0);
            }
            25% {
                transform: translateY(-10px) rotate(5deg);
            }
            75% {
                transform: translateY(-10px) rotate(-5deg);
            }
        }

        .pixel-cat {
            position: absolute;
            z-index: 1000;
            font-size: 20px;
            pointer-events: none;
            animation: run 3s linear forwards;
        }

        .pixel-cat::before {
            content: "üê±";
        }

        @keyframes run {
            0% {
                transform: translateX(-100px);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateX(110vw);
                opacity: 0;
            }
        }

        .firework {
            position: fixed;
            z-index: 1000;
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
            pointer-events: none;
            animation: firework 1s ease-out forwards;
        }

        @keyframes firework {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-100vh) scale(2);
            }
        }

        .secret-wallpaper {
            background: linear-gradient(45deg, #f0f, #0ff, #ff0, red, #0f0);
            background-size: 400% 400%;
            animation: secret-glow 5s ease infinite;
        }

        @keyframes secret-glow {
            0%,
            100% {
                background-position: 0 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        .widget {
            position: absolute;
            background: var(--glass) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            backdrop-filter: var(--blur);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 12px;
            padding: 10px;
            box-shadow: var(--shadow);
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .widget .title {
            font-weight: 800;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 8px;
            flex: 0 0 auto;
        }

        .widget .content {
            font-size: 14px;
            flex: 1;
            overflow: auto;
        }

        .weather-widget .temp {
            font-size: 18px;
            font-weight: 700;
        }

        .notes-shell {
            display: grid;
            grid-template-columns: 250px 1fr;
            height: 100%;
        }

        .clock-shell {
            display: grid;
            grid-template-columns: 240px 1fr;
            height: 100%;
        }

        .clock-sidebar {
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            overflow: auto;
        }

        .clock-content {
            position: relative;
            padding: 16px 20px;
            overflow: auto;
        }

        .clock-sidebar ul li:hover {
            background: var(--glass-2) var(--noise-url) repeat;
            background-blend-mode: normal, soft-light;
            background-size: auto, 10% 10%;
            transform: translateY(-1px);
        }

        .clock-sidebar ul li.active {
            background: linear-gradient(180deg, var(--accent), #6b82ff);
            color: #0b0f17;
            font-weight: 800;
            box-shadow: 0 6px 16px rgba(138, 155, 255, 0.35);
        }

        .app-icon {
            border-radius: 8px;
        }

        .icon-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .app-content-container {
            width: 100%;
            height: 100%;
            overflow: auto;
            position: relative;
        }

        .tab-bar {
            display: flex;
            align-items: center;
            padding: 0 8px;
            background: var(--glass-2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            overflow-x: auto;
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: background 0.2s;
        }

        .tab.active {
            border-bottom: 2px solid var(--accent);
            background: var(--glass-2);
        }

        .tab-close {
            margin-left: 8px;
            cursor: pointer;
            color: var(--muted);
        }

        .new-tab-btn {
            padding: 8px;
            cursor: pointer;
            color: var(--muted);
            margin-left: auto;
        }

        /* Redesigned Files App Styles */

        .files-shell {
            display: grid;
            grid-template-columns: 280px 1fr;
        }

        .sidebar {
            padding: 16px;
        }

        .file-search {
            margin-bottom: 12px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
        }

        .file-item:hover {
            background: var(--glass-2);
        }

        .file-icon {
            font-size: 20px;
        }

        .file-name {
            flex: 1;
        }

        .file-actions {
            display: flex;
            gap: 4px;
        }

        /* Redesigned Recorder App Styles */

        .recorder-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .recorder-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .rec-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 8px;
            background: var(--glass-2);
        }

        .rec-audio {
            flex: 1;
        }

        /* Redesigned Calculator App Styles */

        #calcDisplay {
            font-size: 28px;
            padding: 12px;
            border-radius: 8px;
            background: var(--glass-2);
        }

        #calcButtons {
            grid-template-columns: repeat(5, 1fr);
        }

        .calc-btn-advanced {
            background: var(--accent);
            color: #fff;
        }

        /* Redesigned Control Center Styles */

        #controlCenterMenu {
            width: 280px;
            padding: 16px;
        }

        .cc-item-slider {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cc-slider {
            flex: 1;
        }
    </style>
</head>

<body>
    <div class="hidden overlay" id="onboarding">
        <div class="oobe-ball"></div>
        <div class="oobe-ball"></div>
        <div class="oobe-ball"></div>
        <div class="oobe-ball"></div>
        <div class="oobe-ball"></div>
        <div class="card oobe-card" id="ob-step-1">
            <div style="
                        text-align: center;
                        height: 300px;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                    ">
                <div id="welcomeFonts" style="font-size: 48px; font-weight: 600; line-height: 1">Welcome</div>
            </div>
            <p style="text-align: center; font-size: 14px; color: var(--muted); margin: 20px 0">
                Touch to continue
            </p>
            <div class="row" style="justify-content: center; gap: 10px; margin-top: auto">
                <button class="btn secondary" id="obSkip">Skip</button>
                <button class="btn" id="obNext">Next</button>
            </div>
        </div>
        <div class="hidden card oobe-card" id="ob-step-2">
            <div style="text-align: center">
                <div style="font-size: 56px; line-height: 1">üë§</div>
                <h1 style="margin: 8px 0 12px; font-size: 28px; font-weight: 600">Create your local account</h1>
            </div>
            <p style="text-align: center" class="oobe-sub">
                Choose a display name. You can change this later in<strong>‚öôÔ∏è Settings</strong>.
            </p>
            <input id="obName" class="input" placeholder="Enter your name" />
            <div class="row" style="justify-content: flex-end; gap: 10px; margin-top: auto">
                <button class="btn secondary" id="obBack2">Back</button>
                <button class="btn" id="obNext2">Next</button>
            </div>
        </div>
        <div class="hidden card oobe-card" id="ob-step-3">
            <div style="text-align: center">
                <div style="font-size: 56px; line-height: 1">üïí</div>
                <h1 style="margin: 8px 0 12px; font-size: 28px; font-weight: 600">Choose Time Zone</h1>
            </div>
            <p style="text-align: center" class="oobe-sub">
                Select your time zone. You can change this later in<strong>‚öôÔ∏è Settings</strong>.
            </p>
            <select id="obTimeZone" class="input" style="width: 100%">
                    <option value="UTC">UTC</option>
                    <option value="America/New_York">America/New York</option>
                    <option value="Europe/London">Europe/London</option>
                    <option value="Asia/Tokyo">Asia/Tokyo</option>
                    <option value="Australia/Sydney">Australia/Sydney</option>
                    <option value="Asia/Shanghai">Asia/Shanghai</option>
                </select>
            <div class="row" style="justify-content: flex-end; gap: 10px; margin-top: auto">
                <button class="btn secondary" id="obBack3">Back</button>
                <button class="btn" id="obNext3">Next</button>
            </div>
        </div>
        <div class="hidden card oobe-card" id="ob-step-4">
            <div style="text-align: center">
                <div style="font-size: 56px; line-height: 1">üìÇ</div>
                <h1 style="margin: 8px 0 12px; font-size: 28px; font-weight: 600">Migrate Data</h1>
            </div>
            <p style="text-align: center" class="oobe-sub">
                Select a folder to migrate files to MeowOS. You can skip this.
            </p>
            <input type="file" id="obMigrateFolder" webkitdirectory directory multiple style="display: none" />
            <button class="btn secondary" id="obChooseFolder">Choose Folder</button>
            <div id="obMigrateStatus" style="margin: 10px 0; color: var(--muted)"></div>
            <div class="row" style="justify-content: flex-end; gap: 10px; margin-top: auto">
                <button class="btn secondary" id="obBack4">Back</button>
                <button class="btn secondary" id="obSkipMigrate">Skip</button>
                <button class="btn" id="obFinishMigrate">Finish Setup</button>
            </div>
        </div>
    </div>
    <div class="hidden overlay" id="loading">
        <div class="card oobe-card">
            <div style="text-align: center">
                <div style="font-size: 56px; line-height: 1; animation: spin 1s linear infinite">üîÑ</div>
                <h1 style="margin: 8px 0 12px; font-size: 28px; font-weight: 600">Loading and Setting Up</h1>
            </div>
            <p style="text-align: center; color: var(--muted)">Please wait...</p>
        </div>
    </div>
    <div class="hidden" id="desktop">
        <div class="topbar">
            <div class="emoji hello" id="hello">üò∫ Hi!</div>
            <button class="control-center" id="controlCenter" title="Control Center">‚öôÔ∏è</button>
            <div class="clock" id="clock" style="position: relative">--:--</div>
        </div>
        <div class="hidden control-center-menu" id="controlCenterMenu">
            <div class="cc-section">
                <h3 style="margin: 0 0 12px; font-weight: 800; color: var(--text)">Quick Controls</h3>
                <div class="cc-item">
                    <label>Wifi: <input type="checkbox" class="switch" checked /></label>
                </div>
                <div class="cc-item">
                    <label>Bluetooth: <input type="checkbox" class="switch" /></label>
                </div>
                <div class="cc-item">
                    <label>Airplane Mode: <input type="checkbox" class="switch" /></label>
                </div>
                <div class="cc-item cc-item-slider">
                    <label>Brightness:</label>
                    <input type="range" class="cc-slider" min="0" max="100" value="80" />
                </div>
                <div class="cc-item cc-item-slider">
                    <label>Volume:</label>
                    <input type="range" class="cc-slider" min="0" max="100" value="50" />
                </div>
                <div class="cc-item">
                    <button class="btn" id="ccReboot">Reboot</button>
                </div>
                <div class="cc-item">
                    <button class="btn secondary" id="ccSettings">Settings</button>
                </div>
            </div>
        </div>
        <div class="hidden" id="meowMenu">
            <div>
                <div class="meow-head">
                    <div class="avatar">üò∫</div>
                    <div style="font-weight: 800" id="meowUser">Meow</div>
                    <div style="margin-left: auto; color: var(--muted); font-size: 12px">Meow</div>
                </div>
                <div class="meow-section-title" style="margin-top: 10px" id="pinnedTitle">Pinned</div>
                <div class="meow-grid" id="meowPinned"></div>
                <div class="meow-section-title" style="margin-top: 10px" id="allTitle">All apps</div>
                <div class="meow-grid" id="meowAll"></div>
                <div class="meow-section-title" style="margin-top: 10px" id="recentsTitle">Recent files</div>
                <div class="meow-recents" id="meowRecents"></div>
            </div>
        </div>
        <div class="hidden app-window" id="win-notes" style="left: 6vw; top: 9vh" data-app="notes">
            <div class="window-header">
                <div class="win-emoji" draggable="true">üóíÔ∏è</div>
                <div class="win-title">Notes</div>
                <div class="window-actions">
                    <button class="win-btn win-min" title="Minimize"></button>
                    <button class="win-btn win-max" title="Maximize"></button>
                    <button class="win-btn win-close" title="Close"></button>
                </div>
            </div>
            <div class="window-body notes-shell">
                <div class="sidebar">
                    <div class="row" style="margin-bottom: 10px">
                        <button class="btn secondary" id="notesNew">+ New Note</button>
                    </div>
                    <div class="list" id="notesList"></div>
                </div>
                <div style="display: flex; flex-direction: column">
                    <div class="toolbar">
                        <button class="btn secondary" id="notesSaveToFiles" title="Save to Files">üíæ</button>
                        <button class="btn secondary" id="notesBold" title="Bold"><strong>B</strong></button>
                        <button class="btn secondary" id="notesItalic" title="Italic"><em>I</em></button>
                        <button class="btn secondary" id="notesUnderline" title="Underline"><u>U</u></button>
                    </div>
                    <div style="flex: 1; position: relative">
                        <div id="notesPlaceholder" style="
                                    position: absolute;
                                    top: 12px;
                                    left: 12px;
                                    color: var(--muted);
                                    pointer-events: none;
                                    z-index: 1;
                                ">
                            Select or create a note...
                        </div>
                        <div id="notesText" contenteditable="true" style="height: 100%; padding: 12px; overflow: auto; outline: 0"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="hidden app-window" id="win-calendar" style="left: 22vw; top: 12vh; width: 620px" data-app="calendar">
            <div class="window-header">
                <div class="win-emoji" draggable="true">üìÖ</div>
                <div class="win-title" id="calTitle">Calendar</div>
                <div class="window-actions">
                    <button class="win-btn win-min" title="Minimize"></button>
                    <button class="win-btn win-max" title="Maximize"></button>
                    <button class="win-btn win-close" title="Close"></button>
                </div>
            </div>
            <div class="window-body cal-wrap">
                <div class="cal-controls">
                    <button class="btn secondary" id="calPrev">‚óÄ</button>
                    <div style="font-weight: 800" id="calMonth"></div>
                    <button class="btn secondary" id="calNext">‚ñ∂</button>
                </div>
                <div class="cal-head">
                    <div>Mon</div>
                    <div>Tue</div>
                    <div>Wed</div>
                    <div>Thu</div>
                    <div>Fri</div>
                    <div>Sat</div>
                    <div>Sun</div>
                </div>
                <div class="cal-grid" id="calGrid"></div>
            </div>
        </div>
        <div class="hidden app-window" id="win-browser" style="left: 12vw; top: 18vh; width: 1000px; height: 600px" data-app="browser">
            <div class="window-header">
                <div class="win-emoji" draggable="true">üåê</div>
                <div class="win-title">Web Browser</div>
                <div class="window-actions" style="flex: 1; justify-content: flex-end">
                    <div style="width: 8px"></div>
                    <button class="win-btn win-min" title="Minimize"></button>
                    <button class="win-btn win-max" title="Maximize"></button>
                    <button class="win-btn win-close" title="Close"></button>
                </div>
            </div>
            <div class="tab-bar" id="tabBar"></div>
            <div class="toolbar">
                <button class="btn secondary" id="back" title="Back">‚üµ</button>
                <button class="btn secondary" id="forward" title="Forward">‚ü∂</button>
                <button class="btn secondary" id="reload" title="Reload">‚ü≥</button>
                <div class="urlbar">
                    <input id="url" placeholder="Enter a URL or search (e.g. cats)" />
                    <button class="btn" id="go">Go</button>
                </div>
                <button class="btn secondary" id="openExt" title="Open original in new tab">‚Üó</button>
                <button class="btn secondary" id="zoomOut">-</button>
                <span id="zoomLevel">100%</span>
                <button class="btn secondary" id="zoomIn">+</button>
            </div>
            <div class="window-body">
                <div style="width: 100%; height: 100%; display: none; overflow: auto" id="embedContainer"></div>
                <div id="browserContent" style="width: 100%; height: 100%; position: relative"></div>
            </div>
        </div>
        <div class="hidden app-window" id="win-files" style="left: 38vw; top: 10vh; width: 860px; height: 520px" data-app="files">
            <div class="window-header">
                <div class="win-emoji" draggable="true">üìÅ</div>
                <div class="win-title">Files</div>
                <div class="window-actions">
                    <button class="win-btn win-min" title="Minimize"></button>
                    <button class="win-btn win-max" title="Maximize"></button>
                    <button class="win-btn win-close" title="Close"></button>
                </div>
            </div>
            <div class="window-body files-shell">
                <div class="sidebar">
                    <input id="fileSearch" class="input file-search" placeholder="Search files..." />
                    <div class="row" style="margin-bottom: 8px">
                        <button class="btn secondary" id="backBtn">‚óÄ Back</button>
                        <span id="currentPathDisplay" style="margin-left: 10px; color: var(--muted)">/</span>
                    </div>
                    <div class="row" style="margin-bottom: 8px">
                        <button class="btn secondary" id="newFolder">New Folder</button>
                    </div>
                    <div class="row" style="margin-bottom: 8px">
                        <input id="newFileName" class="input" placeholder="new-file.txt" />
                        <button class="btn" id="createFile">New File</button>
                    </div>
                    <div class="row" style="margin-bottom: 8px">
                        <input id="uploadFile" type="file" multiple="multiple" style="display: none" />
                        <button class="btn secondary" id="uploadBtn">Upload</button>
                    </div>
                    <div class="list" id="createdList"></div>
                </div>
                <div class="editor">
                    <div class="toolbar">
                        <div class="emoji" id="currentFileIcon">üìÑ</div>
                        <div style="font-weight: 800; flex: 1" id="currentFileName">No file open</div>
                        <button class="btn secondary" id="downloadFile">Download</button>
                        <button class="btn" id="saveFile">Save</button>
                    </div>
                    <div class="viewer" id="viewerWrap">
                        <div class="media-view" id="mediaViewer"></div>
                    </div>
                    <textarea id="editorArea" placeholder="Open or create a text file to edit‚Ä¶"></textarea>
                </div>
            </div>
        </div>
        <div class="hidden app-window" id="win-recorder" style="left: 20vw; top: 18vh; width: 500px; height: 280px" data-app="recorder">
            <div class="window-header">
                <div class="win-emoji" draggable="true">üéôÔ∏è</div>
                <div class="win-title">Recorder</div>
                <div class="window-actions">
                    <button class="win-btn win-min" title="Minimize"></button>
                    <button class="win-btn win-max" title="Maximize"></button>
                    <button class="win-btn win-close" title="Close"></button>
                </div>
            </div>
            <div class="window-body pad recorder-container">
                <div class="recorder-controls">
                    <button class="btn" id="recStart">Record</button>
                    <button class="btn secondary" id="recStop" disabled="disabled">Stop</button>
                    <div style="color: var(--muted)" id="recState">Idle</div>
                </div>
                <div style="display: grid; gap: 8px" id="recList"></div>
            </div>
        </div>
        <div class="hidden app-window" id="win-paint" style="left: 30vw; top: 16vh; width: 700px; height: 520px" data-app="paint">
            <div class="window-header">
                <div class="win-emoji" draggable="true">üé®</div>
                <div class="win-title">Paint</div>
                <div class="window-actions">
                    <button class="win-btn win-min" title="Minimize"></button>
                    <button class="win-btn win-max" title="Maximize"></button>
                    <button class="win-btn win-close" title="Close"></button>
                </div>
            </div>
            <div class="window-body pad" style="display: flex; flex-direction: column; gap: 8px">
                <div style="display: flex; gap: 8px">
                    <input id="brushSize" type="range" value="6" max="40" min="1" />
                    <input id="brushColor" type="color" value="#000000" />
                    <button class="btn" id="clearPaint">Clear</button>
                    <button class="btn" id="savePaint">Save</button>
                </div>
                <canvas class="paint-canvas" id="paintCanvas"></canvas>
            </div>
        </div>
        <div class="hidden app-window" id="win-calculator" style="left: 15vw; top: 15vh; width: 500px; height: 500px" data-app="calculator">
            <div class="window-header">
                <div class="win-emoji" draggable="true">üßÆ</div>
                <div class="win-title">Calculator</div>
                <div class="window-actions">
                    <button class="win-btn win-min" title="Minimize"></button>
                    <button class="win-btn win-max" title="Maximize"></button>
                    <button class="win-btn win-close" title="Close"></button>
                </div>
            </div>
            <div class="window-body pad" style="display: flex; flex-direction: column">
                <input id="calcDisplay" class="input" readonly="readonly" style="
                            font-size: 28px;
                            text-align: right;
                            margin-bottom: 10px;
                            padding: 12px;
                            border-radius: 8px;
                            background: var(--glass-2);
                        " />
                <div id="calcButtons"></div>
            </div>
        </div>
        <div class="hidden app-window" id="win-clock" style="left: 40vw; top: 10vh; width: 500px; height: 500px" data-app="clock">
            <div class="window-header">
                <div class="win-emoji" draggable="true">üïê</div>
                <div class="win-title">Clock</div>
                <div class="window-actions">
                    <button class="win-btn win-min" title="Minimize"></button>
                    <button class="win-btn win-max" title="Maximize"></button>
                    <button class="win-btn win-close" title="Close"></button>
                </div>
            </div>
            <div class="window-body clock-shell">
                <aside class="clock-sidebar">
                    <ul style="list-style: none; margin: 8px 0 0; padding: 0; display: grid; gap: 6px">
                        <li data-tab="alarm" class="active" style="
                                    display: flex;
                                    align-items: center;
                                    gap: 10px;
                                    padding: 8px 10px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    color: var(--text);
                                    transition:
                                        background 0.15s ease,
                                        transform 0.06s ease;
                                ">
                            ‚è∞ Alarms
                        </li>
                        <li data-tab="stopwatch" style="
                                    display: flex;
                                    align-items: center;
                                    gap: 10px;
                                    padding: 8px 10px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    color: var(--text);
                                    transition:
                                        background 0.15s ease,
                                        transform 0.06s ease;
                                ">
                            ‚è±Ô∏è Stopwatch
                        </li>
                        <li data-tab="timer" style="
                                    display: flex;
                                    align-items: center;
                                    gap: 10px;
                                    padding: 8px 10px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    color: var(--text);
                                    transition:
                                        background 0.15s ease,
                                        transform 0.06s ease;
                                ">
                            ‚è≤Ô∏è Timer
                        </li>
                    </ul>
                </aside>
                <section class="clock-content">
                    <div data-tab-content="alarm">
                        <div id="alarmList" style="display: grid; gap: 8px"></div>
                        <div style="display: flex; gap: 8px">
                            <input id="alarmInput" type="number" placeholder="Minutes" />
                            <button class="btn" id="addAlarm">Add Alarm</button>
                        </div>
                    </div>
                    <div data-tab-content="stopwatch" style="display: none">
                        <div id="stopwatchDisplay" style="font-size: 32px; text-align: center; font-weight: 700; margin: 20px 0">
                            00:00:00
                        </div>
                        <div style="display: flex; justify-content: center; gap: 10px">
                            <button class="btn" id="swStart">Start</button>
                            <button class="btn" id="swStop">Stop</button>
                            <button class="btn" id="swReset">Reset</button>
                        </div>
                    </div>
                    <div data-tab-content="timer" style="display: none">
                        <div id="timerDisplay" style="font-size: 32px; text-align: center; font-weight: 700; margin: 20px 0">
                            00:00
                        </div>
                        <div style="display: flex; justify-content: center; gap: 10px">
                            <input id="timerInput" type="number" placeholder="Minutes" style="width: 100px" />
                            <button class="btn" id="timerStart">Start</button>
                            <button class="btn" id="timerStop">Stop</button>
                        </div>
                    </div>
                </section>
            </div>
        </div>
        <div class="hidden app-window" id="win-weather" style="left: 45vw; top: 12vh; width: 400px; height: 500px" data-app="weather">
            <div class="window-header">
                <div class="win-emoji" draggable="true">üå§Ô∏è</div>
                <div class="win-title">Weather</div>
                <div class="window-actions">
                    <button class="win-btn win-min" title="Minimize"></button>
                    <button class="win-btn win-max" title="Maximize"></button>
                    <button class="win-btn win-close" title="Close"></button>
                </div>
            </div>
            <div class="window-body pad" style="display: flex; flex-direction: column; gap: 10px">
                <div class="row">
                    <input id="weatherCityInput" class="input" placeholder="Enter city (e.g. London)" />
                    <button class="btn" id="fetchWeather">Fetch Weather</button>
                </div>
                <div id="weatherDisplay" style="flex: 1; text-align: center; padding: 20px; color: var(--muted); font-size: 18px"></div>
            </div>
        </div>
        <div class="hidden app-window" id="win-settings" style="left: 26vw; top: 14vh; width: 700px" data-app="settings">
            <div class="window-header">
                <div class="win-emoji" draggable="true">‚öôÔ∏è</div>
                <div class="win-title">Settings</div>
                <div class="window-actions">
                    <button class="win-btn win-min" title="Minimize"></button>
                    <button class="win-btn win-max" title="Maximize"></button>
                    <button class="win-btn win-close" title="Close"></button>
                </div>
            </div>
            <div class="window-body settings-body">
                <div class="settings-shell">
                    <aside class="settings-sidebar">
                        <div class="search">
                            <input id="settingsSearch" class="input" placeholder="Search Settings" />
                        </div>
                        <ul id="settingsCats">
                            <li data-cat="profile" class="active">üë§ Profile</li>
                            <li data-cat="appearance">üé® Appearance</li>
                            <li data-cat="accessibility">‚ôø Accessibility</li>
                            <li data-cat="meowmenu">üêæ Meow Menu</li>
                            <li data-cat="wallpapers">üñºÔ∏è Wallpapers</li>
                            <li data-cat="desktop">üñ• Desktop & Dock</li>
                            <li data-cat="browser">üåê Browser</li>
                            <li data-cat="apps">üì¶ Apps</li>
                            <li data-cat="system">‚öôÔ∏è System</li>
                            <li data-cat="tablet">üì± Tablet</li>
                            <li data-cat="credits">üìù Credits</li>
                        </ul>
                    </aside>
                    <section class="settings-content">
                        <div class="settings-pane" data-pane="profile">
                            <h2 class="settings-h2">Profile</h2>
                            <div class="section">
                                <label for="setName">Display name</label>
                                <input id="setName" class="input" placeholder="Your name" />
                                <div style="height: 8px"></div>
                                <button class="btn" id="applyName">Update Name</button>
                            </div>
                        </div>
                        <div class="settings-pane" data-pane="appearance" hidden>
                            <h2 class="settings-h2">Appearance</h2>
                            <div class="section settings-row">
                                <h3 class="emoji" style="margin: 0">üî§ Text Color</h3>
                                <input id="textColor" type="color" value="#1a1a1a" />
                            </div>
                            <div class="section settings-row">
                                <h3 class="emoji" style="margin: 0">üé® Accent Color</h3>
                                <input id="accentColor" type="color" value="#8a9bff" />
                            </div>
                            <div class="section settings-row">
                                <h3 class="emoji" style="margin: 0">üí§ Screensaver</h3>
                                <label style="display: flex; align-items: center; gap: 10px; margin-left: auto"><input id="screensaverEnable" type="checkbox" class="switch" /><span
                                            >Enable</span
                                        ></label
                                    >
                                </div>
                                <div class="section">
                                    <h3 class="emoji" style="margin: 0 0 8px">‚è±Ô∏è Screensaver Timeout (minutes)</h3>
                                    <input
                                        id="screensaverTimeout"
                                        type="number"
                                        class="input"
                                        max="60"
                                        min="1"
                                        value="5"
                                    />
                                </div>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">üî§ Font Family</h3>
                                    <select id="fontFamily">
                                        <option value="">Default</option>
                                        <option value="serif">Serif</option>
                                        <option value="monospace">Monospace</option>
                                        <option value="cursive">Cursive</option>
                                    </select>
                                </div>
                            </div>
                            <div class="settings-pane" data-pane="accessibility" hidden>
                                <h2 class="settings-h2">Accessibility</h2>
                                <div class="section">
                                    <h3 class="emoji" style="margin: 0 0 8px">üî§ Text Size</h3>
                                    <input id="textScale" type="range" value="1" max="1.5" min="0.8" step="0.1" />
                                    <div style="text-align: center; color: var(--muted)" id="scaleValue">1.0x</div>
                                </div>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">üßä Reduce transparency</h3>
                                    <label style="display: flex; align-items: center; gap: 10px; margin-left: auto"
                                        ><input id="reduceTransparency" type="checkbox" class="switch" /><span
                                            >Disable blur & glass</span
                                        ></label
                                    >
                                </div>
                                <div class="section">
                                    <h3 class="emoji" style="margin: 0 0 8px">üîç Blur Intensity</h3>
                                    <input id="blurIntensity" type="range" value="50" max="100" min="0" step="2" />
                                    <div style="text-align: center; color: var(--muted)" id="blurValue">50px</div>
                                </div>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">üåÄ Reduce Motion</h3>
                                    <label style="display: flex; align-items: center; gap: 10px; margin-left: auto"
                                        ><input id="reduceMotion" type="checkbox" class="switch" /><span
                                            >Disable animations</span
                                        ></label
                                    >
                                </div>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">üåì High Contrast</h3>
                                    <label style="display: flex; align-items: center; gap: 10px; margin-left: auto"
                                        ><input id="highContrast" type="checkbox" class="switch" /><span
                                            >Stronger borders & surfaces</span
                                        ></label
                                    >
                                </div>
                            </div>
                            <div class="settings-pane" data-pane="meowmenu" hidden>
                                <h2 class="settings-h2">Meow Menu</h2>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">üìå Show Pinned</h3>
                                    <label style="display: flex; align-items: center; gap: 10px; margin-left: auto"
                                        ><input id="showPinned" type="checkbox" class="switch" checked="checked" /><span
                                            >Enable pinned apps section</span
                                        ></label
                                    >
                                </div>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">üì± Show All Apps</h3>
                                    <label style="display: flex; align-items: center; gap: 10px; margin-left: auto"
                                        ><input id="showAll" type="checkbox" class="switch" checked="checked" /><span
                                            >Enable all apps section</span
                                        ></label
                                    >
                                </div>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">üìÑ Show Recent Files</h3>
                                    <label style="display: flex; align-items: center; gap: 10px; margin-left: auto"
                                        ><input
                                            id="showRecents"
                                            type="checkbox"
                                            class="switch"
                                            checked="checked"
                                        /><span>Enable recent files section</span></label
                                    >
                                </div>
                                <div class="section">
                                    <h3 class="emoji" style="margin: 0 0 8px">üìê Icon Size</h3>
                                    <input id="meowIconSize" type="range" value="92" max="120" min="64" step="4" />
                                    <div style="text-align: center; color: var(--muted)" id="iconSizeValue">92px</div>
                                </div>
                            </div>
                            <div class="settings-pane" data-pane="wallpapers" hidden>
                                <h2 class="settings-h2">Wallpapers</h2>
                                <div class="section">
                                    <h3 class="emoji" style="margin: 0 0 8px">üñºÔ∏è Default Wallpapers</h3>
                                    <div id="defaultPreviews" class="grid"></div>
                                </div>
                                <div class="section">
                                    <h3 class="emoji" style="margin: 0 0 8px">üì§ Upload from Device</h3>
                                    <input id="wallUpload" type="file" accept="image/*" />
                                </div>
                                <div class="section">
                                    <h3 class="emoji" style="margin: 0 0 8px">üìÅ From Files</h3>
                                    <div id="fileWallList" class="list"></div>
                                </div>
                            </div>
                            <div class="settings-pane" data-pane="desktop" hidden>
                                <h2 class="settings-h2">Desktop & Dock</h2>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">‚è±Ô∏è Show Seconds</h3>
                                    <label style="display: flex; align-items: center; gap: 10px; margin-left: auto"
                                        ><input id="showSeconds" type="checkbox" class="switch" /><span
                                            >Include seconds in clock</span
                                        ></label
                                    >
                                </div>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">üåç Time Zone</h3>
                                    <select id="timeZone">
                                        <option value="UTC">UTC</option>
                                        <option value="America/New_York">America/New York</option>
                                        <option value="Europe/London">Europe/London</option>
                                        <option value="Asia/Tokyo">Asia/Tokyo</option>
                                        <option value="Australia/Sydney">Australia/Sydney</option>
                                        <option value="Asia/Shanghai">Asia/Shanghai</option>
                                    </select>
                                </div>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">üõû Dock Position</h3>
                                    <select id="dockPos">
                                        <option value="bottom">Bottom</option>
                                        <option value="left">Left</option>
                                    </select>
                                </div>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">üõû Auto-Hide Dock</h3>
                                    <label style="display: flex; align-items: center; gap: 10px; margin-left: auto"
                                        ><input id="autoHideDock" type="checkbox" class="switch" /><span
                                            >Hide dock when not in use</span
                                        ></label
                                    >
                                </div>
                                <div class="section">
                                    <h3 class="emoji" style="margin: 0 0 8px">üóìÔ∏è Widgets</h3>
                                    <div class="settings-row">
                                        <h4>Clock Widget</h4>
                                        <label style="display: flex; align-items: center; gap: 10px"
                                            ><input id="clockWidget" type="checkbox" class="switch" /><span
                                                >Enable</span
                                            ></label
                                        >
                                    </div>
                                    <div class="settings-row">
                                        <h4>Calendar Widget</h4>
                                        <label style="display: flex; align-items: center; gap: 10px"
                                            ><input id="calendarWidget" type="checkbox" class="switch" /><span
                                                >Enable</span
                                            ></label
                                        >
                                    </div>
                                    <div class="settings-row">
                                        <h4>Weather Widget</h4>
                                        <label style="display: flex; align-items: center; gap: 10px"
                                            ><input id="weatherWidget" type="checkbox" class="switch" /><span
                                                >Enable</span
                                            ></label
                                        >
                                    </div>
                                    <div class="settings-row">
                                        <h4>Random Wikipedia</h4>
                                        <label style="display: flex; align-items: center; gap: 10px"
                                            ><input id="randomWidget" type="checkbox" class="switch" /><span
                                                >Enable</span
                                            ></label
                                        >
                                    </div>
                                </div>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">üñºÔ∏è Icon Style</h3>
                                    <select id="iconsMode">
                                        <option value="png">PNG Icons</option>
                                        <option value="emoji">Emoji Icons</option>
                                    </select>
                                </div>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">üè∑Ô∏è Dock Labels</h3>
                                    <label style="display: flex; align-items: center; gap: 10px; margin-left: auto"
                                        ><input id="showDockLabels" type="checkbox" class="switch" /><span
                                            >Show app names</span
                                        ></label
                                    >
                                </div>
                                <div class="section">
                                    <h3 class="emoji" style="margin: 0 0 8px">üîÑ Dock Icon Corner Radius</h3>
                                    <input
                                        id="dockIconRadius"
                                        type="range"
                                        value="8"
                                        max="25"
                                        min="0"
                                        step="1"
                                        style="width: 100%"
                                    />
                                    <div style="text-align: center; color: var(--muted)" id="radiusValue">8px</div>
                                </div>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">&#128070; Tap Feedback</h3>
                                    <label style="display: flex; align-items: center; gap: 10px; margin-left: auto"
                                        ><input id="tapFeedback" type="checkbox" class="switch" /><span
                                            >Show ripple on taps</span
                                        ></label
                                    >
                                </div>
                            </div>
                            <div class="settings-pane" data-pane="browser" hidden>
                                <h2 class="settings-h2">Browser</h2>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">üîé Search Engine</h3>
                                    <select id="searchEngine">
                                        <option value="ddg">DuckDuckGo</option>
                                        <option value="google">Google</option>
                                        <option value="bing">Bing</option>
                                        <option value="brave">Brave</option>
                                        <option value="wikipedia" selected="selected">Wikipedia</option>
                                    </select>
                                </div>
                                <div class="section">
                                    <h3 class="emoji" style="margin: 0 0 8px">üè† Home Page</h3>
                                    <div class="row">
                                        <input
                                            id="homePage"
                                            class="input"
                                            placeholder="https://meowosproxy.kyrylo89.workers.dev"
                                            value="https://meowosproxy.kyrylo89.workers.dev"
                                        />
                                        <button class="btn" id="applyHome">Set Home</button>
                                    </div>
                                </div>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">üß∞ Proxy Mode</h3>
                                    <select id="proxyMode" title="Use reader proxy for sites that block iframes">
                                        <option value="auto">Auto (only when blocked)</option>
                                        <option value="always">Always use reader proxy</option>
                                        <option value="off">Off (try embedding directly)</option>
                                    </select>
                                </div>
                                <div class="section settings-row">
                                    <h3 class="emoji" style="margin: 0">üö´ Block Popups</h3>
                                    <label style="display: flex; align-items: center; gap: 10px; margin-left: auto"
                                        ><input id="blockPopups" type="checkbox" class="switch" /><span
                                            >Prevent new tabs from sites</span
                                        ></label
                                    >
                                </div>
                                <div class="section">
                                    <button class="btn secondary" id="clearHistory">Clear Browsing History</button>
                                    <div style="color: var(--muted); font-size: 13px; margin-top: 6px">
                                        Sites that block iframes are auto-viewed via a safe readable proxy in
                                        Auto/Always modes. Use ‚Üó to open the original.
                                    </div>
                                </div>
                            </div>
                            <div class="settings-pane" data-pane="apps" hidden>
                                <h2 class="settings-h2">Installed Apps</h2>
                                <div class="section" id="installedAppsList"></div>
                            </div>
                            <div class="settings-pane" data-pane="system" hidden>
                                <h2 class="settings-h2">System</h2>
                                <div class="section">
                                    <h3 class="emoji" style="margin: 0 0 8px">üê± About MeowOS</h3>
                                    <div
                                        style="
                                            display: flex;
                                            flex-direction: column;
                                            gap: 12px;
                                            align-items: center;
                                            justify-content: center;
                                        "
                                    >
                                        <div style="text-align: center">
                                            <div style="font-size: 56px; line-height: 1">üêà</div>
                                            <div style="font-size: 36px; font-weight: 900; margin-top: 8px">MeowOS</div>
                                            <div style="font-size: 14px; color: var(--muted); margin-top: 4px">
                                                Siamese
                                            </div>
                                        </div>
                                        <div style="width: 420px; color: var(--muted); text-align: center">
                                            MeowOS is a tiny in-browser operating system prototype. It stores files
                                            locally and demonstrates apps ‚Äî Notes, Calendar, Files, Browser, Paint,
                                            Recorder, Calculator, Clock, Settings.
                                        </div>
                                    </div>
                                </div>
                                <div class="section">
                                    <h3 class="emoji" style="margin: 0 0 8px">üßπ Maintenance</h3>
                                    <button class="btn secondary" id="factoryReset">
                                        Factory Reset (clear MeowOS local data)
                                    </button>
                                    <button class="btn secondary" id="recoveryBtn">Recovery Mode</button>
                                </div>
                                <div class="section">
                                    <h3 class="emoji" style="margin: 0 0 8px">üóÇÔ∏è Backup & Restore</h3>
                                    <div class="row">
                                        <button class="btn" id="exportConfig">Export Settings</button>
                                        <label style="display: inline-block; cursor: pointer" class="btn secondary"
                                            >Import Settings
                                            <input
                                                id="importConfig"
                                                type="file"
                                                accept="application/json"
                                                style="display: none"
                                        /></label>
                            </div>
                        </div>
                        <div class="section">
                            <h3 class="emoji" style="margin: 0 0 8px">üõ†Ô∏è Developer</h3>
                            <button class="btn secondary" id="openSandbox">Open Sandbox MeowOS</button>
                        </div>
                </div>
                <div class="settings-pane" data-pane="tablet" hidden>
                    <h2 class="settings-h2">Tablet Mode</h2>
                    <div class="section settings-row">
                        <h3 class="emoji" style="margin: 0">üì± Tablet Mode</h3>
                        <label style="display: flex; align-items: center; gap: 10px; margin-left: auto"><input id="tabletMode" type="checkbox" class="switch" /><span
                                            >Enable Tablet Mode (Full-screen windows, no no resize/minimize)</span
                                        ></label
                                    >
                                </div>
                            </div>
                            <div class="settings-pane" data-pane="credits" hidden>
                                <h2 class="settings-h2">Credits</h2>
                                <div class="section">
                                    <h3 class="emoji" style="margin: 0 0 8px">üìù Credits</h3>
                                    <div
                                        style="
                                            color: var(--text);
                                            text-align: left;
                                            white-space: pre-wrap;
                                            background: rgba(255, 255, 255, 0.04);
                                            padding: 12px;
                                            border-radius: 8px;
                                            border: 1px solid rgba(255, 255, 255, 0.08);
                                        "
                                    >
                                        Credits: Creation idea:<span class="credits-kyrkat">KyrKat</span
                                        >inspiration:macOS and AnuraOS Basic development:ChatGPT UI and UX:ChatGPT nad
                                        Grok and KyrKat Enhanced Development:Grok and ChatGPT Features Ideas:ChatGPT and
                                        KyrKat and VladKing014 (Nickname) Beta Tests:KyrKat and VladKing014
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
            <div
                class="hidden app-window"
                id="win-cat"
                style="left: 50vw; top: 30vh; width: 300px; height: 200px"
                data-app="cat"
            >
                <div class="window-header">
                    <div class="win-emoji">üêæ</div>
                    <div class="win-title">Cat Growth</div>
                    <div class="window-actions">
                        <button class="win-btn win-min" title="Minimize"></button>
                        <button class="win-btn win-max" title="Maximize"></button>
                        <button class="win-btn win-close" title="Close"></button>
                    </div>
                </div>
                <div
                    class="window-body pad"
                    id="catBody"
                    style="
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                        align-items: center;
                        justify-content: center;
                    "
                ></div>
            </div>
            <div
                class="hidden app-window"
                id="win-meowstore"
                style="left: 25vw; top: 20vh; width: 600px; height: 500px"
                data-app="meowstore"
            >
                <div class="window-header">
                    <div class="win-emoji" draggable="true">üè™</div>
                    <div class="win-title">MeowStore</div>
                    <div class="window-actions">
                        <button class="win-btn win-min" title="Minimize"></button>
                        <button class="win-btn win-max" title="Maximize"></button>
                        <button class="win-btn win-close" title="Close"></button>
                    </div>
                </div>
                <div class="window-body settings-shell">
                    <aside class="settings-sidebar">
                        <ul style="list-style: none; margin: 0; padding: 0; display: grid; gap: 6px">
                            <li
                                data-tab="store"
                                class="active"
                                style="
                                    display: flex;
                                    align-items: center;
                                    gap: 10px;
                                    padding: 8px 10px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    color: var(--text);
                                    transition:
                                        background 0.15s ease,
                                        transform 0.06s ease;
                                "
                            >
                                üè™ Store
                            </li>
                            <li
                                data-tab="custom"
                                style="
                                    display: flex;
                                    align-items: center;
                                    gap: 10px;
                                    padding: 8px 10px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    color: var(--text);
                                    transition:
                                        background 0.15s ease,
                                        transform 0.06s ease;
                                "
                            >
                                ‚ûï Custom
                            </li>
                        </ul>
                    </aside>
                    <section class="settings-content">
                        <div id="storeTab" style="display: block">
                            <input
                                id="storeSearch"
                                class="input"
                                placeholder="Search apps..."
                                style="margin-bottom: 10px"
                            />
                            <div id="storeList" style="flex: 1; overflow: auto"></div>
                        </div>
                        <div id="customTab" style="display: none">
                            <input id="appName" class="input" placeholder="App Name" />
                            <input id="appEmoji" class="input" placeholder="Emoji Icon (e.g. üöÄ)" maxlength="2" />
                            <textarea
                                id="appHtml"
                                placeholder="Paste HTML code here"
                                class="input"
                                style="height: 100px"
                            ></textarea>
                            <button class="btn secondary" id="chooseFile">Choose File</button>
                            <button class="btn" id="addApp">Add App</button>
                        </div>
                    </section>
                </div>
            </div>
            <div class="dock" id="dock"></div>
            <div class="hidden" id="contextMenu">
                <div class="context-item" id="removeShortcut">Remove</div>
            </div>
            <div class="hidden" id="fileContextMenu">
                <div class="context-item" data-action="rename">Rename</div>
                <div class="context-item" data-action="delete">Delete</div>
                <div class="context-item" data-action="move">Move</div>
            </div>
            <div class="hidden dialog-overlay" id="dialogTemplate">
                <div class="dialog-card">
                    <h3 id="dialogTitle"></h3>
                    <div id="dialogMessage"></div>
                    <div class="dialog-buttons">
                        <button class="btn secondary" id="dialogCancel">Cancel</button>
                        <button class="btn" id="dialogConfirm">Confirm</button>
                    </div>
                </div>
            </div>
            <div class="hidden" id="notifCenter">
                <div id="notifsList"></div>
            </div>
            <div class="hidden overlay" id="spotlight">
                <div class="card">
                    <input id="spotlightInput" class="input" placeholder="Search apps or /meowai query" />
                    <div id="spotlightResults"></div>
                </div>
            </div>
            <div id="screensaver-overlay"></div>
            <div class="hidden overlay" id="recovery">
                <div class="card">
                    <h1>Recovery Mode</h1>
                    <button class="btn" id="recReset">Factory Reset</button>
                    <button class="btn secondary" id="recNoAnim">Disable Animations</button>
                    <button class="btn secondary" id="recNoGlass">Disable Glass Effects</button>
                    <button class="btn secondary" id="recBack">Back</button>
                </div>
            </div>
            <div class="debug-panel" id="debugPanel">
                <h3>KyrKat Menu üê±</h3>
                <div style="display: flex; gap: 4px">
                    <input
                        id="debugChaosDuration"
                        type="number"
                        class="input"
                        placeholder="Duration (s)"
                        style="width: 80px"
                        value="4"
                    />
                    <button class="btn" id="debugSpawnMeowTest">Activate MeowTest Chaos</button>
                </div>
                <button class="btn" id="debugFullscreen">Toggle Fullscreen</button>
                <div style="display: flex; gap: 4px">
                    <input
                        id="debugNotifText"
                        class="input"
                        placeholder="Enter notification text"
                        style="width: 180px"
                    />
                    <button class="btn" id="debugShowNotif">Show Notification</button>
                </div>
                <div style="display: flex; gap: 4px">
                    <input id="debugCatDays" type="number" class="input" placeholder="Days" style="width: 80px" />
                    <button class="btn" id="debugSetCatAge">Set Cat Age</button>
                </div>
                <button class="btn" id="debugFireworks">Spawn Fireworks</button>
                <button class="btn" id="debugClose">Close</button>
            </div>
        </div>
        <script>
            const isVM = window.name === "vm";
            const $ = (sel, el = document) => el.querySelector(sel);
            const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));
            const store = {
                get(k, def = null) {
                    if (isVM) k = "vm_" + k;
                    try {
                        const v = localStorage.getItem(k);
                        return v == null ? def : JSON.parse(v);
                    } catch {
                        return def;
                    }
                },
                set(k, v) {
                    if (isVM) k = "vm_" + k;
                    localStorage.setItem(k, JSON.stringify(v));
                },
                del(k) {
                    if (isVM) k = "vm_" + k;
                    localStorage.removeItem(k);
                },
            };
            const K = {
                setup: "meowos_setup",
                name: "meowos_name",
                notes: "meowos_notes",
                files: "meowos_files",
                wallpaper: "meowos_wallpaper",
                accent: "meowos_accent",
                scale: "meowos_scale",
                dock: "meowos_dockpos",
                theme: "meowos_theme",
                pinned: "meowos_pinned",
                shortcuts: "meowos_shortcuts",
                blur: "meowos_blur",
                reduce: "meowos_reduce",
                search: "meowos_search",
                home: "meowos_home",
                proxy: "meowos_proxy",
                blockPopups: "meowos_blockpopups",
                reduceMotion: "meowos_reduce_motion",
                highContrast: "meowos_high_contrast",
                customApps: "meowos_customapps",
                clockWidget: "meowos_clockwidget",
                calendarWidget: "meowos_calendarwidget",
                weatherWidget: "meowos_weatherwidget",
                randomWidget: "meowos_randomwidget",
                weatherCity: "meowos_weathercity",
                tz: "meowos_tz",
                screensaverEnable: "meowos_screensaver_enable",
                screensaverTimeout: "meowos_screensaver_timeout",
                fontFamily: "meowos_fontfamily",
                defaultWall: "meowos_defaultwall",
                alarms: "meowos_alarms",
                cat: "meowos_cat",
                showPinned: "meowos_show_pinned",
                showAll: "meowos_show_all",
                showRecents: "meowos_show_recents",
                meowIconSize: "meowos_meow_icon_size",
                dockIconRadius: "meowos_dock_icon_radius",
                debugUnlocked: "meowos_debug_unlocked",
                secretWallpaper: "meowos_secret_wallpaper",
                tapFeedback: "meowos_tap_feedback",
                showSeconds: "meowos_show_seconds",
                autoHideDock: "meowos_auto_hide_dock",
                currentNote: "meowos_current_note",
                tablet: "meowos_tablet",
                textcolor: "meowos_textcolor",
                iconsMode: "meowos_icons_mode",
                showDockLabels: "meowos_show_dock_labels",
                appExecutionMode: "meowos_app_execution_mode",
            };
            const apps = [
                "notes",
                "calendar",
                "browser",
                "files",
                "recorder",
                "paint",
                "calculator",
                "clock",
                "settings",
                "weather",
                "meowstore",
            ];
            const iconsLoaded = {};
            function getEmojiChar(app) {
                const map = {
                    notes: "üóíÔ∏è",
                    calendar: "üìÖ",
                    browser: "üåê",
                    files: "üìÅ",
                    recorder: "üéôÔ∏è",
                    paint: "üé®",
                    calculator: "üßÆ",
                    clock: "üïê",
                    settings: "‚öôÔ∏è",
                    cat: "üê±",
                    weather: "üå§Ô∏è",
                    meowstore: "üè™",
                };
                if (app.startsWith("custom_")) {
                    const customs = store.get(K.customApps, []);
                    const c = customs.find((c) => c.id === app.slice(7));
                    return c ? c.emoji : "‚ùì";
                }
                return map[app] || "‚ùì";
            }
            function getIcon(app, size = "28px", isDock = false) {
                if (app.startsWith("custom_") || app === "cat") {
                    const iconChar = getEmojiChar(app);
                    if (iconChar.startsWith("http")) {
                        const imgStyle = `width:${size};height:${size};border-radius:${isDock ? "var(--dock-icon-radius)" : "8px"};display:block;`;
                        const fallback = `<span class="dock-emoji" style="font-size:${size};line-height:1;display:none;">‚ùì</span>`;
                        const imgEl = `<img src="${iconChar}" style="${imgStyle}" onerror="this.style.display='none';this.nextElementSibling.style.display='inline';" alt="">`;
                        if (isDock) {
                            const bg = "rgba(255,255,255,0.05)";
                            return `<span class="icon-wrapper" style="display:flex;align-items:center;justify-content:center;width:${size};height:${size};border-radius:var(--dock-icon-radius);background:${bg};">${imgEl}${fallback}</span>`;
                        } else {
                            return `${imgEl}${fallback}`;
                        }
                    }
                    if (isDock) {
                        const bg = "rgba(255,255,255,0.05)";
                        return `<span class="icon-wrapper" style="display:flex;align-items:center;justify-content:center;width:${size};height:${size};border-radius:var(--dock-icon-radius);background:${bg}"><span class="dock-emoji" style="font-size:${size};line-height:1">${iconChar}</span></span>`;
                    }
                    return `<span class="dock-emoji" style="font-size:${size};line-height:1">${iconChar}</span>`;
                }
                const mode = store.get(K.iconsMode, "emoji");
                if (isDock) {
                    const bg = "rgba(255,255,255,0.05)";
                    let inner;
                    const pngMap = {
                        notes: "notes.png",
                        calendar: "calendar.png",
                        browser: "browser.png",
                        files: "files.png",
                        recorder: "recorder.png",
                        paint: "paint.png",
                        calculator: "calculator.png",
                        clock: "clock.png",
                        settings: "settings.png",
                        weather: "weather.png",
                        meowstore: "meowstore.png",
                    };
                    const src = pngMap[app];
                    if (mode === "emoji" || !src || !iconsLoaded[app]) {
                        inner = `<span class="dock-emoji" style="font-size:${size};line-height:1">${getEmojiChar(app)}</span>`;
                    } else {
                        inner = `<img src="${src}" class="app-icon" style="width:${size};height:${size};border-radius:var(--dock-icon-radius);display:block;">`;
                    }
                    return `<span class="icon-wrapper" style="display:flex;align-items:center;justify-content:center;width:${size};height:${size};border-radius:var(--dock-icon-radius);background:${bg};">${inner}</span>`;
                }
                if (mode === "emoji") {
                    return `<span class="dock-emoji" style="font-size:${size};line-height:1">${getEmojiChar(app)}</span>`;
                }
                const pngMap = {
                    notes: "notes.png",
                    calendar: "calendar.png",
                    browser: "browser.png",
                    files: "files.png",
                    recorder: "recorder.png",
                    paint: "paint.png",
                    calculator: "calculator.png",
                    clock: "clock.png",
                    settings: "settings.png",
                    weather: "weather.png",
                    meowstore: "meowstore.png",
                };
                const src = pngMap[app];
                if (!src || !iconsLoaded[app]) {
                    return `<span class="dock-emoji" style="font-size:${size};line-height:1">${getEmojiChar(app)}</span>`;
                }
                return `<img src="${src}" class="app-icon" style="width:${size};height:${size};border-radius:8px;display:block;">`;
            }
            function getLabel(app) {
                if (app.startsWith("custom_")) {
                    const customs = store.get(K.customApps, []);
                    const c = customs.find((c) => c.id === app.slice(7));
                    return c ? c.name : "Unknown";
                }
                return app.charAt(0).toUpperCase() + app.slice(1);
            }
            async function preloadIcons() {
                const pngApps = [
                    "notes",
                    "calendar",
                    "browser",
                    "files",
                    "recorder",
                    "paint",
                    "calculator",
                    "clock",
                    "settings",
                    "weather",
                    "meowstore",
                ];
                const promises = pngApps.map(
                    (app) =>
                        new Promise((resolve) => {
                            const img = new Image();
                            const name = `${app}.png`;
                            img.onload = () => {
                                iconsLoaded[app] = name;
                                resolve(true);
                            };
                            img.onerror = () => {
                                iconsLoaded[app] = null;
                                resolve(false);
                            };
                            img.src = name;
                        })
                );
                const results = await Promise.all(promises);
                const allLoaded = results.every(Boolean);
                if (allLoaded) {
                    store.set(K.iconsMode, "png");
                } else {
                    store.set(K.iconsMode, "emoji");
                }
                return allLoaded;
            }
            function preload() {
                preloadIcons().then(() => {
                    refreshIcons();
                });
            }
            function refreshIcons() {
                renderDock();
                buildMeowMenu();
                renderShortcuts();
                $$(".app-window:not(.hidden)").forEach((win) => {
                    const app = win.dataset.app;
                    if (app && !app.startsWith("custom_") && $(".win-emoji", win)) {
                        $(".win-emoji", win).innerHTML = getIcon(app, "20px");
                    }
                });
            }
            let zTop = 10;
            let dragElement = null,
                dragOffsetX = 0,
                dragOffsetY = 0;
            let clockWidget = null;
            let calendarWidget = null;
            let weatherWidget = null;
            let randomWidget = null;
            let lastMidnight = null;
            let idleTimer;
            let catInterval;
            let startClickCount = 0;
            let startClickTimer = 0;
            let rClickCount = 0;
            let rClickTimer = 0;
            let welcomeFontInterval;
            // Easter Egg: Konami Code
            const konamiCode = [38, 38, 40, 40, 37, 39, 37, 39, 66, 65]; // ‚Üë‚Üë‚Üì‚Üì‚Üê‚Üí‚Üê‚ÜíBA
            let konamiIndex = 0;
            function initKonami() {
                document.addEventListener("keydown", (e) => {
                    if (
                        $("#onboarding").classList.contains("hidden") &&
                        !$("#spotlight").classList.contains("hidden") === false
                    ) {
                        if (e.keyCode === konamiCode[konamiIndex]) {
                            konamiIndex++;
                            if (konamiIndex === konamiCode.length) {
                                konamiIndex = 0;
                                // Spawn pixel cats running across the screen
                                for (let i = 0; i < 5; i++) {
                                    setTimeout(() => {
                                        const cat = document.createElement("div");
                                        cat.className = "pixel-cat";
                                        cat.style.top = 20 + Math.random() * 60 + "%";
                                        cat.style.animationDelay = Math.random() * 0.5 + "s";
                                        document.body.appendChild(cat);
                                        setTimeout(() => cat.remove(), 3000);
                                    }, i * 200);
                                }
                                flash("Konami Code activated! üê± Running cats!");
                            }
                        } else {
                            konamiIndex = 0;
                        }
                    }
                });
            }
            function checkAlarms() {
                const nowStr = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", hour12: false });
                let alarms = store.get(K.alarms, []);
                const ringing = alarms.filter((a) => a.time === nowStr);
                if (ringing.length) {
                    showCustomAlert("Alarm", "Alarm ringing!");
                    alarms = alarms.filter((a) => a.time !== nowStr);
                    store.set(K.alarms, alarms);
                }
            }
            function resetIdleTimer() {
                clearTimeout(idleTimer);
                $("#screensaver-overlay").style.display = "none";
                if (store.get(K.screensaverEnable, false)) {
                    const timeout = store.get(K.screensaverTimeout, 5) * 60000;
                    idleTimer = setTimeout(() => {
                        $("#screensaver-overlay").style.display = "block";
                    }, timeout);
                }
            }
            function applyBackground() {
                const wp = store.get(K.wallpaper);
                if (wp) {
                    document.body.style.backgroundImage = `url(${wp})`;
                    document.body.style.backgroundSize = "cover";
                } else {
                    const def = store.get(K.defaultWall, "blue-balls");
                    let grad1 = "--dark-grad1",
                        grad2 = "--dark-grad2";
                    let bg = "";
                    if (def === "default") {
                        bg = `radial-gradient(80vw 80vh at 10% 15%,var(${grad1}),transparent 60%),radial-gradient(80vw 80vh at 90% 85%,var(${grad2}),transparent 60%)`;
                    } else if (def === "orange-balls") {
                        bg = `radial-gradient(circle at 20% 80%, #cc7a00 0%, #cc5500 30%, transparent 50%), radial-gradient(circle at 60% 20%, #cc6600 0%, #cc7a00 30%, transparent 50%), radial-gradient(circle at 80% 70%, #cc5500 0%, #cc6600 30%, transparent 50%), linear-gradient(to bottom, #0b0f17, #1a1f2e)`;
                    } else if (def === "blue-balls") {
                        bg = `radial-gradient(circle at 10% 30%, #2c5282 0%, #2a4365 30%, transparent 50%), radial-gradient(circle at 70% 60%, #319795 0%, #285e61 30%, transparent 50%), radial-gradient(circle at 40% 90%, #68d391 0%, #38a169 30%, transparent 50%), linear-gradient(to bottom, #0b0f17, #1a1f2e)`;
                    } else if (def === "green-rectangles") {
                        bg = `repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(46, 207, 142, 0.2) 50px, rgba(46, 207, 142, 0.2) 100px), repeating-linear-gradient(0deg, transparent, transparent 30px, rgba(46, 207, 142, 0.2) 30px, rgba(46, 207, 142, 0.2) 60px), linear-gradient(to bottom, #0b0f17, #1a1f2e)`;
                    } else if (def === "blue-stripes") {
                        bg = `repeating-linear-gradient(45deg, transparent, transparent 20px, #2c5282 20px, #2c5282 40px), linear-gradient(to bottom, #0b0f17, #1a1f2e)`;
                    } else if (def === "checkerboard") {
                        bg = `repeating-conic-gradient(from 0deg at 10px 10px, #1a1f2e 0deg 90deg, #0b0f17 90deg 180deg, #1a1f2e 180deg 270deg, #0b0f17 270deg 360deg), linear-gradient(to bottom, #0b0f17, #1a1f2e)`;
                    } else if (def === "dots") {
                        bg = `radial-gradient(circle at 20px 20px, rgba(138, 155, 255, 0.4) 1px, transparent 1px), radial-gradient(circle at 40px 40px, rgba(138, 155, 255, 0.4) 1px, transparent 1px), repeating-linear-gradient(0deg, transparent, transparent 20px), linear-gradient(to bottom, #0b0f17, #1a1f2e)`;
                    } else if (def === "blue") {
                        bg = "linear-gradient(to bottom, #00008b, #87ceeb)";
                    } else if (def === "green") {
                        bg = "linear-gradient(to bottom, #006400, #90ee90)";
                    } else if (def === "red") {
                        bg = "linear-gradient(to bottom, #8b0000, #ff7f7f)";
                    } else if (def === "purple") {
                        bg = "linear-gradient(to bottom, #4b0082, #dda0dd)";
                    } else if (def === "orange") {
                        bg = "linear-gradient(to bottom, #ff4500, #ffd700)";
                    } else if (def === "pink") {
                        bg = "linear-gradient(to bottom, #ff1493, #ffc0cb)";
                    } else if (def === "teal") {
                        bg = "linear-gradient(to bottom, #008080, #00bfff)";
                    } else if (def === "lavender") {
                        bg = "linear-gradient(to bottom, #e6e6fa, #9370db)";
                    } else if (def === "gray") {
                        bg = "linear-gradient(to bottom, #a9a9a9, #696969)";
                    } else if (def === "yellow") {
                        bg = "linear-gradient(to bottom, #ffff00, #ffd700)";
                    } else if (def === "cyan") {
                        bg = "linear-gradient(to bottom, #00ffff, #008b8b)";
                    } else if (def === "magenta") {
                        bg = "linear-gradient(to bottom, #ff00ff, #da70d6)";
                    } else if (def === "black") {
                        bg = "linear-gradient(to bottom, #000000, #333333)";
                    } else if (def === "cat-orange") {
                        bg = "radial-gradient(circle at 20% 80%, #cc7a00, #cc5500, #cc6600)";
                    } else if (def === "indigo") {
                        bg = "linear-gradient(to bottom, #4b0082, #8a2be2)";
                    } else if (def === "lime") {
                        bg = "linear-gradient(to bottom, #32cd32, #adff2f)";
                    } else if (def === "maroon") {
                        bg = "linear-gradient(to bottom, #800000, #bc8f8f)";
                    } else if (def === "navy") {
                        bg = "linear-gradient(to bottom, #000080, #4682b4)";
                    } else if (def === "olive") {
                        bg = "linear-gradient(to bottom, #808000, #bdbd7c)";
                    } else if (def === "silver") {
                        bg = "linear-gradient(to bottom, #c0c0c0, #a9a9a9)";
                    } else if (def === "violet") {
                        bg = "linear-gradient(to bottom, #ee82ee, #8a2be2)";
                    } else if (def === "secret") {
                        document.body.classList.add("secret-wallpaper");
                        return;
                    }
                    document.body.style.backgroundImage = bg;
                }
            }
            function updateTextColor() {
                const customText = store.get(K.textcolor);
                if (customText) {
                    document.documentElement.style.setProperty("--text", customText);
                } else {
                    const defaultText = "#e6ecff";
                    document.documentElement.style.setProperty("--text", defaultText);
                    store.set(K.textcolor, defaultText);
                }
            }
            function showDesktop() {
                $("#onboarding").classList.add("hidden");
                $("#loading").classList.add("hidden");
                $("#desktop").classList.remove("hidden");
                const displayName = store.get(K.name, "Friend");
                $("#hello").textContent = `üò∫ Welcome, ${displayName}!`;
                $("#meowUser").textContent = displayName;
                const clock = $("#clock");
                const tz = store.get(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
                const update = () => {
                    const d = new Date();
                    const opts = { hour: "2-digit", minute: "2-digit", timeZone: tz };
                    if (store.get(K.showSeconds, false)) opts.second = "2-digit";
                    clock.textContent = d.toLocaleTimeString([], opts);
                    const timeStr = d.toLocaleTimeString([], {
                        hour: "2-digit",
                        minute: "2-digit",
                        hourCycle: "h23",
                        timeZone: tz,
                    });
                    const currentDate = d.toLocaleString([], {
                        timeZone: tz,
                        year: "numeric",
                        month: "numeric",
                        day: "numeric",
                    });
                    if (timeStr === "00:00" && lastMidnight !== currentDate) {
                        flash("üê±üí§");
                        lastMidnight = currentDate;
                    }
                };
                update();
                setInterval(update, 1000 * 30);
                setInterval(checkAlarms, 60000);
                checkAlarms();
                updateTextColor();
                const scale = store.get(K.scale, 1);
                document.documentElement.style.setProperty("--font-scale", scale);
                const font = store.get(K.fontFamily, null);
                if (font) document.documentElement.style.setProperty("--font-family", font);
                const dockPos = store.get(K.dock, "bottom");
                if (dockPos === "left") document.body.classList.add("dock-left");
                const accent = store.get(K.accent, "#8a9bff");
                document.documentElement.style.setProperty("--accent", accent);
                const blur = store.get(K.blur, 50);
                document.documentElement.style.setProperty("--blur", `saturate(140%) blur(${blur}px)`);
                document.body.classList.toggle("no-glass", !!store.get(K.reduce, false));
                document.body.classList.toggle("reduce-motion", !!store.get(K.reduceMotion, false));
                document.body.classList.toggle("high-contrast", !!store.get(K.highContrast, false));
                const iconSize = store.get(K.meowIconSize, 92);
                document.documentElement.style.setProperty("--meow-icon-size", iconSize + "px");
                const dockRadius = store.get(K.dockIconRadius, 8);
                document.documentElement.style.setProperty("--dock-icon-radius", dockRadius + "px");
                applyBackground();
                applyTabletMode(store.get(K.tablet, false));
                buildMeowMenu();
                renderDock();
                renderShortcuts();
                toggleClockWidget(store.get(K.clockWidget, false));
                toggleCalendarWidget(store.get(K.calendarWidget, false));
                toggleWeatherWidget(store.get(K.weatherWidget, false));
                toggleRandomWidget(store.get(K.randomWidget, false));
                // Edge minimizers
                const leftEdge = document.createElement("div");
                leftEdge.id = "leftMinEdge";
                leftEdge.style.cssText =
                    "position:fixed;left:0;top:0;width:20px;height:100vh;z-index:999;cursor:pointer;background:transparent;";
                leftEdge.addEventListener("click", restoreFromEdge.bind(null, "left"));
                document.body.appendChild(leftEdge);
                const rightEdge = document.createElement("div");
                rightEdge.id = "rightMinEdge";
                rightEdge.style.cssText =
                    "position:fixed;right:0;top:0;width:20px;height:100vh;z-index:999;cursor:pointer;background:transparent;";
                rightEdge.addEventListener("click", restoreFromEdge.bind(null, "right"));
                document.body.appendChild(rightEdge);
                document.addEventListener("mousemove", resetIdleTimer);
                document.addEventListener("keydown", resetIdleTimer);
                document.addEventListener("touchstart", resetIdleTimer);
                resetIdleTimer();
                addRippleEffect($("#desktop"));
                $$(".window-body").forEach((w) => addRippleEffect(w));
                // Edge minimizers
                // Init Easter Eggs
                initKonami();
                initDebug();
                toggleAutoHideDock(store.get(K.autoHideDock, false));
                if (isVM) document.title = "MeowOS VM";
                // Control Center init
                $("#ccReboot").addEventListener("click", () => {
                    showCustomConfirm("Reboot", "Refresh MeowOS?", () => location.reload());
                });
                $("#ccSettings").addEventListener("click", () => {
                    openWindow("settings");
                    $("#controlCenterMenu").classList.add("hidden");
                });
                $("#controlCenter").addEventListener("click", () => {
                    $("#controlCenterMenu").classList.toggle("hidden");
                });
                document.addEventListener("click", (e) => {
                    const cc = $("#controlCenter"),
                        menu = $("#controlCenterMenu");
                    if (!menu.contains(e.target) && !cc.contains(e.target)) menu.classList.add("hidden");
                });
                preload();
            }
            function centerWindow(win) {
                if (store.get(K.tablet, false)) return;
                const rect = win.getBoundingClientRect();
                const centerX = (window.innerWidth - rect.width) / 2;
                const centerY = (window.innerHeight - rect.height) / 2;
                win.style.left = Math.max(10, centerX) + "px";
                win.style.top = Math.max(10, centerY) + "px";
            }
            function applyTabletMode(enable) {
                document.body.classList.toggle("tablet-mode", enable);
                if (enable) {
                    $$(".app-window").forEach((win) => {
                        win.style.position = "fixed";
                        win.style.inset = "0";
                        win.style.borderRadius = "0";
                        win.style.width = "100vw";
                        win.style.height = "100vh";
                        win.style.zIndex = "1000";
                        win.style.minWidth = "auto";
                        win.style.minHeight = "auto";
                    });
                    $$(".win-max, .win-min").forEach((btn) => (btn.style.display = "none"));
                    $$(".window-header").forEach((header) => {
                        header.style.cursor = "default";
                    });
                } else {
                    $$(".app-window").forEach((win) => {
                        win.style.position = "";
                        win.style.inset = "";
                        win.style.borderRadius = "";
                        win.style.width = "";
                        win.style.height = "";
                        win.style.zIndex = "";
                        win.style.minWidth = "";
                        win.style.minHeight = "";
                    });
                    $$(".win-max, .win-min").forEach((btn) => (btn.style.display = ""));
                    $$(".window-header").forEach((header) => {
                        header.style.cursor = "grab";
                    });
                }
            }
            function toggleAutoHideDock(enable) {
                const dock = $("#dock");
                const dockPos = store.get(K.dock, "bottom");
                if (enable) {
                    dock.style.transition = dockPos === "bottom" ? "bottom 0.3s ease" : "left 0.3s ease";
                    dock.style[dockPos] = dockPos === "bottom" ? "-60px" : "-60px";
                    dock.addEventListener(
                        "mouseenter",
                        () => (dock.style[dockPos] = dockPos === "bottom" ? "14px" : "14px")
                    );
                    dock.addEventListener(
                        "mouseleave",
                        () => (dock.style[dockPos] = dockPos === "bottom" ? "-60px" : "-60px")
                    );
                } else {
                    dock.style.transition = "";
                    dock.style[dockPos] = dockPos === "bottom" ? "14px" : "14px";
                    dock.removeEventListener("mouseenter", () => {});
                    dock.removeEventListener("mouseleave", () => {});
                }
            }
            function restoreFromEdge(side) {
                const edge = side === "left" ? $("#leftMinEdge") : $("#rightMinEdge");
                const winId = edge.dataset.minWindow;
                if (!winId) return;
                const win = document.getElementById(winId);
                if (!win) return;
                win.style.display = "";
                const origLeft = win.dataset.origLeft;
                const origTop = win.dataset.origTop;
                const origWidth = win.dataset.origWidth;
                const origHeight = win.dataset.origHeight;
                win.style.left = side === "left" ? `-${parseFloat(origWidth)}px` : `${window.innerWidth}px`;
                win.style.top = origTop;
                win.style.width = origWidth;
                win.style.height = origHeight;
                win.style.transition = "left 0.3s ease";
                setTimeout(() => {
                    win.style.left = origLeft;
                }, 10);
                setTimeout(() => {
                    win.style.transition = "";
                    edge.dataset.minWindow = "";
                    bringToFront(win);
                    dockMarkOpen(win.dataset.app, true);
                }, 300);
            }
            function toggleClockWidget(enable) {
                if (clockWidget) clockWidget.remove();
                if (!enable) return;
                clockWidget = document.createElement("div");
                clockWidget.className = "widget";
                clockWidget.style.top = "60px";
                clockWidget.style.right = "20px";
                clockWidget.style.width = "120px";
                clockWidget.style.minWidth = "100px";
                clockWidget.style.minHeight = "80px";
                const title = document.createElement("div");
                title.className = "title";
                title.textContent = "Clock";
                clockWidget.appendChild(title);
                const time = document.createElement("div");
                time.className = "content";
                time.style.fontSize = "24px";
                time.style.fontWeight = "bold";
                clockWidget.appendChild(time);
                const updateTime = () => {
                    const d = new Date();
                    const tz = store.get(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
                    const opts = { hour: "2-digit", minute: "2-digit", timeZone: tz };
                    if (store.get(K.showSeconds, false)) opts.second = "2-digit";
                    time.textContent = d.toLocaleTimeString([], opts);
                };
                updateTime();
                setInterval(updateTime, 1000);
                $("#desktop").appendChild(clockWidget);
                makeWidgetDraggable(clockWidget);
                addWidgetResizers(clockWidget, 100, 80);
            }
            function toggleCalendarWidget(enable) {
                if (calendarWidget) calendarWidget.remove();
                if (!enable) return;
                calendarWidget = document.createElement("div");
                calendarWidget.className = "widget";
                calendarWidget.style.top = "200px";
                calendarWidget.style.right = "20px";
                calendarWidget.style.width = "210px";
                calendarWidget.style.minWidth = "180px";
                calendarWidget.style.minHeight = "150px";
                const title = document.createElement("div");
                title.className = "title";
                title.textContent = "Calendar";
                calendarWidget.appendChild(title);
                const month = document.createElement("div");
                month.style.textAlign = "center";
                month.style.fontWeight = "bold";
                calendarWidget.appendChild(month);
                const grid = document.createElement("div");
                grid.style.display = "grid";
                grid.style.gridTemplateColumns = "repeat(7, 1fr)";
                grid.style.gap = "2px";
                calendarWidget.appendChild(grid);
                const updateCal = () => {
                    const d = new Date();
                    const tz = store.get(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
                    month.textContent = d.toLocaleString(undefined, { month: "long", year: "numeric", timeZone: tz });
                    grid.innerHTML = "";
                    ["M", "T", "W", "T", "F", "S", "S"].forEach((day) => {
                        const dh = document.createElement("div");
                        dh.textContent = day;
                        dh.style.textAlign = "center";
                        dh.style.color = "var(--muted)";
                        grid.appendChild(dh);
                    });
                    const first = new Date(
                        d.toLocaleString("en-us", {
                            timeZone: tz,
                            year: "numeric",
                            month: "numeric",
                            day: "2-digit",
                            hour: "2-digit",
                            minute: "2-digit",
                            second: "2-digit",
                        })
                    );
                    first.setDate(1);
                    const offset = (first.getDay() + 6) % 7;
                    for (let i = 0; i < offset; i++) {
                        const empty = document.createElement("div");
                        grid.appendChild(empty);
                    }
                    const daysInMonth = new Date(first.getFullYear(), first.getMonth() + 1, 0).getDate();
                    const today = d;
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dd = document.createElement("div");
                        dd.textContent = day;
                        dd.style.textAlign = "center";
                        if (
                            day === today.getDate() &&
                            first.getMonth() === today.getMonth() &&
                            first.getFullYear() === today.getFullYear()
                        ) {
                            dd.style.background = "var(--accent)";
                            dd.style.color = "#fff";
                        }
                        dd.style.borderRadius = "50%";
                        dd.style.width = "24px";
                        dd.style.height = "24px";
                        dd.style.lineHeight = "24px";
                        dd.style.margin = "auto";
                        grid.appendChild(dd);
                    }
                    const dateCellsSoFar = offset + daysInMonth;
                    const endOffset = 42 - dateCellsSoFar;
                    for (let i = 0; i < endOffset; i++) {
                        const empty = document.createElement("div");
                        grid.appendChild(empty);
                    }
                };
                updateCal();
                $("#desktop").appendChild(calendarWidget);
                makeWidgetDraggable(calendarWidget);
                addWidgetResizers(calendarWidget, 180, 150);
            }
            function toggleWeatherWidget(enable) {
                if (weatherWidget) weatherWidget.remove();
                if (!enable) return;
                weatherWidget = document.createElement("div");
                weatherWidget.className = "widget";
                weatherWidget.style.top = "340px";
                weatherWidget.style.right = "20px";
                weatherWidget.style.width = "120px";
                weatherWidget.style.minWidth = "100px";
                weatherWidget.style.minHeight = "80px";
                const title = document.createElement("div");
                title.className = "title";
                title.textContent = "Weather";
                weatherWidget.appendChild(title);
                const content = document.createElement("div");
                content.className = "content";
                weatherWidget.appendChild(content);
                const city = store.get(K.weatherCity, "London");
                const updateWeather = async () => {
                    const weather = await fetchWeatherFor(`weather ${city}`);
                    content.innerHTML = `<div class="temp">${weather.split("¬∞C")[0]}¬∞C</div><div style="font-size:12px;color:var(--muted)">${city}</div>`;
                };
                updateWeather();
                setInterval(updateWeather, 600000); // Update every 10 min
                $("#desktop").appendChild(weatherWidget);
                makeWidgetDraggable(weatherWidget);
                addWidgetResizers(weatherWidget, 100, 80);
            }
            function toggleRandomWidget(enable) {
                if (randomWidget) randomWidget.remove();
                if (!enable) return;
                randomWidget = document.createElement("div");
                randomWidget.className = "widget";
                randomWidget.style.top = "60px";
                randomWidget.style.left = "20px";
                randomWidget.style.width = "200px";
                randomWidget.style.minWidth = "150px";
                randomWidget.style.minHeight = "100px";
                const title = document.createElement("div");
                title.className = "title";
                title.textContent = "Random Wiki";
                randomWidget.appendChild(title);
                const content = document.createElement("div");
                content.className = "content";
                content.style.cursor = "pointer";
                randomWidget.appendChild(content);
                const updateRandom = async () => {
                    try {
                        const randRes = await fetch(
                            "https://r.jina.ai/https://en.wikipedia.org/w/api.php?action=query&format=json&list=random&rnnamespace=0&rnlimit=1"
                        );
                        const randData = await randRes.json();
                        const randTitle = randData.query.random[0].title;
                        const extractRes = await fetch(
                            `https://r.jina.ai/https://en.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&exintro&explaintext&redirects=1&titles=${encodeURIComponent(randTitle)}`
                        );
                        const extractData = await extractRes.json();
                        const pages = extractData.query.pages;
                        const page = Object.values(pages)[0];
                        if (page.missing) {
                            content.innerHTML = "No article found.";
                            return;
                        }
                        const summary = page.extract ? page.extract.split(".")[0] + "." : "No summary available.";
                        content.innerHTML = `<div style="font-weight:bold; margin-bottom:4px;">${randTitle}</div><div style="font-size:12px;">${summary}</div><div style="font-size:10px; color:var(--muted); margin-top:4px; cursor:pointer;" onclick="openInBrowser('https://en.wikipedia.org/wiki/${encodeURIComponent(randTitle.replace(/ /g, "_"))}')">Read more</div>`;
                    } catch (e) {
                        content.textContent = "Failed to load random article.";
                    }
                };
                updateRandom();
                setInterval(updateRandom, 3600000); // Update every hour
                content.addEventListener("click", () => updateRandom());
                $("#desktop").appendChild(randomWidget);
                makeWidgetDraggable(randomWidget);
                addWidgetResizers(randomWidget, 150, 100);
            }
            function openInBrowser(url) {
                openWindow("browser");
                const input = $("#url");
                input.value = url;
                const event = new KeyboardEvent("keydown", { key: "Enter", bubbles: true });
                input.dispatchEvent(event);
            }
            function startOnboarding() {
                $("#onboarding").classList.remove("hidden");
                $("#ob-step-1").classList.remove("hidden");
                $("#ob-step-2").classList.add("hidden");
                $("#ob-step-3").classList.add("hidden");
                $("#ob-step-4").classList.add("hidden");
                const currentTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                $("#obTimeZone").value = currentTz;
                if (!$("#obTimeZone").querySelector(`option[value="${currentTz}"]`)) {
                    const opt = document.createElement("option");
                    opt.value = currentTz;
                    opt.textContent = currentTz;
                    $("#obTimeZone").appendChild(opt);
                    $("#obTimeZone").value = currentTz;
                }
                // Cycle fonts for Welcome
                const fonts = ["cursive", "serif", "fantasy", "monospace", "ui-serif", "ui-sans-serif", "ui-monospace"];
                let fontIndex = 0;
                const welcomeEl = $("#welcomeFonts");
                function cycleFont() {
                    welcomeEl.style.fontFamily = fonts[fontIndex];
                    fontIndex = (fontIndex + 1) % fonts.length;
                }
                welcomeFontInterval = setInterval(cycleFont, 2000);
                cycleFont(); // Initial
            }
            function makeDraggable(win) {
                const header = $(".window-header", win);
                let startX = 0,
                    startY = 0,
                    sx = 0,
                    sy = 0,
                    dragging = false;
                header.addEventListener("mousedown", (e) => {
                    const tag = e.target.tagName;
                    if (
                        ["INPUT", "TEXTAREA", "SELECT", "BUTTON", "LABEL", "A"].includes(tag) ||
                        e.target.closest(".toolbar")
                    )
                        return;
                    if (e.target.classList.contains("win-btn") || e.target.closest(".toolbar")) return;
                    dragging = true;
                    header.style.cursor = "grabbing";
                    const rect = win.getBoundingClientRect();
                    sx = rect.left;
                    sy = rect.top;
                    startX = e.clientX;
                    startY = e.clientY;
                    bringToFront(win);
                    e.preventDefault();
                });
                window.addEventListener("mousemove", (e) => {
                    if (!dragging) return;
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    win.style.left = Math.max(6, sx + dx) + "px";
                    win.style.top = Math.max(6, sy + dy) + "px";
                });
                window.addEventListener("mouseup", () => {
                    dragging = false;
                    header.style.cursor = "grab";
                });
                header.addEventListener("dblclick", () => toggleMaximize(win));
                win.addEventListener("mousedown", () => bringToFront(win));
                const [minBtn, maxBtn, closeBtn] = $$(".win-btn", win);
                if (minBtn) minBtn.addEventListener("click", () => minimizeWindow(win));
                if (maxBtn) maxBtn.addEventListener("click", () => toggleMaximize(win));
                if (closeBtn) closeBtn.addEventListener("click", () => closeWindow(win));
                const iconEl = $(".win-emoji", win);
                if (iconEl) {
                    iconEl.innerHTML = getIcon(win.dataset.app, "20px");
                    iconEl.draggable = true;
                    iconEl.addEventListener("dragstart", (e) => {
                        e.dataTransfer.setData("text", JSON.stringify({ from: "window", app: win.dataset.app }));
                    });
                }
                addResizers(win);
            }
            function addResizers(win) {
                const directions = [
                    {
                        pos: "top-left",
                        cursor: "nwse-resize",
                        dx: -1,
                        dy: -1,
                        width: "10px",
                        height: "10px",
                        top: "-5px",
                        left: "-5px",
                    },
                    {
                        pos: "top-right",
                        cursor: "nesw-resize",
                        dx: 1,
                        dy: -1,
                        width: "10px",
                        height: "10px",
                        top: "-5px",
                        right: "-5px",
                    },
                    {
                        pos: "bottom-left",
                        cursor: "nesw-resize",
                        dx: -1,
                        dy: 1,
                        width: "10px",
                        height: "10px",
                        bottom: "-5px",
                        left: "-5px",
                    },
                    {
                        pos: "bottom-right",
                        cursor: "nwse-resize",
                        dx: 1,
                        dy: 1,
                        width: "10px",
                        height: "10px",
                        bottom: "-5px",
                        right: "-5px",
                    },
                    {
                        pos: "top",
                        cursor: "ns-resize",
                        dx: 0,
                        dy: -1,
                        width: "calc(100% + 10px)",
                        height: "10px",
                        top: "-5px",
                        left: "-5px",
                    },
                    {
                        pos: "bottom",
                        cursor: "ns-resize",
                        dx: 0,
                        dy: 1,
                        width: "calc(100% + 10px)",
                        height: "10px",
                        bottom: "-5px",
                        left: "-5px",
                    },
                    {
                        pos: "left",
                        cursor: "ew-resize",
                        dx: -1,
                        dy: 0,
                        width: "10px",
                        height: "calc(100% + 10px)",
                        left: "-5px",
                        top: "-5px",
                    },
                    {
                        pos: "right",
                        cursor: "ew-resize",
                        dx: 1,
                        dy: 0,
                        width: "10px",
                        height: "calc(100% + 10px)",
                        right: "-5px",
                        top: "-5px",
                    },
                ];
                directions.forEach((dir) => {
                    const resizer = document.createElement("div");
                    resizer.className = `resizer ${dir.pos}`;
                    resizer.style.cursor = dir.cursor;
                    resizer.style.width = dir.width;
                    resizer.style.height = dir.height;
                    resizer.style.position = "absolute";
                    resizer.style.userSelect = "none";
                    if (dir.top) resizer.style.top = dir.top;
                    if (dir.bottom) resizer.style.bottom = dir.bottom;
                    if (dir.left) resizer.style.left = dir.left;
                    if (dir.right) resizer.style.right = dir.right;
                    win.appendChild(resizer);
                    let resizing = false,
                        startX,
                        startY,
                        startWidth,
                        startHeight,
                        startLeft,
                        startTop;
                    resizer.addEventListener("mousedown", (e) => {
                        resizing = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        startWidth = parseInt(getComputedStyle(win).width, 10);
                        startHeight = parseInt(getComputedStyle(win).height, 10);
                        startLeft = win.getBoundingClientRect().left;
                        startTop = win.getBoundingClientRect().top;
                        e.preventDefault();
                    });
                    window.addEventListener("mousemove", (e) => {
                        if (!resizing) return;
                        if (dir.dx !== 0) {
                            if (dir.dx === -1) {
                                const newWidth = startWidth - (e.clientX - startX);
                                if (newWidth > 200) {
                                    win.style.width = newWidth + "px";
                                    win.style.left = startLeft + (e.clientX - startX) + "px";
                                }
                            } else {
                                const newWidth = startWidth + (e.clientX - startX);
                                if (newWidth > 200) win.style.width = newWidth + "px";
                            }
                        }
                        if (dir.dy !== 0) {
                            if (dir.dy === -1) {
                                const newHeight = startHeight - (e.clientY - startY);
                                if (newHeight > 150) {
                                    win.style.height = newHeight + "px";
                                    win.style.top = startTop + (e.clientY - startY) + "px";
                                }
                            } else {
                                const newHeight = startHeight + (e.clientY - startY);
                                if (newHeight > 150) win.style.height = newHeight + "px";
                            }
                        }
                    });
                    window.addEventListener("mouseup", () => {
                        resizing = false;
                    });
                });
            }
            function bringToFront(win) {
                win.style.zIndex = ++zTop;
                dockMarkOpen(win.dataset.app, true);
            }
            function openWindow(app) {
                if (app.startsWith("custom_")) {
                    openCustom(app.slice(7));
                    return;
                }
                if (app === "cat") {
                    showCatWindow();
                    return;
                }
                if (app === "kyrkat") {
                    $("#debugPanel").style.display = "block";
                    return;
                }
                const win = $(`#win-${app}`);
                if (!win) return;
                win.classList.remove("hidden", "minimized");
                const tabletMode = store.get(K.tablet, false);
                if (tabletMode) {
                    win.style.position = "fixed";
                    win.style.inset = "0";
                    win.style.borderRadius = "0";
                    win.style.width = "100vw";
                    win.style.height = "100vh";
                    win.style.zIndex = "1000";
                    win.style.minWidth = "auto";
                    win.style.minHeight = "auto";
                    $$(".win-max, .win-min").forEach((btn) => (btn.style.display = "none"));
                    $(".window-header", win).style.cursor = "default";
                }
                const iconEl = $(".win-emoji", win);
                if (iconEl) {
                    iconEl.innerHTML = getIcon(app, "20px");
                    iconEl.draggable = true;
                    iconEl.addEventListener("dragstart", (e) => {
                        e.dataTransfer.setData("text", JSON.stringify({ from: "window", app: app }));
                    });
                }
                bringToFront(win);
                centerWindow(win);
            }
            function openNewWindow(app, file = null) {
                const originalId = `win-${app}`;
                const original = $(`#${originalId}`);
                if (!original) return openWindow(app);
                const instanceId = Date.now();
                const cloneId = originalId + "-" + instanceId;
                const clone = original.cloneNode(true);
                clone.id = cloneId;
                clone.dataset.app = app;
                clone.dataset.instance = instanceId;
                if (file) {
                    const titleEl = clone.querySelector(".win-title");
                    titleEl.textContent = titleEl.textContent + ` - ${file}`;
                }
                clone.classList.remove("hidden", "minimized");
                clone.style.left = `${10 + Math.random() * 40}vw`;
                clone.style.top = `${10 + Math.random() * 30}vh`;
                $$("[id]", clone).forEach((el) => {
                    el.id += "-" + instanceId;
                });
                makeDraggable(clone);
                addResizers(clone);
                const tabletMode = store.get(K.tablet, false);
                if (tabletMode) {
                    clone.style.position = "fixed";
                    clone.style.inset = "0";
                    clone.style.borderRadius = "0";
                    clone.style.width = "100vw";
                    clone.style.height = "100vh";
                    clone.style.zIndex = "1000";
                    clone.style.minWidth = "auto";
                    clone.style.minHeight = "auto";
                    $$(".win-max, .win-min", clone).forEach((btn) => (btn.style.display = "none"));
                    $(".window-header", clone).style.cursor = "default";
                }
                const iconEl = $(".win-emoji", clone);
                if (iconEl) {
                    iconEl.innerHTML = getIcon(app, "20px");
                    iconEl.draggable = true;
                    iconEl.addEventListener("dragstart", (e) => {
                        e.dataTransfer.setData("text", JSON.stringify({ from: "window", app: app }));
                    });
                }
                bringToFront(clone);
                centerWindow(clone);
                $("#desktop").appendChild(clone);
            }
            function minimizeWindow(win) {
                if (win.dataset.max === "1") {
                    toggleMaximize(win);
                }
                win.dataset.origLeft = win.style.left || win.getBoundingClientRect().left + "px";
                win.dataset.origTop = win.style.top || win.getBoundingClientRect().top + "px";
                win.dataset.origWidth = win.style.width || win.getBoundingClientRect().width + "px";
                win.dataset.origHeight = win.style.height || win.getBoundingClientRect().height + "px";
                const rect = win.getBoundingClientRect();
                const isLeft = rect.left + rect.width / 2 < window.innerWidth / 2;
                const targetLeft = isLeft ? -rect.width : window.innerWidth;
                win.dataset.minSide = isLeft ? "left" : "right";
                win.style.transition = "left 0.3s ease";
                win.style.left = targetLeft + "px";
                setTimeout(() => {
                    win.style.display = "none";
                    win.style.transition = "";
                    const edge = isLeft ? $("#leftMinEdge") : $("#rightMinEdge");
                    edge.dataset.minWindow = win.id;
                    edge.style.background = "rgba(255,255,255,0.1)";
                    setTimeout(() => (edge.style.background = "transparent"), 500);
                }, 300);
                dockMarkOpen(win.dataset.app, false);
            }
            function closeWindow(win) {
                if (win.dataset.app === "cat") {
                    if (catInterval) clearInterval(catInterval);
                }
                const side = win.dataset.minSide;
                if (side) {
                    const edge = side === "left" ? $("#leftMinEdge") : $("#rightMinEdge");
                    if (edge.dataset.minWindow === win.id) {
                        edge.dataset.minWindow = "";
                    }
                }
                win.classList.add("hidden");
                dockMarkOpen(win.dataset.app, false);
            }
            function toggleMaximize(win) {
                if (win.dataset.max === "1") {
                    win.style.left = win.dataset.x;
                    win.style.top = win.dataset.y;
                    win.style.width = win.dataset.w;
                    win.style.height = win.dataset.h;
                    win.dataset.max = "0";
                } else {
                    const rect = win.getBoundingClientRect();
                    win.dataset.x = rect.left + "px";
                    win.dataset.y = rect.top + "px";
                    win.dataset.w = rect.width + "px";
                    win.dataset.h = rect.height + "px";
                    win.style.left = "6px";
                    win.style.top = "6px";
                    win.style.width = window.innerWidth - 12 + "px";
                    win.style.height = window.innerHeight - 78 + "px";
                    win.dataset.max = "1";
                }
                bringToFront(win);
            }
            function dockMarkOpen(app, isOpen) {
                const btn = $(`.dock-item[data-open="${app}"]`);
                if (btn) {
                    btn.classList.toggle("open", isOpen);
                }
            }
            function buildMeowMenu() {
                const pinnedPref = store.get(K.pinned, null) ?? null;
                const defaultPins = ["notes", "files", "browser", "settings"];
                if (pinnedPref === null) store.set(K.pinned, defaultPins);
                const pins = store.get(K.pinned, defaultPins);
                const showPinned = store.get(K.showPinned, true);
                const pinWrap = $("#meowPinned");
                pinWrap.innerHTML = "";
                $("#pinnedTitle").style.display = showPinned ? "block" : "none";
                if (showPinned) {
                    pins.forEach((app) => {
                        const b = document.createElement("div");
                        b.className = "meow-item";
                        b.draggable = true;
                        b.innerHTML = `${getIcon(app, "28px")}<div class="meow-label">${getLabel(app)}</div>`;
                        b.addEventListener("click", () => openWindow(app));
                        b.addEventListener("dragstart", (e) =>
                            e.dataTransfer.setData("text", JSON.stringify({ from: "meow", app }))
                        );
                        pinWrap.appendChild(b);
                    });
                }
                const showAll = store.get(K.showAll, true);
                const allWrap = $("#meowAll");
                allWrap.innerHTML = "";
                $("#allTitle").style.display = showAll ? "block" : "none";
                if (showAll) {
                    apps.forEach((app) => {
                        const b = document.createElement("div");
                        b.className = "meow-item";
                        b.draggable = true;
                        b.innerHTML = `${getIcon(app, "28px")}<div class="meow-label">${getLabel(app)}</div>`;
                        b.addEventListener("click", () => openWindow(app));
                        b.addEventListener("dragstart", (e) =>
                            e.dataTransfer.setData("text", JSON.stringify({ from: "meow", app }))
                        );
                        allWrap.appendChild(b);
                    });
                    const customs = store.get(K.customApps, []);
                    customs.forEach((c) => {
                        const iconChar = c.emoji;
                        let iconHtml;
                        if (iconChar.startsWith("http")) {
                            iconHtml = `<img src="${iconChar}" style="width:28px;height:28px;border-radius:8px;" onerror="this.style.display='none';this.nextElementSibling.style.display='inline';" alt=""><span style="font-size:28px;line-height:1;display:none;">‚ùì</span>`;
                        } else {
                            iconHtml = `<span class="meow-emoji" style="font-size:28px;line-height:1">${iconChar}</span>`;
                        }
                        const b = document.createElement("div");
                        b.className = "meow-item";
                        b.draggable = true;
                        b.innerHTML = `${iconHtml}<div class="meow-label">${c.name}</div>`;
                        b.addEventListener("click", () => openWindow("custom_" + c.id));
                        b.addEventListener("dragstart", (e) =>
                            e.dataTransfer.setData("text", JSON.stringify({ from: "meow", app: "custom_" + c.id }))
                        );
                        allWrap.appendChild(b);
                    });
                    // KyrKat Menu if unlocked
                    if (store.get(K.debugUnlocked, false)) {
                        const kyrkatItem = document.createElement("div");
                        kyrkatItem.className = "meow-item";
                        kyrkatItem.innerHTML = `<span class="meow-emoji" style="font-size:28px;line-height:1">üê±</span><div class="meow-label">KyrKat Menu</div>`;
                        kyrkatItem.addEventListener("click", () => openWindow("kyrkat"));
                        allWrap.appendChild(kyrkatItem);
                    }
                }
                const showRecents = store.get(K.showRecents, true);
                const recWrap = $("#meowRecents");
                recWrap.innerHTML = "";
                $("#recentsTitle").style.display = showRecents ? "block" : "none";
                if (showRecents) {
                    const files = loadFilesStore();
                    Object.keys(files)
                        .slice(-8)
                        .reverse()
                        .forEach((name) => {
                            const entry = files[name];
                            const icon =
                                entry.type === "text"
                                    ? "üìÑ"
                                    : entry.type === "image"
                                      ? "üñºÔ∏è"
                                      : entry.type === "audio"
                                        ? "üéµ"
                                        : "üéûÔ∏è";
                            const item = document.createElement("div");
                            item.className = "recent";
                            item.innerHTML = `<div class="icon">${icon}</div><div class="name">${name}</div>`;
                            item.addEventListener("click", () => {
                                openWindow("files");
                                openCreatedFile(name);
                            });
                            recWrap.appendChild(item);
                        });
                }
            }
            $("#hello").addEventListener("click", () => {
                $("#meowMenu").classList.toggle("hidden");
                const menu = $("#meowMenu");
                menu.style.left = "50%";
                menu.style.bottom = "76px";
                menu.style.transform = "translateX(-50%)";
                const now = Date.now();
                if (startClickCount === 0 || now - startClickTimer > 5000) {
                    startClickCount = 1;
                    startClickTimer = now;
                } else {
                    startClickCount++;
                }
                if (startClickCount >= 5) {
                    showCatWindow();
                    startClickCount = 0;
                }
            });
            document.addEventListener("click", (e) => {
                const sm = $("#meowMenu"),
                    hello = $("#hello");
                if (!sm.contains(e.target) && !hello.contains(e.target)) sm.classList.add("hidden");
                const nc = $("#notifCenter"),
                    clock = $("#clock");
                if (!nc.contains(e.target) && !clock.contains(e.target)) nc.classList.add("hidden");
            });
            function renderDock() {
                let pinned = store.get(K.pinned, null);
                if (pinned === null) {
                    pinned = ["notes", "files", "browser", "settings"];
                    store.set(K.pinned, pinned);
                }
                const dock = $("#dock");
                dock.innerHTML = "";
                const showLabels = store.get(K.showDockLabels, false);
                pinned.forEach((app) => {
                    const item = document.createElement("button");
                    item.className = "dock-item";
                    item.dataset.open = app;
                    item.innerHTML = `${getIcon(app, "28px", true)}${showLabels ? `<div class="dock-label">${getLabel(app)}</div>` : ""}<div class="dot"></div>`;
                    item.addEventListener("click", () => openWindow(app));
                    item.draggable = true;
                    item.addEventListener("dragstart", (e) =>
                        e.dataTransfer.setData("text", JSON.stringify({ from: "dock", app }))
                    );
                    item.addEventListener("contextmenu", (e) => {
                        e.preventDefault();
                        showAppContextMenu(e.clientX, e.clientY, app);
                    });
                    dock.appendChild(item);
                });
            }
            function showAppContextMenu(x, y, app) {
                const menu = $("#contextMenu");
                menu.innerHTML = "";
                const newWinItem = document.createElement("div");
                newWinItem.className = "context-item";
                newWinItem.textContent = "New window";
                newWinItem.addEventListener("click", () => {
                    openNewWindow(app);
                    menu.classList.add("hidden");
                });
                menu.appendChild(newWinItem);
                const unpinItem = document.createElement("div");
                unpinItem.className = "context-item";
                unpinItem.textContent = "Unpin from Dock";
                unpinItem.addEventListener("click", () => {
                    unpinApp(app);
                    menu.classList.add("hidden");
                });
                menu.appendChild(unpinItem);
                menu.style.left = x + "px";
                menu.style.top = y + "px";
                menu.classList.remove("hidden");
            }
            function renderShortcuts() {
                $$(" .shortcut").forEach((e) => e.remove());
                const shortcuts = store.get(K.shortcuts, []);
                shortcuts.forEach((s, i) => {
                    const icon = document.createElement("button");
                    icon.className = "dock-item shortcut";
                    icon.style.position = "absolute";
                    icon.style.left = s.x + "px";
                    icon.style.top = s.y + "px";
                    icon.style.minWidth = "auto";
                    icon.dataset.index = i;
                    icon.dataset.type = s.type;
                    icon.dataset.id = s.id;
                    icon.innerHTML = `${getIcon(s.id, "28px", true)}<div class="dock-label">${s.type === "app" ? getLabel(s.id) : s.id}</div>`;
                    icon.addEventListener("click", () => {
                        if (s.type === "app") openWindow(s.id);
                        else {
                            openWindow("files");
                            openCreatedFile(s.id);
                        }
                    });
                    icon.addEventListener("mousedown", (e) => {
                        dragElement = icon;
                        const rect = icon.getBoundingClientRect();
                        dragOffsetX = e.clientX - rect.left;
                        dragOffsetY = e.clientY - rect.top;
                        e.preventDefault();
                    });
                    icon.addEventListener("contextmenu", (e) => {
                        e.preventDefault();
                        showShortcutContextMenu(e.clientX, e.clientY, icon);
                    });
                    $("#desktop").appendChild(icon);
                });
            }
            function showShortcutContextMenu(x, y, target) {
                const menu = $("#contextMenu");
                menu.innerHTML = "";
                const type = target.dataset.type;
                const id = target.dataset.id;
                if (type === "app") {
                    const newWinItem = document.createElement("div");
                    newWinItem.className = "context-item";
                    newWinItem.textContent = "New window";
                    newWinItem.addEventListener("click", () => {
                        openNewWindow(id);
                        menu.classList.add("hidden");
                    });
                    menu.appendChild(newWinItem);
                } else if (type === "file") {
                    const newWinItem = document.createElement("div");
                    newWinItem.className = "context-item";
                    newWinItem.textContent = "Open in new Files window";
                    newWinItem.addEventListener("click", () => {
                        openNewWindow("files");
                        menu.classList.add("hidden");
                    });
                    menu.appendChild(newWinItem);
                }
                const removeItem = document.createElement("div");
                removeItem.className = "context-item";
                removeItem.textContent = "Remove";
                removeItem.addEventListener("click", () => {
                    showCustomConfirm("Remove Shortcut", "Remove this shortcut?", () => {
                        removeShortcut(target.dataset.index);
                    });
                    menu.classList.add("hidden");
                });
                menu.appendChild(removeItem);
                menu.style.left = x + "px";
                menu.style.top = y + "px";
                menu.classList.remove("hidden");
            }
            function addShortcut(type, id, x, y) {
                let shortcuts = store.get(K.shortcuts, []);
                shortcuts.push({ type, id, x, y });
                store.set(K.shortcuts, shortcuts);
                renderShortcuts();
            }
            function updateShortcutPosition(i, x, y) {
                let shortcuts = store.get(K.shortcuts, []);
                shortcuts[i].x = parseInt(x);
                shortcuts[i].y = parseInt(y);
                store.set(K.shortcuts, shortcuts);
            }
            function removeShortcut(i) {
                let shortcuts = store.get(K.shortcuts, []);
                shortcuts.splice(i, 1);
                store.set(K.shortcuts, shortcuts);
                renderShortcuts();
            }
            function unpinApp(app) {
                let pinned = store.get(K.pinned, ["notes", "files", "browser", "settings"]);
                pinned = pinned.filter((a) => a !== app);
                store.set(K.pinned, pinned);
                renderDock();
                buildMeowMenu();
            }
            function showContextMenu(x, y, target) {
                const menu = $("#contextMenu");
                menu.style.left = x + "px";
                menu.style.top = y + "px";
                menu.classList.remove("hidden");
                $("#removeShortcut").addEventListener(
                    "click",
                    () => {
                        showCustomConfirm("Remove Shortcut", "Remove this shortcut?", () => {
                            removeShortcut(target.dataset.index);
                        });
                        menu.classList.add("hidden");
                    },
                    { once: true }
                );
            }
            function showFileContext(x, y, name) {
                const menu = $("#fileContextMenu");
                menu.dataset.name = name;
                menu.style.left = x + "px";
                menu.style.top = y + "px";
                menu.classList.remove("hidden");
                $$(".context-item", menu).forEach((item) => item.replaceWith(item.cloneNode(true)));
                $$(".context-item", menu).forEach((item) => {
                    item.addEventListener(
                        "click",
                        () => {
                            const action = item.dataset.action;
                            if (action === "rename") {
                                showCustomPrompt("Rename File", "New name:", name, (newName) => {
                                    if (newName && newName !== name) {
                                        const files = loadFilesStore();
                                        if (files[newName]) {
                                            showCustomAlert("Error", "Name exists");
                                            return;
                                        }
                                        files[newName] = files[name];
                                        delete files[name];
                                        saveFilesStore(files);
                                        renderCreatedList();
                                    }
                                });
                            } else if (action === "delete") {
                                showCustomConfirm("Delete File", "Delete " + name + "?", () => {
                                    const files = loadFilesStore();
                                    delete files[name];
                                    saveFilesStore(files);
                                    renderCreatedList();
                                });
                            } else if (action === "move") {
                                showCustomPrompt("Move File", "New path (e.g. /folder/):", "", (newPath) => {
                                    if (newPath) {
                                        const files = loadFilesStore();
                                        const newKey = newPath + name;
                                        if (files[newKey]) {
                                            showCustomAlert("Error", "Path exists");
                                            return;
                                        }
                                        files[newKey] = files[name];
                                        delete files[name];
                                        saveFilesStore(files);
                                        renderCreatedList();
                                        flash("File moved");
                                    }
                                });
                            }
                            menu.classList.add("hidden");
                        },
                        { once: true }
                    );
                });
            }
            document.addEventListener("click", () => {
                $("#contextMenu").classList.add("hidden");
                $("#fileContextMenu").classList.add("hidden");
            });
            function showCustomConfirm(title, message, onConfirm) {
                const overlay = document.createElement("div");
                overlay.className = "dialog-overlay";
                const card = document.createElement("div");
                card.className = "dialog-card";
                card.innerHTML = `<h3>${title}</h3><div id="dialogMessage"></div><div class="dialog-buttons"><button class="btn secondary" id="dialogCancel">Cancel</button><button class="btn" id="dialogConfirm">Confirm</button></div>`;
                overlay.appendChild(card);
                document.body.appendChild(overlay);
                $("#dialogMessage", overlay).innerHTML = message;
                $("#dialogCancel", overlay).addEventListener("click", () => overlay.remove());
                $("#dialogConfirm", overlay).addEventListener("click", () => {
                    onConfirm();
                    overlay.remove();
                });
            }
            function showCustomAlert(title, message) {
                const overlay = document.createElement("div");
                overlay.className = "dialog-overlay";
                const card = document.createElement("div");
                card.className = "dialog-card";
                card.innerHTML = `<h3>${title}</h3><div id="dialogMessage"></div><div class="dialog-buttons"><button class="btn" id="dialogOK">OK</button></div>`;
                overlay.appendChild(card);
                document.body.appendChild(overlay);
                $("#dialogMessage", overlay).innerHTML = message;
                $("#dialogOK", overlay).addEventListener("click", () => overlay.remove());
            }
            function showCustomPrompt(title, message, def = "", onConfirm) {
                const overlay = document.createElement("div");
                overlay.className = "dialog-overlay";
                const card = document.createElement("div");
                card.className = "dialog-card";
                card.innerHTML = `<h3>${title}</h3><div id="dialogMessage"></div><input class="input" id="promptInput" value="${def}"><div class="dialog-buttons"><button class="btn secondary" id="dialogCancel">Cancel</button><button class="btn" id="dialogConfirm">OK</button></div>`;
                overlay.appendChild(card);
                document.body.appendChild(overlay);
                $("#dialogMessage", overlay).innerHTML = message;
                const input = $("#promptInput", overlay);
                input.focus();
                $("#dialogCancel", overlay).addEventListener("click", () => overlay.remove());
                $("#dialogConfirm", overlay).addEventListener("click", () => {
                    onConfirm(input.value.trim());
                    overlay.remove();
                });
            }
            function showFileSelectDialog(title, items, onSelect) {
                const overlay = document.createElement("div");
                overlay.className = "dialog-overlay";
                const card = document.createElement("div");
                card.className = "dialog-card";
                card.innerHTML = `<h3>${title}</h3><div id="fileSelectList" style="max-height:200px; overflow:auto;"></div><div class="dialog-buttons"><button class="btn secondary">Cancel</button></div>`;
                overlay.appendChild(card);
                document.body.appendChild(overlay);
                const list = $("#fileSelectList", overlay);
                items.forEach((item) => {
                    const div = document.createElement("div");
                    div.textContent = item;
                    div.style.padding = "8px";
                    div.style.cursor = "pointer";
                    div.style.borderRadius = "4px";
                    div.addEventListener("click", () => {
                        onSelect(item);
                        overlay.remove();
                    });
                    list.appendChild(div);
                });
                $(".btn.secondary", overlay).addEventListener("click", () => overlay.remove());
            }
            function buildTree(paths) {
                function createNode(name) {
                    return { name, children: {}, files: [] };
                }
                const root = createNode("root");
                paths.forEach((path) => {
                    const parts = path.split("/");
                    let current = root;
                    for (let i = 0; i < parts.length - 1; i++) {
                        const part = parts[i];
                        if (!current.children[part]) {
                            current.children[part] = createNode(part);
                        }
                        current = current.children[part];
                    }
                    const fileName = parts[parts.length - 1];
                    current.files.push(fileName);
                });
                function renderNode(node, ul) {
                    const childNames = Object.keys(node.children).sort();
                    const sortedFiles = node.files.sort();
                    childNames.forEach((childName) => {
                        const child = node.children[childName];
                        const li = document.createElement("li");
                        const dirSpan = document.createElement("span");
                        dirSpan.className = "fname";
                        dirSpan.textContent = childName + "/";
                        li.appendChild(dirSpan);
                        const childUl = document.createElement("ul");
                        renderNode(child, childUl);
                        li.appendChild(childUl);
                        ul.appendChild(li);
                    });
                    sortedFiles.forEach((file) => {
                        const li = document.createElement("li");
                        const fileSpan = document.createElement("span");
                        fileSpan.className = "fname";
                        fileSpan.textContent = file;
                        li.appendChild(fileSpan);
                        ul.appendChild(li);
                    });
                }
                const ul = document.createElement("ul");
                renderNode(root, ul);
                return ul;
            }
            function initNotes() {
                const notesData = store.get(K.notes, {});
                let currentNoteId = store.get(K.currentNote, null);
                if (Object.keys(notesData).length === 0) {
                    const defaultId = Date.now().toString();
                    notesData[defaultId] = { content: "<p>Welcome to Notes! üê±</p>", name: "Welcome Note" };
                    currentNoteId = defaultId;
                    store.set(K.notes, notesData);
                    store.set(K.currentNote, defaultId);
                }
                const notesListEl = $("#notesList");
                const notesText = $("#notesText");
                const placeholder = $("#notesPlaceholder");
                function renderNotesList() {
                    notesListEl.innerHTML = "";
                    Object.keys(notesData).forEach((id) => {
                        const note = notesData[id];
                        const displayname =
                            note.name ||
                            new Date(Number(id)).toLocaleString("en-US", {
                                month: "short",
                                day: "numeric",
                                year: "numeric",
                                hour: "2-digit",
                                minute: "2-digit",
                            });
                        const div = document.createElement("div");
                        div.className = "pill";
                        div.innerHTML = `<span style="flex:1;">${displayname}</span>`;
                        div.addEventListener("click", (e) => {
                            selectNote(id);
                        });
                        div.addEventListener("contextmenu", (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            showNoteContext(e.clientX, e.clientY, id);
                        });
                        notesListEl.appendChild(div);
                    });
                }
                function selectNote(id) {
                    currentNoteId = id;
                    store.set(K.currentNote, id);
                    notesText.innerHTML = notesData[id].content || "";
                    updatePlaceholder();
                    notesText.focus();
                }
                function deleteNote(id) {
                    if (id === currentNoteId) {
                        const keys = Object.keys(notesData);
                        if (keys.length > 1) {
                            const nextId = keys.find((k) => k !== id);
                            selectNote(nextId);
                        } else {
                            notesText.innerHTML = "";
                            currentNoteId = null;
                        }
                    }
                    delete notesData[id];
                    store.set(K.notes, notesData);
                    renderNotesList();
                }
                function showNoteContext(x, y, id) {
                    const menu = $("#fileContextMenu");
                    menu.dataset.noteId = id;
                    menu.style.left = x + "px";
                    menu.style.top = y + "px";
                    menu.classList.remove("hidden");
                    $$(".context-item", menu).forEach((item) => item.replaceWith(item.cloneNode(true)));
                    $$(".context-item", menu).forEach((item) => {
                        item.addEventListener(
                            "click",
                            () => {
                                const action = item.dataset.action;
                                if (action === "rename") {
                                    showCustomPrompt(
                                        "Rename Note",
                                        "New name:",
                                        notesData[id].name || "",
                                        (newName) => {
                                            if (newName.trim()) {
                                                notesData[id].name = newName.trim();
                                                store.set(K.notes, notesData);
                                                renderNotesList();
                                            }
                                        }
                                    );
                                } else if (action === "delete") {
                                    showCustomConfirm("Delete Note", "Delete this note?", () => deleteNote(id));
                                }
                                menu.classList.add("hidden");
                            },
                            { once: true }
                        );
                    });
                }
                function updatePlaceholder() {
                    if (!currentNoteId) {
                        placeholder.textContent = "Create a new note...";
                    } else if (notesText.innerHTML.trim() === "") {
                        const note = notesData[currentNoteId];
                        placeholder.textContent = `${note.name || "Untitled"} - Write here...`;
                    } else {
                        placeholder.style.display = "none";
                    }
                }
                function saveCurrentNote() {
                    if (currentNoteId !== null) {
                        notesData[currentNoteId].content = notesText.innerHTML;
                        store.set(K.notes, notesData);
                    }
                }
                let saveTimer;
                notesText.addEventListener("input", () => {
                    updatePlaceholder();
                    clearTimeout(saveTimer);
                    saveTimer = setTimeout(saveCurrentNote, 1000);
                });
                notesText.addEventListener("focus", () => (notesText.style.outline = "none"));
                function applyFormat(cmd) {
                    notesText.focus();
                    document.execCommand(cmd, false, null);
                    notesText.focus();
                }
                $("#notesBold").addEventListener("click", () => applyFormat("bold"));
                $("#notesItalic").addEventListener("click", () => applyFormat("italic"));
                $("#notesUnderline").addEventListener("click", () => applyFormat("underline"));
                $("#notesNew").addEventListener("click", () => {
                    const id = Date.now().toString();
                    notesData[id] = { content: "", name: "Untitled" };
                    selectNote(id);
                    renderNotesList();
                });
                $("#notesSaveToFiles").addEventListener("click", () => {
                    if (currentNoteId === null) {
                        showCustomAlert("No Note", "Create or select a note first.");
                        return;
                    }
                    const content = notesText.innerHTML;
                    if (!content.trim()) {
                        showCustomAlert("Empty Note", "Note is empty.");
                        return;
                    }
                    const note = notesData[currentNoteId];
                    const defaultName = `${note.name || "note"}-${currentNoteId.slice(-8)}.html`;
                    showCustomPrompt("Save Note to Files", "File name:", defaultName, (name) => {
                        if (!name.endsWith(".html")) name += ".html";
                        const path = "/User/Downloads/" + name;
                        const files = loadFilesStore();
                        if (files[path]) {
                            showCustomConfirm("Overwrite?", `Overwrite ${name}?`, () => saveToFiles(path, content));
                        } else {
                            saveToFiles(path, content);
                        }
                    });
                });
                function saveToFiles(name, content) {
                    const files = loadFilesStore();
                    files[name] = { type: "text", text: content };
                    saveFilesStore(files);
                    flash("Note saved to Files");
                    openWindow("files");
                    openCreatedFile(name);
                }
                // Initial render
                renderNotesList();
                if (currentNoteId) selectNote(currentNoteId);
                updatePlaceholder();
            }
            let calDate = new Date();
            function renderCalendar() {
                const grid = $("#calGrid");
                grid.innerHTML = "";
                const m = calDate.getMonth(),
                    y = calDate.getFullYear();
                $("#calMonth").textContent = calDate.toLocaleString(undefined, { month: "long", year: "numeric" });
                const first = new Date(y, m, 1);
                const startOffset = (first.getDay() + 6) % 7;
                const daysInMonth = new Date(y, m + 1, 0).getDate();
                for (let i = 0; i < startOffset; i++) {
                    const empty = document.createElement("div");
                    empty.className = "day";
                    grid.appendChild(empty);
                }
                const today = new Date();
                for (let d = 1; d <= daysInMonth; d++) {
                    const cell = document.createElement("div");
                    cell.className = "day";
                    cell.textContent = d;
                    if (d === today.getDate() && m === today.getMonth() && y === today.getFullYear())
                        cell.classList.add("today");
                    grid.appendChild(cell);
                }
                const totalSoFar = startOffset + daysInMonth;
                const endOffset = 42 - totalSoFar;
                for (let i = 0; i < endOffset; i++) {
                    const empty = document.createElement("div");
                    empty.className = "day";
                    grid.appendChild(empty);
                }
            }
            function newProxy(u) {
                return `https://meowosproxy.kyrylo89.workers.dev/?url=${encodeURIComponent(u)}`;
            }
            const SEARCH_ENGINES = {
                ddg: (q) => `https://duckduckgo.com/?q=${encodeURIComponent(q)}`,
                google: (q) => `https://www.google.com/search?q=${encodeURIComponent(q)}`,
                bing: (q) => `https://www.bing.com/search?q=${encodeURIComponent(q)}`,
                brave: (q) => `https://search.brave.com/search?q=${encodeURIComponent(q)}`,
                wikipedia: (q) => `https://en.wikipedia.org/w/index.php?search=${encodeURIComponent(q)}`,
            };
            function isLikelyUrl(v) {
                return /^https?:\/\//i.test(v) || (v.includes(".") && !v.includes(" "));
            }
            function normalizeUrl(input) {
                const v = (input || "").trim();
                const homeBase = "https://meowosproxy.kyrylo89.workers.dev";
                if (!v) return store.get(K.home, homeBase);
                if (isLikelyUrl(v)) return /^https?:\/\//i.test(v) ? v : "https://" + v;
                const engine = store.get(K.search, "wikipedia");
                const builder = SEARCH_ENGINES[engine] || SEARCH_ENGINES.wikipedia;
                return builder(v);
            }
            let browserTabs = [];
            let currentTabId = 0;
            function applyBrowserSandbox(frame) {
                const block = store.get(K.blockPopups, true);
                let sandbox = "allow-same-origin allow-scripts allow-forms";
                if (!block) sandbox += " allow-popups allow-popups-to-escape-sandbox";
                frame.setAttribute("sandbox", sandbox);
            }
            function initBrowser() {
                const input = $("#url");
                const go = $("#go");
                const zoomOut = $("#zoomOut");
                const zoomIn = $("#zoomIn");
                const zoomZoom = $("#zoomLevel");
                const homeBase = "https://meowosproxy.kyrylo89.workers.dev";
                const contentContainer = $("#browserContent");
                const tabBar = $("#tabBar");
                const embedContainer = $("#embedContainer");
                let nextTabId = 1;
                function createTab(url = homeBase) {
                    const tab = {
                        id: nextTabId++,
                        title: "New Tab",
                        url: url,
                        history: [],
                        historyIndex: -1,
                        zoom: 100,
                        container: document.createElement("div"),
                        iframe: document.createElement("iframe"),
                        embed: document.createElement("div"),
                    };
                    tab.container.style.position = "absolute";
                    tab.container.style.inset = "0";
                    tab.container.style.display = "none";
                    tab.iframe.id = "webview-" + tab.id;
                    tab.iframe.className = "webview";
                    tab.iframe.referrerpolicy = "no-referrer";
                    tab.iframe.title = "webview";
                    tab.iframe.style.width = "100%";
                    tab.iframe.style.height = "100%";
                    tab.iframe.style.background = "#0c1220";
                    applyBrowserSandbox(tab.iframe);
                    tab.embed.id = "embedContainer-" + tab.id;
                    tab.embed.style.width = "100%";
                    tab.embed.style.height = "100%";
                    tab.embed.style.display = "none";
                    tab.embed.style.overflow = "auto";
                    tab.container.appendChild(tab.iframe);
                    tab.container.appendChild(tab.embed);
                    contentContainer.appendChild(tab.container);
                    browserTabs.push(tab);
                    return tab;
                }
                function renderTabs() {
                    tabBar.innerHTML = "";
                    browserTabs.forEach((tab) => {
                        const tabEl = document.createElement("div");
                        tabEl.className = "tab";
                        tabEl.dataset.id = tab.id;
                        tabEl.innerHTML = `<span>${tab.title}</span><span class="tab-close">√ó</span>`;
                        if (tab.id === currentTabId) tabEl.classList.add("active");
                        tabEl.addEventListener("click", () => switchTab(tab.id));
                        tabEl.querySelector(".tab-close").addEventListener("click", (e) => {
                            e.stopPropagation();
                            closeTab(tab.id);
                        });
                        tabBar.appendChild(tabEl);
                    });
                    const newTabBtn = document.createElement("button");
                    newTabBtn.className = "new-tab-btn";
                    newTabBtn.textContent = "+";
                    newTabBtn.addEventListener("click", () => {
                        const newTab = createTab();
                        switchTab(newTab.id);
                        navigate(newTab, homeBase);
                    });
                    tabBar.appendChild(newTabBtn);
                }
                function switchTab(id) {
                    const tab = browserTabs.find((t) => t.id === id);
                    if (!tab) return;
                    currentTabId = id;
                    browserTabs.forEach((t) => {
                        t.container.style.display = t.id === id ? "block" : "none";
                    });
                    input.value = tab.url;
                    updateZoomDisplay(tab);
                    renderTabs();
                }
                function closeTab(id) {
                    const index = browserTabs.findIndex((t) => t.id === id);
                    if (index === -1) return;
                    browserTabs.splice(index, 1);
                    if (currentTabId === id) {
                        const newIndex = Math.max(0, index - 1);
                        currentTabId = browserTabs[newIndex] ? browserTabs[newIndex].id : 0;
                    }
                    renderTabs();
                    if (browserTabs.length === 0) {
                        const newTab = createTab();
                        currentTabId = newTab.id;
                        renderTabs();
                        navigate(newTab, homeBase);
                    } else {
                        switchTab(currentTabId);
                    }
                }
                function updateTabTitle(tab) {
                    try {
                        tab.title = tab.iframe.contentDocument.title || "New Tab";
                    } catch {
                        tab.title = "New Tab";
                    }
                    renderTabs();
                }
                function updateZoomDisplay(tab) {
                    zoomLevel.textContent = tab.zoom + "%";
                    tab.iframe.style.zoom = tab.zoom + "%";
                }
                function isYouTubeUrl(u) {
                    try {
                        const url = new URL(u);
                        if (url.hostname.endsWith("youtube.com") || url.hostname.endsWith("youtu.be")) {
                            const v = url.searchParams.get("v") || url.pathname.slice(1);
                            if (v) return v;
                        }
                    } catch {}
                    return null;
                }
                function isXUrl(u) {
                    try {
                        const url = new URL(u);
                        if (url.hostname.endsWith("x.com") || url.hostname.endsWith("twitter.com")) {
                            const parts = url.pathname.split("/");
                            if (parts.length >= 4 && parts[2] === "status") {
                                return parts[3];
                            }
                        }
                    } catch {}
                    return null;
                }
                function navigate(tab, raw, push = true) {
                    const urlRaw = normalizeUrl(raw || input.value);
                    const mode = store.get(K.proxy, "auto");
                    let target;
                    if (mode === "always") {
                        target = newProxy(urlRaw);
                    } else {
                        target = urlRaw;
                    }
                    const ytId = isYouTubeUrl(urlRaw);
                    const xId = isXUrl(urlRaw);
                    tab.iframe.style.display = "block";
                    tab.embed.style.display = "none";
                    if (ytId) {
                        target = `https://www.youtube.com/embed/${ytId}`;
                    } else if (xId) {
                        tab.iframe.style.display = "none";
                        tab.embed.style.display = "block";
                        tab.embed.innerHTML = `
              <blockquote class="twitter-tweet">
                <a href="${urlRaw}"></a>
              </blockquote>
            `;
                        if (!document.querySelector('script[src="https://platform.twitter.com/widgets.js"]')) {
                            const script = document.createElement("script");
                            script.src = "https://platform.twitter.com/widgets.js";
                            script.async = true;
                            document.body.appendChild(script);
                        } else if (typeof twttr !== "undefined" && twttr.widgets) {
                            twttr.widgets.load(tab.embed);
                        }
                        if (push) {
                            tab.history = tab.history.slice(0, tab.historyIndex + 1);
                            tab.history.push(urlRaw);
                            tab.historyIndex = tab.history.length - 1;
                        }
                        input.value = urlRaw;
                        return;
                    }
                    if (urlRaw === homeBase && mode !== "always") {
                        input.value = "";
                        tab.iframe.src = homeBase;
                        if (push) {
                            tab.history = tab.history.slice(0, tab.historyIndex + 1);
                            tab.history.push(urlRaw);
                            tab.historyIndex = tab.history.length - 1;
                        }
                        let settled = false;
                        tab.iframe.addEventListener(
                            "load",
                            () => {
                                settled = true;
                            },
                            { once: true }
                        );
                        return;
                    }
                    tab.iframe.src = target;
                    if (push) {
                        tab.history = tab.history.slice(0, tab.historyIndex + 1);
                        tab.history.push(urlRaw);
                        tab.historyIndex = tab.history.length - 1;
                    }
                    input.value = urlRaw;
                    let settled = false;
                    const t = setTimeout(() => {
                        if (mode !== "auto" || settled) return;
                        if (!settled) {
                            try {
                                const doc = tab.iframe.contentDocument;
                                if (doc && (!doc.body || !doc.body.childElementCount)) {
                                    tab.iframe.src = newProxy(urlRaw);
                                    flash("Site restricted ‚Äî showing via proxy");
                                }
                            } catch {}
                        }
                    }, 1200);
                    tab.iframe.addEventListener(
                        "load",
                        () => {
                            settled = true;
                            clearTimeout(t);
                            const current = tab.history[tab.historyIndex];
                            if (current) input.value = current;
                            updateTabTitle(tab);
                        },
                        { once: true }
                    );
                }
                go.addEventListener("click", () => {
                    const currentTab = browserTabs.find((t) => t.id === currentTabId);
                    navigate(currentTab, $("#url").value);
                });
                input.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") {
                        const currentTab = browserTabs.find((t) => t.id === currentTabId);
                        navigate(currentTab, input.value);
                    }
                });
                $("#back").addEventListener("click", () => {
                    const tab = browserTabs.find((t) => t.id === currentTabId);
                    if (tab.historyIndex > 0) {
                        tab.historyIndex--;
                        const u = tab.history[tab.historyIndex];
                        navigate(tab, u, false);
                    }
                });
                $("#forward").addEventListener("click", () => {
                    const tab = browserTabs.find((t) => t.id === currentTabId);
                    if (tab.historyIndex < tab.history.length - 1) {
                        tab.historyIndex++;
                        const u = tab.history[tab.historyIndex];
                        navigate(tab, u, false);
                    }
                });
                $("#reload").addEventListener("click", () => {
                    const tab = browserTabs.find((t) => t.id === currentTabId);
                    const u = input.value || tab.history[tab.historyIndex] || store.get(K.home, homeBase);
                    navigate(tab, u, false);
                });
                $("#openExt").addEventListener("click", () => {
                    const url =
                        input.value ||
                        browserTabs.find((t) => t.id === currentTabId).history[
                            browserTabs.find((t) => t.id === currentTabId).historyIndex
                        ] ||
                        store.get(K.home, homeBase);
                    window.open(url, "_blank");
                });
                zoomOut.addEventListener("click", () => {
                    const tab = browserTabs.find((t) => t.id === currentTabId);
                    tab.zoom = Math.max(50, tab.zoom - 25);
                    updateZoomDisplay(tab);
                });
                zoomIn.addEventListener("click", () => {
                    const tab = browserTabs.find((t) => t.id === currentTabId);
                    tab.zoom = Math.min(250, tab.zoom + 25);
                    updateZoomDisplay(tab);
                });
                // Initial tab
                const initialTab = createTab();
                currentTabId = initialTab.id;
                renderTabs();
                switchTab(currentTabId);
                navigate(initialTab, homeBase);
            }
            function loadFilesStore() {
                return store.get(K.files, {});
            }
            function saveFilesStore(obj) {
                store.set(K.files, obj);
            }
            const fileState = { currentName: null, isCreated: false, currentType: "text" };
            function readAsText(file) {
                return new Promise((res, rej) => {
                    const r = new FileReader();
                    r.onload = () => res(r.result);
                    r.onerror = rej;
                    r.readAsText(file);
                });
            }
            function readAsDataURL(file) {
                return new Promise((res, rej) => {
                    const r = new FileReader();
                    r.onload = () => res(r.result);
                    r.onerror = rej;
                    r.readAsDataURL(file);
                });
            }
            function installFromContent(name, content) {
                const lines = content.split("\n");
                let app_name,
                    app_icon,
                    app_developer,
                    app_code = "";
                let inCode = false;
                let codeLines = [];
                for (let line of lines) {
                    line = line.trim();
                    if (!inCode) {
                        if (line === "app_code:") {
                            inCode = true;
                            continue;
                        } else if (line) {
                            const parts = line.split(":");
                            if (parts.length >= 2) {
                                const key = parts[0].trim();
                                const val = parts.slice(1).join(":").trim();
                                if (key === "app_name") app_name = val;
                                if (key === "app_icon") app_icon = val;
                                if (key === "app_developer") app_developer = val;
                            }
                        }
                    } else {
                        if (line === "---") continue;
                        codeLines.push(line);
                    }
                }
                app_code = codeLines.join("\n");
                app_name = app_name || name.replace(/\.maf$/, "");
                app_icon = app_icon || "üì¶";
                app_developer = app_developer || "Unknown";
                const id = app_name.toLowerCase().replace(/\W+/g, "-");
                let customs = store.get(K.customApps, []);
                if (customs.find((c) => c.id === id)) {
                    showCustomAlert("Error", "App with that name exists");
                    return;
                }
                customs.push({ id, name: app_name, emoji: app_icon, html: app_code });
                store.set(K.customApps, customs);
                buildMeowMenu();
                flash("App installed! Find it in Meow menu.");
            }
            function installMaf(name) {
                const files = loadFilesStore();
                const content = files[name].text;
                installFromContent(name, content);
            }
            function initMeowStore() {
                // Tab switching
                $$("#win-meowstore [data-tab]").forEach((btn) => {
                    btn.addEventListener("click", (e) => {
                        $$("#win-meowstore [data-tab]").forEach((b) => b.classList.remove("active"));
                        e.target.classList.add("active");
                        $$('#win-meowstore [id$="Tab"]').forEach(
                            (c) => (c.style.display = c.id === e.target.dataset.tab + "Tab" ? "block" : "none")
                        );
                    });
                });
                const list = $("#storeList");
                const storeSearch = $("#storeSearch");
                async function loadApps() {
                    try {
                        const res = await fetch("apps.txt");
                        if (!res.ok) throw new Error("No apps.txt found");
                        const text = await res.text();
                        const blocks = text
                            .split("---")
                            .map((b) => b.trim())
                            .filter((b) => b);
                        const apps = [];
                        for (let block of blocks) {
                            const lines = block.split("\n").map((l) => l.trim());
                            let app_name = "",
                                app_icon = "üì¶",
                                app_developer = "Unknown",
                                app_code = "";
                            let inCode = false;
                            for (let line of lines) {
                                if (line === "app_code:") {
                                    inCode = true;
                                    continue;
                                }
                                if (!inCode) {
                                    const parts = line.split(":");
                                    if (parts.length >= 2) {
                                        const key = parts[0].trim(),
                                            val = parts.slice(1).join(":").trim();
                                        if (key === "app_name") app_name = val;
                                        if (key === "app_icon") app_icon = val;
                                        if (key === "app_developer") app_developer = val;
                                    }
                                } else {
                                    app_code += line + "\n";
                                }
                            }
                            if (app_name && app_code.trim()) {
                                apps.push({
                                    name: app_name,
                                    icon: app_icon,
                                    developer: app_developer,
                                    code: app_code.trim(),
                                });
                            }
                        }
                        list.innerHTML = "";
                        apps.forEach((app) => {
                            const iconChar = app.icon;
                            let iconHtml;
                            if (iconChar.startsWith("http")) {
                                iconHtml = `<img src="${iconChar}" style="width:32px;height:32px;border-radius:4px;" onerror="this.style.display='none';this.nextElementSibling.style.display='block';" alt="${app.name}"><span style="font-size:32px;display:none;">üì¶</span>`;
                            } else {
                                iconHtml = `<div style="font-size:32px">${iconChar}</div>`;
                            }
                            const div = document.createElement("div");
                            div.dataset.name = app.name.toLowerCase();
                            div.style.padding = "12px";
                            div.style.border = "1px solid var(--glass-2)";
                            div.style.borderRadius = "8px";
                            div.style.marginBottom = "8px";
                            div.style.display = "flex";
                            div.style.alignItems = "center";
                            div.style.gap = "12px";
                            div.innerHTML = `${iconHtml}<div style=flex:1><div style=font-weight:800>${app.name}</div><div style=font-size:12px;color:var(--muted)>by ${app.developer}</div></div><button class=btn style=margin-left:auto>Install</button>`;
                            div.querySelector("button").addEventListener("click", () => {
                                showCustomConfirm("Install App", `Install ${app.name}?`, () => {
                                    const id = app.name.toLowerCase().replace(/\W+/g, "-");
                                    let customs = store.get(K.customApps, []);
                                    if (customs.find((c) => c.id === id)) {
                                        showCustomAlert("Exists", "App already installed");
                                        return;
                                    }
                                    customs.push({
                                        id,
                                        name: app.name,
                                        emoji: app.icon,
                                        html: app.code,
                                        trusted: true,
                                    });
                                    store.set(K.customApps, customs);
                                    buildMeowMenu();
                                    flash("App installed from MeowStore!");
                                    div.querySelector("button").textContent = "Installed";
                                    div.querySelector("button").disabled = true;
                                });
                            });
                            list.appendChild(div);
                        });
                        if (!apps.length)
                            list.innerHTML =
                                "<p style=text-align:center;color:var(--muted)>No apps available in apps.txt</p>";
                    } catch (e) {
                        list.innerHTML = `<p style=text-align:center;color:var(--muted)>Failed to load apps.txt: ${e.message}</p>`;
                    }
                }
                loadApps();
                // Search functionality
                storeSearch.addEventListener("input", (e) => {
                    const q = e.target.value.toLowerCase();
                    $$("#storeList > div").forEach((div) => {
                        div.style.display = div.dataset.name.includes(q) ? "" : "none";
                    });
                });
                // Custom tab (former App Installer)
                const htmlTa = $("#appHtml");
                const chooseFileBtn = $("#chooseFile");
                chooseFileBtn.addEventListener("click", () => {
                    const sources = [
                        { name: "Choose from Device", action: "device" },
                        { name: "MeowOS Files", action: "meowos" },
                    ];
                    showFileSelectDialog(
                        "Choose File Source",
                        sources.map((s) => s.name),
                        (selected) => {
                            const action = sources.find((s) => s.name === selected).action;
                            if (action === "device") {
                                const input = document.createElement("input");
                                input.type = "file";
                                input.accept = ".html,.htm";
                                input.onchange = async (e) => {
                                    const file = e.target.files[0];
                                    if (file) {
                                        const text = await readAsText(file);
                                        htmlTa.value = text;
                                    }
                                };
                                input.click();
                            } else {
                                const filesObj = loadFilesStore();
                                const textFiles = Object.keys(filesObj).filter((n) => filesObj[n].type === "text");
                                if (textFiles.length) {
                                    showFileSelectDialog("Select File", textFiles, (name) => {
                                        htmlTa.value = filesObj[name].text;
                                    });
                                } else {
                                    showCustomAlert("No Files", "No text files to choose from.");
                                }
                            }
                        }
                    );
                });
                $("#addApp").addEventListener("click", () => {
                    const name = $("#appName").value.trim();
                    if (!name) {
                        showCustomAlert("Error", "Enter app name");
                        return;
                    }
                    const emoji = $("#appEmoji").value.trim() || "‚ùì";
                    const html = htmlTa.value.trim();
                    if (!html) {
                        showCustomAlert("Error", "Provide HTML code or file");
                        return;
                    }
                    const id = name.toLowerCase().replace(/\W+/g, "-");
                    let customs = store.get(K.customApps, []);
                    if (customs.find((c) => c.id === id)) {
                        showCustomAlert("Error", "App with that name exists");
                        return;
                    }
                    customs.push({ id, name, emoji, html });
                    store.set(K.customApps, customs);
                    buildMeowMenu();
                    flash("App added! Find it in Meow menu.");
                    $("#appName").value = "";
                    $("#appEmoji").value = "";
                    htmlTa.value = "";
                });
            }
            function renderCreatedList() {
                const files = loadFilesStore();
                const list = $("#createdList");
                list.innerHTML = "";
                const search = $("#fileSearch").value.toLowerCase();
                const folders = new Set();
                const fileNames = [];
                Object.keys(files).forEach((key) => {
                    if (key.startsWith(currentPathFiles)) {
                        const rel = key.slice(currentPathFiles.length);
                        if (rel && rel.toLowerCase().includes(search)) {
                            if (rel.includes("/")) {
                                const folder = rel.split("/")[0];
                                folders.add(folder);
                            } else {
                                fileNames.push(rel);
                            }
                        }
                    }
                });
                [...folders].sort().forEach((folder) => {
                    const btn = document.createElement("div");
                    btn.className = "file-item";
                    btn.innerHTML = `<div class="file-icon">üìÅ</div><div class="file-name">${folder}</div><div class="file-actions"><span class="action rename" data-name="${folder}" data-is-folder="true">‚úèÔ∏è</span> <span class="action delete" data-name="${folder}" data-is-folder="true">üóëÔ∏è</span></div>`;
                    btn.addEventListener("click", (e) => {
                        if (e.target.classList.contains("action")) return;
                        currentPathFiles += folder + "/";
                        $("#currentPathDisplay").textContent = currentPathFiles || "/";
                        $("#backBtn").disabled = currentPathFiles === "/";
                        renderCreatedList();
                    });
                    btn.querySelector(".rename").addEventListener("click", (e) => {
                        e.stopPropagation();
                        showCustomPrompt("Rename Folder", "New name:", folder, (newName) => {
                            if (newName && newName !== folder) {
                                const oldPath = currentPathFiles + folder + "/";
                                const newPath = currentPathFiles + newName + "/";
                                const files = loadFilesStore();
                                if (Object.keys(files).some((k) => k.startsWith(newPath))) {
                                    showCustomAlert("Error", "Name exists");
                                    return;
                                }
                                Object.keys(files).forEach((k) => {
                                    if (k.startsWith(oldPath)) {
                                        const newK = newPath + k.slice(oldPath.length);
                                        files[newK] = files[k];
                                        delete files[k];
                                    }
                                });
                                saveFilesStore(files);
                                renderCreatedList();
                            }
                        });
                    });
                    btn.querySelector(".delete").addEventListener("click", (e) => {
                        e.stopPropagation();
                        const folderPath = currentPathFiles + folder + "/";
                        const filesInFolder = Object.keys(files).filter(
                            (k) => k.startsWith(folderPath) && k !== currentPathFiles + folder + "/"
                        );
                        if (filesInFolder.length > 0) {
                            showCustomAlert("Error", "Folder is not empty.");
                            return;
                        }
                        showCustomConfirm("Delete Folder", "Delete " + folder + "?", () => {
                            delete files[folderPath];
                            saveFilesStore(files);
                            renderCreatedList();
                        });
                    });
                    btn.addEventListener("contextmenu", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showFileContext(e.clientX, e.clientY, folder, true);
                    });
                    list.appendChild(btn);
                });
                fileNames.sort().forEach((name) => {
                    const entry = files[currentPathFiles + name];
                    let icon = name.endsWith(".maf")
                        ? "üì¶"
                        : entry.type === "text"
                          ? "üìÑ"
                          : entry.type === "image"
                            ? "üñºÔ∏è"
                            : entry.type === "audio"
                              ? "üéµ"
                              : "üéûÔ∏è";
                    const btn = document.createElement("div");
                    btn.className = "file-item";
                    btn.innerHTML = `<div class="file-icon">${icon}</div><div class="file-name">${name}</div><div class="file-actions"><span class="action download" data-name="${name}">‚¨áÔ∏è</span> <span class="action rename" data-name="${name}">‚úèÔ∏è</span> <span class="action delete" data-name="${name}">üóëÔ∏è</span> <span class="action move" data-name="${name}">‚û°Ô∏è</span></div>`;
                    let clickTimer;
                    btn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        if (clickTimer) {
                            clearTimeout(clickTimer);
                            if (name.endsWith(".maf")) {
                                showCustomConfirm("Install App", `Install app from ${name}?`, () => {
                                    installMaf(currentPathFiles + name);
                                });
                            }
                            clickTimer = null;
                        } else {
                            clickTimer = setTimeout(() => {
                                openCreatedFile(currentPathFiles + name);
                                clickTimer = null;
                            }, 250);
                        }
                    });
                    btn.querySelector(".download").addEventListener("click", (e) => {
                        e.stopPropagation();
                        const files = loadFilesStore();
                        const entry = files[currentPathFiles + name];
                        if (entry.type === "text") {
                            const blob = new Blob([entry.text || entry.data || ""], { type: "text/plain" });
                            triggerDownload(blob, name);
                        } else {
                            const blob = dataURLtoBlob(entry.data);
                            triggerDownload(blob, name);
                        }
                    });
                    btn.querySelector(".rename").addEventListener("click", (e) => {
                        e.stopPropagation();
                        showCustomPrompt("Rename File", "New name:", name, (newName) => {
                            if (newName && newName !== name) {
                                const files = loadFilesStore();
                                const newKey = currentPathFiles + newName;
                                if (files[newKey]) {
                                    showCustomAlert("Error", "Name exists");
                                    return;
                                }
                                files[newKey] = files[currentPathFiles + name];
                                delete files[currentPathFiles + name];
                                saveFilesStore(files);
                                renderCreatedList();
                            }
                        });
                    });
                    btn.querySelector(".delete").addEventListener("click", (e) => {
                        e.stopPropagation();
                        showCustomConfirm("Delete File", "Delete " + name + "?", () => {
                            const files = loadFilesStore();
                            delete files[currentPathFiles + name];
                            saveFilesStore(files);
                            renderCreatedList();
                        });
                    });
                    btn.querySelector(".move").addEventListener("click", (e) => {
                        e.stopPropagation();
                        showCustomPrompt("Move File", "New path (e.g. /folder/):", currentPathFiles, (newPath) => {
                            if (newPath !== currentPathFiles) {
                                const files = loadFilesStore();
                                const newKey = newPath + name;
                                if (files[newKey]) {
                                    showCustomAlert("Error", "File exists at destination");
                                    return;
                                }
                                files[newKey] = files[currentPathFiles + name];
                                delete files[currentPathFiles + name];
                                saveFilesStore(files);
                                renderCreatedList();
                                flash("File moved");
                            }
                        });
                    });
                    btn.addEventListener("contextmenu", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showFileContext(e.clientX, e.clientY, name);
                    });
                    btn.draggable = true;
                    btn.addEventListener("dragstart", (e) =>
                        e.dataTransfer.setData("text", JSON.stringify({ type: "file", id: currentPathFiles + name }))
                    );
                    list.appendChild(btn);
                });
            }
            let currentPathFiles = "/";
            async function openCreatedFile(path) {
                const files = loadFilesStore();
                const entry = files[path];
                if (!entry) return;
                $("#currentFileName").textContent = path.split("/").pop();
                fileState.currentName = path;
                fileState.isCreated = true;
                fileState.currentType = entry.type;
                if (entry.type === "text") {
                    if (path.endsWith(".html")) {
                        $("#editorArea").style.display = "none";
                        $("#viewerWrap").classList.add("show");
                        const iframe = document.createElement("iframe");
                        iframe.srcdoc = entry.text;
                        iframe.style.width = "100%";
                        iframe.style.height = "100%";
                        iframe.style.borderRadius = "10px";
                        $("#mediaViewer").innerHTML = "";
                        $("#mediaViewer").appendChild(iframe);
                        $("#currentFileIcon").textContent = "üåê";
                    } else {
                        $("#editorArea").style.display = "block";
                        $("#viewerWrap").classList.remove("show");
                        $("#editorArea").value = entry.text ?? entry.data ?? "";
                        $("#currentFileIcon").textContent = path.endsWith(".maf") ? "üì¶" : "üìÑ";
                    }
                } else {
                    $("#editorArea").style.display = "none";
                    $("#viewerWrap").classList.add("show");
                    const v = $("#mediaViewer");
                    v.innerHTML = "";
                    if (entry.type === "image") {
                        const img = document.createElement("img");
                        img.src = entry.data;
                        v.appendChild(img);
                        $("#currentFileIcon").textContent = "üñºÔ∏è";
                    } else if (entry.type === "audio") {
                        const a = document.createElement("audio");
                        a.controls = true;
                        a.src = entry.data;
                        v.appendChild(a);
                        $("#currentFileIcon").textContent = "üéµ";
                    } else if (entry.type === "video") {
                        const vid = document.createElement("video");
                        vid.controls = true;
                        vid.src = entry.data;
                        v.appendChild(vid);
                        $("#currentFileIcon").textContent = "üéûÔ∏è";
                    } else {
                        v.textContent = "Preview not available.";
                        $("#currentFileIcon").textContent = "üìÑ";
                    }
                }
            }
            function saveCurrentFile() {
                if (!fileState.currentName) {
                    showCustomAlert("Error", "No file open.");
                    return;
                }
                const files = loadFilesStore();
                if (fileState.isCreated) {
                    const entry = files[fileState.currentName] || { type: "text", text: "" };
                    if (entry.type === "text") {
                        entry.text = $("#editorArea").value;
                        entry.type = "text";
                        files[fileState.currentName] = entry;
                        saveFilesStore(files);
                        renderCreatedList();
                        flash("Saved!");
                    } else {
                        flash("Saved (no overwrite for binary files via editor).");
                    }
                } else {
                    flash("Uploaded files cannot be overwritten in place in editor. Create a new file to save edits.");
                }
            }
            function downloadCurrent() {
                if (!fileState.currentName) {
                    showCustomAlert("Error", "No file open.");
                    return;
                }
                const files = loadFilesStore();
                const entry = files[fileState.currentName];
                if (!entry) return;
                if (entry.type === "text") {
                    const blob = new Blob([entry.text || entry.data || ""], { type: "text/plain" });
                    triggerDownload(blob, fileState.currentName.split("/").pop());
                } else {
                    const blob = dataURLtoBlob(entry.data);
                    triggerDownload(blob, fileState.currentName.split("/").pop());
                }
            }
            function triggerDownload(blob, name) {
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = name;
                a.click();
                setTimeout(() => URL.revokeObjectURL(a.href), 1500);
            }
            function dataURLtoBlob(dataurl) {
                const arr = dataurl.split(","),
                    mime = arr[0].match(/:(.*?);/)[1],
                    bstr = atob(arr[1]),
                    n = bstr.length,
                    u8arr = new Uint8Array(n);
                for (let i = 0; i < n; i++) u8arr[i] = bstr.charCodeAt(i);
                return new Blob([u8arr], { type: mime });
            }
            function initFiles() {
                renderCreatedList();
                $("#fileSearch").addEventListener("input", renderCreatedList);
                $("#backBtn").addEventListener("click", () => {
                    if (currentPathFiles !== "/") {
                        currentPathFiles = currentPathFiles.replace(/[^\/]+\/$/, "");
                        $("#currentPathDisplay").textContent = currentPathFiles || "/";
                        $("#backBtn").disabled = currentPathFiles === "/";
                        renderCreatedList();
                    }
                });
                $("#newFolder").addEventListener("click", () => {
                    showCustomPrompt("New Folder", "Folder name:", "", (name) => {
                        if (name) {
                            const files = loadFilesStore();
                            const folderPath = currentPathFiles + name + "/";
                            if (Object.keys(files).some((k) => k.startsWith(folderPath))) {
                                showCustomAlert("Error", "Folder exists");
                                return;
                            }
                            files[folderPath] = { type: "folder" };
                            saveFilesStore(files);
                            renderCreatedList();
                        }
                    });
                });
                $("#createFile").addEventListener("click", () => {
                    const name = ($("#newFileName").value || "").trim();
                    if (!name) {
                        showCustomAlert("Error", "Enter a file name, e.g. notes.txt");
                        return;
                    }
                    const files = loadFilesStore();
                    const key = currentPathFiles + name;
                    if (files[key]) {
                        showCustomAlert("Error", "That name already exists.");
                        return;
                    }
                    files[key] = { type: "text", text: "" };
                    saveFilesStore(files);
                    $("#newFileName").value = "";
                    renderCreatedList();
                    openCreatedFile(key);
                });
                $("#saveFile").addEventListener("click", saveCurrentFile);
                $("#downloadFile").addEventListener("click", downloadCurrent);
                $("#uploadBtn").addEventListener("click", () => $("#uploadFile").click());
                $("#uploadFile").addEventListener("change", async (e) => {
                    const selectedFiles = Array.from(e.target.files);
                    const files = loadFilesStore();
                    for (const file of selectedFiles) {
                        let name = file.name;
                        let i = 1;
                        let key = currentPathFiles + name;
                        while (files[key]) {
                            const ext = name.split(".").pop();
                            const base = name.replace(/\.[^/.]+$/, "");
                            name = `${base} (${i}).${ext}`;
                            key = currentPathFiles + name;
                            i++;
                        }
                        if (file.type.startsWith("text/")) {
                            const text = await readAsText(file);
                            files[key] = { type: "text", text };
                        } else if (file.type.startsWith("image/")) {
                            const data = await readAsDataURL(file);
                            files[key] = { type: "image", data };
                        } else if (file.type.startsWith("audio/")) {
                            const data = await readAsDataURL(file);
                            files[key] = { type: "audio", data };
                        } else if (file.type.startsWith("video/")) {
                            const data = await readAsDataURL(file);
                            files[key] = { type: "video", data };
                        } else {
                            const data = await readAsDataURL(file);
                            files[key] = { type: "text", text: data }; // Fallback
                        }
                    }
                    saveFilesStore(files);
                    renderCreatedList();
                    e.target.value = "";
                    flash(`${selectedFiles.length} file(s) uploaded!`);
                });
                $("#currentPathDisplay").textContent = currentPathFiles || "/";
                $("#backBtn").disabled = currentPathFiles === "/";
            }
            function initCalculator() {
                let currentInput = "";
                const display = $("#calcDisplay");
                function updateDisplay() {
                    display.value = currentInput || "0";
                }
                const buttons = [
                    "7",
                    "8",
                    "9",
                    "/",
                    "sin",
                    "4",
                    "5",
                    "6",
                    "*",
                    "cos",
                    "1",
                    "2",
                    "3",
                    "-",
                    "tan",
                    "0",
                    ".",
                    "=",
                    "+",
                    "sqrt",
                    "C",
                    "(",
                    ")",
                    "^",
                    "log",
                    "œÄ",
                    "e",
                    "AC",
                    "DEL",
                    "ans",
                ];
                const container = $("#calcButtons");
                container.style.display = "grid";
                container.style.gridTemplateColumns = "repeat(5, 1fr)";
                container.style.gap = "8px";
                buttons.forEach((btnText) => {
                    const btn = document.createElement("button");
                    btn.className = "btn secondary";
                    if (["sin", "cos", "tan", "sqrt", "log", "^"].includes(btnText))
                        btn.classList.add("calc-btn-advanced");
                    btn.textContent = btnText;
                    btn.style.padding = "12px";
                    btn.style.fontSize = "18px";
                    btn.addEventListener("click", () => {
                        if (btnText === "C") currentInput = "";
                        else if (btnText === "AC") currentInput = "";
                        else if (btnText === "DEL") currentInput = currentInput.slice(0, -1);
                        else if (btnText === "=" || btnText === "ans") {
                            try {
                                currentInput = eval(currentInput.replace("^", "**")).toString();
                            } catch {
                                currentInput = "Error";
                            }
                        } else if (["sin", "cos", "tan", "sqrt", "log"].includes(btnText)) {
                            currentInput += "Math." + btnText + "(";
                        } else if (btnText === "^") {
                            currentInput += "**";
                        } else if (btnText === "œÄ") {
                            currentInput += "Math.PI";
                        } else if (btnText === "e") {
                            currentInput += "Math.E";
                        } else currentInput += btnText;
                        updateDisplay();
                    });
                    container.appendChild(btn);
                });
                updateDisplay();
            }
            function initClock() {
                $$("[data-tab]").forEach((btn) =>
                    btn.addEventListener("click", (e) => {
                        $$("[data-tab]").forEach((b) => b.classList.remove("active"));
                        e.target.classList.add("active");
                        $$("[data-tab-content]").forEach(
                            (c) => (c.style.display = c.dataset.tabContent === e.target.dataset.tab ? "block" : "none")
                        );
                    })
                );
                // Alarms
                let alarms = store.get(K.alarms, []);
                function renderAlarms() {
                    const list = $("#alarmList");
                    list.innerHTML = "";
                    alarms.forEach((a, i) => {
                        const div = document.createElement("div");
                        div.style.display = "flex";
                        div.style.alignItems = "center";
                        div.style.gap = "8px";
                        div.style.padding = "8px";
                        div.style.border = "1px solid rgba(255,255,255,.1)";
                        div.style.borderRadius = "8px";
                        div.innerHTML = `<span>${a.time}</span> <span class="action" data-action="delete" data-index="${i}">üóëÔ∏è</span>`;
                        div.querySelector('[data-action="delete"]').addEventListener("click", () => {
                            alarms.splice(i, 1);
                            store.set(K.alarms, alarms);
                            renderAlarms();
                        });
                        list.appendChild(div);
                    });
                }
                renderAlarms();
                $("#addAlarm").addEventListener("click", () => {
                    const min = parseInt($("#alarmInput").value);
                    if (isNaN(min) || min <= 0) return;
                    const now = new Date();
                    const alarmTime = new Date(now.getTime() + min * 60000);
                    const timeStr = alarmTime.toLocaleTimeString([], {
                        hour: "2-digit",
                        minute: "2-digit",
                        hour12: false,
                    });
                    alarms.push({ time: timeStr });
                    store.set(K.alarms, alarms);
                    renderAlarms();
                    $("#alarmInput").value = "";
                });
                // Stopwatch
                let swInterval,
                    swTime = 0,
                    swRunning = false;
                function updateSW() {
                    const sec = Math.floor(swTime / 1000);
                    const min = Math.floor(sec / 60);
                    const h = Math.floor(min / 60);
                    const s = sec % 60;
                    const m = min % 60;
                    $("#stopwatchDisplay").textContent =
                        `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
                }
                $("#swStart").addEventListener("click", () => {
                    if (swRunning) return;
                    swRunning = true;
                    swInterval = setInterval(() => {
                        swTime += 1000;
                        updateSW();
                    }, 1000);
                });
                $("#swStop").addEventListener("click", () => {
                    if (!swRunning) return;
                    clearInterval(swInterval);
                    swRunning = false;
                });
                $("#swReset").addEventListener("click", () => {
                    clearInterval(swInterval);
                    swRunning = false;
                    swTime = 0;
                    updateSW();
                });
                // Timer
                let timerInterval,
                    timerTime = 0,
                    timerRunning = false;
                function updateTimer() {
                    const sec = Math.floor(timerTime / 1000);
                    const min = Math.floor(sec / 60);
                    $("#timerDisplay").textContent =
                        `${min.toString().padStart(2, "0")}:${(sec % 60).toString().padStart(2, "0")}`;
                    if (timerTime <= 0) {
                        clearInterval(timerInterval);
                        timerRunning = false;
                        showCustomAlert("Timer", "Timer done!");
                    }
                }
                $("#timerStart").addEventListener("click", () => {
                    if (timerRunning || !$("#timerInput").value) return;
                    const min = parseInt($("#timerInput").value);
                    timerTime = min * 60 * 1000;
                    timerRunning = true;
                    updateTimer();
                    timerInterval = setInterval(() => {
                        timerTime -= 1000;
                        updateTimer();
                    }, 1000);
                });
                $("#timerStop").addEventListener("click", () => {
                    clearInterval(timerInterval);
                    timerRunning = false;
                });
            }
            function initWeather() {
                const city = store.get(K.weatherCity, "London");
                const updateWeather = async () => {
                    const weather = await fetchWeatherFor(`weather ${city}`);
                    $("#weatherDisplay").innerHTML =
                        `<div style="font-size:24px;font-weight:700;margin-bottom:10px;">${weather}</div>`;
                };
                updateWeather();
                setInterval(updateWeather, 600000); // Update every 10 min
            }
            function initSettings() {
                function renderInstalledApps() {
                    const list = $("#installedAppsList");
                    list.innerHTML = "";
                    let customs = store.get(K.customApps, []);
                    if (!customs.length) {
                        list.innerHTML = "<p>No installed apps.</p>";
                        return;
                    }
                    customs.forEach((app, index) => {
                        let iconHtml;
                        if (app.emoji.startsWith("http")) {
                            iconHtml = `<img src="${app.emoji}" style="width:20px;height:20px;border-radius:4px;vertical-align:middle;margin-right:4px;" alt="">`;
                        } else {
                            iconHtml = `${app.emoji} `;
                        }
                        const row = document.createElement("div");
                        row.className = "settings-row";
                        row.innerHTML = `<span>${iconHtml}${app.name}</span>`;
                        const deleteBtn = document.createElement("button");
                        deleteBtn.className = "btn secondary";
                        deleteBtn.textContent = "Delete";
                        deleteBtn.addEventListener("click", () => {
                            customs = customs.filter((c) => c.id !== app.id);
                            store.set(K.customApps, customs);
                            let pinned = store.get(K.pinned, []);
                            pinned = pinned.filter((p) => p !== "custom_" + app.id);
                            store.set(K.pinned, pinned);
                            let shortcuts = store.get(K.shortcuts, []);
                            shortcuts = shortcuts.filter((s) => !(s.type === "app" && s.id === "custom_" + app.id));
                            store.set(K.shortcuts, shortcuts);
                            renderInstalledApps();
                            buildMeowMenu();
                            renderDock();
                            renderShortcuts();
                            const win = $("#win-custom-" + app.id);
                            if (win) win.remove();
                            flash("App deleted");
                        });
                        row.appendChild(deleteBtn);
                        list.appendChild(row);
                    });
                }
                renderInstalledApps();
                const appsPane = $("[data-pane=apps]");
                const execSection = document.createElement("div");
                execSection.className = "section";
                execSection.innerHTML = `
          <h3 class=emoji style="margin:0 0 8px">‚öôÔ∏è App Execution Mode</h3>
          <p style="color:var(--muted);font-size:13px;margin-bottom:8px">How custom apps from MeowStore run:</p>
          <select id=appExecutionMode>
            <option value="sandboxed">Sandboxed iframe (safe)</option>
            <option value="unsandboxed">Unsandboxed iframe</option>
            <option value="direct">Direct code execution (dangerous)</option>
          </select>
        `;
                appsPane.insertBefore(execSection, $("#installedAppsList"));
                $("#appExecutionMode").value = store.get(K.appExecutionMode, "unsandboxed");
                $("#appExecutionMode").addEventListener("change", (e) => {
                    store.set(K.appExecutionMode, e.target.value);
                    flash("App execution mode updated");
                });
                $("#setName").value = store.get(K.name, "") || "";
                $("#applyName").addEventListener("click", () => {
                    const v = $("#setName").value.trim();
                    if (!v) {
                        showCustomAlert("Error", "Enter a name");
                        return;
                    }
                    store.set(K.name, v);
                    $("#hello").textContent = `üò∫ Welcome, ${v}!`;
                    $("#meowUser").textContent = v;
                    flash("Name updated");
                });
                $("#textColor").value = store.get(K.textcolor, "#e6ecff");
                $("#textColor").addEventListener("input", (e) => {
                    document.documentElement.style.setProperty("--text", e.target.value);
                    store.set(K.textcolor, e.target.value);
                });
                const scaleSlider = $("#textScale");
                const scaleValue = $("#scaleValue");
                scaleSlider.value = store.get(K.scale, 1);
                scaleValue.textContent = `${scaleSlider.value}x`;
                scaleSlider.addEventListener("input", (e) => {
                    const val = e.target.value;
                    document.documentElement.style.setProperty("--font-scale", val);
                    scaleValue.textContent = `${val}x`;
                });
                scaleSlider.addEventListener("change", (e) => {
                    store.set(K.scale, e.target.value);
                    flash("Textscale updated");
                });
                $("#showSeconds").checked = !!store.get(K.showSeconds, false);
                $("#showSeconds").addEventListener("change", (e) => {
                    store.set(K.showSeconds, e.target.checked);
                    update();
                    flash(e.target.checked ? "Seconds shown" : "Seconds hidden");
                });
                const currentTz = store.get(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
                $("#timeZone").value = currentTz;
                if (!$("#timeZone").querySelector(`option[value="${currentTz}"]`)) {
                    const opt = document.createElement("option");
                    opt.value = currentTz;
                    opt.textContent = currentTz;
                    $("#timeZone").appendChild(opt);
                    $("#timeZone").value = currentTz;
                }
                $("#timeZone").addEventListener("change", (e) => {
                    store.set(K.tz, e.target.value);
                    update();
                    flash("Time zone updated");
                    if (clockWidget) toggleClockWidget(true);
                    if (calendarWidget) toggleCalendarWidget(true);
                });
                $("#accentColor").addEventListener("input", (e) =>
                    document.documentElement.style.setProperty("--accent", e.target.value)
                );
                $("#accentColor").addEventListener("change", (e) => {
                    store.set(K.accent, e.target.value);
                    flash("Accent color updated");
                });
                $("#dockPos").value = store.get(K.dock, "bottom");
                $("#dockPos").addEventListener("change", (e) => {
                    const pos = e.target.value;
                    store.set(K.dock, pos);
                    document.body.classList.toggle("dock-left", pos === "left");
                    flash("Dock position updated");
                });
                $("#autoHideDock").checked = !!store.get(K.autoHideDock, false);
                $("#autoHideDock").addEventListener("change", (e) => {
                    store.set(K.autoHideDock, e.target.checked);
                    toggleAutoHideDock(e.target.checked);
                    flash(e.target.checked ? "Auto-hide dock enabled" : "Auto-hide dock disabled");
                });
                $("#reduceTransparency").checked = !!store.get(K.reduce, false);
                $("#reduceTransparency").addEventListener("change", (e) => {
                    const on = e.target.checked;
                    store.set(K.reduce, on);
                    document.body.classList.toggle("no-glass", on);
                    if (on) document.documentElement.style.setProperty("--blur", "none");
                    else
                        document.documentElement.style.setProperty(
                            "--blur",
                            `saturate(140%) blur(${store.get(K.blur, 50)}px)`
                        );
                    flash(on ? "Transparency disabled" : "Transparency enabled");
                });
                const blurSlider = $("#blurIntensity");
                const blurValue = $("#blurValue");
                blurSlider.value = store.get(K.blur, 50);
                blurValue.textContent = `${blurSlider.value}px`;
                blurSlider.addEventListener("input", (e) => {
                    const val = e.target.value;
                    if (!store.get(K.reduce, false))
                        document.documentElement.style.setProperty("--blur", `saturate(140%) blur(${val}px)`);
                    blurValue.textContent = `${val}px`;
                });
                blurSlider.addEventListener("change", (e) => {
                    store.set(K.blur, e.target.value);
                    if (!store.get(K.reduce, false)) flash("Blur intensity updated");
                });
                $("#fontFamily").value = store.get(K.fontFamily, "");
                $("#fontFamily").addEventListener("change", (e) => {
                    const font = e.target.value;
                    store.set(K.fontFamily, font);
                    document.documentElement.style.setProperty(
                        "--font-family",
                        font ||
                            'ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Color Emoji","Apple Color Emoji","Segoe UI Emoji",sans-serif'
                    );
                    flash("Font updated");
                });
                $("#searchEngine").value = store.get(K.search, "wikipedia");
                $("#searchEngine").addEventListener("change", (e) => {
                    store.set(K.search, e.target.value);
                    flash("Search engine updated");
                });
                $("#homePage").value = store.get(K.home, "https://meowosproxy.kyrylo89.workers.dev");
                $("#applyHome").addEventListener("click", () => {
                    const v = $("#homePage").value.trim();
                    if (!v) {
                        showCustomAlert("Error", "Enter a URL");
                        return;
                    }
                    store.set(K.home, /^https?:\/\//i.test(v) ? v : "https://" + v);
                    flash("Homepage updated");
                });
                $("#proxyMode").value = store.get(K.proxy, "auto");
                $("#proxyMode").addEventListener("change", (e) => {
                    store.set(K.proxy, e.target.value);
                    flash("Proxy mode updated");
                });
                $("#blockPopups").checked = !!store.get(K.blockPopups, true);
                $("#blockPopups").addEventListener("change", (e) => {
                    store.set(K.blockPopups, e.target.checked);
                    applyBrowserSandbox();
                    flash(e.target.checked ? "Popups blocked" : "Popups allowed");
                });
                $("#clearHistory").addEventListener("click", () => {
                    browserHistory = [];
                    browserIndex = -1;
                    flash("Browsing history cleared");
                });
                $("#reduceMotion").checked = !!store.get(K.reduceMotion, false);
                $("#reduceMotion").addEventListener("change", (e) => {
                    store.set(K.reduceMotion, e.target.checked);
                    document.body.classList.toggle("reduce-motion", e.target.checked);
                    flash(e.target.checked ? "Motion reduced" : "Motion enabled");
                });
                $("#highContrast").checked = !!store.get(K.highContrast, false);
                $("#highContrast").addEventListener("change", (e) => {
                    store.set(K.highContrast, e.target.checked);
                    document.body.classList.toggle("high-contrast", e.target.checked);
                    flash(e.target.checked ? "High contrast on" : "High contrast off");
                });
                $("#screensaverEnable").checked = !!store.get(K.screensaverEnable, false);
                $("#screensaverEnable").addEventListener("change", (e) => {
                    store.set(K.screensaverEnable, e.target.checked);
                    resetIdleTimer();
                    flash(e.target.checked ? "Screensaver enabled" : "Screensaver disabled");
                });
                $("#screensaverTimeout").value = store.get(K.screensaverTimeout, 5);
                $("#screensaverTimeout").addEventListener("change", (e) => {
                    store.set(K.screensaverTimeout, parseInt(e.target.value));
                    resetIdleTimer();
                    flash("Screensaver timeout updated");
                });
                $("#clockWidget").checked = !!store.get(K.clockWidget, false);
                $("#clockWidget").addEventListener("change", (e) => {
                    store.set(K.clockWidget, e.target.checked);
                    toggleClockWidget(e.target.checked);
                    flash(e.target.checked ? "Clock widget enabled" : "Clock widget disabled");
                });
                $("#calendarWidget").checked = !!store.get(K.calendarWidget, false);
                $("#calendarWidget").addEventListener("change", (e) => {
                    store.set(K.calendarWidget, e.target.checked);
                    toggleCalendarWidget(e.target.checked);
                    flash(e.target.checked ? "Calendar widget enabled" : "Calendar widget disabled");
                });
                $("#weatherWidget").checked = !!store.get(K.weatherWidget, false);
                $("#weatherWidget").addEventListener("change", (e) => {
                    store.set(K.weatherWidget, e.target.checked);
                    toggleWeatherWidget(e.target.checked);
                    if (e.target.checked) {
                        showCustomPrompt(
                            "Weather City",
                            "Enter city name:",
                            store.get(K.weatherCity, "London"),
                            (city) => {
                                store.set(K.weatherCity, city);
                            }
                        );
                    }
                    flash(e.target.checked ? "Weather widget enabled" : "Weather widget disabled");
                });
                $("#randomWidget").checked = !!store.get(K.randomWidget, false);
                $("#randomWidget").addEventListener("change", (e) => {
                    store.set(K.randomWidget, e.target.checked);
                    toggleRandomWidget(e.target.checked);
                    flash(e.target.checked ? "Random Wikipedia widget enabled" : "Random Wikipedia widget disabled");
                });
                // Meow Menu settings
                $("#showPinned").checked = store.get(K.showPinned, true);
                $("#showPinned").addEventListener("change", (e) => {
                    store.set(K.showPinned, e.target.checked);
                    buildMeowMenu();
                    flash(e.target.checked ? "Pinned section enabled" : "Pinned section disabled");
                });
                $("#showAll").checked = store.get(K.showAll, true);
                $("#showAll").addEventListener("change", (e) => {
                    store.set(K.showAll, e.target.checked);
                    buildMeowMenu();
                    flash(e.target.checked ? "All apps section enabled" : "All apps section disabled");
                });
                $("#showRecents").checked = store.get(K.showRecents, true);
                $("#showRecents").addEventListener("change", (e) => {
                    store.set(K.showRecents, e.target.checked);
                    buildMeowMenu();
                    flash(e.target.checked ? "Recent files section enabled" : "Recent files section disabled");
                });
                const iconSizeSlider = $("#meowIconSize");
                const iconSizeValue = $("#iconSizeValue");
                iconSizeSlider.value = store.get(K.meowIconSize, 92);
                iconSizeValue.textContent = `${iconSizeSlider.value}px`;
                iconSizeSlider.addEventListener("input", (e) => {
                    const val = e.target.value;
                    document.documentElement.style.setProperty("--meow-icon-size", val + "px");
                    iconSizeValue.textContent = `${val}px`;
                    $$(".meow-item").forEach((item) => {
                        item.style.width = val + "px";
                    });
                });
                iconSizeSlider.addEventListener("change", (e) => {
                    store.set(K.meowIconSize, parseInt(e.target.value));
                    flash("Icon size updated");
                });
                // Icon Style
                $("#iconsMode").value = store.get(K.iconsMode, "emoji");
                $("#iconsMode").addEventListener("change", (e) => {
                    store.set(K.iconsMode, e.target.value);
                    const showLabelsStored = store.get(K.showDockLabels, null);
                    if (showLabelsStored === null) {
                        $("#showDockLabels").checked = e.target.value === "emoji";
                        store.set(K.showDockLabels, e.target.value === "emoji");
                    }
                    refreshIcons();
                    flash("Icon style updated");
                });
                // Dock Labels
                const iconsMode = store.get(K.iconsMode, "emoji");
                const defaultLabels = iconsMode === "emoji";
                $("#showDockLabels").checked = store.get(K.showDockLabels, defaultLabels);
                $("#showDockLabels").addEventListener("change", (e) => {
                    store.set(K.showDockLabels, e.target.checked);
                    renderDock();
                    flash(e.target.checked ? "Dock labels enabled" : "Dock labels disabled");
                });
                // Dock Icon Radius
                const radiusSlider = $("#dockIconRadius");
                const radiusValue = $("#radiusValue");
                const defaultRadius = 8;
                radiusSlider.value = store.get(K.dockIconRadius, defaultRadius);
                radiusValue.textContent = `${radiusSlider.value}px`;
                document.documentElement.style.setProperty("--dock-icon-radius", radiusSlider.value + "px");
                radiusSlider.addEventListener("input", (e) => {
                    const val = e.target.value;
                    document.documentElement.style.setProperty("--dock-icon-radius", val + "px");
                    radiusValue.textContent = `${val}px`;
                    refreshIcons();
                });
                radiusSlider.addEventListener("change", (e) => {
                    store.set(K.dockIconRadius, parseInt(e.target.value));
                    flash("Dock icon radius updated");
                });
                // Tablet Mode
                $("#tabletMode").checked = !!store.get(K.tablet, false);
                $("#tabletMode").addEventListener("change", (e) => {
                    store.set(K.tablet, e.target.checked);
                    applyTabletMode(e.target.checked);
                    flash(e.target.checked ? "Tablet mode enabled" : "Tablet mode disabled");
                });
                // Easter Egg: Credits KyrKat click
                $$(".credits-kyrkat").forEach((el) => {
                    el.addEventListener("click", () => {
                        flash("üê± Thanks, KyrKat! Secret unlocked! üê±");
                        store.set(K.debugUnlocked, true);
                        store.set(K.secretWallpaper, "secret");
                        applyBackground();
                    });
                });
                // Wallpaper settings
                const defaults = [
                    {
                        id: "orange-balls",
                        name: "3D Orange Balls",
                        css: "radial-gradient(circle at 20% 80%, #cc7a00 0%, #cc5500 30%, transparent 50%), radial-gradient(circle at 60% 20%, #cc6600 0%, #cc7a00 30%, transparent 50%), radial-gradient(circle at 80% 70%, #cc5500 0%, #cc6600 30%, transparent 50%), linear-gradient(to bottom, #0b0f17, #1a1f2e)",
                    },
                    {
                        id: "blue-balls",
                        name: "Blue Bouncing Balls",
                        css: "radial-gradient(circle at 10% 30%, #2c5282 0%, #2a4365 30%, transparent 50%), radial-gradient(circle at 70% 60%, #319795 0%, #285e61 30%, transparent 50%), radial-gradient(circle at 40% 90%, #68d391 0%, #38a169 30%, transparent 50%), linear-gradient(to bottom, #0b0f17, #1a1f2e)",
                    },
                    {
                        id: "green-rectangles",
                        name: "Green Rectangles",
                        css: "repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(46, 207, 142, 0.2) 50px, rgba(46, 207, 142, 0.2) 100px), repeating-linear-gradient(0deg, transparent, transparent 30px, rgba(46, 207, 142, 0.2) 30px, rgba(46, 207, 142, 0.2) 60px), linear-gradient(to bottom, #0b0f17, #1a1f2e)",
                    },
                    {
                        id: "blue-stripes",
                        name: "Blue Stripes",
                        css: "repeating-linear-gradient(45deg, transparent, transparent 20px, #2c5282 20px, #2c5282 40px), linear-gradient(to bottom, #0b0f17, #1a1f2e)",
                    },
                    {
                        id: "checkerboard",
                        name: "Checkerboard Tiles",
                        css: "repeating-conic-gradient(from 0deg at 10px 10px, #1a1f2e 0deg 90deg, #0b0f17 90deg 180deg, #1a1f2e 180deg 270deg, #0b0f17 270deg 360deg), linear-gradient(to bottom, #0b0f17, #1a1f2e)",
                    },
                    {
                        id: "dots",
                        name: "Polka Dots",
                        css: "radial-gradient(circle at 20px 20px, rgba(138, 155, 255, 0.4) 1px, transparent 1px), radial-gradient(circle at 40px 40px, rgba(138, 155, 255, 0.4) 1px, transparent 1px), repeating-linear-gradient(0deg, transparent, transparent 20px), linear-gradient(to bottom, #0b0f17, #1a1f2e)",
                    },
                    {
                        id: "default",
                        name: "Meow Gradient",
                        css: "radial-gradient(80vw 80vh at 10% 15%,var(--dark-grad1),transparent 60%),radial-gradient(80vw 80vh at 90% 85%,var(--dark-grad2),transparent 60%)",
                    },
                    { id: "blue", name: "Blue Sky", css: "linear-gradient(to bottom, #00008b, #87ceeb)" },
                    { id: "green", name: "Green Forest", css: "linear-gradient(to bottom, #006400, #90ee90)" },
                    { id: "red", name: "Red Sunset", css: "linear-gradient(to bottom, #8b0000, #ff7f7f)" },
                    { id: "purple", name: "Purple Night", css: "linear-gradient(to bottom, #4b0082, #dda0dd)" },
                    { id: "orange", name: "Orange Sunset", css: "linear-gradient(to bottom, #ff4500, #ffd700)" },
                    { id: "pink", name: "Pink Dawn", css: "linear-gradient(to bottom, #ff1493, #ffc0cb)" },
                    { id: "teal", name: "Teal Ocean", css: "linear-gradient(to bottom, #008080, #00bfff)" },
                    { id: "lavender", name: "Lavender Fields", css: "linear-gradient(to bottom, #e6e6fa, #9370db)" },
                    { id: "gray", name: "Gray Mist", css: "linear-gradient(to bottom, #a9a9a9, #696969)" },
                    { id: "yellow", name: "Sunny Yellow", css: "linear-gradient(to bottom, #ffff00, #ffd700)" },
                    { id: "cyan", name: "Cyan Waves", css: "linear-gradient(to bottom, #00ffff, #008b8b)" },
                    { id: "magenta", name: "Magenta Bloom", css: "linear-gradient(to bottom, #ff00ff, #da70d6)" },
                    { id: "black", name: "Night Black", css: "linear-gradient(to bottom, #000000, #333333)" },
                    {
                        id: "cat-orange",
                        name: "Dark Cat Orange",
                        css: "radial-gradient(circle at 20% 80%, #cc7a00, #cc5500, #cc6600)",
                    },
                    { id: "indigo", name: "Indigo Twilight", css: "linear-gradient(to bottom, #4b0082, #8a2be2)" },
                    { id: "lime", name: "Lime Meadow", css: "linear-gradient(to bottom, #32cd32, #adff2f)" },
                    { id: "maroon", name: "Maroon Dusk", css: "linear-gradient(to bottom, #800000, #bc8f8f)" },
                    { id: "navy", name: "Navy Depths", css: "linear-gradient(to bottom, #000080, #4682b4)" },
                    { id: "olive", name: "Olive Grove", css: "linear-gradient(to bottom, #808000, #bdbd7c)" },
                    { id: "silver", name: "Silver Moon", css: "linear-gradient(to bottom, #c0c0c0, #a9a9a9)" },
                    { id: "violet", name: "Violet Horizon", css: "linear-gradient(to bottom, #ee82ee, #8a2be2)" },
                ];
                const prevWrap = $("#defaultPreviews");
                defaults.forEach((d) => {
                    const pill = document.createElement("div");
                    pill.className = "pill";
                    pill.dataset.id = d.id;
                    const prev = document.createElement("div");
                    prev.className = "preview-div";
                    prev.style.backgroundImage = d.css;
                    const label = document.createElement("div");
                    label.textContent = d.name;
                    pill.appendChild(prev);
                    pill.appendChild(label);
                    pill.addEventListener("click", () => {
                        store.set(K.defaultWall, d.id);
                        store.del(K.wallpaper);
                        applyBackground();
                        flash("Wallpaper set");
                    });
                    prevWrap.appendChild(pill);
                });
                if (store.get(K.defaultWall) && !store.get(K.wallpaper)) {
                    const active = prevWrap.querySelector(`[data-id="${store.get(K.defaultWall)}"]`);
                    if (active) active.style.border = "2px solid var(--accent)";
                }
                $("#wallUpload").addEventListener("change", async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const data = await new Promise((r) => {
                        const reader = new FileReader();
                        reader.onload = () => r(reader.result);
                        reader.readAsDataURL(file);
                    });
                    store.set(K.wallpaper, data);
                    store.del(K.defaultWall);
                    applyBackground();
                    flash("Wallpaper updated");
                });
                function renderFileWalls() {
                    const files = loadFilesStore();
                    const list = $("#fileWallList");
                    list.innerHTML = "";
                    Object.keys(files)
                        .filter((n) => files[n].type === "image")
                        .forEach((name) => {
                            const pill = document.createElement("div");
                            pill.className = "pill";
                            const prev = document.createElement("img");
                            prev.src = files[name].data;
                            prev.style.width = "100px";
                            prev.style.height = "60px";
                            prev.style.objectFit = "cover";
                            prev.style.borderRadius = "8px";
                            const label = document.createElement("div");
                            label.textContent = name;
                            pill.appendChild(prev);
                            pill.appendChild(label);
                            pill.addEventListener("click", () => {
                                store.set(K.wallpaper, files[name].data);
                                store.del(K.defaultWall);
                                applyBackground();
                                flash("Wallpaper set from file");
                            });
                            list.appendChild(pill);
                        });
                }
                renderFileWalls();
                $("#factoryReset").addEventListener("click", () => {
                    showCustomConfirm("Factory Reset", "Clear all MeowOS data?", () => {
                        const prefix = isVM ? "vm_meowos_" : "meowos_";
                        Object.keys(localStorage)
                            .filter((k) => k.startsWith(prefix))
                            .forEach((k) => localStorage.removeItem(k));
                        location.reload();
                    });
                });
                $("#recoveryBtn").addEventListener("click", () => {
                    $("#recovery").classList.remove("hidden");
                });
                $("#recReset").addEventListener("click", () => {
                    showCustomConfirm("Factory Reset", "Clear all MeowOS data?", () => {
                        const prefix = isVM ? "vm_meowos_" : "meowos_";
                        Object.keys(localStorage)
                            .filter((k) => k.startsWith(prefix))
                            .forEach((k) => localStorage.removeItem(k));
                        location.reload();
                    });
                });
                $("#recNoAnim").addEventListener("click", () => {
                    store.set(K.reduceMotion, true);
                    document.body.classList.add("reduce-motion");
                    flash("Animations disabled");
                    $("#recovery").classList.add("hidden");
                });
                $("#recNoGlass").addEventListener("click", () => {
                    store.set(K.reduce, true);
                    document.body.classList.add("no-glass");
                    document.documentElement.style.setProperty("--blur", "none");
                    flash("Glass effects disabled");
                    $("#recovery").classList.add("hidden");
                });
                $("#recBack").addEventListener("click", () => {
                    $("#recovery").classList.add("hidden");
                });
                $("#exportConfig").addEventListener("click", () => {
                    const keys = Object.values(K);
                    const obj = {};
                    keys.forEach((k) => {
                        const v = localStorage.getItem(isVM ? "vm_" + k : k);
                        if (v != null) obj[k] = JSON.parse(v);
                    });
                    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
                    triggerDownload(blob, "meowos-settings.json");
                });
                $("#importConfig").addEventListener("change", async (e) => {
                    const file = e.target.files?.[0];
                    if (!file) return;
                    const text = await file.text();
                    try {
                        const data = JSON.parse(text);
                        Object.entries(data).forEach(([k, v]) => {
                            if (Object.keys(K).includes(k))
                                localStorage.setItem(isVM ? "vm_" + k : k, JSON.stringify(v));
                        });
                        flash("Settings imported ‚Äî reloading‚Ä¶");
                        setTimeout(() => location.reload(), 600);
                    } catch {
                        showCustomAlert("Error", "Invalid settings file");
                    }
                });
                const cats = $("#settingsCats");
                const panes = $$(".settings-pane");
                cats.addEventListener("click", (e) => {
                    const li = e.target.closest("li");
                    if (!li) return;
                    cats.querySelectorAll("li").forEach((n) => n.classList.remove("active"));
                    li.classList.add("active");
                    const target = li.dataset.cat;
                    panes.forEach((p) => (p.hidden = p.dataset.pane !== target));
                });
                const index = [];
                panes.forEach((pane) => {
                    pane.querySelectorAll("h2,h3,label,button,select,input").forEach((el) => {
                        const txt = (el.textContent || el.placeholder || "").trim();
                        if (txt) index.push({ pane, el, text: txt.toLowerCase() });
                    });
                });
                function jumpToPane(pane) {
                    const id = pane.dataset.pane;
                    cats.querySelectorAll("li").forEach((n) => n.classList.remove("active"));
                    const li = cats.querySelector(`li[data-cat="${id}"]`);
                    if (li) {
                        li.classList.add("active");
                    }
                    panes.forEach((p) => (p.hidden = p !== pane));
                }
                function highlight(el) {
                    el.scrollIntoView({ behavior: "smooth", block: "center" });
                    el.style.outline = `2px solid var(--accent)`;
                    el.style.borderRadius = "6px";
                    setTimeout(() => {
                        el.style.outline = "";
                    }, 1200);
                }
                $("#settingsSearch").addEventListener("input", (e) => {
                    const q = e.target.value.trim().toLowerCase();
                    if (!q) return;
                    const hit = index.find((it) => it.text.includes(q));
                    if (hit) {
                        jumpToPane(hit.pane);
                        highlight(hit.el);
                    }
                });
                $("#tapFeedback").checked = !!store.get(K.tapFeedback, false);
                $("#tapFeedback").addEventListener("change", (e) => {
                    store.set(K.tapFeedback, e.target.checked);
                    flash(e.target.checked ? "Tap feedback enabled" : "Tap feedback disabled");
                });
                $("#openSandbox").addEventListener("click", () => {
                    const vmWin = window.open("", "MeowOS VM", "width=800,height=600");
                    vmWin.name = "vm";
                    vmWin.document.open();
                    vmWin.document.write(document.documentElement.outerHTML);
                    vmWin.document.close();
                    flash("Sandbox MeowOS opened in new window");
                });
            }
            function initPaint() {
                const canvas = $("#paintCanvas");
                const ctx = canvas.getContext("2d");
                function resizeCanvas() {
                    const rect = canvas.getBoundingClientRect();
                    canvas.width = rect.width * devicePixelRatio;
                    canvas.height = rect.height * devicePixelRatio;
                    ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
                    ctx.fillStyle = "#ffffff";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
                let painting = false,
                    lastX = 0,
                    lastY = 0;
                const brush = () => parseInt($("#brushSize").value, 10) || 6;
                const color = () => $("#brushColor").value || "#000";
                function start(e) {
                    painting = true;
                    const r = canvas.getBoundingClientRect();
                    const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
                    const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
                    lastX = x;
                    lastY = y;
                }
                function draw(e) {
                    if (!painting) return;
                    const r = canvas.getBoundingClientRect();
                    const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
                    const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
                    ctx.strokeStyle = color();
                    ctx.lineWidth = brush();
                    ctx.lineCap = "round";
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    lastX = x;
                    lastY = y;
                    e.preventDefault();
                }
                function stop() {
                    painting = false;
                }
                canvas.addEventListener("mousedown", start);
                canvas.addEventListener("mousemove", draw);
                canvas.addEventListener("mouseup", stop);
                canvas.addEventListener("mouseleave", stop);
                canvas.addEventListener("touchstart", start, { passive: false });
                canvas.addEventListener("touchmove", draw, { passive: false });
                canvas.addEventListener("touchend", stop);
                $("#clearPaint").addEventListener("click", () => {
                    ctx.fillStyle = "#ffffff";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                });
                $("#savePaint").addEventListener("click", () => {
                    const dataURL = canvas.toDataURL("image/png");
                    const files = loadFilesStore();
                    let base = "painting",
                        i = 1,
                        name = `${base}.png`;
                    let key = "/User/Downloads/" + name;
                    while (files[key]) {
                        i++;
                        name = `${base}-${i}.png`;
                        key = "/User/Downloads/" + name;
                    }
                    files[key] = { type: "image", data: dataURL };
                    saveFilesStore(files);
                    renderCreatedList();
                    openCreatedFile(key);
                    flash("Painting saved");
                });
                const ro = new ResizeObserver(() => resizeCanvas());
                ro.observe(canvas);
                setTimeout(() => resizeCanvas(), 200);
            }
            function initRecorder() {
                const startBtn = $("#recStart"),
                    stopBtn = $("#recStop"),
                    recState = $("#recState"),
                    recList = $("#recList");
                let mediaRecorder = null,
                    chunks = [];
                startBtn.addEventListener("click", async () => {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        chunks = [];
                        mediaRecorder.ondataavailable = (e) => {
                            if (e.data && e.data.size) chunks.push(e.data);
                        };
                        mediaRecorder.onstop = async () => {
                            const blob = new Blob(chunks, { type: "audio/webm" });
                            const dataURL = await new Promise((res, rej) => {
                                const r = new FileReader();
                                r.onload = () => res(r.result);
                                r.onerror = rej;
                                r.readAsDataURL(blob);
                            });
                            const files = loadFilesStore();
                            let base = "recording",
                                i = 1,
                                name = `${base}.webm`;
                            let key = "/User/Downloads/" + name;
                            while (files[key]) {
                                i++;
                                name = `${base}-${i}.webm`;
                                key = "/User/Downloads/" + name;
                            }
                            files[key] = { type: "audio", data: dataURL };
                            saveFilesStore(files);
                            renderCreatedList();
                            const el = document.createElement("div");
                            el.className = "rec-list-item";
                            const a = document.createElement("audio");
                            a.controls = true;
                            a.src = dataURL;
                            const dl = document.createElement("button");
                            dl.className = "btn secondary";
                            dl.textContent = "Download";
                            dl.addEventListener("click", () => {
                                const b = dataURLtoBlob(dataURL);
                                triggerDownload(b, name);
                            });
                            const del = document.createElement("button");
                            del.className = "btn secondary";
                            del.textContent = "Delete";
                            del.addEventListener("click", () => {
                                el.remove();
                                const files = loadFilesStore();
                                delete files[name];
                                saveFilesStore(files);
                            });
                            el.appendChild(a);
                            el.appendChild(dl);
                            el.appendChild(del);
                            recList.prepend(el);
                            flash("Recording saved to Files");
                            recState.textContent = "Idle";
                            startBtn.disabled = false;
                            stopBtn.disabled = true;
                        };
                        mediaRecorder.start();
                        recState.textContent = "Recording‚Ä¶";
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                    } catch (e) {
                        showCustomAlert("Error", "Microphone access denied or not available.");
                    }
                });
                stopBtn.addEventListener("click", () => {
                    if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
                });
                const files = loadFilesStore();
                Object.keys(files)
                    .filter((n) => files[n].type === "audio")
                    .reverse()
                    .forEach((n) => {
                        const el = document.createElement("div");
                        el.className = "rec-list-item";
                        const a = document.createElement("audio");
                        a.controls = true;
                        a.src = files[n].data;
                        const dl = document.createElement("button");
                        dl.className = "btn secondary";
                        dl.textContent = "Download";
                        dl.addEventListener("click", () => {
                            const b = dataURLtoBlob(files[n].data);
                            triggerDownload(b, n);
                        });
                        const del = document.createElement("button");
                        del.className = "btn secondary";
                        del.textContent = "Delete";
                        del.addEventListener("click", () => {
                            el.remove();
                            const files = loadFilesStore();
                            delete files[n];
                            saveFilesStore(files);
                        });
                        el.appendChild(a);
                        el.appendChild(dl);
                        el.appendChild(del);
                        recList.prepend(el);
                    });
            }
            function openCustom(id) {
               let customs = store.get(K.customApps, []);
                const c = customs.find((c) => c.id === id);
                if (!c) return;
                let win = $("#win-custom-" + id);
                if (!win) {
                    win = document.createElement("div");
                    win.className = "app-window hidden";
                    win.id = "win-custom-" + id;
                    win.dataset.app = "custom_" + id;
                    win.style.left = "20vw";
                    win.style.top = "15vh";
                    win.style.width = "700px";
                    win.style.height = "500px";
                    const header = document.createElement("div");
                    header.className = "window-header";
                    header.innerHTML = `
            <div class="win-emoji" draggable="true"><span class="dock-emoji" style="font-size:20px;line-height:1">${c.emoji}</span></div>
            <div class="win-title">${c.name}</div>
            <div class="window-actions">
              <button class="win-btn win-min" title="Minimize"></button>
              <button class="win-btn win-max" title="Maximize"></button>
              <button class="win-btn win-close" title="Close"></button>
            </div>
          `;
                    win.appendChild(header);
                    const body = document.createElement("div");
                    body.className = "window-body";
                    body.style.height = "calc(100% - 46px)";
                    const mode = store.get(K.appExecutionMode, "unsandboxed");
                    const container = document.createElement("div");
                    container.className = "app-content-container";
                    if (mode === "direct") {
                        container.innerHTML = c.html;
                        const scripts = container.querySelectorAll("script");
                        scripts.forEach((script) => {
                            const newScript = document.createElement("script");
                            newScript.textContent = script.textContent;
                            script.parentNode.replaceChild(newScript, script);
                        });
                        addRippleEffect(container);
                    } else {
                        const iframe = document.createElement("iframe");
                        iframe.style.width = "100%";
                        iframe.style.height = "100%";
                        iframe.style.border = "0";
                        iframe.srcdoc = c.html;
                        if (mode === "unsandboxed") {
                            iframe.removeAttribute("sandbox");
                            iframe.allow = "camera; microphone; geolocation; fullscreen; pointer-lock; *";
                        } else {
                            iframe.sandbox = "allow-scripts allow-same-origin allow-forms allow-popups";
                        }
                        container.appendChild(iframe);
                        addRippleEffect(container);
                    }
                    body.appendChild(container);
                    win.appendChild(body);
                    $("#desktop").appendChild(win);
                    makeDraggable(win);
                    addResizers(win);
                }
                win.classList.remove("hidden", "minimized");
                const tabletMode = store.get(K.tablet, false);
                if (tabletMode) {
                    win.style.position = "fixed";
                    win.style.inset = "0";
                    win.style.borderRadius = "0";
                    win.style.width = "100vw";
                    win.style.height = "100vh";
                    win.style.zIndex = "1000";
                    win.style.minWidth = "auto";
                    win.style.minHeight = "auto";
                    $$(".win-max, .win-min", win).forEach((btn) => (btn.style.display = "none"));
                    $(".window-header", win).style.cursor = "default";
                }
                bringToFront(win);
                centerWindow(win);
            }
            // Easter Egg: Debug Menu
            function initDebug() {
                document.addEventListener("keydown", (e) => {
                    if (e.ctrlKey && e.key === "k" && e.key === "d") {
                        // Simplified: ctrl+k then d
                        if (store.get(K.debugUnlocked, false)) {
                            $("#debugPanel").style.display =
                                $("#debugPanel").style.display === "block" ? "none" : "block";
                        }
                    }
                });
                $("#debugSpawnMeowTest").addEventListener("click", () => {
                    const duration = parseInt($("#debugChaosDuration").value) || 4;
                    let count = 0;
                    const interval = setInterval(() => {
                        if (count++ > duration * 5) {
                            // Approximate taps per second
                            clearInterval(interval);
                            return;
                        }
                        const x = Math.random() * window.innerWidth;
                        const y = Math.random() * window.innerHeight;
                        const event = new MouseEvent("click", { clientX: x, clientY: y, bubbles: true });
                        document.elementFromPoint(x, y)?.dispatchEvent(event);
                    }, 200);
                    flash(`MeowTest Chaos activated! Random taps for ${duration} seconds.`);
                });
                $("#debugFullscreen").addEventListener("click", () => {
                    if (!document.fullscreenElement) {
                        document.documentElement
                            .requestFullscreen()
                            .catch((err) => flash("Fullscreen failed: " + err.message));
                    } else {
                        document.exitFullscreen();
                    }
                    flash("Fullscreen toggled");
                });
                $("#debugShowNotif").addEventListener("click", () => {
                    const text = $("#debugNotifText").value.trim();
                    if (text) {
                        flash(text);
                        $("#debugNotifText").value = "";
                    }
                });
                $("#debugSetCatAge").addEventListener("click", () => {
                    const days = parseInt($("#debugCatDays").value);
                    if (days && days >= 0) {
                        const catData = store.get(K.cat, null);
                        if (catData) {
                            catData.startTime = Date.now() - days * gameDayMs;
                            store.set(K.cat, catData);
                            if (!$("#win-cat").classList.contains("hidden")) {
                                updateCatDisplay();
                            }
                            flash(`Cat age set to ${days} days!`);
                        } else {
                            flash("No cat data found. Create a cat first.");
                        }
                        $("#debugCatDays").value = "";
                    }
                });
                $("#debugFireworks").addEventListener("click", () => {
                    flash("Fireworks!");
                    for (let i = 0; i < 20; i++) {
                        setTimeout(() => {
                            const fw = document.createElement("div");
                            fw.className = "firework";
                            fw.style.left = Math.random() * 100 + "%";
                            fw.style.top = "100vh";
                            document.body.appendChild(fw);
                            setTimeout(() => fw.remove(), 1000);
                        }, i * 100);
                    }
                });
                $("#debugClose").addEventListener("click", () => {
                    $("#debugPanel").style.display = "none";
                });
            }
            document.addEventListener("mousemove", (e) => {
                if (dragElement && dragElement.classList.contains("shortcut")) {
                    dragElement.style.left = e.clientX - dragOffsetX + "px";
                    dragElement.style.top = e.clientY - dragOffsetY + "px";
                }
            });
            document.addEventListener("mouseup", () => {
                if (dragElement && dragElement.classList.contains("shortcut")) {
                    updateShortcutPosition(dragElement.dataset.index, dragElement.style.left, dragElement.style.top);
                }
                dragElement = null;
            });
            $("#desktop").addEventListener("dragover", (e) => e.preventDefault());
            $("#desktop").addEventListener("drop", (e) => {
                e.preventDefault();
                const dockRect = $("#dock").getBoundingClientRect();
                if (
                    e.clientX >= dockRect.left &&
                    e.clientX <= dockRect.right &&
                    e.clientY >= dockRect.top &&
                    e.clientY <= dockRect.bottom
                )
                    return;
                const rawData = e.dataTransfer.getData("text");
                if (!rawData) return;
                const data = JSON.parse(rawData);
                if (data.from === "dock") {
                    unpinApp(data.app);
                } else if (data.from === "meow" || data.from === "window") {
                    addShortcut("app", data.app, e.clientX, e.clientY);
                } else if (data.type === "file") {
                    addShortcut("file", data.id, e.clientX, e.clientY);
                }
            });
            $("#dock").addEventListener("dragover", (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            $("#dock").addEventListener("drop", (e) => {
                e.preventDefault();
                e.stopPropagation();
                const rawData = e.dataTransfer.getData("text");
                if (!rawData) return;
                const data = JSON.parse(rawData);
                if (data.from === "meow" || data.from === "window") {
                    let pinned = store.get(K.pinned, []);
                    if (!pinned.includes(data.app)) {
                        pinned.push(data.app);
                        store.set(K.pinned, pinned);
                        renderDock();
                        buildMeowMenu();
                    }
                }
            });
            const CITY_TZ = {
                tokyo: "Asia/Tokyo",
                london: "Europe/London",
                paris: "Europe/Paris",
                berlin: "Europe/Berlin",
                copenhagen: "Europe/Copenhagen",
                newyork: "America/New_York",
                "new york": "America/New_York",
                nyc: "America/New_York",
                losangeles: "America/Los_Angeles",
                "los angeles": "America/Los_Angeles",
                la: "America/Los_Angeles",
                sydney: "Australia/Sydney",
                moscow: "Europe/Moscow",
                beijing: "Asia/Shanghai",
                delhi: "Asia/Kolkata",
                dubai: "Asia/Dubai",
                singapore: "Asia/Singapore",
            };
            function formatTimeInTZ(tz) {
                const d = new Date();
                const opts = { hour: "2-digit", minute: "2-digit", hour12: true, timeZone: tz };
                return d.toLocaleTimeString([], opts);
            }
            function formatLocalDate() {
                const d = new Date();
                return d.toLocaleDateString(undefined, {
                    weekday: "long",
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                });
            }
            async function fetchWeatherFor(query) {
                const q = (query || "").toLowerCase();
                try {
                    if (/\b(here|my location|near me)\b/.test(q) && navigator.geolocation) {
                        const coords = await new Promise((res, rej) =>
                            navigator.geolocation.getCurrentPosition((p) => res(p.coords), rej, {
                                enableHighAccuracy: true,
                                timeout: 6000,
                            })
                        );
                        const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.latitude}&longitude=${coords.longitude}&current_weather=true`;
                        const r = await fetch(url);
                        const j = await r.json();
                        if (j && j.current_weather) {
                            const cw = j.current_weather;
                            return `Weather here: ${cw.temperature}¬∞C, wind ${cw.windspeed} km/h`;
                        }
                    }
                } catch {}
                const m = query.match(/weather\s+(.+)/i);
                const name = m ? m[1].trim() : query.replace(/weather/gi, "").trim();
                if (!name) return "Tell me a city, e.g. weather Paris";
                try {
                    const g = await fetch(
                        `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1`
                    );
                    const gj = await g.json();
                    if (gj && gj.results && gj.results.length) {
                        const { latitude, longitude, name: city, country } = gj.results[0];
                        const w = await fetch(
                            `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`
                        );
                        const jw = await w.json();
                        if (jw && jw.current_weather) {
                            const cw = jw.current_weather;
                            return `Weather in ${city}, ${country}: ${cw.temperature}¬∞C, wind ${cw.windspeed} km/h`;
                        }
                    }
                    return "Couldn't find that city for weather, sorry.";
                } catch {
                    return "Weather lookup failed, meow.";
                }
            }
            async function localBot(text) {
                const t = text.trim();
                const lower = t.toLowerCase();
                if (lower.startsWith("what is ")) {
                    const query = t.slice(8).trim();
                    try {
                        const res = await fetch(
                            `https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=extracts&exintro&explaintext&redirects=1&titles=${encodeURIComponent(query)}`
                        );
                        const data = await res.json();
                        const pages = data.query.pages;
                        const page = Object.values(pages)[0];
                        if (page.missing) return `No Wikipedia entry for "${query}"`;
                        return page.extract || `Found "${page.title}" but no summary available.`;
                    } catch (e) {
                        return "Failed to fetch from Wikipedia.";
                    }
                }
                if (lower.includes("meow")) return "Meow, I love cats too! üêæ";
                if (/\bdate\b/.test(lower)) return `Today is ${formatLocalDate()}.`;
                if (/\btime\b/.test(lower)) {
                    const cityMatch = lower.match(/\btime(?:\s+in)?\s+([a-z\s]+)$/i);
                    if (cityMatch) {
                        const cityRaw = cityMatch[1].trim();
                        const key = cityRaw.replace(/\s+/g, "");
                        const tz = CITY_TZ[cityRaw] || CITY_TZ[key];
                        if (tz)
                            return `Time in ${cityRaw.replace(/\b\w/g, (c) => c.toUpperCase())}: ${formatTimeInTZ(tz)}.`;
                    }
                    return `Local time: ${formatTimeInTZ(Intl.DateTimeFormat().resolvedOptions().timeZone)}.`;
                }
                if (lower.includes("weather")) {
                    return await fetchWeatherFor(lower);
                }
                return "Sorry, I don't understand that query.";
            }
            // Easter Egg: Spotlight /meowdance
            function initSpotlightEasterEgg() {
                $("#spotlightInput").addEventListener("input", async () => {
                    const val = $("#spotlightInput").value.trim().toLowerCase();
                    const res = $("#spotlightResults");
                    res.innerHTML = "";
                    if (val === "/meowdance") {
                        // Dance across the screen
                        for (let i = 0; i < 3; i++) {
                            const dancer = document.createElement("div");
                            dancer.className = "dancing-cat";
                            dancer.innerHTML = "üò∫";
                            document.body.appendChild(dancer);
                            setTimeout(() => dancer.remove(), 2000);
                        }
                        flash("Meowdance activated! üíÉüê±");
                        $("#spotlight").classList.add("hidden");
                        $("#spotlightInput").value = "";
                        return;
                    }
                    if (val.startsWith("/meowai ")) {
                        const query = val.slice(8).trim();
                        if (query) {
                            const response = await localBot(query);
                            const div = document.createElement("div");
                            div.textContent = response;
                            res.appendChild(div);
                        }
                    } else {
                        const allApps = [...apps, ...store.get(K.customApps, []).map((c) => "custom_" + c.id)];
                        allApps
                            .filter((a) => getLabel(a).toLowerCase().includes(val))
                            .forEach((a) => {
                                const btn = document.createElement("div");
                                btn.className = "start-item";
                                btn.innerHTML = `<div class="start-emoji" style="font-size:24px;line-height:1">${getIcon(a, "24px")}</div><div class="start-label">${getLabel(a)}</div>`;
                                btn.addEventListener("click", () => {
                                    openWindow(a);
                                    $("#spotlight").classList.add("hidden");
                                    $("#spotlightInput").value = "";
                                });
                                res.appendChild(btn);
                            });
                    }
                });
            }
            document.addEventListener("keydown", (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
                    e.preventDefault();
                    const spot = $("#spotlight");
                    spot.classList.toggle("hidden");
                    if (!spot.classList.contains("hidden")) $("#spotlightInput").focus();
                }
                if (e.key === "Escape" && !$("#spotlight").classList.contains("hidden")) {
                    $("#spotlight").classList.add("hidden");
                    $("#spotlightInput").value = "";
                    $("#spotlightResults").innerHTML = "";
                }
                if (
                    e.ctrlKey &&
                    e.altKey &&
                    e.key.toLowerCase() === "r" &&
                    !$("#onboarding").classList.contains("hidden")
                ) {
                    $("#recovery").classList.remove("hidden");
                }
                if (e.key.toLowerCase() === "r" && !$("#onboarding").classList.contains("hidden")) {
                    const now = Date.now();
                    if (rClickCount === 0 || now - rClickTimer > 10000) {
                        rClickCount = 1;
                        rClickTimer = now;
                    } else {
                        rClickCount++;
                    }
                    if (rClickCount >= 5) {
                        $("#recovery").classList.remove("hidden");
                        rClickCount = 0;
                    }
                }
            });
            $("#spotlightInput").addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    const res = $$("#spotlightResults .start-item");
                    if (res.length) res[0].click();
                }
            });
            $("#clock").addEventListener("click", () => $("#notifCenter").classList.toggle("hidden"));
            window.addEventListener("DOMContentLoaded", () => {
                applyBackground();
                const isSetup = !!store.get(K.setup, false);
                if (isSetup) showDesktop();
                else startOnboarding();
                $("#obNext").addEventListener("click", () => {
                    if (welcomeFontInterval) clearInterval(welcomeFontInterval);
                    $("#ob-step-1").classList.add("hidden");
                    $("#ob-step-2").classList.remove("hidden");
                    $("#obName").focus();
                });
                $("#obBack2").addEventListener("click", () => {
                    $("#ob-step-2").classList.add("hidden");
                    $("#ob-step-1").classList.remove("hidden");
                });
                $("#obNext2").addEventListener("click", () => {
                    const name = $("#obName").value.trim() || "Friend";
                    store.set(K.name, name);
                    $("#ob-step-2").classList.add("hidden");
                    $("#ob-step-3").classList.remove("hidden");
                });
                $("#obBack3").addEventListener("click", () => {
                    $("#ob-step-3").classList.add("hidden");
                    $("#ob-step-2").classList.remove("hidden");
                });
                $("#obNext3").addEventListener("click", () => {
                    const tz = $("#obTimeZone").value;
                    store.set(K.tz, tz);
                    $("#ob-step-3").classList.add("hidden");
                    $("#ob-step-4").classList.remove("hidden");
                });
                $("#obBack4").addEventListener("click", () => {
                    $("#ob-step-4").classList.add("hidden");
                    $("#ob-step-3").classList.remove("hidden");
                });
                $("#obSkipMigrate").addEventListener("click", () => {
                    store.set(K.setup, true);
                    $("#onboarding").classList.add("hidden");
                    $("#loading").classList.add("hidden");
                    showDesktop();
                });
                $("#obFinishMigrate").addEventListener("click", () => {
                    store.set(K.setup, true);
                    $("#onboarding").classList.add("hidden");
                    $("#loading").classList.add("hidden");
                    showDesktop();
                });
                $("#obChooseFolder").addEventListener("click", () => {
                    $("#obMigrateFolder").click();
                });
                $("#obMigrateFolder").addEventListener("change", async (e) => {
                    const selectedFiles = Array.from(e.target.files);
                    const status = $("#obMigrateStatus");
                    status.textContent = "Migrating files...";
                    const meowFiles = loadFilesStore();
                    for (const file of selectedFiles) {
                        const relPath = file.webkitRelativePath;
                        if (!relPath) continue;
                        const key = "/" + relPath;
                        if (meowFiles[key]) continue;
                        let entry;
                        if (file.type.startsWith("text/")) {
                            const text = await readAsText(file);
                            entry = { type: "text", text };
                        } else {
                            const data = await readAsDataURL(file);
                            const type = file.type.startsWith("image/")
                                ? "image"
                                : file.type.startsWith("audio/")
                                  ? "audio"
                                  : file.type.startsWith("video/")
                                    ? "video"
                                    : "binary";
                            entry = { type, data };
                        }
                        meowFiles[key] = entry;
                    }
                    saveFilesStore(meowFiles);
                    status.textContent = "Migration complete!";
                });
                $("#obSkip").addEventListener("click", () => {
                    if (welcomeFontInterval) clearInterval(welcomeFontInterval);
                    store.set(K.name, "Friend");
                    store.set(K.theme, "dark");
                    store.set(K.scale, 1);
                    store.set(K.setup, true);
                    store.set(K.tz, Intl.DateTimeFormat().resolvedOptions().timeZone);
                    updateTextColor();
                    $("#onboarding").classList.add("hidden");
                    $("#loading").classList.add("hidden");
                    showDesktop();
                });
                [
                    "notes",
                    "calendar",
                    "browser",
                    "files",
                    "recorder",
                    "paint",
                    "calculator",
                    "clock",
                    "settings",
                    "weather",
                    "meowstore",
                ].forEach((id) => {
                    const el = document.getElementById("win-" + id);
                    if (el) makeDraggable(el);
                });
                initNotes();
                initFiles();
                initSettings();
                initBrowser();
                initRecorder();
                initPaint();
                initCalculator();
                initClock();
                initWeather();
                initMeowStore();
                $("#calPrev").addEventListener("click", () => {
                    calDate.setMonth(calDate.getMonth() - 1);
                    renderCalendar();
                });
                $("#calNext").addEventListener("click", () => {
                    calDate.setMonth(calDate.getMonth() + 1);
                    renderCalendar();
                });
                renderCalendar();
                // Init Easter Eggs
                initSpotlightEasterEgg();
                if (isSetup) openWindow("notes");
            });
            (function ensureDefaults() {
                const files = loadFilesStore();
                if (!Object.keys(files).length) {
                    files["/User/"] = { type: "folder" };
                    files["/User/Downloads/"] = { type: "folder" };
                    files["/User/images/"] = { type: "folder" };
                    files["/User/videos/"] = { type: "folder" };
                    files["/welcome.txt"] = {
                        type: "text",
                        text: "Welcome to MeowOS! Your files are stored locally in your browser.",
                    };
                    saveFilesStore(files);
                }
            })();
            function addRippleEffect(el) {
                el.addEventListener("click", (e) => {
                    if (!store.get(K.tapFeedback, false)) return;
                    const interactiveTags = ["BUTTON", "INPUT", "SELECT", "LABEL", "A", "TEXTAREA"];
                    if (
                        interactiveTags.includes(e.target.tagName) ||
                        e.target.closest(".switch") ||
                        e.target.closest(".btn")
                    ) {
                        return;
                    }
                    const ripple = document.createElement("span");
                    const rect = el.getBoundingClientRect();
                    const size = Math.max(el.clientWidth, el.clientHeight);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    ripple.style.width = ripple.style.height = size + "px";
                    ripple.style.left = x + "px";
                    ripple.style.top = y + "px";
                    ripple.classList.add("ripple");
                    el.appendChild(ripple);
                    setTimeout(() => ripple.remove(), 600);
                });
            }
        </script>
    </body>

</html>
